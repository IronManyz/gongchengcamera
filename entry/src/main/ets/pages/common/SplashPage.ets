import router from '@ohos.router'
import { common } from '@kit.AbilityKit'
import { PermissionManager, PermissionStatus } from '../../utils/PermissionManager'

/**
 * å¯åŠ¨é¡µé¢
 * EngineeringCamera åº”ç”¨å¯åŠ¨æ—¶çš„æ¬¢è¿é¡µé¢
 * æ ¹æ®åŸå‹è®¾è®¡æä¾›ä¸“ä¸šçš„å·¥ç¨‹åº”ç”¨å¯åŠ¨ä½“éªŒ
 */
@Entry
@Component
struct SplashPage {
  @State private loadingProgress: number = 0
  @State private appVersion: string = 'v1.0.0'
  @State private appDescription: string = 'å·¥ç¨‹ä¸“ä¸šç›¸æœº'
  @State private navigateToMain: boolean = false
  @State private loadingText: string = 'æ­£åœ¨åˆå§‹åŒ–...'
  @State private permissionGranted: boolean = false
  @State private showPermissionSkip: boolean = false

  aboutToAppear(): void {
    // è®¾ç½®åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯
    this.setAppInfo()

    // å¼€å§‹åˆå§‹åŒ–
    this.initializeApp()
  }

  /**
   * è®¾ç½®åº”ç”¨ä¿¡æ¯
   */
  private setAppInfo(): void {
    // ä»é…ç½®æ–‡ä»¶è¯»å–ç‰ˆæœ¬ä¿¡æ¯
    this.appVersion = 'v1.0.1'
    this.appDescription = 'å·¥ç¨‹ä¸“ä¸šç›¸æœº'
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  private async initializeApp(): Promise<void> {
    try {
      // æ¨¡æ‹Ÿåº”ç”¨åˆå§‹åŒ–è¿‡ç¨‹
      await this.performInitialization()

      // ç­‰å¾…ç”¨æˆ·çœ‹åˆ°å¯åŠ¨åŠ¨ç”»å®Œæˆ
      await this.waitAnimationComplete()

      // è·³è½¬åˆ°ä¸»é¡µé¢
      this.navigateToMainPage()
    } catch (error) {
      console.error('SplashPage initialization failed:', error)
      // å³ä½¿å‡ºé”™ä¹Ÿè¦è·³è½¬åˆ°ä¸»é¡µé¢
      this.navigateToMainPage()
    }
  }

  /**
   * æ‰§è¡Œåº”ç”¨åˆå§‹åŒ–
   */
  private async performInitialization(): Promise<void> {
    try {
      // æ­¥éª¤1: åˆå§‹åŒ–æ•°æ®åº“
      this.loadingProgress = 10
      this.loadingText = 'æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...'
      await this.delay(300)

      // æ­¥éª¤2: åŠ è½½é…ç½®æ–‡ä»¶
      this.loadingProgress = 25
      this.loadingText = 'æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶...'
      await this.delay(300)

      // æ­¥éª¤3: è¯·æ±‚åº”ç”¨æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      this.loadingProgress = 40
      this.loadingText = 'æ­£åœ¨è¯·æ±‚åº”ç”¨æƒé™...'
      await this.requestAppPermissions()

      // æ­¥éª¤4: å¯åŠ¨æœåŠ¡
      this.loadingProgress = 70
      this.loadingText = 'æ­£åœ¨å¯åŠ¨æœåŠ¡...'
      await this.delay(300)

      // æ­¥éª¤5: å‡†å¤‡ç•Œé¢
      this.loadingProgress = 90
      this.loadingText = 'æ­£åœ¨å‡†å¤‡ç•Œé¢...'
      await this.delay(300)

      // å®Œæˆ
      this.loadingProgress = 100
      this.loadingText = 'åˆå§‹åŒ–å®Œæˆ'
      await this.delay(200)

    } catch (error) {
      console.error('Initialization failed:', error)
      this.loadingText = 'åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­å¯åŠ¨...'
      await this.delay(500)
    }
  }

  /**
   * è¯·æ±‚åº”ç”¨å¿…è¦æƒé™
   */
  private async requestAppPermissions(): Promise<void> {
    console.log('=== SplashPage: Requesting app permissions ===')
    
    try {
      const context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext
      if (!context) {
        console.warn('Failed to get context for permission request')
        this.permissionGranted = false
        return
      }

      const permissionManager: PermissionManager = PermissionManager.getInstance()
      
      // è¯·æ±‚ç›¸æœºã€å­˜å‚¨å’Œä½ç½®æƒé™
      console.log('Requesting camera and storage permissions...')
      const result = await permissionManager.requestCameraPermission(context)
      
      console.log('Permission request result:', result.status)
      
      if (result.status === PermissionStatus.GRANTED) {
        console.log('All permissions granted successfully')
        this.permissionGranted = true
        this.loadingText = 'æƒé™æˆäºˆæˆåŠŸ'
      } else {
        console.warn('Permissions not fully granted:', result.message)
        this.permissionGranted = false
        this.loadingText = 'éƒ¨åˆ†æƒé™æœªæˆäºˆ'
        this.showPermissionSkip = true
      }
      
      await this.delay(500)
      
    } catch (error) {
      console.error('Request permissions failed:', error)
      this.permissionGranted = false
      this.loadingText = 'æƒé™è¯·æ±‚å¤±è´¥'
      this.showPermissionSkip = true
      await this.delay(500)
    }
  }

  /**
   * å»¶è¿Ÿè¾…åŠ©å‡½æ•°
   */
  private delay(ms: number): Promise<void> {
    return new Promise<void>((resolve) => {
      setTimeout(() => resolve(), ms)
    })
  }

  /**
   * ç­‰å¾…åŠ¨ç”»å®Œæˆ
   */
  private async waitAnimationComplete(): Promise<void> {
    return new Promise<void>((resolve: () => void) => {
      setTimeout(() => {
        resolve()
      }, 800)
    })
  }

  /**
   * è·³è½¬åˆ°ä¸»é¡µé¢
   */
  private navigateToMainPage(): void {
    this.navigateToMain = true
    setTimeout(() => {
      router.replaceUrl({
        url: 'pages/MainPage',
        params: {
          fromSplash: true,
          permissionsGranted: this.permissionGranted
        }
      }).catch((error: Error) => {
        console.error('Navigation failed:', error)
        // å¦‚æœå¯¼èˆªå¤±è´¥ï¼Œå°è¯•å…¶ä»–é¡µé¢
        router.replaceUrl({
          url: 'pages/Index',
          params: {}
        })
      })
    }, 300)
  }

  build() {
    Stack() {
      // èƒŒæ™¯å±‚ - ä½¿ç”¨æ¸å˜èƒŒæ™¯
      Column() {
        // åº”ç”¨LogoåŒºåŸŸ
        Column() {
          // Logoå›¾æ ‡ - ä½¿ç”¨emojiä»£æ›¿ä¸å­˜åœ¨çš„èµ„æº
          Text('ğŸ“¸')
            .fontSize(80)
            .margin({ bottom: 24 })

          // åº”ç”¨åç§°
          Text('å·¥ç¨‹æ‹è®°')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890FF')
            .margin({ bottom: 8 })

          // è‹±æ–‡åç§°
          Text('Engineering Photo Record')
            .fontSize(18)
            .fontColor('#52C41A')
            .margin({ bottom: 16 })

          // åº”ç”¨æè¿°
          Text('ä¸“ä¸š Â· å®‰å…¨ Â· é«˜æ•ˆ')
            .fontSize(16)
            .fontColor('#666666')
        }
        .margin({ bottom: 80 })

        // åŠ è½½è¿›åº¦åŒºåŸŸ
        Column() {
          // è¿›åº¦æ¡
          Progress({
            value: this.loadingProgress,
            total: 100,
            type: ProgressType.Linear
          })
            .width(240)
            .height(6)
            .color('#1890FF')
            .backgroundColor('#E5E5E5')
            .borderRadius(3)

          // åŠ è½½æ–‡æœ¬
          Text(this.loadingText)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })

          // è¿›åº¦ç™¾åˆ†æ¯”
          Text(`${this.loadingProgress}%`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1890FF')
            .margin({ top: 8 })

          // æƒé™çŠ¶æ€æç¤º
          if (this.loadingProgress >= 40) {
            if (this.permissionGranted) {
              Text('âœ“ æƒé™å·²æˆäºˆ')
                .fontSize(12)
                .fontColor('#52C41A')
                .margin({ top: 12 })
            } else if (this.showPermissionSkip) {
              Column({ space: 8 }) {
                Text('âš ï¸ éƒ¨åˆ†æƒé™æœªæˆäºˆ')
                  .fontSize(12)
                  .fontColor('#FAAD14')
                
                Text('æ‚¨å¯ä»¥ç¨ååœ¨è®¾ç½®ä¸­æˆäºˆæƒé™')
                  .fontSize(11)
                  .fontColor('#999999')
              }
              .margin({ top: 12 })
            }
          }
        }

        Blank()

        // ç‰ˆæœ¬ä¿¡æ¯
        Column() {
          Text(this.appVersion)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ bottom: 8 })

          Text('ä¸“ä¸šçš„å·¥ç¨‹æ‹æ‘„ç®¡ç†å·¥å…·')
            .fontSize(12)
            .fontColor('#BFBFBF')
        }
        .margin({ bottom: 60 })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor('#F5F5F5')

      // è·³è½¬æç¤ºå·²å–æ¶ˆï¼Œä¿æŒç•Œé¢ç®€æ´
    }
    .width('100%')
    .height('100%')
  }
}
