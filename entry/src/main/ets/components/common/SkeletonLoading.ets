/**
 * éª¨æž¶å±åŠ è½½ç»„ä»¶
 * æä¾›å¤šç§éª¨æž¶å±æ•ˆæžœï¼Œæå‡å†…å®¹åŠ è½½æ—¶çš„ç”¨æˆ·ä½“éªŒ
 */

import { ThemeManager } from '../../theme/ThemeManager'

export type SkeletonType =
  | 'text'         // æ–‡æœ¬éª¨æž¶
  | 'avatar'       // å¤´åƒéª¨æž¶
  | 'image'         // å›¾ç‰‡éª¨æž¶
  | 'card'          // å¡ç‰‡éª¨æž¶
  | 'list'          // åˆ—è¡¨éª¨æž¶
  | 'table'         // è¡¨æ ¼éª¨æž¶
  | 'custom'        // è‡ªå®šä¹‰éª¨æž¶

export type SkeletonAnimation =
  | 'wave'          // æ³¢æµªåŠ¨ç”»
  | 'pulse'         // è„‰å†²åŠ¨ç”»
  | 'shimmer'       // é—ªå…‰æ•ˆæžœ
  | 'fade'          // æ·¡å…¥æ·¡å‡º
  | 'none'          // æ— åŠ¨ç”»

@ComponentV2
export struct SkeletonLoading {
  @Param isLoading: boolean = false
  @Param type: SkeletonType = 'text'
  @Param animation: SkeletonAnimation = 'wave'
  @Param rows: number = 3
  @Param width: string = '100%'
  @Param height: string = 'auto'
  @Param borderRadius: number = 4
  @Param showAvatar: boolean = false
  @Param avatarSize: number = 40
  @Param theme: 'light' | 'dark' = 'light'
  @Param shimmerColor: string = 'rgba(255, 255, 255, 0.3)'

  @State private shimmerPosition: number = 0

  aboutToAppear() {
    if (this.animation === 'wave' || this.animation === 'shimmer') {
      this.startShimmerAnimation()
    }
  }

  /**
   * å¯åŠ¨é—ªå…‰åŠ¨ç”»
   */
  private startShimmerAnimation() {
    animateTo({
      duration: 2000,
      curve: Curve.Linear,
      iterations: -1
    }, () => {
      this.shimmerPosition = (this.shimmerPosition + 200) % 400
    })
  }

  build() {
    if (this.isLoading) {
      Column() {
        switch (this.type) {
          case 'text':
            this.buildTextSkeleton()
            break
          case 'avatar':
            this.buildAvatarSkeleton()
            break
          case 'image':
            this.buildImageSkeleton()
            break
          case 'card':
            this.buildCardSkeleton()
            break
          case 'list':
            this.buildListSkeleton()
            break
          case 'table':
            this.buildTableSkeleton()
            break
          default:
            this.buildTextSkeleton()
            break
        }
      }
      .width(this.width)
      .height(this.height)
      .animation(
        this.animation !== 'none' ? {
          duration: 300,
          curve: Curve.EaseInOut
        } : undefined
      )
    }
  }

  /**
   * æž„å»ºæ–‡æœ¬éª¨æž¶
   */
  @Builder
  private buildTextSkeleton() {
    Column({ space: 8 }) {
      ForEach(Array.from({ length: this.rows }), () => {
        Row()
          .width('100%')
          .height(16)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)
          .position({ relative: 'absolute' })
          .linearGradient({
            direction: GradientDirection.Right,
            colors: this.getShimmerGradient()
          })
          .translate({ x: this.getShimmerOffset() })
      })
    }
  }

  /**
   * æž„å»ºå¤´åƒéª¨æž¶
   */
  @Builder
  private buildAvatarSkeleton() {
    Column({ space: 12 }) {
      // å¤´åƒéª¨æž¶
      Circle({ width: this.avatarSize, height: this.avatarSize })
        .fill(this.getSkeletonColor())
        .position({ relative: 'absolute' })
        .linearGradient({
          direction: GradientDirection.Right,
          colors: this.getShimmerGradient()
        })
        .translate({ x: this.getShimmerOffset() })

      // ä¿¡æ¯éª¨æž¶
      Column({ space: 6 }) {
        Row()
          .width(80)
          .height(12)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)

        Row()
          .width(120)
          .height(8)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)
      }
      .alignItems(HorizontalAlign.Start)
    }
  }

  /**
   * æž„å»ºå›¾ç‰‡éª¨æž¶
   */
  @Builder
  private buildImageSkeleton() {
    Column()
      .width(this.width)
      .height(this.height)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor(this.getSkeletonColor())
      .borderRadius(this.borderRadius)
      .position({ relative: 'absolute' })
      .linearGradient({
        direction: GradientDirection.Right,
        colors: this.getShimmerGradient()
      })
      .translate({ x: this.getShimmerOffset() })

    // å›¾ç‰‡å ä½ç¬¦
    Text('ðŸ–¼ï¸')
      .fontSize(24)
      .fontColor('#CCCCCC')
  }

  /**
   * æž„å»ºå¡ç‰‡éª¨æž¶
   */
  @Builder
  private buildCardSkeleton() {
    Column({ space: 16 }) {
      // å¡ç‰‡å¤´éƒ¨
      Row()
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        .padding({ bottom: 12 }) {

        Circle({ width: 16, height: 16 })
          .fill(this.getSkeletonColor())
          .borderRadius(8)

        Row({ space: 8 }) {
          Row()
            .width(60)
            .height(12)
            .backgroundColor(this.getSkeletonColor())
            .borderRadius(this.borderRadius)

          Row()
            .width(40)
            .height(8)
            .backgroundColor(this.getSkeletonColor())
            .borderRadius(this.borderRadius)
        }
      }

      // å¡ç‰‡å†…å®¹
      ForEach(Array.from({ length: 3 }), () => {
        Row()
          .width('100%')
          .height(14)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)
          .margin({ bottom: 8 })
      })

      // å¡ç‰‡åº•éƒ¨
      Row({ space: 12 }) {
        Row()
          .width(80)
          .height(10)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)

        Row()
          .width(60)
          .height(10)
          .backgroundColor(this.getSkeletonColor())
          .borderRadius(this.borderRadius)
      }
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(ThemeManager.getCurrentSurfaceColor())
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: ThemeManager.getCurrentShadowColor(),
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æž„å»ºåˆ—è¡¨éª¨æž¶
   */
  @Builder
  private buildListSkeleton() {
    Column({ space: 12 }) {
      ForEach(Array.from({ length: this.rows }), (index: number) => {
        Row({ space: 12 }) {
          // åˆ—è¡¨é¡¹å¤´åƒ
          if (this.showAvatar) {
            Circle({ width: this.avatarSize, height: this.avatarSize })
              .fill(this.getSkeletonColor())
              .borderRadius(this.avatarSize / 2)
          }

          // åˆ—è¡¨é¡¹å†…å®¹
          Column({ space: 8 }) {
            Row()
              .width('80%')
              .height(16)
              .backgroundColor(this.getSkeletonColor())
              .borderRadius(this.borderRadius)

            Row()
              .width('60%')
              .height(12)
              .backgroundColor(this.getSkeletonColor())
              .borderRadius(this.borderRadius)

            Row()
              .width('40%')
              .height(8)
              .backgroundColor(this.getSkeletonColor())
              .borderRadius(this.borderRadius)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(ThemeManager.getCurrentSurfaceColor())
        .borderRadius(8)
        .shadow({
          radius: 2,
          color: ThemeManager.getCurrentShadowColor(),
          offsetX: 0,
          offsetY: 1
        })
      })
    }
  }

  /**
   * æž„å»ºè¡¨æ ¼éª¨æž¶
   */
  @Builder
  private buildTableSkeleton() {
    Column() {
      // è¡¨å¤´
      Row({ space: 8 }) {
        ForEach(Array.from({ length: 4 }), () => {
          Row()
            .width('100%')
            .height(16)
            .backgroundColor(this.getSkeletonColor())
            .borderRadius(this.borderRadius)
        })
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ bottom: 12 })
      .border({ width: { bottom: 1 }, color: ThemeManager.getCurrentBorderColor() })

      // è¡¨æ ¼å†…å®¹
      ForEach(Array.from({ length: this.rows }), () => {
        Row({ space: 8 }) {
          ForEach(Array.from({ length: 4 }), () => {
            Row()
              .width('100%')
              .height(12)
              .backgroundColor(this.getSkeletonColor())
              .borderRadius(this.borderRadius)
          })
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ vertical: 8 })
        .border({ width: { bottom: 1 }, color: ThemeManager.getCurrentBorderColor() })
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(ThemeManager.getCurrentSurfaceColor())
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: ThemeManager.getCurrentShadowColor(),
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * èŽ·å–éª¨æž¶é¢œè‰²
   */
  private getSkeletonColor(): string {
    return this.theme === 'dark' ? '#2C2C2C' : '#F0F0F0'
  }

  /**
   * èŽ·å–é—ªå…‰æ¸å˜é¢œè‰²
   */
  private getShimmerGradient(): ResourceStr[] {
    const baseColor = this.getSkeletonColor()
    return [
      baseColor,
      this.shimmerColor,
      baseColor
    ]
  }

  /**
   * èŽ·å–é—ªå…‰åç§»é‡
   */
  private getShimmerOffset(): number {
    switch (this.animation) {
      case 'wave':
        return this.shimmerPosition - 200
      case 'shimmer':
        return this.shimmerPosition - 200
      case 'pulse':
        return Math.sin(Date.now() / 500) * 10
      default:
        return 0
    }
  }
}

/**
 * éª¨æž¶å±å®¹å™¨ç»„ä»¶
 * ä¸ºé¡µé¢æä¾›å®Œæ•´çš„éª¨æž¶å±æ•ˆæžœ
 */
@ComponentV2
export struct SkeletonScreen {
  @Param isLoading: boolean = false
  @Param hasHeader: boolean = true
  @Param hasFooter: boolean = true
  @Param backgroundColor: string = '#F5F5F5'
  @Param children: () => void = () => {}

  build() {
    Stack() {
      // éª¨æž¶å±
      if (this.isLoading) {
        Column() {
          // å¤´éƒ¨éª¨æž¶
          if (this.hasHeader) {
            Row()
              .width('100%')
              .height(56)
              .backgroundColor('#FFFFFF')
              .justifyContent(FlexAlign.SpaceBetween)
              .alignItems(VerticalAlign.Center)
              .padding({ left: 16, right: 16 }) {

              Row()
                .width(120)
                .height(16)
                .backgroundColor('#F0F0F0')
                .borderRadius(4)

              Row({ space: 8 }) {
                Circle({ width: 32, height: 32 })
                  .fill('#F0F0F0')
                  .borderRadius(16)

                Row()
                  .width(80)
                  .height(8)
                  .backgroundColor('#F0F0F0')
                  .borderRadius(4)
              }
            }
          }

          // å†…å®¹éª¨æž¶
          Column() {
            // æ ‡é¢˜éª¨æž¶
            Row()
              .width('60%')
              .height(24)
              .backgroundColor('#F0F0F0')
              .borderRadius(4)
              .margin({ bottom: 16 })

            // å†…å®¹åˆ—è¡¨éª¨æž¶
            ForEach(Array.from({ length: 5 }), (index: number) => {
              Row({ space: 12 }) {
                Circle({ width: 48, height: 48 })
                  .fill('#F0F0F0')
                  .borderRadius(24)

                Column({ space: 8 }) {
                  Row()
                    .width('70%')
                    .height(16)
                    .backgroundColor('#F0F0F0')
                    .borderRadius(4)

                  Row()
                    .width('50%')
                    .height(12)
                    .backgroundColor('#F0F0F0')
                    .borderRadius(4)

                  Row()
                    .width('80%')
                    .height(8)
                    .backgroundColor('#F0F0F0')
                    .borderRadius(4)
                }
                .layoutWeight(1)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .margin({ bottom: 12 })
              .shadow({
                radius: 2,
                color: 'rgba(0, 0, 0, 0.1)',
                offsetX: 0,
                offsetY: 1
              })
            })
          }
          .layoutWeight(1)

          // åº•éƒ¨éª¨æž¶
          if (this.hasFooter) {
            Row()
              .width('100%')
              .height(60)
              .backgroundColor('#FFFFFF')
              .justifyContent(FlexAlign.SpaceAround)
              .alignItems(VerticalAlign.Center)
              .border({ width: { top: 1 }, color: '#F0F0F0' }) {

              Row()
                .width(60)
                .height(8)
                .backgroundColor('#F0F0F0')
                .borderRadius(4)

              Row()
                .width(80)
                .height(8)
                .backgroundColor('#F0F0F0')
                .borderRadius(4)

              Row()
                .width(60)
                .height(8)
                .backgroundColor('#F0F0F0')
                .borderRadius(4)
            }
          }
        }
        .width('100%')
        .height('100%')
        .backgroundColor(this.backgroundColor)
        .zIndex(1000)
      }

      // å®žé™…å†…å®¹
      if (!this.isLoading) {
        Column() {
          this.children()
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }
}