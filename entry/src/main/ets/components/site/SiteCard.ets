/**
 * å·¥ç‚¹å¡ç‰‡ç»„ä»¶
 * æ ¹æ®åŽŸåž‹è®¾è®¡å®žçŽ°çš„å·¥ç‚¹ä¿¡æ¯å±•ç¤ºå¡ç‰‡
 */

import { SimpleSite } from '../../models/SimpleSite'

@ComponentV2
export struct SiteCard {
  @Param site: SimpleSite = new SimpleSite()
  @Param showThumbnails: boolean = true
  @Param showLocation: boolean = true
  @Param onCamera: (site: SimpleSite) => void = () => {}
  @Param onView: (site: SimpleSite) => void = () => {}
  @Param onTap: (site: SimpleSite) => void = () => {}
  @Param onLongPress: (site: SimpleSite) => void = () => {}

  /**
   * å¤„ç†å¡ç‰‡ç‚¹å‡»
   */
  private handleCardClick(): void {
    if (this.onTap) {
      this.onTap(this.site)
    } else {
      this.onView(this.site)
    }
  }

  /**
   * å¤„ç†å¡ç‰‡é•¿æŒ‰
   */
  private handleLongPress(): void {
    if (this.onLongPress) {
      this.onLongPress(this.site)
    }
  }

  /**
   * èŽ·å–æµ·æ‹”æ˜¾ç¤ºæ–‡æœ¬
   */
  private getAltitudeText(): string {
    if (this.site.altitude === 0) return ''
    return ` â›°ï¸ ${this.site.altitude}m`
  }

  /**
   * èŽ·å–çŠ¶æ€æŒ‡ç¤ºå™¨
   */
  @Builder
  private StatusIndicator() {
    Text(this.site.getStatusText())
      .fontSize(12)
      .fontColor(this.site.getStatusColor())
      .backgroundColor(this.site.getStatusColor() + '15')
      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
      .borderRadius(10)
  }

  /**
   * ç¼©ç•¥å›¾é¢„è§ˆåŒºåŸŸ
   */
  @Builder
  private ThumbnailPreview() {
    if (this.showThumbnails && this.site.hasPhotos()) {
      Row() {
        ForEach([1, 2, 3, 4], (index: number) => {
          if (index <= Math.min(this.site.photoCount, 4)) {
            Text('ðŸ–¼')
              .fontSize(16)
              .backgroundColor('#F5F5F5')
              .padding(4)
              .borderRadius(4)
          } else if (index === 4 && this.site.photoCount > 4) {
            Text(`+${this.site.photoCount - 3}`)
              .fontSize(12)
              .fontColor('#8C8C8C')
              .backgroundColor('#F5F5F5')
              .padding(4)
              .borderRadius(4)
          }
        })
      }
      .margin({ top: 8 })
    }
  }

  /**
   * ä½ç½®ä¿¡æ¯åŒºåŸŸ
   */
  @Builder
  private LocationInfo() {
    if (this.showLocation && this.site.hasLocation()) {
      Text(`ðŸ“Œ ${this.site.getCoordinatesString()}${this.getAltitudeText()}`)
        .fontSize(12)
        .fontColor('#8C8C8C')
        .margin({ top: 4 })
    }
  }

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // å·¥ç‚¹åç§°
        Row() {
          Text('ðŸ“')
            .fontSize(16)
            .margin({ right: 8 })

          Text(this.site.getDisplayName())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')
            .layoutWeight(1)

          // çŠ¶æ€æŒ‡ç¤ºå™¨
          this.StatusIndicator()
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        // å·¥ç‚¹æè¿°ï¼ˆå¦‚æžœæœ‰ï¼‰
        if (this.site.description) {
          Text(this.site.description)
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 })
            .width('100%')
        }

        // åœ°å€ä¿¡æ¯
        Text(this.site.getFullAddress())
          .fontSize(12)
          .fontColor('#8C8C8C')
          .margin({ top: 4 })
          .width('100%')

        // ä½ç½®ä¿¡æ¯
        this.LocationInfo()

        // ç¼©ç•¥å›¾é¢„è§ˆ
        this.ThumbnailPreview()

        // ç»Ÿè®¡ä¿¡æ¯å’Œæœ€åŽæ›´æ–°æ—¶é—´
        Row() {
          Text(`ðŸ“· ${this.site.photoCount}å¼ ç…§ç‰‡`)
            .fontSize(12)
            .fontColor('#666666')

          Blank()

          Text(`æœ€æ–°: ${this.site.getLastUpdateTime()}`)
            .fontSize(12)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .width('100%')
      .padding(16)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®åŒºåŸŸ
      Row() {
        Button('ðŸ“¸ æ‹ç…§')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(6)
          .onClick(() => {
            this.onCamera(this.site)
          })

        Blank()

        Button('ðŸ‘ï¸ æŸ¥çœ‹')
          .fontSize(14)
          .fontColor('#1890FF')
          .backgroundColor('#FFFFFF')
          .border({ width: 1, color: '#1890FF' })
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(6)
          .onClick(() => {
            this.onView(this.site)
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({
      radius: 6,
      color: '#00000015',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.handleCardClick()
    })
    .gesture(
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          this.handleLongPress()
        })
    )
  }
}