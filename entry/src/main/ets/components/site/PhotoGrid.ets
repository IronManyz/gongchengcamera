/**
 * ç…§ç‰‡ç½‘æ ¼ç»„ä»¶
 * ç”¨äºŽå±•ç¤ºå·¥ç‚¹çš„ç…§ç‰‡ç¼©ç•¥å›¾ï¼Œæ”¯æŒç½‘æ ¼å¸ƒå±€å’Œç‚¹å‡»äº¤äº’
 */

import { photoStore } from '../../store/photo/PhotoStore'
import { Photo } from '../../models/Photo'
import { ThemeManager } from '../../theme/ThemeManager'

@ComponentV2
export struct PhotoGrid {
  @Require @Param siteId: string = ''
  @Param maxPhotos: number = 4
  @Param onPhotoClick: (photo: Photo) => void = () => {}
  @Param onMoreClick: () => void = () => {}
  @Param compact: boolean = false
  @State private photos: Photo[] = []
  @State private isLoading: boolean = false

  async aboutToAppear() {
    await this.loadPhotos()
  }

  /**
   * åŠ è½½å·¥ç‚¹ç…§ç‰‡
   */
  private async loadPhotos(): Promise<void> {
    if (!this.siteId) {
      return
    }

    this.isLoading = true
    try {
      this.photos = await photoStore.getPhotosBySite(this.siteId, this.maxPhotos)
    } catch (error) {
      console.error('åŠ è½½å·¥ç‚¹ç…§ç‰‡å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * å¤„ç†ç…§ç‰‡ç‚¹å‡»
   */
  private handlePhotoClick(photo: Photo): void {
    if (this.onPhotoClick) {
      this.onPhotoClick(photo)
    }
  }

  /**
   * å¤„ç†æ›´å¤šç‚¹å‡»
   */
  private handleMoreClick(): void {
    if (this.onMoreClick) {
      this.onMoreClick()
    }
  }

  build() {
    Column() {
      // ç½‘æ ¼æ ‡é¢˜
      Row() {
        Text('çŽ°åœºç…§ç‰‡')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeManager.getCurrentTextColor())

        Blank()

        if (this.photos.length > this.maxPhotos && this.onMoreClick) {
          Text(`æŸ¥çœ‹å…¨éƒ¨ (${this.photos.length})`)
            .fontSize(12)
            .fontColor(ThemeManager.getCurrentPrimaryColor())
            .onClick(() => this.handleMoreClick())
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ç…§ç‰‡ç½‘æ ¼
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          Row({ space: 8 }) {
            LoadingProgress()
              .width(20)
              .height(20)
              .color(ThemeManager.getCurrentPrimaryColor())

            Text('åŠ è½½ç…§ç‰‡ä¸­...')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 32, bottom: 32 })
        }
        .width('100%')
        .height(160)
        .backgroundColor('#FAFAFA')
        .borderRadius(8)
      } else if (this.photos.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ðŸ“·')
            .fontSize(32)
            .fontColor('#C0C0C0')
            .margin({ bottom: 12 })

          Text('æš‚æ— ç…§ç‰‡')
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .padding({ top: 24, bottom: 24 })
        .height(160)
        .backgroundColor('#FAFAFA')
        .borderRadius(8)
      } else {
        // ç…§ç‰‡ç½‘æ ¼å¸ƒå±€
        Grid() {
          ForEach(this.photos, (photo: Photo, index?: number) => {
            GridItem() {
              Column() {
                // ç…§ç‰‡å®¹å™¨
                Stack() {
                  // ç…§ç‰‡èƒŒæ™¯
                  if (index === 0) {
                    // ç¬¬ä¸€å¼ å¤§å›¾å±•ç¤º
                    Image(photo.getThumbnailPath())
                      .width('100%')
                      .height(120)
                      .objectFit(ImageFit.Cover)
                      .borderRadius(8)
                      .onClick(() => this.handlePhotoClick(photo))
                  }
                }
                .width('100%')
                .aspectRatio(1)
                .margin({ bottom: 8 })
                .borderRadius(8)
                .backgroundColor('#FFFFFF')
                .shadow({
                  radius: 4,
                  color: '#00000015',
                  offsetX: 0,
                  offsetY: 2
                })
              }

              // ç…§ç‰‡ç¼–å·ï¼ˆå¦‚æžœæ˜¯ç¼©ç•¥å›¾ï¼‰
              if (this.compact && index && index > 0) {
                Text(`${index + 1}`)
                  .fontSize(10)
                  .fontColor('#FFFFFF')
                  .fontWeight(FontWeight.Bold)
                  .position({ x: '8%', y: '8%' })
                  .textAlign(TextAlign.Center)
                  .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                  .backgroundColor('#00000080')
                  .borderRadius(8)
              }
            }
            .onClick(() => this.handlePhotoClick(photo))
          }
        }
        .columnsTemplate('1fr 1fr 1fr 1fr')
        .columnsGap(8)
        .rowsGap(8)
        .width('100%')
        .height(this.compact ? 80 : 160)
        .padding({ left: 0, right: 0, top: 0, bottom: 12 })
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }
}