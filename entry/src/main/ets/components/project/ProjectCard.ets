/**
 * å·¥ç¨‹å¡ç‰‡ç»„ä»¶
 * å±•ç¤ºå·¥ç¨‹æ¦‚è¦ä¿¡æ¯ï¼Œç¬¦åˆåŸå‹è®¾è®¡
 */

import { Project } from '../../models/Project'
import { ProjectStatus } from '../../types/AppTypes'
import router from '@ohos.router'

@ComponentV2
export struct ProjectCard {
  @Require @Param project: Project = new Project()
  @Param showStats: boolean = true
  @Param onTap: (project: Project) => void = () => {}
  @Require @Param onLongPress: (project: Project) => void = () => {}
  @Param showTeamMember?: boolean = true // æ–°å¢å›¢é˜Ÿæˆå‘˜æ˜¾ç¤º
  @Param compact?: boolean = false // æ–°å¢ç´§å‡‘å¸ƒå±€æ¨¡å¼
  @Param elevation?: boolean = true // æ”¹ä¸ºé»˜è®¤å¼€å¯é«˜ç¨‹æ•ˆæœ
  @Local private isPressed: boolean = false // æ”¹ä¸ºLocalçŠ¶æ€

  // çŠ¶æ€é¢œè‰²æ˜ å°„
  private getStatusColor(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return '#52C41A' // ç»¿è‰² - è¿›è¡Œä¸­
      case ProjectStatus.COMPLETED:
        return '#1890FF' // è“è‰² - å·²å®Œæˆ
      case ProjectStatus.PAUSED:
        return '#FAAD14' // æ©™è‰² - æš‚åœ
      case ProjectStatus.CANCELLED:
        return '#FF4D4F' // çº¢è‰² - å·²å–æ¶ˆ
      default:
        return '#8C8C8C' // ç°è‰² - æœªçŸ¥
    }
  }

  // çŠ¶æ€æ–‡æœ¬æ˜ å°„
  private getStatusText(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return 'è¿›è¡Œä¸­'
      case ProjectStatus.COMPLETED:
        return 'å·²å®Œæˆ'
      case ProjectStatus.PAUSED:
        return 'æš‚åœä¸­'
      case ProjectStatus.CANCELLED:
        return 'å·²å–æ¶ˆ'
      default:
        return 'æœªçŸ¥'
    }
  }

  // é¡¹ç›®å¥åº·çŠ¶æ€æ–‡æœ¬æ˜ å°„
  private getHealthStatusText(project: Project): string {
    if (project.progress >= 100) {
      return 'é¡¹ç›®å®Œæˆ'
    } else if (project.progress >= 75) {
      return 'å³å°†å®Œæˆ'
    } else if (project.progress >= 50) {
      return 'è¿›å±•è‰¯å¥½'
    } else if (project.progress >= 25) {
      return 'éœ€è¦å…³æ³¨'
    } else {
      return 'éœ€è¦å¯åŠ¨'
    }
  }

  // ä¼˜å…ˆçº§æ–‡æœ¬æ˜ å°„
  private getPriorityText(priority: string): string {
    switch (priority.toLowerCase()) {
      case 'high':
      case 'é«˜':
        return 'é«˜ä¼˜å…ˆçº§'
      case 'medium':
      case 'ä¸­':
        return 'ä¸­ä¼˜å…ˆçº§'
      case 'low':
      case 'ä½':
        return 'ä½ä¼˜å…ˆçº§'
      default:
        return priority
    }
  }

  // ä¼˜å…ˆçº§é¢œè‰²æ˜ å°„
  private getPriorityColor(priority: string): string {
    switch (priority.toLowerCase()) {
      case 'high':
      case 'é«˜':
        return '#FF4D4F' // çº¢è‰²
      case 'medium':
      case 'ä¸­':
        return '#FAAD14' // æ©™è‰²
      case 'low':
      case 'ä½':
        return '#52C41A' // ç»¿è‰²
      default:
        return '#8C8C8C' // ç°è‰²
    }
  }

  // è·å–çŠ¶æ€å›¾æ ‡
  private getStatusIcon(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return 'ğŸŸ¢' // ç»¿è‰²åœ†åœˆ
      case ProjectStatus.COMPLETED:
        return 'âœ…' // å®Œæˆæ ‡è®°
      case ProjectStatus.PAUSED:
        return 'â¸ï¸' // æš‚åœç¬¦å·
      case ProjectStatus.CANCELLED:
        return 'âŒ' // å–æ¶ˆæ ‡è®°
      default:
        return 'âšª' // ç©ºç™½åœ†åœˆ
    }
  }

  // è·å–å¥åº·çŠ¶æ€é¢œè‰²
  private getHealthStatusColor(progress: number): string {
    if (progress >= 75) {
      return '#52C41A' // ç»¿è‰² - è‰¯å¥½
    } else if (progress >= 50) {
      return '#FAAD14' // æ©™è‰² - ä¸­ç­‰
    } else if (progress >= 25) {
      return '#FA8C16' // æ·±æ©™è‰² - éœ€è¦å…³æ³¨
    } else {
      return '#FF4D4F' // çº¢è‰² - ç´§æ€¥
    }
  }

  // è·å–å¡ç‰‡èƒŒæ™¯é¢œè‰²
  private getCardBackgroundColor(status: ProjectStatus): string {
    const color = this.getStatusColor(status)
    return `${color}05` // ç®€å•çš„èƒŒæ™¯è‰²
  }

  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æŒ‡ç¤ºæ¡
      Row()
        .width('100%')
        .height(3)
        .backgroundColor(this.getStatusColor(this.project.status))
        .borderRadius({ topLeft: 8, topRight: 8 })

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Row() {
        // å·¦ä¾§çŠ¶æ€æŒ‡ç¤ºå™¨
        Column() {
          Text(this.getStatusIcon(this.project.status))
            .fontSize(20)
            .margin({ bottom: 8 })

          // è¿›åº¦ç¯
          Stack() {
            Circle({ width: 40, height: 40 })
              .fill(this.getHealthStatusColor(this.project.progress) + '20')
              .stroke(this.getHealthStatusColor(this.project.progress))
              .strokeWidth(2)

            Text(`${this.project.progress}%`)
              .fontSize(10)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getHealthStatusColor(this.project.progress))
          }
        }
        .width(50)
        .alignItems(HorizontalAlign.Center)

        // ä¸­é—´ä¿¡æ¯åŒºåŸŸ
        Column() {
          // é¡¹ç›®ç¼–å·
          Text(this.project.code)
            .fontSize(12)
            .fontColor('#1890FF')
            .fontWeight(FontWeight.Medium)
            .fontStyle(FontStyle.Italic)
            .margin({ top: 4 })

          // é¡¹ç›®åç§°
          Text(this.project.getDisplayName())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .margin({ top: 4 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')

          // è´Ÿè´£äººå’Œå®¢æˆ·ä¿¡æ¯
          Row({ space: 12 }) {
            // è´Ÿè´£äºº
            Row({ space: 4 }) {
              Text('ğŸ‘¤')
                .fontSize(12)
                .fontColor('#595959')
              Text(this.project.manager || 'æœªæŒ‡å®š')
                .fontSize(12)
                .fontColor('#595959')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .layoutWeight(1)
            }
            .layoutWeight(1)

            // å®¢æˆ·
            Row({ space: 4 }) {
              Text('ğŸ¢')
                .fontSize(12)
                .fontColor('#595959')
              Text(this.project.client)
                .fontSize(12)
                .fontColor('#595959')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .layoutWeight(1)
            }
            .layoutWeight(1)
          }
          .width('100%')
          .margin({ top: 6 })

          // æ ‡ç­¾è¡Œ
          Row({ space: 8 }) {
            // ä¼˜å…ˆçº§æ ‡ç­¾
            if (this.project.priority) {
              Text(this.getPriorityText(this.project.priority))
                .fontSize(10)
                .fontColor('#FFFFFF')
                .backgroundColor(this.getPriorityColor(this.project.priority))
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(10)
                .maxLines(1)
            }

            // çŠ¶æ€æ ‡ç­¾
            Text(this.getStatusText(this.project.status))
              .fontSize(10)
              .fontColor('#FFFFFF')
              .backgroundColor(this.getStatusColor(this.project.status))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(10)
              .maxLines(1)

            // æ—¶é—´æ ‡ç­¾
            Text(this.getRelativeTime(this.project.updatedAt))
              .fontSize(10)
              .fontColor('#8C8C8C')
              .backgroundColor('#F5F5F5')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(10)
              .maxLines(1)
          }
          .width('100%')
          .margin({ top: 8 })

          // ç»Ÿè®¡ä¿¡æ¯
          if (this.showStats) {
            Column() {
              // ç»Ÿè®¡æ•°æ®è¡Œ
              Row({ space: 16 }) {
                // å·¥ç‚¹ç»Ÿè®¡
                Column({ space: 4 }) {
                  Text(`${this.project.siteCount || 0}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1890FF')
                  Text('å·¥ç‚¹')
                    .fontSize(10)
                    .fontColor('#8C8C8C')
                }
                .layoutWeight(1)
                .backgroundColor('#F0F8FF')
                .padding({ top: 8, bottom: 8 })
                .borderRadius(8)

                // ç…§ç‰‡ç»Ÿè®¡
                Column({ space: 4 }) {
                  Text(`${this.project.photoCount || 0}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#722ED1')
                  Text('ç…§ç‰‡')
                    .fontSize(10)
                    .fontColor('#8C8C8C')
                }
                .layoutWeight(1)
                .backgroundColor('#F9F0FF')
                .padding({ top: 8, bottom: 8 })
                .borderRadius(8)

                // è¿›åº¦æŒ‡ç¤º
                Column({ space: 4 }) {
                  Text(`${this.project.progress}%`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.getHealthStatusColor(this.project.progress))
                  Text('è¿›åº¦')
                    .fontSize(10)
                    .fontColor('#8C8C8C')
                }
                .layoutWeight(1)
                .backgroundColor(`${this.getHealthStatusColor(this.project.progress)}15`)
                .padding({ top: 8, bottom: 8 })
                .borderRadius(8)
              }
              .width('100%')
              .margin({ top: 8 })
            }
            .width('100%')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .padding({ right: 12 })

        // å³ä¾§æ“ä½œåŒºåŸŸ
        Column({ space: 8 }) {
          // æ›´å¤šæ“ä½œæŒ‰é’®
          Button() {
            Text('â‹®')
              .fontSize(16)
              .fontColor('#8C8C8C')
          }
          .width(32)
          .height(32)
          .backgroundColor('#F5F5F5')
          .borderRadius(16)
          .onClick(() => {
            if (this.onLongPress) {
              this.onLongPress(this.project)
            }
          })

          Blank()

          // çŠ¶æ€æŒ‡ç¤ºå™¨
          if (this.project.status === ProjectStatus.ACTIVE) {
            Column({ space: 2 }) {
              Circle({ width: 8, height: 8 })
                .fill(this.getStatusColor(this.project.status))
              Text('æ´»è·ƒ')
                .fontSize(8)
                .fontColor(this.getStatusColor(this.project.status))
            }
          }
        }
        .width(40)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow(this.elevation ? {
      radius: this.isPressed ? 2 : 8,
      color: this.isPressed ? '#00000015' : '#00000020',
      offsetX: 0,
      offsetY: this.isPressed ? 1 : 4
    } : undefined)
    .scale({ x: this.isPressed ? 0.98 : 1.0, y: this.isPressed ? 0.98 : 1.0 })
    .animation({
      duration: 150,
      curve: Curve.EaseInOut
    })
    .onClick(() => {
      if (this.onTap) {
        this.onTap(this.project)
      }
    })
    .gesture(
      // æŒ‰å‹æ‰‹åŠ¿
      TapGesture({ count: 1 })
        .onAction(() => {
          // ç‚¹å‡»æ—¶çš„æŒ‰å‹æ•ˆæœ
          this.isPressed = true
          setTimeout(() => {
            this.isPressed = false
          }, 150)
        })
    )
    .gesture(
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          if (this.onLongPress) {
            this.onLongPress(this.project)
          }
        })
        .onAction(() => {
          // é•¿æŒ‰æ—¶çš„è§†è§‰åé¦ˆ
          this.isPressed = false
        })
    )
  }

  /**
   * è·å–ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
   */
  private getRelativeTime(date: Date): string {
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffMinutes = Math.floor(diffMs / (1000 * 60))
    const diffHours = Math.floor(diffMinutes / 60)
    const diffDays = Math.floor(diffHours / 24)

    if (diffMinutes < 1) {
      return 'åˆšåˆš'
    } else if (diffMinutes < 60) {
      return `${diffMinutes}åˆ†é’Ÿå‰`
    } else if (diffHours < 24) {
      return `${diffHours}å°æ—¶å‰`
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`
    } else {
      return this.formatDate(date)
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(date: Date): string {
    return `${date.getMonth() + 1}-${date.getDate()}`
  }
}