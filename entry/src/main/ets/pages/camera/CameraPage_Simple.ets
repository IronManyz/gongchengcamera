/**
 * ç®€åŒ–ç›¸æœºé¡µé¢
 * æ ¹æ®åŸå‹è®¾è®¡å®ç°çš„å·¥ç¨‹æ‹ç…§ç•Œé¢
 */

import router from '@ohos.router'

@Entry
@ComponentV2
struct CameraPage_Simple {
  @Local private isCameraReady: boolean = false
  @Local private isLoading: boolean = true
  @Local private showPreview: boolean = false
  @Local private capturedImagePath: string = ''

  // å·¥ç‚¹ä¿¡æ¯
  @Local private projectId: string = ''
  @Local private siteId: string = ''
  @Local private siteName: string = ''

  // è®¾ç½®é€‰é¡¹
  @Local private watermarkEnabled: boolean = true
  @Local private flashEnabled: boolean = false

  aboutToAppear(): void {
    this.loadRouteParams()
    this.initCamera()
  }

  /**
   * åŠ è½½è·¯ç”±å‚æ•°
   */
  private loadRouteParams(): void {
    try {
      const params = router.getParams() as Record<string, Object>
      if (params) {
        this.projectId = (params.projectId as string) || ''
        this.siteId = (params.siteId as string) || ''
        this.siteName = (params.siteName as string) || ''
      }
    } catch (error) {
      console.error('Failed to load route params:', error)
    }
  }

  /**
   * åˆå§‹åŒ–ç›¸æœº
   */
  private async initCamera(): Promise<void> {
    // æ¨¡æ‹Ÿç›¸æœºåˆå§‹åŒ–
    setTimeout(() => {
      this.isCameraReady = true
      this.isLoading = false
      console.log('Camera initialized')
    }, 1000)
  }

  /**
   * æ‹ç…§
   */
  private takePhoto(): void {
    console.log('Taking photo...')
    // æ¨¡æ‹Ÿæ‹ç…§è¿‡ç¨‹
    setTimeout(() => {
      this.capturedImagePath = '/mock/path/photo_' + Date.now() + '.jpg'
      this.showPreview = true
      console.log('Photo captured:', this.capturedImagePath)
    }, 500)
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * é‡æ–°æ‹ç…§
   */
  private retakePhoto(): void {
    this.showPreview = false
    this.capturedImagePath = ''
  }

  /**
   * ç¡®è®¤ç…§ç‰‡
   */
  private confirmPhoto(): void {
    // TODO: ä¿å­˜ç…§ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“ï¼Œå…³è”å·¥ç‚¹
    console.log('Photo confirmed and saved')
    this.navigateBack()
  }

  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          Text('ğŸ“¸')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('ç›¸æœºåˆå§‹åŒ–ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#000000')

      } else if (this.showPreview) {
        // é¢„è§ˆçŠ¶æ€
        this.buildPreviewView()

      } else if (this.isCameraReady) {
        // ç›¸æœºé¢„è§ˆçŠ¶æ€
        this.buildCameraView()

      } else {
        // é»˜è®¤çŠ¶æ€
        Column() {
          Text('ğŸ“¸')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('ç›¸æœºå‡†å¤‡ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#000000')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }

  /**
   * æ„å»ºç›¸æœºè§†å›¾
   */
  @Builder
  private buildCameraView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('â†')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.navigateBack()
          })

        Blank()

        // å·¥ç‚¹ä¿¡æ¯
        if (this.siteName) {
          Text(this.siteName)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
        }

        Blank()

        // é—ªå…‰ç¯æŒ‰é’®
        Button(this.flashEnabled ? 'âš¡' : 'ğŸ”¦')
          .fontSize(20)
          .fontColor(this.flashEnabled ? '#FFD700' : '#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.flashEnabled = !this.flashEnabled
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // ç›¸æœºé¢„è§ˆåŒºåŸŸï¼ˆæ¨¡æ‹Ÿï¼‰
      Column() {
        Text('ğŸ“·')
          .fontSize(64)
          .fontColor('#666666')
          .margin({ bottom: 16 })

        Text('ç›¸æœºé¢„è§ˆåŒºåŸŸ')
          .fontSize(16)
          .fontColor('#999999')

        if (this.watermarkEnabled) {
          Text('ğŸ’§ æ°´å°å·²å¯ç”¨')
            .fontSize(14)
            .fontColor('#1890FF')
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#111111')

      // åº•éƒ¨æ§åˆ¶æ 
      Column() {
        // åŠŸèƒ½æŒ‰é’®
        Row({ space: 20 }) {
          Button('ğŸ”')
            .fontSize(24)
            .fontColor('#FFFFFF')
            .backgroundColor('#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              // TODO: åˆ‡æ¢å‰åæ‘„åƒå¤´
              console.log('Switch camera')
            })

          // æ‹ç…§æŒ‰é’®
          Button()
            .width(80)
            .height(80)
            .borderRadius(40)
            .backgroundColor('#FFFFFF')
            .border({ width: 4, color: '#E0E0E0' })
            .onClick(() => {
              this.takePhoto()
            })

          Button('ğŸ’§')
            .fontSize(24)
            .fontColor(this.watermarkEnabled ? '#1890FF' : '#FFFFFF')
            .backgroundColor(this.watermarkEnabled ? '#FFFFFF20' : '#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.watermarkEnabled = !this.watermarkEnabled
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 20 })

        // æç¤ºä¿¡æ¯
        Text('è½»è§¦æ‹ç…§ï¼Œé•¿æŒ‰è¿æ‹')
          .fontSize(14)
          .fontColor('#CCCCCC')
          .margin({ bottom: 20 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 20 })
      .backgroundColor('#00000080')
    }
  }

  /**
   * æ„å»ºé¢„è§ˆè§†å›¾
   */
  @Builder
  private buildPreviewView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('âœ•')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.retakePhoto()
          })

        Blank()

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Medium)

        Blank()

        Button('âœ“')
          .fontSize(20)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // å›¾ç‰‡é¢„è§ˆï¼ˆæ¨¡æ‹Ÿï¼‰
      Column() {
        Text('ğŸ–¼ï¸')
          .fontSize(64)
          .fontColor('#666666')
          .margin({ bottom: 16 })

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(16)
          .fontColor('#999999')
          .margin({ bottom: 8 })

        Text(this.capturedImagePath)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (this.watermarkEnabled) {
          Text('ğŸ’§ åŒ…å«æ°´å°ä¿¡æ¯')
            .fontSize(14)
            .fontColor('#1890FF')
            .margin({ top: 8 })
        }

        if (this.siteName) {
          Text(`ğŸ“ å·¥ç‚¹: ${this.siteName}`)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#000000')

      // åº•éƒ¨æ“ä½œæ 
      Row({ space: 20 }) {
        Button('é‡æ–°æ‹ç…§')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#666666')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.retakePhoto()
          })

        Button('ä½¿ç”¨ç…§ç‰‡')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20, top: 16, bottom: 40 })
      .backgroundColor('#00000080')
    }
  }
}