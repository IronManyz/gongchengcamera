/**
 * ç…§ç‰‡é¢„è§ˆé¡µé¢
 * æä¾›ç…§ç‰‡å…¨å±é¢„è§ˆã€ç¼–è¾‘å’Œç®¡ç†åŠŸèƒ½
 */

import router from '@ohos.router'
import { SimplePhoto, PhotoFilter, PresetPhotoFilters, PhotoFilterType } from '../../models/SimplePhoto'

@Entry
@ComponentV2
struct PhotoPreviewPage {
  @Local private photo: SimplePhoto = new SimplePhoto()
  @Local private isEditMode: boolean = false
  @Local private currentFilter: PhotoFilter = PresetPhotoFilters.getOriginal()
  @Local private brightnessValue: number = 0
  @Local private contrastValue: number = 0
  @Local private saturationValue: number = 0
  @Local private rotationValue: number = 0
  @Local private scaleValue: number = 1.0
  @Local private offsetXValue: number = 0
  @Local private offsetYValue: number = 0
  @Local private showInfo: boolean = false
  @Local private isLoading: boolean = false

  aboutToAppear(): void {
    this.loadRouteParams()
    this.initPhotoData()
  }

  /**
   * åŠ è½½è·¯ç”±å‚æ•°
   */
  private loadRouteParams(): void {
    try {
      const params = router.getParams() as Record<string, Object>
      if (params && params.photo) {
        this.photo = params.photo as SimplePhoto
      } else if (params && params.photoId) {
        // TODO: æ ¹æ®photoIdä»æ•°æ®åº“åŠ è½½ç…§ç‰‡
        this.loadMockPhotoData(params.photoId as string)
      }
    } catch (error) {
      console.error('Failed to load route params:', error)
    }
  }

  /**
   * åˆå§‹åŒ–ç…§ç‰‡æ•°æ®
   */
  private initPhotoData(): void {
    // é‡ç½®ç¼–è¾‘å‚æ•°
    this.brightnessValue = 0
    this.contrastValue = 0
    this.saturationValue = 0
    this.rotationValue = 0
    this.scaleValue = 1.0
    this.offsetXValue = 0
    this.offsetYValue = 0
    this.currentFilter = PresetPhotoFilters.getOriginal()
  }

  /**
   * åŠ è½½æ¨¡æ‹Ÿç…§ç‰‡æ•°æ®
   */
  private loadMockPhotoData(photoId: string): void {
    this.photo = new SimplePhoto(photoId, '/mock/path/' + photoId + '.jpg')
    this.photo.name = 'å·¥ç¨‹ç…§ç‰‡_' + photoId
    this.photo.width = 1920
    this.photo.height = 1080
    this.photo.fileSize = 2048000
    this.photo.takenAt = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
    this.photo.addTag('å·¥ç¨‹')
    this.photo.addTag('å»ºç­‘')
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
   */
  private toggleEditMode(): void {
    this.isEditMode = !this.isEditMode
    if (!this.isEditMode) {
      this.initPhotoData()
    }
  }

  /**
   * åˆ‡æ¢ä¿¡æ¯æ˜¾ç¤º
   */
  private toggleInfoDisplay(): void {
    this.showInfo = !this.showInfo
  }

  /**
   * åº”ç”¨æ»¤é•œ
   */
  private applyFilter(filter: PhotoFilter): void {
    this.currentFilter = filter
    // é‡ç½®å…¶ä»–è°ƒæ•´å‚æ•°
    this.brightnessValue = 0
    this.contrastValue = 0
    this.saturationValue = 0

    // åº”ç”¨é¢„è®¾æ»¤é•œçš„å¼ºåº¦
    switch (filter.type) {
      case PhotoFilterType.BRIGHTNESS:
        this.brightnessValue = filter.intensity / 2
        break
      case PhotoFilterType.CONTRAST:
        this.contrastValue = filter.intensity / 2
        break
      case PhotoFilterType.SATURATION:
        this.saturationValue = filter.intensity / 2
        break
      // å…¶ä»–æ»¤é•œç±»å‹çš„å®ç°
    }
  }

  /**
   * æ—‹è½¬ç…§ç‰‡
   */
  private rotatePhoto(): void {
    this.rotationValue = (this.rotationValue + 90) % 360
  }

  /**
   * é‡ç½®ç¼–è¾‘
   */
  private resetEdits(): void {
    this.initPhotoData()
  }

  /**
   * ä¿å­˜ç¼–è¾‘
   */
  private async saveEdits(): Promise<void> {
    this.isLoading = true
    try {
      // TODO: å®é™…ä¿å­˜ç¼–è¾‘åçš„ç…§ç‰‡
      this.photo.markAsEdited()
      console.log('Photo edits saved')

      // é€€å‡ºç¼–è¾‘æ¨¡å¼
      this.isEditMode = false
    } catch (error) {
      console.error('Failed to save edits:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * åˆ†äº«ç…§ç‰‡
   */
  private sharePhoto(): void {
    console.log('Sharing photo:', this.photo.getDisplayName())
    // TODO: å®ç°ç…§ç‰‡åˆ†äº«åŠŸèƒ½
  }

  /**
   * åˆ é™¤ç…§ç‰‡
   */
  private deletePhoto(): void {
    // TODO: å®ç°ç…§ç‰‡åˆ é™¤ç¡®è®¤å’Œåˆ é™¤é€»è¾‘
    console.log('Deleting photo:', this.photo.getDisplayName())
  }

  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          Text('â³')
            .fontSize(48)
            .fontColor('#FFFFFF')
            .margin({ bottom: 16 })

          Text('ä¿å­˜ä¸­...')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#000000')
      } else {
        // ä¸»å†…å®¹
        Column() {
          // é¡¶éƒ¨å·¥å…·æ 
          this.buildTopToolbar()

          // ç…§ç‰‡æ˜¾ç¤ºåŒºåŸŸ
          Stack() {
            // ç…§ç‰‡å†…å®¹
            this.buildPhotoDisplay()

            // ä¿¡æ¯è¦†ç›–å±‚
            if (this.showInfo) {
              this.buildInfoOverlay()
            }

            // ç¼–è¾‘å·¥å…·
            if (this.isEditMode) {
              this.buildEditTools()
            }
          }
          .layoutWeight(1)

          // åº•éƒ¨å·¥å…·æ 
          this.buildBottomToolbar()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#000000')
      }
    }
  }

  /**
   * æ„å»ºé¡¶éƒ¨å·¥å…·æ 
   */
  @Builder
  private buildTopToolbar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button('â†')
        .fontSize(20)
        .fontColor('#FFFFFF')
        .backgroundColor('transparent')
        .onClick(() => {
          this.navigateBack()
        })

      Blank()

      // ç…§ç‰‡æ ‡é¢˜
      Text(this.photo.getDisplayName())
        .fontSize(16)
        .fontColor('#FFFFFF')
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })

      Blank()

      // åŠŸèƒ½æŒ‰é’®
      Row({ space: 16 }) {
        Button(this.showInfo ? 'â„¹ï¸' : 'â„¹ï¸')
          .fontSize(20)
          .fontColor(this.showInfo ? '#1890FF' : '#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.toggleInfoDisplay()
          })

        Button(this.isEditMode ? 'âœ“' : 'âœï¸')
          .fontSize(20)
          .fontColor(this.isEditMode ? '#52C41A' : '#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            if (this.isEditMode) {
              this.saveEdits()
            } else {
              this.toggleEditMode()
            }
          })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  /**
   * æ„å»ºç…§ç‰‡æ˜¾ç¤º
   */
  @Builder
  private buildPhotoDisplay() {
    // æ¨¡æ‹Ÿç…§ç‰‡æ˜¾ç¤º
    Column() {
      Text('ğŸ–¼ï¸')
        .fontSize(120)
        .fontColor('#666666')
        .margin({ bottom: 16 })

      Text(this.photo.getDisplayName())
        .fontSize(18)
        .fontColor('#FFFFFF')
        .margin({ bottom: 8 })

      Text(this.photo.getDimensionsText())
        .fontSize(14)
        .fontColor('#CCCCCC')
        .margin({ bottom: 4 })

      Text(this.photo.getFileSizeText())
        .fontSize(14)
        .fontColor('#CCCCCC')

      if (this.photo.isEdited) {
        Text('å·²ç¼–è¾‘')
          .fontSize(12)
          .fontColor('#1890FF')
          .backgroundColor('#1890FF20')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
          .margin({ top: 8 })
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .rotate({ angle: this.rotationValue })
    .scale({ x: this.scaleValue, y: this.scaleValue })
  }

  /**
   * æ„å»ºä¿¡æ¯è¦†ç›–å±‚
   */
  @Builder
  private buildInfoOverlay() {
    Column() {
      // åŠé€æ˜èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')

      // ä¿¡æ¯å†…å®¹
      Column({ space: 12 }) {
        Text('ğŸ“· ç…§ç‰‡ä¿¡æ¯')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)

        // åŸºæœ¬ä¿¡æ¯
        Row() {
          Text('æ–‡ä»¶å:')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .width(80)
          Text(this.photo.getDisplayName())
            .fontSize(14)
            .fontColor('#FFFFFF')
            .layoutWeight(1)
        }
        .width('100%')

        Row() {
          Text('å°ºå¯¸:')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .width(80)
          Text(this.photo.getDimensionsText())
            .fontSize(14)
            .fontColor('#FFFFFF')
            .layoutWeight(1)
        }
        .width('100%')

        Row() {
          Text('å¤§å°:')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .width(80)
          Text(this.photo.getFileSizeText())
            .fontSize(14)
            .fontColor('#FFFFFF')
            .layoutWeight(1)
        }
        .width('100%')

        Row() {
          Text('æ‹æ‘„æ—¶é—´:')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .width(80)
          Text(this.photo.getTakenTimeText())
            .fontSize(14)
            .fontColor('#FFFFFF')
            .layoutWeight(1)
        }
        .width('100%')

        // ä½ç½®ä¿¡æ¯
        if (this.photo.hasLocation()) {
          Row() {
            Text('ä½ç½®:')
              .fontSize(14)
              .fontColor('#CCCCCC')
              .width(80)
            Text(this.photo.getCoordinatesString())
              .fontSize(14)
              .fontColor('#FFFFFF')
              .layoutWeight(1)
          }
          .width('100%')

          if (this.photo.address) {
            Row() {
              Text('åœ°å€:')
                .fontSize(14)
                .fontColor('#CCCCCC')
                .width(80)
              Text(this.photo.address)
                .fontSize(14)
                .fontColor('#FFFFFF')
                .layoutWeight(1)
            }
            .width('100%')
          }
        }

        // æ ‡ç­¾
        if (this.photo.hasTags()) {
          Row() {
            Text('æ ‡ç­¾:')
              .fontSize(14)
              .fontColor('#CCCCCC')
              .width(80)
            Row({ space: 8 }) {
              ForEach(this.photo.tags, (tag: string) => {
                Text(tag)
                  .fontSize(12)
                  .fontColor('#1890FF')
                  .backgroundColor('#1890FF20')
                  .padding({ left: 6, right: 6, top: 3, bottom: 3 })
                  .borderRadius(8)
              })
            }
            .layoutWeight(1)
          }
          .width('100%')
        }

        // ç¼–è¾‘çŠ¶æ€
        if (this.photo.isEdited) {
          Row() {
            Text('çŠ¶æ€:')
              .fontSize(14)
              .fontColor('#CCCCCC')
              .width(80)
            Text(this.photo.getEditedStatusText())
              .fontSize(14)
              .fontColor('#FFA500')
              .layoutWeight(1)
          }
          .width('100%')
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#00000090')
      .borderRadius(12)
      .margin(20)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ„å»ºç¼–è¾‘å·¥å…·
   */
  @Builder
  private buildEditTools() {
    Column() {
      Blank()

      // ç¼–è¾‘å·¥å…·æ 
      Column({ space: 16 }) {
        // æ»¤é•œé€‰æ‹©
        Column() {
          Text('æ»¤é•œ')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .margin({ bottom: 12 })

          Scroll() {
            Row({ space: 12 }) {
              ForEach(PresetPhotoFilters.getAllPresets(), (filter: PhotoFilter) => {
                Column({ space: 4 }) {
                  Text(this.getFilterIcon(filter.type))
                    .fontSize(24)
                    .fontColor(this.currentFilter.id === filter.id ? '#1890FF' : '#FFFFFF')
                    .backgroundColor(this.currentFilter.id === filter.id ? '#FFFFFF20' : '#333333')
                    .width(50)
                    .height(50)
                    .borderRadius(25)
                    .textAlign(TextAlign.Center)
                    .onClick(() => {
                      this.applyFilter(filter)
                    })

                  Text(filter.getDisplayName())
                    .fontSize(12)
                    .fontColor(this.currentFilter.id === filter.id ? '#1890FF' : '#CCCCCC')
                    .maxLines(1)
                }
              })
            }
            .padding({ left: 20, right: 20 })
          }
          .scrollable(ScrollDirection.Horizontal)
        }

        // è°ƒæ•´å·¥å…·
        Column({ space: 12 }) {
          // äº®åº¦è°ƒæ•´
          Row() {
            Text('â˜€ï¸')
              .fontSize(20)
              .width(30)
            Text('äº®åº¦')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .width(60)
            Slider({
              value: this.brightnessValue,
              min: -100,
              max: 100,
              step: 1,
              style: SliderStyle.OutSet
            })
              .layoutWeight(1)
              .onChange((value: number) => {
                this.brightnessValue = value
              })
            Text(`${this.brightnessValue}`)
              .fontSize(12)
              .fontColor('#CCCCCC')
              .width(40)
          }
          .width('100%')

          // å¯¹æ¯”åº¦è°ƒæ•´
          Row() {
            Text('â—')
              .fontSize(20)
              .width(30)
            Text('å¯¹æ¯”åº¦')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .width(60)
            Slider({
              value: this.contrastValue,
              min: -100,
              max: 100,
              step: 1,
              style: SliderStyle.OutSet
            })
              .layoutWeight(1)
              .onChange((value: number) => {
                this.contrastValue = value
              })
            Text(`${this.contrastValue}`)
              .fontSize(12)
              .fontColor('#CCCCCC')
              .width(40)
          }
          .width('100%')

          // é¥±å’Œåº¦è°ƒæ•´
          Row() {
            Text('ğŸ¨')
              .fontSize(20)
              .width(30)
            Text('é¥±å’Œåº¦')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .width(60)
            Slider({
              value: this.saturationValue,
              min: -100,
              max: 100,
              step: 1,
              style: SliderStyle.OutSet
            })
              .layoutWeight(1)
              .onChange((value: number) => {
                this.saturationValue = value
              })
            Text(`${this.saturationValue}`)
              .fontSize(12)
              .fontColor('#CCCCCC')
              .width(40)
          }
          .width('100%')
        }

        // æ“ä½œæŒ‰é’®
        Row({ space: 12 }) {
          Button('æ—‹è½¬')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#666666')
            .onClick(() => {
              this.rotatePhoto()
            })

          Button('é‡ç½®')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF4444')
            .onClick(() => {
              this.resetEdits()
            })
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#00000090')
      .borderRadius({ topLeft: 20, topRight: 20 })
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ„å»ºåº•éƒ¨å·¥å…·æ 
   */
  @Builder
  private buildBottomToolbar() {
    Column() {
      if (this.isEditMode) {
        // ç¼–è¾‘æ¨¡å¼å·¥å…·æ 
        Row({ space: 20 }) {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#666666')
            .padding({ left: 24, right: 24, top: 12, bottom: 12 })
            .borderRadius(8)
            .onClick(() => {
              this.toggleEditMode()
            })

          Button('ä¿å­˜')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#1890FF')
            .padding({ left: 24, right: 24, top: 12, bottom: 12 })
            .borderRadius(8)
            .onClick(() => {
              this.saveEdits()
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ left: 20, right: 20, bottom: 20 })
      } else {
        // æŸ¥çœ‹æ¨¡å¼å·¥å…·æ 
        Row({ space: 20 }) {
          Button('ğŸ”„')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.rotatePhoto()
            })

          Button('âœï¸')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('#1890FF')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.toggleEditMode()
            })

          Button('ğŸ“¤')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('#52C41A')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.sharePhoto()
            })

          Button('ğŸ—‘ï¸')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF4444')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.deletePhoto()
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ left: 20, right: 20, bottom: 20 })
      }
    }
    .width('100%')
    .backgroundColor('#00000080')
  }

  /**
   * è·å–æ»¤é•œå›¾æ ‡
   */
  private getFilterIcon(filterType: PhotoFilterType): string {
    switch (filterType) {
      case PhotoFilterType.NONE:
        return 'ğŸ¨'
      case PhotoFilterType.BRIGHTNESS:
        return 'â˜€ï¸'
      case PhotoFilterType.CONTRAST:
        return 'â—'
      case PhotoFilterType.SATURATION:
        return 'ğŸŒˆ'
      case PhotoFilterType.SEPIA:
        return 'ğŸ“œ'
      case PhotoFilterType.GRAYSCALE:
        return 'âš«'
      case PhotoFilterType.BLUR:
        return 'ğŸ’¨'
      case PhotoFilterType.VINTAGE:
        return 'ğŸ“·'
      case PhotoFilterType.COLD:
        return 'â„ï¸'
      case PhotoFilterType.WARM:
        return 'ğŸ”¥'
      default:
        return 'ğŸ¨'
    }
  }
}