/**
 * å·¥ç‚¹å¡ç‰‡ç»„ä»¶
 * æ ¹æ®åŸå‹è®¾è®¡å®ç°çš„å·¥ç‚¹ä¿¡æ¯å±•ç¤ºå¡ç‰‡ï¼Œæ”¯æŒå¤šç§å¸ƒå±€æ¨¡å¼å’Œäº¤äº’æ•ˆæœ
 */

import { SimpleSite } from '../../models/SimpleSite'
import { ThemeManager } from '../../theme/ThemeManager'

@ComponentV2
export struct SiteCard {
  @Require @Param site: SimpleSite = new SimpleSite()
  @Param showThumbnails: boolean = true
  @Param showLocation: boolean = true
  @Param showTags: boolean = true // æ–°å¢æ ‡ç­¾æ˜¾ç¤º
  @Param compact: boolean = false // æ–°å¢ç´§å‡‘å¸ƒå±€æ¨¡å¼
  @Param elevation: boolean = false // æ–°å¢é«˜ç¨‹æ•ˆæœ
  @Param showWeather: boolean = false // æ–°å¢å¤©æ°”æ˜¾ç¤º
  @Param actionButtons: boolean = true // æ–°å¢æ“ä½œæŒ‰é’®æ˜¾ç¤ºæ§åˆ¶

  // å›è°ƒå‡½æ•°
  @Param onTap: (site: SimpleSite) => void = () => {}
  @Param onLongPress: (site: SimpleSite) => void = () => {}
  @Param onCamera: (site: SimpleSite) => void = () => {}
  @Param onView: (site: SimpleSite) => void = () => {}
  @Param onNavigate: (site: SimpleSite) => void = () => {} // æ–°å¢å¯¼èˆªå›è°ƒ

  /**
   * å¤„ç†å¡ç‰‡ç‚¹å‡»
   */
  private handleCardClick(): void {
    if (this.onTap) {
      this.onTap(this.site)
    } else {
      this.onView(this.site)
    }
  }

  /**
   * è·å–å·¥ç‚¹ä¼˜å…ˆçº§é¢œè‰²
   */
  private getSitePriorityColor(): string {
    // æ ¹æ®ç…§ç‰‡æ•°é‡ç¡®å®šä¼˜å…ˆçº§é¢œè‰²
    if (this.site.photoCount === 0) return '#8C8C8C' // ç°è‰² - æš‚æ— ç…§ç‰‡
    if (this.site.photoCount < 5) return '#FAAD14' // æ©™è‰² - éœ€è¦å…³æ³¨
    if (this.site.photoCount < 10) return '#1890FF' // è“è‰² - ç…§ç‰‡é€‚ä¸­
    return '#52C41A' // ç»¿è‰² - ç…§ç‰‡å……è¶³
  }

  /**
   * è·å–å·¥ç‚¹å¥åº·çŠ¶æ€æ–‡æœ¬
   */
  private getHealthStatusText(): string {
    if (this.site.photoCount === 0) return 'éœ€è¦æ‹æ‘„'
    if (this.site.photoCount < 5) return 'ç…§ç‰‡è¾ƒå°‘'
    if (this.site.photoCount < 10) return 'ç…§ç‰‡é€‚ä¸­'
    if (this.site.photoCount < 20) return 'ç…§ç‰‡å……è¶³'
    return 'ç…§ç‰‡ä¸°å¯Œ'
  }

  /**
   * å¤„ç†å¡ç‰‡é•¿æŒ‰
   */
  private handleLongPress(): void {
    if (this.onLongPress) {
      this.onLongPress(this.site)
    }
  }

  /**
   * è·å–æµ·æ‹”æ˜¾ç¤ºæ–‡æœ¬
   */
  private getAltitudeText(): string {
    if (this.site.altitude === 0) return ''
    return `â›°ï¸ ${this.site.altitude}m`
  }

  /**
   * è·å–ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
   */
  private getRelativeTime(): string {
    const now = new Date()
    const diffMs = now.getTime() - this.site.updatedAt.getTime()
    const diffMinutes = Math.floor(diffMs / (1000 * 60))
    const diffHours = Math.floor(diffMinutes / 60)
    const diffDays = Math.floor(diffHours / 24)

    if (diffMinutes < 1) return 'åˆšåˆšæ›´æ–°'
    else if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰æ›´æ–°`
    else if (diffHours < 24) return `${diffHours}å°æ—¶å‰æ›´æ–°`
    else if (diffDays < 7) return `${diffDays}å¤©å‰æ›´æ–°`
    else {
      return `${this.site.updatedAt.getMonth() + 1}-${this.site.updatedAt.getDate()}æ›´æ–°`
    }
  }

  /**
   * è·å–çŠ¶æ€æŒ‡ç¤ºå™¨
   */
  @Builder
  private StatusIndicator() {
    Row({ space: 4 }) {
      Circle({ width: 6, height: 6 })
        .fill(this.site.getStatusColor())

      Text(this.site.getStatusText())
        .fontSize(12)
        .fontColor(this.site.getStatusColor())
        .fontWeight(FontWeight.Medium)
    }
    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
    .backgroundColor(this.site.getStatusColor() + '15')
    .borderRadius(10)
  }

  /**
   * æ ‡ç­¾åŒºåŸŸ
   */
  @Builder
  private TagsArea() {
    if (this.showTags && this.site.tags.length > 0) {
      Row({ space: 6 }) {
        ForEach(this.site.tags.slice(0, 3), (tag: string) => {
          Text(tag)
            .fontSize(10)
            .fontColor('#1890FF')
            .backgroundColor('#E6F7FF')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(10)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        })

        // å¦‚æœæ ‡ç­¾æ•°é‡è¶…è¿‡3ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæŒ‡ç¤º
        if (this.site.tags.length > 3) {
          Text(`+${this.site.tags.length - 3}`)
            .fontSize(10)
            .fontColor('#8C8C8C')
            .backgroundColor('#F0F0F0')
            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .margin({ top: 8 })
    }
  }

  /**
   * ç¼©ç•¥å›¾é¢„è§ˆåŒºåŸŸ
   */
  @Builder
  private ThumbnailPreview() {
    if (this.showThumbnails && this.site.hasPhotos()) {
      Column({ space: 8 }) {
        Row({ space: 8 }) {
          ForEach([1, 2, 3, 4], (index: number) => {
            if (index <= Math.min(this.site.photoCount, 4)) {
              Column() {
                Text('ğŸ–¼ï¸')
                  .fontSize(20)
                  .fontColor('#8C8C8C')

                Text('ç…§ç‰‡')
                  .fontSize(8)
                  .fontColor('#999999')
              }
              .width(this.compact ? 40 : 50)
              .height(this.compact ? 40 : 50)
              .backgroundColor('#F8F9FA')
              .justifyContent(FlexAlign.Center)
              .borderRadius(6)
              .border({ width: 1, color: '#F0F0F0' })
            } else if (index === 4 && this.site.photoCount > 4) {
              Column() {
                Text(`+${this.site.photoCount - 3}`)
                  .fontSize(12)
                  .fontColor('#1890FF')
                  .fontWeight(FontWeight.Medium)

                Text('æ›´å¤š')
                  .fontSize(8)
                  .fontColor('#1890FF')
              }
              .width(this.compact ? 40 : 50)
              .height(this.compact ? 40 : 50)
              .backgroundColor('#E6F7FF')
              .justifyContent(FlexAlign.Center)
              .borderRadius(6)
              .border({ width: 1, color: '#1890FF' })
            }
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)

        // ç…§ç‰‡ç»Ÿè®¡
        Text(`å…± ${this.site.photoCount} å¼ ç…§ç‰‡`)
          .fontSize(10)
          .fontColor('#666666')
          .alignSelf(ItemAlign.Start)
      }
      .margin({ top: 8 })
      .padding(12)
      .backgroundColor('#FAFBFC')
      .borderRadius(8)
    }
  }

  /**
   * ä½ç½®ä¿¡æ¯åŒºåŸŸ
   */
  @Builder
  private LocationInfo() {
    if (this.showLocation) {
      Column({ space: 6 }) {
        // åœ°å€ä¿¡æ¯
        Row() {
          Text('ğŸ“')
            .fontSize(12)
            .fontColor('#1890FF')

          Text(this.site.getFullAddress())
            .fontSize(12)
            .fontColor('#666666')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')

        // åæ ‡å’Œæµ·æ‹”ä¿¡æ¯
        if (this.site.hasLocation()) {
          Row({ space: 16 }) {
            Text(`ğŸ—ºï¸ ${this.site.getCoordinatesString()}`)
              .fontSize(10)
              .fontColor('#8C8C8C')

            if (this.site.altitude > 0) {
              Text(this.getAltitudeText())
                .fontSize(10)
                .fontColor('#8C8C8C')
            }

            // å¯¼èˆªæŒ‰é’®
            if (this.onNavigate) {
              Button('ğŸ§­')
                .fontSize(10)
                .fontColor('#1890FF')
                .backgroundColor('#E6F7FF')
                .borderRadius(10)
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .onClick(() => this.onNavigate(this.site))
            }
          }
          .width('100%')
        }
      }
      .margin({ top: 8 })
      .padding(8)
      .backgroundColor('#F8F9FA')
      .borderRadius(6)
    }
  }

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // å·¥ç‚¹å¤´éƒ¨ä¿¡æ¯
        Row() {
          // å·¥ç‚¹å›¾æ ‡å’Œåç§°
          Row() {
            Column() {
              Text('ğŸ—ï¸')
                .fontSize(this.compact ? 16 : 20)
                .fontColor(this.getSitePriorityColor())
            }
            .width(this.compact ? 24 : 30)
            .height(this.compact ? 24 : 30)
            .backgroundColor(this.getSitePriorityColor() + '15')
            .borderRadius(6)
            .justifyContent(FlexAlign.Center)

            Column({ space: 2 }) {
              Text(this.site.getDisplayName())
                .fontSize(this.compact ? 14 : 16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#262626')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              // å¥åº·çŠ¶æ€
              Text(this.getHealthStatusText())
                .fontSize(10)
                .fontColor(this.getSitePriorityColor())
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 12 })
            .layoutWeight(1)
          }
          .alignItems(VerticalAlign.Center)
          .layoutWeight(1)

          // çŠ¶æ€æŒ‡ç¤ºå™¨
          this.StatusIndicator()
        }
        .width('100%')
        .margin({ bottom: this.compact ? 8 : 12 })

        // å·¥ç‚¹æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.site.description && !this.compact) {
          Text(this.site.description)
            .fontSize(13)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })
            .width('100%')
        }

        // ä½ç½®ä¿¡æ¯
        this.LocationInfo()

        // æ ‡ç­¾åŒºåŸŸ
        this.TagsArea()

        // ç¼©ç•¥å›¾é¢„è§ˆ
        if (!this.compact) {
          this.ThumbnailPreview()
        }

        // ç»Ÿè®¡ä¿¡æ¯è¡Œ
        if (!this.compact) {
          Row() {
            // ç…§ç‰‡ç»Ÿè®¡
            Row({ space: 4 }) {
              Text('ğŸ“·')
                .fontSize(12)
                .fontColor('#722ED1')
              Text(`${this.site.photoCount}`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#262626')
              Text('å¼ ç…§ç‰‡')
                .fontSize(12)
                .fontColor('#8C8C8C')
            }

            Blank()

            // æ›´æ–°æ—¶é—´
            Text(this.getRelativeTime())
              .fontSize(10)
              .fontColor('#BFBFBF')
          }
          .width('100%')
          .margin({ top: 8 })
        }
      }
      .width('100%')
      .padding(this.compact ? 12 : 16)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®åŒºåŸŸ
      if (this.actionButtons && !this.compact) {
        Divider()
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })
          .color('#F0F0F0')

        Row() {
          // ä¸»è¦æ“ä½œæŒ‰é’® - æ‹ç…§
          Button() {
            Row({ space: 6 }) {
              Text('ğŸ“¸')
                .fontSize(14)
              Text('æ‹ç…§')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
            }
          }
          .height(36)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#1890FF')
          .fontColor('#FFFFFF')
          .borderRadius(18)
          .onClick(() => this.onCamera(this.site))

          Blank()

          // æ¬¡è¦æ“ä½œæŒ‰é’® - æŸ¥çœ‹
          Button() {
            Row({ space: 6 }) {
              Text('ğŸ‘ï¸')
                .fontSize(14)
              Text('æŸ¥çœ‹')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
            }
          }
          .height(36)
          .padding({ left: 16, right: 16 })
          .backgroundColor(Color.Transparent)
          .fontColor('#1890FF')
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(18)
          .onClick(() => this.onView(this.site))

          // å¯¼èˆªæŒ‰é’®ï¼ˆå¦‚æœæœ‰å¯¼èˆªå›è°ƒï¼‰
          if (this.onNavigate) {
            Button() {
              Text('ğŸ§­')
                .fontSize(14)
            }
            .width(36)
            .height(36)
            .backgroundColor('#52C41A')
            .fontColor('#FFFFFF')
            .borderRadius(18)
            .onClick(() => this.onNavigate(this.site))
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%')
    .backgroundColor(ThemeManager.getCurrentSurfaceColor())
    .borderRadius(8)
    .shadow(
      this.elevation ? {
        radius: 8,
        color: ThemeManager.getCurrentShadowColor(),
        offsetX: 0,
        offsetY: 4
      } : {
        radius: 4,
        color: '#00000015',
        offsetX: 0,
        offsetY: 2
      }
    )
    .onClick(() => {
      this.handleCardClick()
    })
    .gesture(
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          this.handleLongPress()
        })
    )
    .animation({
      duration: 200,
      curve: Curve.EaseInOut
    })
  }
}