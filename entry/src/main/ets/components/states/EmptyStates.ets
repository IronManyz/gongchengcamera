/**
 * ç©ºçŠ¶æ€è®¾è®¡ç»„ä»¶åº“
 * æä¾›ä¸“ä¸šçš„ç©ºçŠ¶æ€æ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ
 */

import { ThemeManager } from '../../theme/ThemeManager'

export type EmptyStateType =
  | 'no-data'        // æ— æ•°æ®
  | 'no-results'     // æ— æœç´¢ç»“æœ
  | 'no-network'      // æ— ç½‘ç»œè¿æ¥
  | 'error'           // é”™è¯¯çŠ¶æ€
  | 'loading'         // åŠ è½½ä¸­
  | 'empty-list'      // ç©ºåˆ—è¡¨
  | 'empty-favorites'  // æ— æ”¶è—
  | 'no-permission'   // æ— æƒé™
  | 'not-found'       // é¡µé¢æœªæ‰¾åˆ°
  | 'maintenance'     // ç»´æŠ¤ä¸­
  | 'first-use'       // é¦–æ¬¡ä½¿ç”¨
  | 'custom'          // è‡ªå®šä¹‰çŠ¶æ€

export type EmptyStateSize =
  | 'small' | 'medium' | 'large' | 'full'

export type ActionButtonType =
  | 'primary' | 'secondary' | 'outline' | 'text' | 'icon'

/**
 * åŸºç¡€ç©ºçŠ¶æ€ç»„ä»¶
 * æä¾›ç»Ÿä¸€çš„ç©ºçŠ¶æ€æ˜¾ç¤ºæ¡†æ¶
 */
@ComponentV2
export struct BaseEmptyState {
  @Param type: EmptyStateType = 'no-data'
  @Param title: string = ''
  @Param description: string = ''
  @Param icon: string = ''
  @Param image: string = ''
  @Param size: EmptyStateSize = 'medium'
  @Param showButton: boolean = false
  @Param buttonText: string = 'é‡è¯•'
  @Param buttonType: ActionButtonType = 'primary'
  @Param onButtonPress?: () => void = () => {}
  @Param customContent?: () => void = () => {}

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // å›¾æ ‡åŒºåŸŸ
        if (this.getIconConfig().type === 'emoji') {
          Text(this.getIconConfig().content)
            .fontSize(this.getIconSize())
            .margin({ bottom: 24 })
        } else if (this.getIconConfig().type === 'image') {
          Image(this.getIconConfig().content)
            .width(this.getIconSize() * 2)
            .height(this.getIconSize() * 2)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 24 })
        } else if (this.customContent) {
          this.customContent()
        }

        // æ ‡é¢˜
        if (this.title) {
          Text(this.title)
            .fontSize(this.getTitleSize())
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeManager.getCurrentTextColor())
            .margin({ bottom: 12 })
            .textAlign(TextAlign.Center)
        }

        // æè¿°
        if (this.description) {
          Text(this.description)
            .fontSize(this.getDescriptionSize())
            .fontColor(ThemeManager.getCurrentTextSecondaryColor())
            .textAlign(TextAlign.Center)
            .maxLines(3)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .lineHeight(24)
        }

        // æ“ä½œæŒ‰é’®
        if (this.showButton) {
          this.buildActionButton()
        }
      }
      .width(this.getContentWidth())
      .padding(32)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(ThemeManager.getCurrentBackgroundColor())
  }

  /**
   * æ„å»ºæ“ä½œæŒ‰é’®
   */
  @Builder
  private buildActionButton() {
    Button(this.buttonText)
      .fontSize(16)
      .fontColor(this.getButtonTextColor())
      .fontWeight(FontWeight.Medium)
      .padding({ left: 24, right: 24, top: 12, bottom: 12 })
      .borderRadius(this.getButtonBorderRadius())
      .backgroundColor(this.getButtonBackgroundColor())
      .border({
        width: this.getButtonType() === 'outline' ? 1 : 0,
        color: this.getButtonTextColor()
      })
      .onClick(() => {
        this.onButtonPress?.()
      })
  }

  /**
   * è·å–å›¾æ ‡é…ç½®
   */
  private getIconConfig(): { type: 'emoji' | 'image' | 'svg', content: string } {
    if (this.icon) {
      return { type: 'emoji', content: this.icon }
    } else if (this.image) {
      return { type: 'image', content: this.image }
    } else {
      const defaultIcons: Record<EmptyStateType, string> = {
        'no-data': 'ğŸ“¦',
        'no-results': 'ğŸ”',
        'no-network': 'ğŸ“¶',
        'error': 'âŒ',
        'loading': 'â³',
        'empty-list': 'ğŸ“‹',
        'empty-favorites': 'â­',
        'no-permission': 'ğŸ”’',
        'not-found': 'ğŸ”',
        'maintenance': 'ğŸ”§',
        'first-use': 'ğŸ‘‹'
      }
      return { type: 'emoji', content: defaultIcons[this.type] || 'ğŸ“¦' }
    }
  }

  /**
   * è·å–å›¾æ ‡å°ºå¯¸
   */
  private getIconSize(): number {
    const sizes = {
      'small': 48,
      'medium': 64,
      'large': 80,
      'full': 96
    }
    return sizes[this.size] || sizes['medium']
  }

  /**
   * è·å–æ ‡é¢˜å­—ä½“å¤§å°
   */
  private getTitleSize(): number {
    const sizes = {
      'small': 18,
      'medium': 20,
      'large': 24,
      'full': 28
    }
    return sizes[this.size] || sizes['medium']
  }

  /**
   * è·å–æè¿°å­—ä½“å¤§å°
   */
  private getDescriptionSize(): number {
    const sizes = {
      'small': 14,
      'medium': 16,
      'large': 18,
      'full': 20
    }
    return sizes[this.size] || sizes['medium']
  }

  /**
   * è·å–å†…å®¹å®½åº¦
   */
  private getContentWidth(): string {
    const widths = {
      'small': '280',
      'medium': '320',
      'large': '400',
      'full': '80%'
    }
    return widths[this.size] || widths['medium']
  }

  /**
   * è·å–æŒ‰é’®èƒŒæ™¯é¢œè‰²
   */
  private getButtonBackgroundColor(): string {
    switch (this.buttonType) {
      case 'primary':
        return ThemeManager.getCurrentPrimaryColor()
      case 'secondary':
        return ThemeManager.getCurrentSecondaryColor()
      case 'outline':
        return ThemeManager.getCurrentBackgroundColor()
      case 'text':
        return Color.Transparent
      case 'icon':
        return Color.Transparent
      default:
        return ThemeManager.getCurrentPrimaryColor()
    }
  }

  /**
   * è·å–æŒ‰é’®æ–‡å­—é¢œè‰²
   */
  private getButtonTextColor(): string {
    switch (this.buttonType) {
      case 'primary':
      case 'secondary':
        return '#FFFFFF'
      case 'outline':
        return ThemeManager.getCurrentPrimaryColor()
      case 'text':
        return ThemeManager.getCurrentPrimaryColor()
      case 'icon':
        return ThemeManager.getCurrentPrimaryColor()
      default:
        return '#FFFFFF'
    }
  }

  /**
   * è·å–æŒ‰é’®åœ†è§’
   */
  private getButtonBorderRadius(): number {
    return this.buttonType === 'icon' ? 50 : 8
  }

  /**
   * è·å–æŒ‰é’®ç±»å‹
   */
  private getButtonType(): string {
    return this.buttonType || 'primary'
  }
}

/**
 * åˆ—è¡¨ç©ºçŠ¶æ€ç»„ä»¶
 * ä¸“é—¨ç”¨äºåˆ—è¡¨çš„ç©ºçŠ¶æ€æ˜¾ç¤º
 */
@ComponentV2
export struct EmptyListState {
  @Param itemCount: number = 0
  @Param itemType: string = 'é¡¹ç›®'
  @Param actionText: string = 'åˆ›å»ºæ–°é¡¹ç›®'
  @Param showSearch: boolean = false
  @Param searchPlaceholder: string = 'æœç´¢é¡¹ç›®...'
  @Param onCreateNew?: () => void = () => {}
  @Param onSearch?: (query: string) => void = () => {}

  @State private searchQuery: string = ''

  build() {
    if (this.itemCount === 0) {
      Column() {
        // æœç´¢åŒºåŸŸï¼ˆå¯é€‰ï¼‰
        if (this.showSearch) {
          Row() {
            TextInput({ placeholder: this.searchPlaceholder })
              .width('100%')
              .height(40)
              .backgroundColor(ThemeManager.getCurrentSurfaceColor())
              .borderRadius(8)
              .border({ width: 1, color: ThemeManager.getCurrentBorderColor() })
              .onChange((value: string) => {
                this.searchQuery = value
                this.onSearch?.(value)
              })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(ThemeManager.getCurrentBackgroundColor())
        }

        // ç©ºçŠ¶æ€å›¾æ ‡
        Text('ğŸ“‚')
          .fontSize(80)
          .margin({ bottom: 24 })

        // ç©ºçŠ¶æ€æ–‡æœ¬
        Text(`æš‚æ— ${this.itemType}`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .margin({ bottom: 16 })

        // æ“ä½œæŒ‰é’®
        Button(this.actionText)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor(ThemeManager.getCurrentPrimaryColor())
          .borderRadius(8)
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .onClick(() => {
            this.onCreateNew?.()
          })
      }
      .width('100%')
      .padding(32)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor(ThemeManager.getCurrentBackgroundColor())
      .height('100%')
    }
  }
}

/**
 * æœç´¢ç©ºçŠ¶æ€ç»„ä»¶
 * ä¸“é—¨ç”¨äºæœç´¢ç»“æœçš„ç©ºçŠ¶æ€
 */
@ComponentV2
export struct EmptySearchState {
  @Param query: string = ''
  @Param hasQuery: boolean = false
  @Param suggestions: string[] = []
  @Param showHistory: boolean = true
  @Param searchHistory: string[] = []
  @Param onSearch?: (query: string) => void = () => {}
  @Param onSuggestionSelect?: (suggestion: string) => void = () => {}
  @Param onClearHistory?: () => void = () => {}

  @State private selectedSuggestion: string = ''
  @State private showSuggestions: boolean = false

  build() {
    Column() {
      // æœç´¢å›¾æ ‡
      Text('ğŸ”')
        .fontSize(64)
        .margin({ bottom: 24 })

      // æœç´¢çŠ¶æ€æ–‡æœ¬
      if (this.hasQuery) {
        Text(`æœªæ‰¾åˆ°ä¸ "${this.query}" ç›¸å…³çš„ç»“æœ`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .margin({ bottom: 16 })
          .textAlign(TextAlign.Center)
      } else {
        Text('è¯·è¾“å…¥æœç´¢å…³é”®è¯')
          .fontSize(16)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .margin({ bottom: 24 })
          .textAlign(TextAlign.Center)
      }

      // æœç´¢å»ºè®®ï¼ˆå¯é€‰ï¼‰
      if (this.suggestions.length > 0) {
        Column() {
          Text('æœç´¢å»ºè®®')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeManager.getCurrentTextColor())
            .margin({ bottom: 12 })
            .alignSelf(ItemAlign.Start)

          ForEach(this.suggestions.slice(0, 5), (suggestion: string) => {
            Row() {
              Text(suggestion)
                .fontSize(14)
                .fontColor(this.selectedSuggestion === suggestion ? '#FFFFFF' : ThemeManager.getCurrentTextColor())
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .backgroundColor(this.selectedSuggestion === suggestion ? ThemeManager.getCurrentPrimaryColor() : ThemeManager.getCurrentSurfaceColor())
                .borderRadius(6)
                .borderRadius(6)
                .onClick(() => {
                  this.selectedSuggestion = suggestion
                  this.onSuggestionSelect?.(suggestion)
                  this.onSearch?.(suggestion)
                })
            }
            .width('100%')
            .margin({ bottom: 8 })
          })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(ThemeManager.getCurrentSurfaceColor())
        .borderRadius(12)
        .margin({ top: 16, bottom: 16 })
      }

      // æœç´¢å†å²ï¼ˆå¯é€‰ï¼‰
      if (this.showHistory && this.searchHistory.length > 0) {
        Column() {
          Row() {
            Text('æœ€è¿‘æœç´¢')
              .fontSize(14)
              .fontColor(ThemeManager.getCurrentTextSecondaryColor())
              .layoutWeight(1)

            Text('æ¸…é™¤')
              .fontSize(14)
              .fontColor(ThemeManager.getCurrentPrimaryColor())
              .onClick(() => {
                this.onClearHistory?.()
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
          .margin({ bottom: 12 })

          ForEach(this.searchHistory.slice(0, 3), (history: string) => {
            Row() {
              Text(history)
                .fontSize(14)
                .fontColor(ThemeManager.getCurrentTextColor())
                .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                .backgroundColor(ThemeManager.getCurrentSurfaceColor())
                .borderRadius(6)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .onClick(() => {
                  this.onSearch?.(history)
                })
            }
            .width('100%')
            .margin({ bottom: 8 })
          })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(ThemeManager.getCurrentSurfaceColor())
        .borderRadius(12)
      }
    }
    .width('100%')
    .padding(32)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(ThemeManager.getCurrentBackgroundColor())
    .height('100%')
  }
}

/**
 * ç½‘ç»œé”™è¯¯ç©ºçŠ¶æ€ç»„ä»¶
 * ä¸“é—¨ç”¨äºç½‘ç»œè¿æ¥é—®é¢˜çš„æ˜¾ç¤º
 */
@ComponentV2
export struct NetworkErrorState {
  @Param errorMessage: string = 'ç½‘ç»œè¿æ¥å¤±è´¥'
  @Param errorCode?: string = ''
  @Param showRetry: boolean = true
  @Param retryCount: number = 0
  @Param maxRetries: number = 3
  @Param onRetry?: () => void = () => {}
  @Param onSettings?: () => void = () => {}

  build() {
    Column() {
      // é”™è¯¯å›¾æ ‡
      Text('ğŸ“¶')
        .fontSize(80)
        .margin({ bottom: 24 })

      // é”™è¯¯æ ‡é¢˜
      Text('è¿æ¥å¤±è´¥')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeManager.getCurrentErrorColor())
        .margin({ bottom: 12 })

      // é”™è¯¯æè¿°
      Text(this.errorMessage)
        .fontSize(16)
        .fontColor(ThemeManager.getCurrentTextSecondaryColor())
        .textAlign(TextAlign.Center)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ bottom: 24 })

      // é”™è¯¯ä»£ç ï¼ˆå¦‚æœæœ‰ï¼‰
      if (this.errorCode) {
        Text(`é”™è¯¯ä»£ç : ${this.errorCode}`)
          .fontSize(12)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .backgroundColor(ThemeManager.getCurrentSurfaceColor())
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(4)
          .margin({ bottom: 16 })
      }

      // é‡è¯•ä¿¡æ¯
      if (this.showRetry) {
        Text(`é‡è¯•æ¬¡æ•°: ${this.retryCount}/${this.maxRetries}`)
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .margin({ bottom: 24 })
      }

      // æ“ä½œæŒ‰é’®
      Row() {
        // é‡è¯•æŒ‰é’®
        if (this.showRetry && this.retryCount < this.maxRetries) {
          Button('é‡è¯•')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor(ThemeManager.getCurrentPrimaryColor())
            .borderRadius(8)
            .padding({ left: 20, right: 20, top: 12, bottom: 12 })
            .onClick(() => {
              this.onRetry?.()
            })
        }

        // è®¾ç½®æŒ‰é’®
        if (this.onSettings) {
          Button('ç½‘ç»œè®¾ç½®')
            .fontSize(14)
            .fontColor(ThemeManager.getCurrentPrimaryColor())
            .backgroundColor(Color.Transparent)
            .border({ width: 1, color: ThemeManager.getCurrentPrimaryColor() })
            .borderRadius(8)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .onClick(() => {
              this.onSettings?.()
            })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding(32)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(ThemeManager.getCurrentBackgroundColor())
  }
}