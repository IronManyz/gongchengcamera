/**
 * ç…§ç‰‡åˆ†ç»„ç®¡ç†ç»„ä»¶
 * æä¾›æŒ‰æ—¥æœŸã€å·¥ç¨‹ã€å·¥ç‚¹ã€æ ‡ç­¾çš„åˆ†ç»„åŠŸèƒ½
 */

import { ThemeManager } from '../../theme/ThemeManager'
import { Photo } from '../../models/Photo'

export interface GroupOption {
  key: string
  label: string
  count: number
  icon: string
  type: 'date' | 'project' | 'site' | 'tag'
  subItems?: GroupOption[]
}

export interface GroupFilter {
  dates?: string[]
  projectIds?: string[]
  siteIds?: string[]
  tags?: string[]
  dateRange?: { start: Date, end: Date }
  sortBy?: 'date' | 'name'
  sortOrder?: 'asc' | 'desc'
}

@ComponentV2
export struct PhotoGroupManager {
  @Param photos: Photo[] = []
  @Param selectedFilter?: GroupFilter
  @Param onFilterChange?: (filter: GroupFilter) => void
  @Param onGroupSelect?: (group: GroupOption) => void

  @State private expandedGroups: Set<string> = new Set()
  @State private showProjectSelector: boolean = false
  @State private showSiteSelector: boolean = false
  @State private showTagSelector: boolean = false
  @State private showCalendarSelector: boolean = false

  /**
   * è·å–åˆ†ç»„é€‰é¡¹
   */
  private getGroupOptions(): GroupOption[] {
    const groups: GroupOption[] = []

    // æ—¥æœŸåˆ†ç»„
    groups.push(...this.getDateGroups())

    // å·¥ç¨‹åˆ†ç»„
    groups.push(...this.getProjectGroups())

    // å·¥ç‚¹åˆ†ç»„
    groups.push(...this.getSiteGroups())

    // æ ‡ç­¾åˆ†ç»„
    groups.push(...this.getTagGroups())

    return groups
  }

  /**
   * è·å–æ—¥æœŸåˆ†ç»„
   */
  private getDateGroups(): GroupOption[] {
    const dateGroups = new Map<string, number>()
    const today = new Date()

    this.photos.forEach(photo => {
      if (!photo.takenAt) return

      const photoDate = new Date(photo.takenAt)
      const dateKey = this.getDateGroupKey(photoDate, today)

      dateGroups.set(dateKey, (dateGroups.get(dateKey) || 0) + 1)
    })

    return Array.from(dateGroups.entries()).map(([key, count]) => ({
      key,
      label: key,
      count,
      icon: 'ğŸ“…',
      type: 'date'
    }))
  }

  /**
   * è·å–æ—¥æœŸåˆ†ç»„é”®
   */
  private getDateGroupKey(date: Date, today: Date): string {
    const diffTime = today.getTime() - date.getTime()
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))

    if (diffDays === 0) {
      return 'ä»Šå¤©'
    } else if (diffDays === 1) {
      return 'æ˜¨å¤©'
    } else if (diffDays < 7) {
      return 'æœ¬å‘¨'
    } else if (diffDays < 30) {
      return 'æœ¬æœˆ'
    } else if (diffDays < 90) {
      return 'è¿‘ä¸‰æœˆ'
    } else if (diffDays < 365) {
      return date.getFullYear().toString()
    } else {
      return 'æ›´æ—©'
    }
  }

  /**
   * è·å–å·¥ç¨‹åˆ†ç»„
   */
  private getProjectGroups(): GroupOption[] {
    const projectGroups = new Map<string, number>()
    const projectIdCounts = new Map<string, number>()

    // ç»Ÿè®¡æ¯ä¸ªå·¥ç¨‹çš„ç…§ç‰‡æ•°é‡
    this.photos.forEach(photo => {
      if (photo.projectId) {
        const count = projectIdCounts.get(photo.projectId) || 0
        projectIdCounts.set(photo.projectId, count + 1)
      }
    })

    // ä»Photoå¯¹è±¡ä¸­æå–å·¥ç¨‹ä¿¡æ¯ï¼ˆå‡è®¾Photoæœ‰projectNameå±æ€§ï¼‰
    this.photos.forEach(photo => {
      if (photo.projectId && photo.projectName) {
        projectGroups.set(photo.projectName, projectIdCounts.get(photo.projectId) || 0)
      }
    })

    return Array.from(projectGroups.entries()).map(([name, count]) => ({
      key: name,
      label: name,
      count,
      icon: 'ğŸ—ï¸',
      type: 'project'
    }))
  }

  /**
   * è·å–å·¥ç‚¹åˆ†ç»„
   */
  private getSiteGroups(): GroupOption[] {
    const siteGroups = new Map<string, number>()
    const siteIdCounts = new Map<string, number>()

    // ç»Ÿè®¡æ¯ä¸ªå·¥ç‚¹çš„ç…§ç‰‡æ•°é‡
    this.photos.forEach(photo => {
      if (photo.siteId) {
        const count = siteIdCounts.get(photo.siteId) || 0
        siteIdCounts.set(photo.siteId, count + 1)
      }
    })

    // ä»Photoå¯¹è±¡ä¸­æå–å·¥ç‚¹ä¿¡æ¯ï¼ˆå‡è®¾Photoæœ‰siteNameå±æ€§ï¼‰
    this.photos.forEach(photo => {
      if (photo.siteId && photo.siteName) {
        siteGroups.set(photo.siteName, siteIdCounts.get(photo.siteId) || 0)
      }
    })

    return Array.from(siteGroups.entries()).map(([name, count]) => ({
      key: name,
      label: name,
      count,
      icon: 'ğŸ“',
      type: 'site'
    }))
  }

  /**
   * è·å–æ ‡ç­¾åˆ†ç»„
   */
  private getTagGroups(): GroupOption[] {
    const tagGroups = new Map<string, number>()
    const allTags: string[] = []

    // æ”¶é›†æ‰€æœ‰æ ‡ç­¾
    this.photos.forEach(photo => {
      if (photo.tags && photo.tags.length > 0) {
        photo.tags.forEach(tag => {
          allTags.push(tag)
          const count = tagGroups.get(tag) || 0
          tagGroups.set(tag, count + 1)
        })
      }
    })

    return Array.from(tagGroups.entries()).map(([tag, count]) => ({
      key: tag,
      label: tag,
      count,
      icon: 'ğŸ·ï¸',
      type: 'tag'
    }))
  }

  /**
   * åˆ‡æ¢åˆ†ç»„å±•å¼€çŠ¶æ€
   */
  private toggleGroupExpand(groupKey: string): void {
    if (this.expandedGroups.has(groupKey)) {
      this.expandedGroups.delete(groupKey)
    } else {
      this.expandedGroups.add(groupKey)
    }
  }

  /**
   * è·å–åˆ†ç»„é¡¹æ•°é‡æ–‡æœ¬
   */
  private getCountText(count: number): string {
    if (count === 0) return ''
    if (count === 1) return '1å¼ '
    if (count < 100) return `${count}å¼ `
    return `${Math.floor(count / 100)}00+å¼ `
  }

  /**
   * æ—¥æœŸåˆ†ç»„ç»„ä»¶
   */
  @Builder
  private DateGroupItem(group: GroupOption) {
    Column() {
      // åˆ†ç»„æ ‡é¢˜
      Row({ space: 8 }) {
        Text(group.label)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Text(this.getCountText(group.count))
          .fontSize(12)
          .fontColor('#666666')
          .backgroundColor('#F0F0F0')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(8)

        Spacer()

        Button() {
          Text(this.expandedGroups.has(group.key) ? 'â–²' : 'â–¼')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(24)
        .height(24)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.toggleGroupExpand(group.key))
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .onClick(() => this.onGroupSelect?.(group))

      // å­é¡¹ï¼ˆå¦‚æœæ˜¯å±•å¼€çš„ï¼‰
      if (this.expandedGroups.has(group.key) && group.subItems) {
        Column() {
          ForEach(group.subItems, (subItem: GroupOption) => {
            Row({ space: 8 }) {
              Text(subItem.label)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)

              Text(this.getCountText(subItem.count))
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: 28, right: 12, top: 8, bottom: 8 })
            .onClick(() => this.onGroupSelect?.(subItem))
          }
        })
        .width('100%')
        .padding({ left: 16, right: 8, top: 4, bottom: 4 })
        .backgroundColor('#FAFAFA')
      }
    }
    .width('100%')
    .borderRadius(8)
    .margin({ bottom: 8 })
    .shadow({
      radius: 4,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * å·¥ç¨‹åˆ†ç»„ç»„ä»¶
   */
  @Builder
  private ProjectGroupItem(group: GroupOption) {
    Column() {
      // åˆ†ç»„æ ‡é¢˜
      Row({ space: 8 }) {
        Text(group.icon)
          .fontSize(16)

        Text(group.label)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)

        Text(this.getCountText(group.count))
          .fontSize(12)
          .fontColor('#666666')
          .backgroundColor('#E8F4FD')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(8)

        Spacer()

        Button() {
          Text(this.expandedGroups.has(group.key) ? 'â–²' : 'â–¼')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(24)
        .height(24)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.toggleGroupExpand(group.key))
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .onClick(() => this.onGroupSelect?.(group))

      // å­é¡¹ï¼ˆå¦‚æœæ˜¯å±•å¼€çš„ï¼‰
      if (this.expandedGroups.has(group.key) && group.subItems) {
        Column() {
          ForEach(group.subItems, (subItem: GroupOption) => {
            Row({ space: 8 }) {
              Text(subItem.label)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)

              Text(this.getCountText(subItem.count))
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: 28, right: 12, top: 8, bottom: 8 })
            .onClick(() => this.onGroupSelect?.(subItem))
          })
        }
        .width('100%')
        .padding({ left: 16, right: 8, top: 4, bottom: 4 })
        .backgroundColor('#FAFAFA')
      }
    }
    .width('100%')
    .borderRadius(8)
    .margin({ bottom: 8 })
    .shadow({
      radius: 4,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * é€šç”¨åˆ†ç»„é¡¹
   */
  @Builder
  private GenericGroupItem(group: GroupOption) {
    Row({ space: 12 }) {
      Text(group.icon)
        .fontSize(20)

      Column({ space: 4 }) {
        Text(group.label)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text(this.getCountText(group.count))
          .fontSize(12)
          .fontColor('#999999')
      }

      Text(this.getCountText(group.count))
        .fontSize(12)
        .fontColor('#666666')
        .backgroundColor(group.type === 'tag' ? '#FFF7E6' : '#F0F0F0')
        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
        .borderRadius(8)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
    .onClick(() => this.onGroupSelect?.(group))
  }

  build() {
    Column({ space: 16 }) {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç…§ç‰‡åˆ†ç»„')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Spacer()

        Button('æŸ¥çœ‹å…¨éƒ¨')
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentPrimaryColor())
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            // æŸ¥çœ‹å…¨éƒ¨ç…§ç‰‡
          })
      }
      .width('100%')
      .padding({ horizontal: 16, vertical: 12 })

      // åˆ†ç»„åˆ—è¡¨
      Scroll() {
        Column({ space: 8 }) {
          ForEach(this.getGroupOptions(), (group: GroupOption) => {
            if (group.type === 'date') {
              this.DateGroupItem(group)
            } else if (group.type === 'project') {
              this.ProjectGroupItem(group)
            } else {
              this.GenericGroupItem(group)
            }
          })
        }
      }
      .width('100%')
      .scrollBar(BarState.Off)
    }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FAFAFA')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000015',
      offsetX: 0,
      offsetY: 4
    })
  }
}