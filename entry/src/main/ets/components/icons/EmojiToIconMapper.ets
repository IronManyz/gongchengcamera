/**
 * Emoji åˆ°å›¾æ ‡æ˜ å°„å·¥å…·
 * æä¾›ä¾¿æ·çš„ emoji å›¾æ ‡æ›¿æ¢åŠŸèƒ½
 */

import { EngineeringIcon, Icons } from './EngineeringIcon'

export interface EmojiMapping {
  emoji: string
  iconName: string
  defaultColor?: string
  description?: string
}

/**
 * Emoji å›¾æ ‡æ˜ å°„è¡¨
 * ç”¨äºå¿«é€ŸæŸ¥æ‰¾å’Œæ›¿æ¢ emoji ä¸ºä¸“ä¸šå›¾æ ‡
 */
export const EMOJI_TO_ICON_MAP: Record<string, EmojiMapping> = {
  // å¯¼èˆªå›¾æ ‡
  'ğŸ—ï¸': { emoji: 'ğŸ—ï¸', iconName: 'building', defaultColor: '#1890FF', description: 'å·¥ç¨‹é¡¹ç›®' },
  'ğŸ“±': { emoji: 'ğŸ“±', iconName: 'photo', defaultColor: '#1890FF', description: 'ç›¸å†Œ' },
  'âš™ï¸': { emoji: 'âš™ï¸', iconName: 'settings', defaultColor: '#1890FF', description: 'è®¾ç½®' },

  // ç›¸æœºæ“ä½œ
  'ğŸ“¸': { emoji: 'ğŸ“¸', iconName: 'camera', defaultColor: '#FF4D4F', description: 'æ‹ç…§' },
  'ğŸ“¤': { emoji: 'ğŸ“¤', iconName: 'upload', defaultColor: '#52C41A', description: 'å¯¼å‡º/åˆ†äº«' },
  'ğŸ”„': { emoji: 'ğŸ”„', iconName: 'refresh', defaultColor: '#1890FF', description: 'åˆ·æ–°/åŒæ­¥' },
  'âœï¸': { emoji: 'âœï¸', iconName: 'edit', defaultColor: '#FA8C16', description: 'ç¼–è¾‘' },
  'âœ“': { emoji: 'âœ“', iconName: 'check', defaultColor: '#52C41A', description: 'ç¡®è®¤/å®Œæˆ' },

  // ä½ç½®ç›¸å…³
  'ğŸ“': { emoji: 'ğŸ“', iconName: 'mapPin', defaultColor: '#F5222D', description: 'ä½ç½®/æ ‡è®°' },

  // çŠ¶æ€æŒ‡ç¤º
  'âœ…': { emoji: 'âœ…', iconName: 'check', defaultColor: '#52C41A', description: 'å®Œæˆ/æˆåŠŸ' },
  'âŒ': { emoji: 'âŒ', iconName: 'x', defaultColor: '#FF4D4F', description: 'é”™è¯¯/å¤±è´¥' },
  'âš ï¸': { emoji: 'âš ï¸', iconName: 'alertTriangle', defaultColor: '#FA8C16', description: 'è­¦å‘Š' },
  '!': { emoji: '!', iconName: 'alertTriangle', defaultColor: '#FA8C16', description: 'è­¦å‘Š' },
  'âš ': { emoji: 'âš ', iconName: 'alertTriangle', defaultColor: '#FA8C16', description: 'è­¦å‘Š' },
  'â„¹': { emoji: 'â„¹', iconName: 'infoCircle', defaultColor: '#1890FF', description: 'ä¿¡æ¯' },
  'â„¹ï¸': { emoji: 'â„¹ï¸', iconName: 'infoCircle', defaultColor: '#1890FF', description: 'ä¿¡æ¯' },

  // ç©ºçŠ¶æ€å›¾æ ‡
  'ğŸ”': { emoji: 'ğŸ”', iconName: 'search', defaultColor: '#8C8C8C', description: 'æœç´¢' },
  'ğŸŒ': { emoji: 'ğŸŒ', iconName: 'world', defaultColor: '#1890FF', description: 'ç½‘ç»œ' },
  'ğŸ”’': { emoji: 'ğŸ”’', iconName: 'lock', defaultColor: '#8C8C8C', description: 'æƒé™' },
  'ğŸ“­': { emoji: 'ğŸ“­', iconName: 'mail', defaultColor: '#8C8C8C', description: 'é‚®ç®±/ç©ºçŠ¶æ€' },

  // åŠŸèƒ½å›¾æ ‡
  'ğŸ“Š': { emoji: 'ğŸ“Š', iconName: 'chartBar', defaultColor: '#1890FF', description: 'ç»Ÿè®¡/æŠ¥è¡¨' },
  'ğŸ¨': { emoji: 'ğŸ¨', iconName: 'palette', defaultColor: '#722ED1', description: 'ç¼–è¾‘/æ¶‚é¸¦' },
  'ğŸ–¼ï¸': { emoji: 'ğŸ–¼ï¸', iconName: 'photo', defaultColor: '#1890FF', description: 'å›¾ç‰‡' },

  // å¤©æ°”å›¾æ ‡
  'â˜€ï¸': { emoji: 'â˜€ï¸', iconName: 'sun', defaultColor: '#FA8C16', description: 'æ™´å¤©' },
  'â˜ï¸': { emoji: 'â˜ï¸', iconName: 'cloud', defaultColor: '#8C8C8C', description: 'å¤šäº‘' },
  'ğŸŒ¦ï¸': { emoji: 'ğŸŒ¦ï¸', iconName: 'cloudRain', defaultColor: '#1890FF', description: 'å°é›¨' },
  'ğŸŒ§ï¸': { emoji: 'ğŸŒ§ï¸', iconName: 'cloudRain', defaultColor: '#1890FF', description: 'ä¸­é›¨' },
  'â›ˆï¸': { emoji: 'â›ˆï¸', iconName: 'cloudRain', defaultColor: '#434343', description: 'é›·é›¨' },
  'ğŸŒ¨ï¸': { emoji: 'ğŸŒ¨ï¸', iconName: 'snowflake', defaultColor: '#1890FF', description: 'å°é›ª' },
  'â„ï¸': { emoji: 'â„ï¸', iconName: 'snowflake', defaultColor: '#1890FF', description: 'ä¸­é›ª' },
  'ğŸŒ«ï¸': { emoji: 'ğŸŒ«ï¸', iconName: 'mist', defaultColor: '#8C8C8C', description: 'é›¾/éœ¾' },
  'ğŸŒ¤ï¸': { emoji: 'ğŸŒ¤ï¸', iconName: 'sun', defaultColor: '#FA8C16', description: 'æ™´é—´å¤šäº‘' },

  // æ“ä½œæŒ‰é’®
  'â–¶ï¸': { emoji: 'â–¶ï¸', iconName: 'play', defaultColor: '#52C41A', description: 'å¼€å§‹/æ’­æ”¾' },
  'â¸ï¸': { emoji: 'â¸ï¸', iconName: 'pause', defaultColor: '#FA8C16', description: 'æš‚åœ' },
  'â¹ï¸': { emoji: 'â¹ï¸', iconName: 'square', defaultColor: '#FF4D4F', description: 'åœæ­¢' },

  // æ–‡ä»¶æ“ä½œ
  'ğŸ“„': { emoji: 'ğŸ“„', iconName: 'file', defaultColor: '#8C8C8C', description: 'æ–‡ä»¶' },
  'ğŸ“': { emoji: 'ğŸ“', iconName: 'folder', defaultColor: '#FA8C16', description: 'æ–‡ä»¶å¤¹' },
  'ğŸ—‘ï¸': { emoji: 'ğŸ—‘ï¸', iconName: 'trash', defaultColor: '#FF4D4F', description: 'åˆ é™¤' },
  'ğŸ“‹': { emoji: 'ğŸ“‹', iconName: 'clipboard', defaultColor: '#1890FF', description: 'å‰ªè´´æ¿' },
  'ğŸ“': { emoji: 'ğŸ“', iconName: 'edit', defaultColor: '#1890FF', description: 'ç¼–è¾‘/ç¬”è®°' },

  // ç•Œé¢å…ƒç´ 
  'ğŸ ': { emoji: 'ğŸ ', iconName: 'home', defaultColor: '#1890FF', description: 'é¦–é¡µ' },
  'ğŸ‘¤': { emoji: 'ğŸ‘¤', iconName: 'user', defaultColor: '#1890FF', description: 'ç”¨æˆ·' },
  'ğŸ””': { emoji: 'ğŸ””', iconName: 'bell', defaultColor: '#FA8C16', description: 'é€šçŸ¥' },
  'â¤ï¸': { emoji: 'â¤ï¸', iconName: 'heart', defaultColor: '#FF4D4F', description: 'æ”¶è—/å–œæ¬¢' },
  'â­': { emoji: 'â­', iconName: 'star', defaultColor: '#FAAD14', description: 'æ”¶è—/é‡è¦' },
  'ğŸ”–': { emoji: 'ğŸ”–', iconName: 'bookmark', defaultColor: '#1890FF', description: 'ä¹¦ç­¾' }
}

/**
 * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸º emoji
 */
export function isEmoji(text: string): boolean {
  const emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u
  return emojiRegex.test(text)
}

/**
 * è·å– emoji å¯¹åº”çš„å›¾æ ‡æ˜ å°„
 */
export function getIconMapping(emoji: string): EmojiMapping | null {
  return EMOJI_TO_ICON_MAP[emoji] || null
}

/**
 * å°† emoji è½¬æ¢ä¸ºå›¾æ ‡ç»„ä»¶
 */
export function emojiToIcon(
  emoji: string,
  props?: { size?: number | string, color?: string, strokeWidth?: number }
): EngineeringIcon | null {
  const mapping = getIconMapping(emoji)
  if (!mapping) return null

  const color = props?.color || mapping.defaultColor || '#1890FF'
  const size = props?.size || 24
  const strokeWidth = props?.strokeWidth || 2

  return Icons[mapping.iconName as keyof typeof Icons]?.({
    size,
    color,
    strokeWidth
  }) || null
}

/**
 * æ‰¹é‡æ›¿æ¢æ–‡æœ¬ä¸­çš„ emoji ä¸ºå›¾æ ‡
 */
export function replaceEmojisInText(
  text: string,
  iconProps?: { size?: number | string, color?: string, strokeWidth?: number }
): string {
  return text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, (match) => {
    const mapping = getIconMapping(match)
    return mapping ? `[ICON:${mapping.iconName}]` : match
  })
}

/**
 * å›¾æ ‡æ›¿æ¢å·¥å…·ç±»
 */
export class IconReplacer {
  private defaultProps: { size: number | string, color: string, strokeWidth: number }

  constructor(defaultProps?: { size?: number | string, color?: string, strokeWidth?: number }) {
    this.defaultProps = {
      size: 24,
      color: '#1890FF',
      strokeWidth: 2,
      ...defaultProps
    }
  }

  /**
   * è·å–æ‰€æœ‰æ”¯æŒçš„ emoji æ˜ å°„
   */
  getAllMappings(): Record<string, EmojiMapping> {
    return { ...EMOJI_TO_ICON_MAP }
  }

  /**
   * æŒ‰åˆ†ç±»è·å–æ˜ å°„
   */
  getMappingsByCategory(): Record<string, EmojiMapping[]> {
    const categories: Record<string, EmojiMapping[]> = {
      navigation: [],
      camera: [],
      status: [],
      weather: [],
      file: [],
      interface: []
    }

    Object.values(EMOJI_TO_ICON_MAP).forEach(mapping => {
      const emoji = mapping.emoji

      if (['ğŸ—ï¸', 'ğŸ“±', 'âš™ï¸', 'ğŸ '].includes(emoji)) {
        categories.navigation.push(mapping)
      } else if (['ğŸ“¸', 'ğŸ“¤', 'ğŸ”„', 'âœï¸', 'âœ“', 'ğŸ¨', 'ğŸ–¼ï¸'].includes(emoji)) {
        categories.camera.push(mapping)
      } else if (['âœ…', 'âŒ', 'âš ï¸', '!', 'âš ', 'â„¹', 'â„¹ï¸'].includes(emoji)) {
        categories.status.push(mapping)
      } else if (['â˜€ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'ğŸŒ«ï¸', 'ğŸŒ¤ï¸'].includes(emoji)) {
        categories.weather.push(mapping)
      } else if (['ğŸ“„', 'ğŸ“', 'ğŸ—‘ï¸', 'ğŸ“‹', 'ğŸ“'].includes(emoji)) {
        categories.file.push(mapping)
      } else {
        categories.interface.push(mapping)
      }
    })

    return categories
  }

  /**
   * åˆ›å»ºå›¾æ ‡ç»„ä»¶
   */
  createIcon(emoji: string, props?: Partial<{ size: number | string, color: string, strokeWidth: number }>): EngineeringIcon | null {
    const finalProps = { ...this.defaultProps, ...props }
    return emojiToIcon(emoji, finalProps)
  }

  /**
   * è·å–æ¨èçš„å›¾æ ‡é¢œè‰²
   */
  getRecommendedColor(emoji: string): string {
    const mapping = getIconMapping(emoji)
    return mapping?.defaultColor || this.defaultProps.color
  }

  /**
   * æ£€æŸ¥ emoji æ˜¯å¦æ”¯æŒ
   */
  isEmojiSupported(emoji: string): boolean {
    return emoji in EMOJI_TO_ICON_MAP
  }
}

/**
 * é»˜è®¤å›¾æ ‡æ›¿æ¢å™¨å®ä¾‹
 */
export const defaultIconReplacer = new IconReplacer()

/**
 * ä¾¿æ·å‡½æ•°ï¼šå¿«é€Ÿåˆ›å»ºå›¾æ ‡
 */
export function createIconFromEmoji(
  emoji: string,
  props?: Partial<{ size: number | string, color: string, strokeWidth: number }>
): EngineeringIcon | null {
  return defaultIconReplacer.createIcon(emoji, props)
}