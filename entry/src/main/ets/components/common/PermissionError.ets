/**
 * æƒé™é”™è¯¯å¤„ç†ç»„ä»¶
 * ä¸“é—¨å¤„ç†æƒé™ç›¸å…³çš„é”™è¯¯å’ŒçŠ¶æ€
 */

import { ThemeManager } from '../../theme/ThemeManager'
import { Permissions } from '@ohos.permission'

export interface PermissionErrorConfig {
  permission?: string
  permissions?: string[]
  onGrant?: () => void
  onSettings?: () => void
  onRetry?: () => void
  customMessage?: string
  showRationale?: boolean
}

export enum PermissionType {
  CAMERA = 'ohos.permission.CAMERA',
  MICROPHONE = 'ohos.permission.MICROPHONE',
  LOCATION = 'ohos.permission.APPROXIMATELY_LOCATION',
  STORAGE = 'ohos.permission.READ_WRITE_IMAGES',
  NOTIFICATION = 'ohos.permission.NOTIFICATION_CONTROLLER'
}

export interface PermissionInfo {
  type: PermissionType
  name: string
  description: string
  icon: string
  rationale: string
  dangerous: boolean
}

@ComponentV2
export struct PermissionError {
  @Param config?: PermissionErrorConfig = {}
  @State private permissionInfo?: PermissionInfo
  @State private isCheckingPermission: boolean = false

  private readonly permissionMap: Map<PermissionType, PermissionInfo> = new Map([
    [PermissionType.CAMERA, {
      type: PermissionType.CAMERA,
      name: 'ç›¸æœºæƒé™',
      description: 'éœ€è¦ç›¸æœºæƒé™æ¥æ‹æ‘„å·¥ç¨‹ç…§ç‰‡',
      icon: 'ğŸ“·',
      rationale: 'ç›¸æœºåŠŸèƒ½éœ€è¦è®¿é—®æ‚¨çš„è®¾å¤‡ç›¸æœºï¼Œç”¨äºæ‹æ‘„å·¥ç¨‹ç°åœºç…§ç‰‡ã€‚æˆ‘ä»¬æ‰¿è¯ºä»…ç”¨äºå·¥ç¨‹ç®¡ç†ç›¸å…³çš„æ‹æ‘„ï¼Œä¸ä¼šå­˜å‚¨æˆ–åˆ†äº«æ‚¨çš„ç§äººä¿¡æ¯ã€‚',
      dangerous: true
    }],
    [PermissionType.MICROPHONE, {
      type: PermissionType.MICROPHONE,
      name: 'éº¦å…‹é£æƒé™',
      description: 'éœ€è¦éº¦å…‹é£æƒé™æ¥å½•åˆ¶å·¥ç¨‹è§£è¯´',
      icon: 'ğŸ¤',
      rationale: 'å½•åˆ¶å·¥ç¨‹è§£è¯´åŠŸèƒ½éœ€è¦è®¿é—®æ‚¨çš„è®¾å¤‡éº¦å…‹é£ï¼Œç”¨äºæ·»åŠ è¯­éŸ³è¯´æ˜ã€‚æˆ‘ä»¬ä¸ä¼šåœ¨æ‚¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å½•åˆ¶éŸ³é¢‘ã€‚',
      dangerous: true
    }],
    [PermissionType.LOCATION, {
      type: PermissionType.LOCATION,
      name: 'ä½ç½®æƒé™',
      description: 'éœ€è¦ä½ç½®æƒé™æ¥è®°å½•å·¥ç¨‹ä½ç½®',
      icon: 'ğŸ“',
      rationale: 'ä½ç½®åŠŸèƒ½éœ€è¦è·å–æ‚¨çš„è®¾å¤‡ä½ç½®ï¼Œç”¨äºè®°å½•å·¥ç‚¹çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚è¿™å°†å¸®åŠ©æ‚¨æ›´å¥½åœ°ç®¡ç†å’Œè¿½è¸ªå·¥ç¨‹é¡¹ç›®ä½ç½®ã€‚',
      dangerous: true
    }],
    [PermissionType.STORAGE, {
      type: PermissionType.STORAGE,
      name: 'å­˜å‚¨æƒé™',
      description: 'éœ€è¦å­˜å‚¨æƒé™æ¥ä¿å­˜å’Œç®¡ç†ç…§ç‰‡',
      icon: 'ğŸ’¾',
      rationale: 'å­˜å‚¨åŠŸèƒ½ï¿½ï¿½è¦è®¿é—®æ‚¨çš„è®¾å¤‡å­˜å‚¨ï¼Œç”¨äºä¿å­˜å·¥ç¨‹ç…§ç‰‡å’Œç›¸å…³æ–‡ä»¶ã€‚æˆ‘ä»¬å°†æŒ‰ç…§æ‚¨çš„éšç§è®¾ç½®å®‰å…¨åœ°ç®¡ç†è¿™äº›æ–‡ä»¶ã€‚',
      dangerous: true
    }],
    [PermissionType.NOTIFICATION, {
      type: PermissionType.NOTIFICATION,
      name: 'é€šçŸ¥æƒé™',
      description: 'éœ€è¦é€šçŸ¥æƒé™æ¥å‘é€å·¥ç¨‹æé†’',
      icon: 'ğŸ””',
      rationale: 'é€šçŸ¥åŠŸèƒ½éœ€è¦å‘é€ç³»ç»Ÿé€šçŸ¥ï¼Œç”¨äºæé†’æ‚¨é‡è¦çš„å·¥ç¨‹äº‹ä»¶å’Œä»»åŠ¡ã€‚æ‚¨å¯ä»¥éšæ—¶åœ¨è®¾ç½®ä¸­ç®¡ç†é€šçŸ¥åå¥½ã€‚',
      dangerous: false
    }]
  ])

  aboutToAppear() {
    this.analyzePermission()
  }

  /**
   * åˆ†ææƒé™ç±»å‹
   */
  private analyzePermission(): void {
    const permission = this.config?.permission
    const permissions = this.config?.permissions

    if (permission) {
      this.permissionInfo = this.permissionMap.get(permission as PermissionType)
    } else if (permissions && permissions.length > 0) {
      // å¤„ç†å¤šä¸ªæƒé™çš„æƒ…å†µ
      this.permissionInfo = {
        type: PermissionType.CAMERA,
        name: 'å¤šä¸ªæƒé™',
        description: 'éœ€è¦å¤šä¸ªæƒé™æ¥å®Œæ•´ä½¿ç”¨åº”ç”¨åŠŸèƒ½',
        icon: 'ğŸ”',
        rationale: 'æ­¤åŠŸèƒ½éœ€è¦å¤šä¸ªæƒé™é…åˆä½¿ç”¨ï¼Œè¯·æŒ‰ç…§æç¤ºé€ä¸€æˆæƒã€‚',
        dangerous: true
      }
    } else {
      // é»˜è®¤æƒé™ä¿¡æ¯
      this.permissionInfo = {
        type: PermissionType.CAMERA,
        name: 'åº”ç”¨æƒé™',
        description: 'éœ€è¦ç›¸å…³æƒé™æ¥æ­£å¸¸ä½¿ç”¨åº”ç”¨åŠŸèƒ½',
        icon: 'ğŸ”',
        rationale: 'è¯·æˆäºˆå¿…è¦çš„æƒé™ï¼Œä»¥ä¾¿æˆ‘ä»¬ä¸ºæ‚¨æä¾›å®Œæ•´çš„å·¥ç¨‹ç®¡ç†æœåŠ¡ã€‚',
        dangerous: true
      }
    }
  }

  /**
   * æ£€æŸ¥æƒé™çŠ¶æ€
   */
  private async checkPermissionStatus(): Promise<void> {
    if (!this.permissionInfo) return

    this.isCheckingPermission = true

    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨å®é™…çš„æƒé™æ£€æŸ¥API
      // const status = await Permissions.checkPermission(this.permissionInfo.type)
      // handle permission status

      // æ¨¡æ‹Ÿæƒé™æ£€æŸ¥
      await new Promise(resolve => setTimeout(resolve, 1000))
    } catch (error) {
      console.error('Permission check failed:', error)
    } finally {
      this.isCheckingPermission = false
    }
  }

  /**
   * è¯·æ±‚æƒé™
   */
  private async requestPermission(): Promise<void> {
    if (!this.permissionInfo) return

    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨å®é™…çš„æƒé™è¯·æ±‚API
      // await Permissions.requestPermission(this.permissionInfo.type)

      // æ¨¡æ‹Ÿæƒé™è¯·æ±‚
      await new Promise(resolve => setTimeout(resolve, 1500))
      this.config?.onGrant?.()
    } catch (error) {
      console.error('Permission request failed:', error)
    }
  }

  /**
   * è·³è½¬åˆ°è®¾ç½®
   */
  private openSettings(): void {
    // è¿™é‡Œåº”è¯¥è·³è½¬åˆ°åº”ç”¨è®¾ç½®é¡µé¢
    this.config?.onSettings?.()
  }

  /**
   * æƒé™å›¾æ ‡å’Œä¿¡æ¯
   */
  @Builder
  private PermissionInfoSection() {
    Column({ space: 16 }) {
      // æƒé™å›¾æ ‡
      Text(this.permissionInfo?.icon || 'ğŸ”')
        .fontSize(64)
        .textAlign(TextAlign.Center)

      // æƒé™åç§°
      Text(this.permissionInfo?.name || 'æƒé™è¦æ±‚')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .textAlign(TextAlign.Center)

      // æƒé™æè¿°
      Text(this.config?.customMessage || this.permissionInfo?.description || 'éœ€è¦ç›¸å…³æƒé™')
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .lineHeight(24)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .margin({ top: 8 })

      // æƒé™è¯´æ˜
      if (this.config?.showRationale && this.permissionInfo?.rationale) {
        Column({ space: 8 }) {
          Text('æƒé™è¯´æ˜')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .textAlign(TextAlign.Center)

          Text(this.permissionInfo.rationale)
            .fontSize(12)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
            .lineHeight(18)
            .maxLines(4)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F8F9FA')
        .borderRadius(8)
        .margin({ top: 16 })
      }
    }
    .alignItems(HorizontalAlign.Center)
    .padding(20)
  }

  /**
   * æ“ä½œæŒ‰é’®åŒºåŸŸ
   */
  @Builder
  private ActionButtons() {
    Column({ space: 12 }) {
      // æˆæƒæŒ‰é’®
      if (this.config?.onGrant) {
        Button() {
          Row({ space: 8 }) {
            if (this.isCheckingPermission) {
              LoadingProgress()
                .width(16)
                .height(16)
                .color('#FFFFFF')
            } else {
              Text('âœ“')
                .fontSize(16)
            }
            Text(this.isCheckingPermission ? 'æ£€æŸ¥ä¸­...' : 'æˆäºˆæƒé™')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
          }
        }
        .height(48)
        .width('100%')
        .backgroundColor(ThemeManager.getCurrentPrimaryColor())
        .borderRadius(24)
        .fontColor('#FFFFFF')
        .enabled(!this.isCheckingPermission)
        .onClick(() => {
          if (this.config.onRetry) {
            this.config.onRetry()
          } else {
            this.requestPermission()
          }
        })
      }

      // è®¾ç½®æŒ‰é’®
      if (this.config?.onSettings) {
        Button('å‰å¾€è®¾ç½®')
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentPrimaryColor())
          .backgroundColor(Color.Transparent)
          .border({ width: 1, color: ThemeManager.getCurrentPrimaryColor() })
          .borderRadius(22)
          .width('100%')
          .onClick(() => this.openSettings())
      }

      // é‡è¯•æŒ‰é’®
      if (this.config?.onRetry && !this.config?.onGrant) {
        Button('é‡æ–°æ£€æŸ¥')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F0F0F0')
          .borderRadius(22)
          .width('100%')
          .onClick(() => this.checkPermissionStatus())
      }
    }
    .width('100%')
    .margin({ top: 16 })
  }

  build() {
    Column({ space: 24 }) {
      this.PermissionInfoSection()
      this.ActionButtons()
    }
    .width('100%')
    .padding(32)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#00000015',
      offsetX: 0,
      offsetY: 4
    })
    .margin(16)
  }
}