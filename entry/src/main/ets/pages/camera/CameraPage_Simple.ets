/**
 * ç®€åŒ–ç›¸æœºé¡µé¢
 * æ ¹æ®åŸå‹è®¾è®¡å®ç°çš„å·¥ç¨‹æ‹ç…§ç•Œé¢
 */

import router from '@ohos.router'
import { common } from '@kit.AbilityKit'
import { PermissionManager, PermissionStatus } from '../../utils/PermissionManager'
import { CameraManager, CameraResult } from '../../utils/CameraManager'

/**
 * Surfaceå°ºå¯¸æ¥å£
 */
interface SurfaceSize {
  width: number
  height: number
}

@Entry
@ComponentV2
struct CameraPage_Simple {
  @Local private isCameraReady: boolean = false
  @Local private isLoading: boolean = true
  @Local private showPreview: boolean = false
  @Local private capturedImagePath: string = ''
  @Local private capturedPhotoData: ArrayBuffer | null = null

  // æƒé™ç›¸å…³çŠ¶æ€
  @Local private permissionStatus: PermissionStatus = PermissionStatus.NOT_DETERMINED
  @Local private showPermissionDialog: boolean = false
  @Local private permissionMessage: string = ''

  // å·¥ç‚¹ä¿¡æ¯
  @Local private projectId: string = ''
  @Local private siteId: string = ''
  @Local private siteName: string = ''

  // è®¾ç½®é€‰é¡¹
  @Local private watermarkEnabled: boolean = true
  @Local private flashEnabled: boolean = false

  // ç›¸æœºç®¡ç†ç›¸å…³
  @Local private cameraManager: CameraManager | null = null
  @Local private cameraErrorMessage: string = ''
  @Local private surfaceId: string = ''
  @Local private showCameraError: boolean = false
  @Local private cameraRetryCount: number = 0
  @Local private maxRetryCount: number = 3
  @Local private initializationSteps: string[] = []
  @Local private currentInitStep: string = ''

  aboutToAppear(): void {
    this.loadRouteParams()
    this.checkAndRequestPermission()
  }

  aboutToDisappear(): void {
    console.log('=== CameraPage.aboutToDisappear() ===')
    this.releaseCamera()
  }

  /**
   * é‡Šæ”¾ç›¸æœºèµ„æº
   */
  private async releaseCamera(): Promise<void> {
    console.log('=== CameraPage.releaseCamera() ===')

    try {
      if (this.cameraManager) {
        await this.cameraManager.releaseCamera()
        this.cameraManager = null
        console.log('Camera resources released')
      }
    } catch (error) {
      console.error('Release camera failed:', error)
    }
  }

  /**
   * åŠ è½½è·¯ç”±å‚æ•°
   */
  private loadRouteParams(): void {
    try {
      const params = router.getParams() as Record<string, Object>
      if (params) {
        this.projectId = (params.projectId as string) || ''
        this.siteId = (params.siteId as string) || ''
        this.siteName = (params.siteName as string) || ''
      }
    } catch (error) {
      console.error('Failed to load route params:', error)
    }
  }

  /**
   * æ£€æŸ¥å¹¶ç”³è¯·ç›¸æœºæƒé™
   */
  private async checkAndRequestPermission(): Promise<void> {
    console.log('=== CameraPage.checkAndRequestPermission() ===')

    try {
      console.log('Getting UIAbility context for permission check...')
      // è·å–UIAbilityContext
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        console.error('Failed to get UIAbility context for permission check')
        throw new Error('Failed to get application context')
      }

      console.log('Checking camera permission...')
      // æ£€æŸ¥æƒé™çŠ¶æ€
      const permissionManager = PermissionManager.getInstance()
      const result = await permissionManager.ensureCameraPermission(context)

      this.permissionStatus = result.status
      this.permissionMessage = result.message || ''

      console.log('Permission result:', result)
      console.log('Permission status:', result.status)
      console.log('Permission message:', result.message)

      if (result.status === PermissionStatus.GRANTED) {
        console.log('Camera permission granted, initializing camera manager...')
        this.initCameraManager()
      } else {
        console.log('Camera permission not granted:', result.message)
        this.isLoading = false
        this.showPermissionDialog = true
      }
    } catch (error) {
      console.error('Permission check failed:', error)
      this.permissionMessage = `æƒé™æ£€æŸ¥å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      this.permissionStatus = PermissionStatus.DENIED
      this.isLoading = false
      this.showPermissionDialog = true
    }
  }

  /**
   * ç”³è¯·ç›¸æœºæƒé™
   */
  private async requestPermission(): Promise<void> {
    console.log('=== CameraPage.requestPermission() ===')

    try {
      const context = getContext(this) as common.UIAbilityContext
      const permissionManager = PermissionManager.getInstance()

      const result = await permissionManager.requestCameraPermission(context)

      this.permissionStatus = result.status
      this.permissionMessage = result.message || ''

      if (result.status === PermissionStatus.GRANTED) {
        console.log('Camera permission granted after request')
        this.showPermissionDialog = false
        this.isLoading = true
        this.initCameraManager()
      } else {
        console.log('Camera permission denied after request')
        this.permissionMessage = 'ç›¸æœºæƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯'
      }
    } catch (error) {
      console.error('Request permission failed:', error)
      this.permissionMessage = 'æƒé™ç”³è¯·å¤±è´¥'
    }
  }

  /**
   * åˆå§‹åŒ–ç›¸æœºç®¡ç†å™¨
   */
  private async initCameraManager(): Promise<void> {
    console.log('=== CameraPage.initCameraManager() ===')

    try {
      // è·å–ç›¸æœºç®¡ç†å™¨å®ä¾‹
      this.cameraManager = CameraManager.getInstance()
      console.log('Camera manager instance created')

      // é‡è¦ï¼šè®¾ç½®isLoadingä¸ºfalseï¼Œè®©XComponentå¯ä»¥æ¸²æŸ“
      this.isLoading = false
      console.log('Loading state set to false, XComponent should now render')

      // è®¾ç½®åˆå§‹åŒ–è¶…æ—¶ - 30ç§’åè‡ªåŠ¨åœæ­¢åŠ è½½
      const timeoutId = setTimeout(() => {
        if (!this.isCameraReady && !this.showCameraError) {
          console.error('Camera initialization timeout (30 seconds)')
          this.cameraErrorMessage = 'ç›¸æœºåˆå§‹åŒ–è¶…æ—¶ï¼Œè¯·é‡è¯•'
          this.showCameraError = true
        }
      }, 30000)

      // è®¾ç½®å›è°ƒ
      this.cameraManager.onInitialized(() => {
        console.log('=== Camera initialization callback triggered ===')
        console.log('Previous isCameraReady state:', this.isCameraReady)
        clearTimeout(timeoutId) // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        this.isCameraReady = true
        console.log('New isCameraReady state:', this.isCameraReady)
        console.log('Camera is ready for use!')
        console.log('===========================================')
      })

      this.cameraManager.onError((error: string) => {
        console.error('=== Camera manager error callback ===')
        console.error('Error:', error)
        clearTimeout(timeoutId) // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        this.cameraErrorMessage = error
        this.showCameraError = true
        console.error('===================================')
      })

      console.log('Camera manager initialized, waiting for surface ID')

    } catch (error) {
      console.error('Init camera manager failed:', error)
      this.cameraErrorMessage = `ç›¸æœºç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      this.showCameraError = true
      this.isLoading = false
    }
  }

  /**
   * ä½¿ç”¨Surface IDåˆå§‹åŒ–ç›¸æœºï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ”¯æŒé‡è¯•ï¼‰
   */
  async initializeCameraWithSurface(surfaceId: string): Promise<void> {
    console.log('=== CameraPage.initializeCameraWithSurface() ===')
    console.log('Surface ID:', surfaceId)
    console.log('Camera manager exists:', !!this.cameraManager)
    console.log('Current loading state:', this.isLoading)
    console.log('Current retry count:', this.cameraRetryCount)
    console.log('Current isCameraReady state:', this.isCameraReady)

    try {
      if (!this.cameraManager) {
        console.error('Camera manager is null or undefined')
        throw new Error('Camera manager not initialized')
      }

      if (!surfaceId || surfaceId.length === 0) {
        console.error('Surface ID is invalid')
        throw new Error('Surface IDæ— æ•ˆ')
      }

      console.log('Getting UIAbility context...')
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        console.error('Failed to get UIAbility context')
        throw new Error('Failed to get application context')
      }

      this.currentInitStep = 'å¼€å§‹åˆå§‹åŒ–ç›¸æœº...'
      this.initializationSteps.push('å¼€å§‹åˆå§‹åŒ–')
      
      console.log('Starting camera initialization with surface...')
      console.log('Calling cameraManager.initializeCamera()...')
      
      const result = await this.cameraManager.initializeCamera(context, surfaceId)
      
      this.initializationSteps.push('åˆå§‹åŒ–è°ƒç”¨å®Œæˆ')
      console.log('Camera initialization returned')
      console.log('Result:', result)
      console.log('Result success:', result.success)
      console.log('Result message:', result.message)

      if (result.success) {
        console.log('Camera initialized with surface successfully')
        this.initializationSteps.push('âœ“ åˆå§‹åŒ–æˆåŠŸ')
        this.surfaceId = surfaceId
        this.cameraRetryCount = 0 // é‡ç½®é‡è¯•è®¡æ•°å™¨
        this.currentInitStep = 'åˆå§‹åŒ–æˆåŠŸ'
        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè®¾ç½®isLoading = falseï¼Œå› ä¸ºè¿™ä¼šåœ¨onInitializedå›è°ƒä¸­å¤„ç†
      } else {
        console.error('Camera initialization failed:', result.message)
        this.initializationSteps.push(`âœ— å¤±è´¥: ${result.message}`)

        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•
        if (this.shouldRetryCameraInitialization(result.message)) {
          await this.retryCameraInitialization(surfaceId)
        } else {
          this.cameraErrorMessage = result.message || 'ç›¸æœºåˆå§‹åŒ–å¤±è´¥'
          this.showCameraError = true
          this.isLoading = false
        }
      }

    } catch (error) {
      console.error('Initialize camera with surface failed:', error)

      // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•
      if (this.shouldRetryCameraInitialization(error instanceof Error ? error.message : String(error))) {
        await this.retryCameraInitialization(surfaceId)
      } else {
        this.cameraErrorMessage = `ç›¸æœºé¢„è§ˆåˆå§‹åŒ–å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
        this.showCameraError = true
        this.isLoading = false
      }
    }
  }

  /**
   * åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•ç›¸æœºåˆå§‹åŒ–
   */
  private shouldRetryCameraInitialization(errorMessage?: string): boolean {
    if (this.cameraRetryCount >= this.maxRetryCount) {
      console.log('Max retry count reached, no more retries')
      return false
    }

    if (!errorMessage) {
      return true
    }

    // å®šä¹‰å¯é‡è¯•çš„é”™è¯¯ç±»å‹
    const retryableErrors = [
      'ç›¸æœºè¢«å ç”¨',
      'ç›¸æœºè®¾å¤‡å¼‚å¸¸',
      'åˆå§‹åŒ–è¶…æ—¶',
      'failed to connect',
      'timeout',
      'device busy'
    ]

    const isRetryable = retryableErrors.some(error =>
      errorMessage.toLowerCase().includes(error.toLowerCase())
    )

    console.log(`Error "${errorMessage}" is ${isRetryable ? '' : 'not '}retryable`)
    return isRetryable
  }

  /**
   * é‡è¯•ç›¸æœºåˆå§‹åŒ–
   */
  private async retryCameraInitialization(surfaceId: string): Promise<void> {
    this.cameraRetryCount++
    console.log(`Retrying camera initialization (${this.cameraRetryCount}/${this.maxRetryCount})...`)

    // æ˜¾ç¤ºé‡è¯•æç¤º
    this.cameraErrorMessage = `ç›¸æœºåˆå§‹åŒ–å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (${this.cameraRetryCount}/${this.maxRetryCount})`
    this.showCameraError = true
    this.isLoading = true

    // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•
    const retryDelay = Math.min(1000 * Math.pow(2, this.cameraRetryCount), 5000) // æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§5ç§’
    console.log(`Waiting ${retryDelay}ms before retry...`)

    await new Promise<void>((resolve) => {
      setTimeout(() => {
        resolve()
      }, retryDelay)
    })

    // éšè—é”™è¯¯æç¤ºï¼Œé‡è¯•åˆå§‹åŒ–
    this.showCameraError = false
    this.initializeCameraWithSurface(surfaceId)
  }

  /**
   * æ‹ç…§
   */
  private async takePhoto(): Promise<void> {
    console.log('=== CameraPage.takePhoto() ===')
    console.log('Camera manager exists:', !!this.cameraManager)
    console.log('Page isCameraReady state:', this.isCameraReady)
    console.log('Camera manager isReady:', this.cameraManager?.isCameraReady())

    try {
      if (!this.cameraManager) {
        console.error('Camera manager is null')
        this.cameraErrorMessage = 'ç›¸æœºç®¡ç†å™¨æœªåˆå§‹åŒ–'
        this.showCameraError = true
        return
      }

      if (!this.cameraManager.isCameraReady()) {
        console.error('Camera not ready for taking photo')
        console.error('Page isCameraReady:', this.isCameraReady)
        console.error('Manager isInitialized:', this.cameraManager.isCameraReady())
        this.cameraErrorMessage = 'ç›¸æœºæœªå°±ç»ªï¼Œæ— æ³•æ‹ç…§ã€‚è¯·ç­‰å¾…ç›¸æœºåˆå§‹åŒ–å®Œæˆã€‚'
        this.showCameraError = true
        return
      }

      console.log('Taking photo with camera...')

      // æ‰§è¡ŒçœŸå®æ‹ç…§
      const result = await this.cameraManager.takePhoto()

      if (result.success) {
        console.log('Photo captured successfully')
        this.capturedPhotoData = result.data instanceof ArrayBuffer ? result.data : null
        this.capturedImagePath = `/storage/camera/photo_${Date.now()}.jpg`
        this.showPreview = true
        console.log('Photo data size:', this.capturedPhotoData?.byteLength || 0)
      } else {
        console.error('Take photo failed:', result.message)
        this.cameraErrorMessage = result.message || 'æ‹ç…§å¤±è´¥'
        this.showCameraError = true
      }

    } catch (error) {
      console.error('Take photo failed with exception:', error)
      this.cameraErrorMessage = 'æ‹ç…§è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯'
      this.showCameraError = true
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * è·³è½¬åˆ°ç›¸æœºè®¾ç½®é¡µé¢
   */
  private navigateToCameraSettings(): void {
    try {
      router.pushUrl({
        url: 'pages/settings/settingsPage',
        params: {
          tab: 'camera',
          fromCamera: true
        }
      }).then(() => {
        console.log('Successfully navigated to camera settings')
      }).catch((error: Error) => {
        console.error('Failed to navigate to camera settings:', error)
      })
    } catch (error) {
      console.error('Navigation error:', error)
    }
  }

  /**
   * é‡æ–°æ‹ç…§
   */
  private retakePhoto(): void {
    this.showPreview = false
    this.capturedImagePath = ''
  }

  /**
   * ç¡®è®¤ç…§ç‰‡
   */
  private confirmPhoto(): void {
    // TODO: ä¿å­˜ç…§ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“ï¼Œå…³è”å·¥ç‚¹
    console.log('Photo confirmed and saved')
    this.navigateBack()
  }

  build() {
    Stack() {
      // å§‹ç»ˆæ¸²æŸ“ç›¸æœºè§†å›¾ä½œä¸ºåº•å±‚ï¼Œé¿å…XComponentè¢«é”€æ¯
      if (!this.showPreview) {
        this.buildCameraView()
      } else {
        this.buildPreviewView()
      }

      // è¦†ç›–å±‚ï¼šåŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading) {
        Column() {
          Text('ğŸ“¸')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('ç›¸æœºåˆå§‹åŒ–ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#000000')
      }

      // è¦†ç›–å±‚ï¼šç›¸æœºé”™è¯¯å¯¹è¯æ¡†
      if (this.showCameraError) {
        this.buildCameraErrorDialog()
      }

      // è¦†ç›–å±‚ï¼šæƒé™å¯¹è¯æ¡†
      if (this.showPermissionDialog) {
        this.buildPermissionDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }

  /**
   * æ„å»ºç›¸æœºè§†å›¾
   */
  @Builder
  buildCameraView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('â†')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.navigateBack()
          })

        Blank()

        // å·¥ç‚¹ä¿¡æ¯
        if (this.siteName) {
          Text(this.siteName)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
        }

        Blank()

        // é—ªå…‰ç¯æŒ‰é’®
        Button(this.flashEnabled ? 'âš¡' : 'ğŸ”¦')
          .fontSize(20)
          .fontColor(this.flashEnabled ? '#FFD700' : '#FFFFFF')
          .backgroundColor('transparent')
          .onClick(async () => {
            if (this.cameraManager && this.cameraManager.isCameraReady()) {
              const result = await this.cameraManager.toggleFlash()
              if (result.success) {
                this.flashEnabled = !this.flashEnabled
                console.log('Flash toggled successfully')
              } else {
                console.error('Toggle flash failed:', result.message)
              }
            } else {
              console.log('Camera not ready for flash toggle')
            }
          })

        // è®¾ç½®æŒ‰é’®
        Button('âš™ï¸')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            console.log('Settings button clicked - navigating to camera settings')
            this.navigateToCameraSettings()
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // ç›¸æœºé¢„è§ˆåŒºåŸŸ
      Stack() {
        // ç›¸æœºé¢„è§ˆSurface
        XComponent({
          id: 'camera_preview',
          type: 'surface',
          libraryname: 'entry',
        })
          .onLoad((xComponent: XComponentController) => {
            console.log('=== XComponent onLoad triggered ===')
            console.log('Camera preview XComponent loaded')
            console.log('XComponent controller:', !!xComponent)

            try {
              if (!xComponent) {
                console.error('XComponent controller is null or undefined')
                this.cameraErrorMessage = 'ç›¸æœºé¢„è§ˆç»„ä»¶åŠ è½½å¤±è´¥'
                this.showCameraError = true
                this.isLoading = false
                return
              }

              // è®¾ç½®Surfaceå°ºå¯¸
              try {
                xComponent.setXComponentSurfaceRect({
                  surfaceWidth: 1920,
                  surfaceHeight: 1080
                })
                console.log('Surface rect set: 1920 x 1080')
              } catch (sizeError) {
                console.warn('Failed to set surface rect, using default:', sizeError)
              }

              // è·å–Surface ID
              const surfaceId: string = xComponent.getXComponentSurfaceId()
              console.log('Surface ID obtained:', surfaceId)
              console.log('Surface ID length:', surfaceId?.length || 0)

              if (surfaceId && surfaceId.length > 0) {
                // ä½¿ç”¨Surface IDåˆå§‹åŒ–ç›¸æœº
                console.log('Surface ID is valid, initializing camera...')
                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿Surfaceå®Œå…¨å‡†å¤‡å¥½
                setTimeout(() => {
                  this.initializeCameraWithSurface(surfaceId)
                }, 100)
              } else {
                console.error('Surface ID is empty or invalid')
                this.cameraErrorMessage = 'ç›¸æœºé¢„è§ˆåŒºåŸŸåˆå§‹åŒ–å¤±è´¥ï¼šSurface IDæ— æ•ˆ'
                this.showCameraError = true
                this.isLoading = false
              }
            } catch (error) {
              console.error('XComponent initialization failed:', error)
              console.error('Error details:', JSON.stringify(error))
              this.cameraErrorMessage = `ç›¸æœºé¢„è§ˆç»„ä»¶åˆå§‹åŒ–å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
              this.showCameraError = true
              this.isLoading = false
            }
          })
          .width('100%')
          .height('100%')

        // æ°´å°è¦†ç›–å±‚
        if (this.watermarkEnabled) {
          Column({ space: 8 }) {
            Text('ğŸ“¸ å·¥ç¨‹æ‹è®°')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#00000080')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(16)

            if (this.siteName) {
              Text(`ğŸ“ ${this.siteName}`)
                .fontSize(12)
                .fontColor('#FFFFFF')
                .backgroundColor('#00000080')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(12)
            }

            Text(new Date().toLocaleString())
              .fontSize(12)
              .fontColor('#FFFFFF')
              .backgroundColor('#00000080')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }
          .position({ x: 16, y: 16 })
          .alignItems(HorizontalAlign.Start)
        }

        // ç›¸æœºçŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆå³ä¸Šè§’ï¼‰
        if (!this.isCameraReady) {
          Row({ space: 6 }) {
            LoadingProgress()
              .width(16)
              .height(16)
              .color('#1890FF')
            
            Text('åˆå§‹åŒ–ä¸­')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('#1890FF80')
          .borderRadius(16)
          .position({ x: '50%', y: 16 })
          .translate({ x: '-50%' })
        } else {
          Row({ space: 6 }) {
            Text('âœ“')
              .fontSize(14)
              .fontColor('#52C41A')
            
            Text('å°±ç»ª')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('#52C41A80')
          .borderRadius(16)
          .position({ x: '50%', y: 16 })
          .translate({ x: '-50%' })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#000000')

      // åº•éƒ¨æ§åˆ¶æ 
      Column() {
        // åŠŸèƒ½æŒ‰é’®
        Row({ space: 20 }) {
          Button('ğŸ”')
            .fontSize(24)
            .fontColor('#FFFFFF')
            .backgroundColor('#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              // TODO: åˆ‡æ¢å‰åæ‘„åƒå¤´
              console.log('Switch camera')
            })

          // æ‹ç…§æŒ‰é’®
          Button()
            .width(80)
            .height(80)
            .borderRadius(40)
            .backgroundColor(this.isCameraReady ? '#FFFFFF' : '#666666')
            .border({ width: 4, color: this.isCameraReady ? '#E0E0E0' : '#444444' })
            .enabled(this.isCameraReady)
            .opacity(this.isCameraReady ? 1.0 : 0.5)
            .onClick(() => {
              console.log('Capture button clicked, isCameraReady:', this.isCameraReady)
              this.takePhoto()
            })

          Button('ğŸ’§')
            .fontSize(24)
            .fontColor(this.watermarkEnabled ? '#1890FF' : '#FFFFFF')
            .backgroundColor(this.watermarkEnabled ? '#FFFFFF20' : '#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.watermarkEnabled = !this.watermarkEnabled
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 20 })

        // æç¤ºä¿¡æ¯å’ŒçŠ¶æ€
        if (this.isCameraReady) {
          Text('è½»è§¦æ‹ç…§ï¼Œé•¿æŒ‰è¿æ‹')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .margin({ bottom: 20 })
        } else {
          Row({ space: 8 }) {
            LoadingProgress()
              .width(16)
              .height(16)
              .color('#1890FF')
            
            Text('ç›¸æœºå‡†å¤‡ä¸­...')
              .fontSize(14)
              .fontColor('#1890FF')
          }
          .margin({ bottom: 20 })
        }
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 20 })
      .backgroundColor('#00000080')
    }
  }

  /**
   * æ„å»ºé¢„è§ˆè§†å›¾
   */
  @Builder
  buildPreviewView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('âœ•')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.retakePhoto()
          })

        Blank()

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Medium)

        Blank()

        Button('âœ“')
          .fontSize(20)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // å›¾ç‰‡é¢„è§ˆï¼ˆæ¨¡æ‹Ÿï¼‰
      Column() {
        Text('ğŸ–¼ï¸')
          .fontSize(64)
          .fontColor('#666666')
          .margin({ bottom: 16 })

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(16)
          .fontColor('#999999')
          .margin({ bottom: 8 })

        Text(this.capturedImagePath)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (this.watermarkEnabled) {
          Text('ğŸ’§ åŒ…å«æ°´å°ä¿¡æ¯')
            .fontSize(14)
            .fontColor('#1890FF')
            .margin({ top: 8 })
        }

        if (this.siteName) {
          Text(`ğŸ“ å·¥ç‚¹: ${this.siteName}`)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#000000')

      // åº•éƒ¨æ“ä½œæ 
      Row({ space: 20 }) {
        Button('é‡æ–°æ‹ç…§')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#666666')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.retakePhoto()
          })

        Button('ä½¿ç”¨ç…§ç‰‡')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20, top: 16, bottom: 40 })
      .backgroundColor('#00000080')
    }
  }

  /**
   * æ„å»ºæƒé™å¯¹è¯æ¡†
   */
  @Builder
  buildPermissionDialog() {
    Column() {
      // æƒé™å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // å›¾æ ‡
        Text('ğŸ“¸')
          .fontSize(64)
          .fontColor('#FFFFFF')
          .margin({ bottom: 16 })

        // æ ‡é¢˜
        Text('éœ€è¦ç›¸æœºæƒé™')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 8 })

        // è¯´æ˜
        Text('å·¥ç¨‹æ‹è®°éœ€è¦è®¿é—®ç›¸æœºæ¥æ‹æ‘„å·¥ç¨‹ç°åœºç…§ç‰‡')
          .fontSize(16)
          .fontColor('#E0E0E0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 16 })

        Text('ç”¨äºé¡¹ç›®è®°å½•å’Œç®¡ç†')
          .fontSize(14)
          .fontColor('#B0B0B0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.permissionMessage) {
          Text(this.permissionMessage)
            .fontSize(14)
            .fontColor('#FF6B6B')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 20 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }

        // æŒ‰é’®ç»„
        Column({ space: 12 }) {
          if (this.permissionStatus === PermissionStatus.NOT_DETERMINED) {
            // é¦–æ¬¡ç”³è¯·æƒé™
            Button('æˆäºˆç›¸æœºæƒé™')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                console.log('User clicked grant permission')
                this.requestPermission()
              })
          } else {
            // æƒé™è¢«æ‹’ç»çš„æƒ…å†µ
            Button('é‡æ–°ç”³è¯·æƒé™')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                console.log('User clicked retry permission')
                this.requestPermission()
              })

            Button('å‰å¾€è®¾ç½®')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#1890FF')
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .border({ width: 1, color: '#1890FF' })
              .onClick(() => {
                console.log('User clicked open settings')
                const permissionManager = PermissionManager.getInstance()
                const context = getContext(this) as common.UIAbilityContext
                permissionManager.openAppSettings(context)
              })
          }

          Button('è¿”å›')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#8C8C8C')
            .backgroundColor('transparent')
            .borderRadius(8)
            .onClick(() => {
              console.log('User clicked back')
              this.navigateBack()
            })
        }
        .width('100%')
      }
      .width('88%')
      .backgroundColor('#1E1E1E')
      .borderRadius(16)
      .padding({ top: 32, bottom: 24, left: 24, right: 24 })
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.3)',
        offsetX: 0,
        offsetY: 8
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.8)')
    .onClick(() => {
      // ç‚¹å‡»èƒŒæ™¯ä¸ä¼šå…³é—­å¯¹è¯æ¡†ï¼Œç¡®ä¿ç”¨æˆ·å¿…é¡»åšå‡ºé€‰æ‹©
      console.log('Permission dialog background clicked - ignoring')
    })
  }

  /**
   * æ„å»ºç›¸æœºé”™è¯¯å¯¹è¯æ¡†ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
   */
  @Builder
  buildCameraErrorDialog() {
    Column() {
      // é”™è¯¯å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // å›¾æ ‡å’Œæ ‡é¢˜
        Column({ space: 8 }) {
          Text(this.cameraRetryCount > 0 ? 'â³' : 'âš ï¸')
            .fontSize(64)
            .fontColor(this.cameraRetryCount > 0 ? '#FFD700' : '#FF6B6B')
            .margin({ bottom: 16 })

          Text(this.cameraRetryCount > 0 ? 'ç›¸æœºåˆå§‹åŒ–ä¸­...' : 'ç›¸æœºé”™è¯¯')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
        }

        // é”™è¯¯ä¿¡æ¯
        if (this.cameraErrorMessage) {
          Text(this.cameraErrorMessage)
            .fontSize(14)
            .fontColor(this.cameraRetryCount > 0 ? '#FFD700' : '#FF6B6B')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 16 })
            .maxLines(5)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }

        // é‡è¯•è¿›åº¦ä¿¡æ¯
        if (this.cameraRetryCount > 0) {
          Text(`æ­£åœ¨é‡è¯•ç¬¬ ${this.cameraRetryCount} æ¬¡ï¼Œæœ€å¤š ${this.maxRetryCount} æ¬¡`)
            .fontSize(12)
            .fontColor('#B0B0B0')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 8 })
        }

        // è¯´æ˜æ–‡å­—
        Text(this.getCameraErrorHelpText())
          .fontSize(14)
          .fontColor('#B0B0B0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        // æŒ‰é’®ç»„
        Column({ space: 12 }) {
          // ä¸»è¦æ“ä½œæŒ‰é’®
          if (this.cameraRetryCount > 0 && this.cameraRetryCount < this.maxRetryCount) {
            // é‡è¯•ä¸­çŠ¶æ€
            Button()
              .width('100%')
              .height(48)
              .backgroundColor('#333333')
              .borderRadius(8)
              .enabled(false)
          } else if (this.cameraRetryCount >= this.maxRetryCount) {
            // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ˜¾ç¤ºæ‰‹åŠ¨é‡è¯•
            Button('æ‰‹åŠ¨é‡è¯•')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                this.manualRetryCamera()
              })
          } else {
            // é¦–æ¬¡é”™è¯¯ï¼Œæ˜¾ç¤ºé‡è¯•
            Button('é‡è¯•')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                this.manualRetryCamera()
              })
          }

          // è¾…åŠ©æŒ‰é’®
          Row({ space: 12 }) {
            if (this.cameraRetryCount < this.maxRetryCount) {
              Button('è·³è¿‡é‡è¯•')
                .layoutWeight(1)
                .height(48)
                .fontSize(14)
                .fontColor('#8C8C8C')
                .backgroundColor('transparent')
                .borderRadius(8)
                .border({ width: 1, color: '#555555' })
                .onClick(() => {
                  this.skipRetry()
                })
            }

            Button('è¿”å›')
              .layoutWeight(1)
              .height(48)
              .fontSize(14)
              .fontColor('#8C8C8C')
              .backgroundColor('transparent')
              .borderRadius(8)
              .border({ width: 1, color: '#555555' })
              .onClick(() => {
                console.log('User clicked back from camera error')
                this.navigateBack()
              })
          }
          .width('100%')
        }
        .width('100%')
      }
      .width('88%')
      .backgroundColor('#1E1E1E')
      .borderRadius(16)
      .padding({ top: 32, bottom: 24, left: 24, right: 24 })
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.3)',
        offsetX: 0,
        offsetY: 8
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.8)')
    .onClick(() => {
      // ç‚¹å‡»èƒŒæ™¯ä¸ä¼šå…³é—­å¯¹è¯æ¡†
      console.log('Camera error dialog background clicked - ignoring')
    })
  }

  /**
   * è·å–ç›¸æœºé”™è¯¯å¸®åŠ©æ–‡æœ¬
   */
  private getCameraErrorHelpText(): string {
    if (this.cameraRetryCount > 0) {
      return 'æ­£åœ¨è‡ªåŠ¨é‡è¯•ç›¸æœºåˆå§‹åŒ–ï¼Œè¯·ç¨å€™...'
    }

    if (this.cameraErrorMessage?.includes('æƒé™')) {
      return 'è¯·æ£€æŸ¥ç›¸æœºæƒé™è®¾ç½®'
    } else if (this.cameraErrorMessage?.includes('å ç”¨') || this.cameraErrorMessage?.includes('busy')) {
      return 'è¯·å…³é—­å…¶ä»–ä½¿ç”¨ç›¸æœºçš„åº”ç”¨åé‡è¯•'
    } else if (this.cameraErrorMessage?.includes('è®¾å¤‡') || this.cameraErrorMessage?.includes('device')) {
      return 'è¯·æ£€æŸ¥ç›¸æœºè®¾å¤‡æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæˆ–é‡å¯åº”ç”¨åé‡è¯•'
    } else {
      return 'è¯·æ£€æŸ¥ç›¸æœºæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæˆ–é‡å¯åº”ç”¨åé‡è¯•'
    }
  }

  /**
   * æ‰‹åŠ¨é‡è¯•ç›¸æœº
   */
  private manualRetryCamera(): void {
    console.log('User initiated manual camera retry')

    // é‡ç½®çŠ¶æ€
    this.showCameraError = false
    this.cameraErrorMessage = ''
    this.cameraRetryCount = 0
    this.isLoading = true

    // é‡æ–°åˆå§‹åŒ–ç›¸æœºç®¡ç†å™¨
    this.initCameraManager()
  }

  /**
   * è·³è¿‡é‡è¯•
   */
  private skipRetry(): void {
    console.log('User chose to skip camera retry')

    this.cameraRetryCount = this.maxRetryCount // è®¾ç½®ä¸ºæœ€å¤§å€¼ï¼Œé˜»æ­¢è‡ªåŠ¨é‡è¯•
    this.showCameraError = false
    this.cameraErrorMessage = ''
    this.isLoading = false
  }
}