/**
 * ‰∏ªÈ¢òËÆæÁΩÆÈ°µÈù¢
 * Êèê‰æõÂÆåÊï¥ÁöÑ‰∏ªÈ¢òÁÆ°ÁêÜÂäüËÉΩ
 */

import router from '@ohos.router'
import { ThemeManager, ThemeType, ThemeName } from '../../theme/ThemeManager'
import { ThemeState, ThemeConfig } from '../../theme/ThemeObservable'
import { ThemeToggle } from '../../components/theme/ThemeToggle'
import { AppColors, ColorPalettes } from '../../theme/AppColors'
import { BottomNavigation } from '../../components/common/BottomNavigation'

@Entry
@ComponentV2
struct ThemePage {
  @Local private themeState: ThemeState = ThemeState.getInstance()
  @Local private refreshTrigger: number = 0
  @Local private currentBgColor: string = '#FFFFFF'
  @Local private currentTextColor: string = '#262626'
  @Local private currentSurfaceColor: string = '#FFFFFF'

  private get currentThemeType(): ThemeType {
    // Âº∫Âà∂‰æùËµñrefreshTrigger‰ª•Á°Æ‰øùUIÈáçÊñ∞Ê∏≤Êüì
    void this.refreshTrigger
    return this.themeState.currentTheme.type
  }

  private get currentThemeName(): ThemeName {
    // Âº∫Âà∂‰æùËµñrefreshTrigger‰ª•Á°Æ‰øùUIÈáçÊñ∞Ê∏≤Êüì
    void this.refreshTrigger
    return this.themeState.currentTheme.name
  }

  aboutToAppear() {
    this.themeState = ThemeState.getInstance()
  }

  /**
   * ‰∏ªÈ¢òÁä∂ÊÄÅÂèòÂåñÁõëÂê¨Âô®
   */
  onThemeStateChanged(): void {
    console.log('=== ThemePage.onThemeStateChanged() ===')
    console.log('ThemePage: Theme state changed, triggering UI refresh')
    this.refreshTrigger++
    console.log('ThemePage: refreshTrigger updated to:', this.refreshTrigger)
  }

  /**
   * ÊâãÂä®ÊµãËØï‰∏ªÈ¢òÁ≥ªÁªüÔºàË∞ÉËØïÁî®Ôºâ
   */
  private testThemeSystem(): void {
    console.log('=== MANUAL THEME SYSTEM TEST ===')

    // Test 1: Check ThemeState
    console.log('1. ThemeState Test:')
    console.log('   ThemeState.currentTheme:', JSON.stringify(this.themeState.currentTheme))
    console.log('   ThemeState.updateCount:', this.themeState.updateCount)

    // Test 2: Check ThemeManager
    console.log('2. ThemeManager Test:')
    console.log('   ThemeManager.currentTheme:', JSON.stringify(ThemeManager.getCurrentTheme()))

    // Test 3: Check color retrieval
    console.log('3. Color Retrieval Test:')
    console.log('   getCurrentBgColor():', ThemeManager.getCurrentBgColor())
    console.log('   getCurrentTextColor():', ThemeManager.getCurrentTextColor())
    console.log('   getCurrentSurfaceColor():', ThemeManager.getCurrentSurfaceColor())
    console.log('   getCurrentPrimaryColor():', ThemeManager.getCurrentPrimaryColor())

    // Test 4: Check dark palette
    console.log('4. Dark Palette Test:')
    console.log('   ColorPalettes.dark.background:', ColorPalettes.dark.background)
    console.log('   ColorPalettes.dark.text:', ColorPalettes.dark.text)

    // Test 5: Check current UI state
    console.log('5. UI State Test:')
    console.log('   this.currentThemeType:', this.currentThemeType)
    console.log('   this.currentThemeName:', this.currentThemeName)
    console.log('   this.refreshTrigger:', this.refreshTrigger)

    console.log('=== END MANUAL TEST ===')
  }

  private refreshTheme(): void {
    console.log('=== ThemePage.refreshTheme START ===')
    console.log('ThemePage: refreshTheme called, current trigger:', this.refreshTrigger)
    this.refreshTrigger++
    console.log('ThemePage: refreshTrigger incremented to:', this.refreshTrigger)

    // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÈ¢úËâ≤Âπ∂Êõ¥Êñ∞@StateÂèòÈáè
    this.currentBgColor = ThemeManager.getCurrentBgColor()
    this.currentTextColor = ThemeManager.getCurrentTextColor()
    this.currentSurfaceColor = ThemeManager.getCurrentSurfaceColor()

    console.log('ThemePage: Updated @State color variables:')
    console.log('ThemePage: currentBgColor =', this.currentBgColor)
    console.log('ThemePage: currentTextColor =', this.currentTextColor)
    console.log('ThemePage: currentSurfaceColor =', this.currentSurfaceColor)

    // ÊµãËØïÈ¢úËâ≤Ëé∑Âèñ
    console.log('ThemePage: Testing color retrieval...')
    console.log('ThemePage: Current theme type:', this.currentThemeType)
    console.log('ThemePage: Current theme name:', this.currentThemeName)
    const currentTheme = ThemeManager.getCurrentTheme()
    console.log('ThemePage: ThemeManager isDark:', currentTheme.isDark)
    console.log('ThemePage: Background color from ThemeManager:', ThemeManager.getCurrentBgColor())
    console.log('ThemePage: Text color from ThemeManager:', ThemeManager.getCurrentTextColor())
    console.log('ThemePage: Surface color from ThemeManager:', ThemeManager.getCurrentSurfaceColor())
    console.log('ThemePage: Primary color:', ThemeManager.getCurrentPrimaryColor())

    // Test if ThemeState and ThemeManager are in sync
    console.log('ThemePage: ThemeState currentTheme:', JSON.stringify(this.themeState.currentTheme))
    console.log('ThemePage: ThemeManager currentTheme:', JSON.stringify(ThemeManager.getCurrentTheme()))

    // Âº∫Âà∂Ëß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
    console.log('ThemePage: Forcing UI re-render with @State variables...')
    console.log('ThemePage: refreshTheme completed, new trigger:', this.refreshTrigger)
    console.log('=== ThemePage.refreshTheme END ===')
  }

  /**
   * Ëé∑Âèñ‰∏ªÈ¢òÁ±ªÂûãÊñáÊú¨
   */
  private getThemeTypeText(type: ThemeType): string {
    switch (type) {
      case ThemeType.LIGHT:
        return 'ÊµÖËâ≤'
      case ThemeType.DARK:
        return 'Ê∑±Ëâ≤'
      case ThemeType.AUTO:
        return 'Ë∑üÈöèÁ≥ªÁªü'
      default:
        return 'ÊµÖËâ≤'
    }
  }

  /**
   * Ëé∑Âèñ‰∏ªÈ¢òÂêçÁß∞ÊñáÊú¨
   */
  private getThemeNameText(name: ThemeName): string {
    switch (name) {
      case ThemeName.ENGINEERING:
        return 'Â∑•Á®ã‰∏ªÈ¢ò'
      case ThemeName.SAFETY:
        return 'ÂÆâÂÖ®‰∏ªÈ¢ò'
      case ThemeName.PROFESSIONAL:
        return '‰∏ì‰∏ö‰∏ªÈ¢ò'
      default:
        return 'Â∑•Á®ã‰∏ªÈ¢ò'
    }
  }

  /**
   * ËøîÂõûËÆæÁΩÆÈ°µÈù¢
   */
  private goBack(): void {
    try {
      router.replaceUrl({
        url: 'pages/settings/SettingsPlaceholderPage',
        params: {}
      }).catch((error: Error) => {
        console.error('Navigation back to settings failed:', error)
      })
    } catch (error) {
      console.error('Navigation back to settings failed with exception:', error)
    }
  }

  /**
   * ËÆæÁΩÆ‰∏ªÈ¢òÁ±ªÂûã
   */
  private setThemeType(type: ThemeType): void {
    const currentTheme = this.themeState.currentTheme
    let newTheme: ThemeConfig

    switch (type) {
      case ThemeType.LIGHT:
        newTheme = {
          type: ThemeType.LIGHT,
          name: currentTheme.name,
          isDark: false
        }
        break
      case ThemeType.DARK:
        newTheme = {
          type: ThemeType.DARK,
          name: currentTheme.name,
          isDark: true
        }
        break
      case ThemeType.AUTO:
        newTheme = {
          type: ThemeType.AUTO,
          name: currentTheme.name,
          isDark: false
        }
        break
      default:
        newTheme = currentTheme
    }

    ThemeManager.setTheme(newTheme)
    this.themeState.setTheme(newTheme)

    // Debug test after theme change
    this.testThemeSystem()

    this.refreshTheme()
  }

  /**
   * ËÆæÁΩÆ‰∏ªÈ¢òÂêçÁß∞
   */
  private setThemeName(name: ThemeName): void {
    const currentTheme = this.themeState.currentTheme
    const newTheme: ThemeConfig = {
      type: currentTheme.type,
      name: name,
      isDark: currentTheme.isDark
    }

    ThemeManager.setThemeName(name)
    this.themeState.setTheme(newTheme)

    // Debug test after theme change
    this.testThemeSystem()

    this.refreshTheme()
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Button() {
          Text('‚Äπ')
            .fontSize(24)
            .fontColor(ThemeManager.getCurrentTextColor())
        }
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())

        Text('‰∏ªÈ¢òËÆæÁΩÆ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeManager.getCurrentTextColor())
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank()
        .width(48)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(ThemeManager.getCurrentSurfaceColor())
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // ÂÜÖÂÆπÂå∫Âüü
      Scroll() {
        Column({ space: 24 }) {
          // Ë∞ÉËØï‰ø°ÊÅØÊòæÁ§∫Âå∫Âüü
          Column({ space: 8 }) {
            Text('üîç Ë∞ÉËØï‰ø°ÊÅØ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTextColor)
              .alignSelf(ItemAlign.Start)

            Row() {
              Text('ËÉåÊôØËâ≤:')
                .fontSize(12)
                .fontColor(this.currentTextColor)
                .width(60)

              Text(this.currentBgColor)
                .fontSize(12)
                .fontColor(this.currentTextColor)
                .padding(4)
                .backgroundColor(this.currentBgColor)
                .borderRadius(4)
                .layoutWeight(1)
            }
            .width('100%')

            Row() {
              Text('ÊñáÊú¨Ëâ≤:')
                .fontSize(12)
                .fontColor(this.currentTextColor)
                .width(60)

              Text(this.currentTextColor)
                .fontSize(12)
                .fontColor(this.currentTextColor)
                .padding(4)
                .backgroundColor(this.currentBgColor)
                .borderRadius(4)
                .layoutWeight(1)
            }
            .width('100%')

            Row() {
              Text('‰∏ªÈ¢òÁ±ªÂûã:')
                .fontSize(12)
                .fontColor(ThemeManager.getCurrentTextSecondaryColor())
                .width(60)

              Text(this.currentThemeType + ' (Ëß¶ÂèëÂô®:' + this.refreshTrigger + ')')
                .fontSize(12)
                .fontColor(this.currentTextColor)
                .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor(this.currentSurfaceColor)
          .borderRadius(12)
          .margin({ bottom: 16 })

          // Ë∞ÉËØïÊåâÈíÆÔºà‰∏¥Êó∂Ôºâ
          Button() {
            Text('üîç ÊâãÂä®ÊµãËØï‰∏ªÈ¢òÁ≥ªÁªü')
              .fontSize(14)
              .fontColor('#FFFFFF')
          }
          .width('100%')
          .height(40)
          .backgroundColor('#FF6B35')
          .borderRadius(8)
          .margin({ bottom: 16 })
          .onClick(() => {
            this.testThemeSystem()
          })

          // ‰∏ªÈ¢òÁ±ªÂûãÈÄâÊã©
          Column({ space: 16 }) {
            Text('‰∏ªÈ¢òÊ®°Âºè')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeManager.getCurrentTextColor())
              .alignSelf(ItemAlign.Start)

            // ‰∏ªÈ¢òÁ±ªÂûãÈÄâÊã©Âô®
            ThemeToggle({
              showText: true,
              toggleSize: 'large',
              style: 'button',
              onThemeChanged: () => {
                console.log('=== ThemePage: ThemeToggle callback ===')
                this.refreshTheme()
              }
            })
              .margin({ top: 12 })

            // ÂΩìÂâç‰∏ªÈ¢òÁä∂ÊÄÅÊòæÁ§∫
            Row() {
              Text('ÂΩìÂâç‰∏ªÈ¢ò')
                .fontSize(14)
                .fontColor(ThemeManager.getCurrentTextSecondaryColor())

              Text(this.getThemeTypeText(this.currentThemeType))
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeManager.getCurrentTextColor())
                .margin({ left: 8 })

              Text(`(${this.getThemeNameText(this.currentThemeName)})`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ left: 4 })
            }
            .width('100%')
            .padding(16)
            .backgroundColor(ThemeManager.getCurrentSurfaceColor())
            .borderRadius(12)
            .shadow({
              radius: 4,
              color: ThemeManager.getCurrentShadowColor(),
              offsetX: 0,
              offsetY: 2
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 24 })

          // ‰∏ªÈ¢òÂêçÁß∞ÈÄâÊã©
          Column({ space: 16 }) {
            Text('‰∏ªÈ¢òÈÖçËâ≤')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeManager.getCurrentTextColor())
              .alignSelf(ItemAlign.Start)

            // ‰∏ªÈ¢òÂêçÁß∞ÈÄâÊã©
            Column({ space: 12 }) {
              // Â∑•Á®ã‰∏ªÈ¢ò
              this.buildThemeOption(
                ThemeName.ENGINEERING,
                'Â∑•Á®ã‰∏ªÈ¢ò',
                AppColors.primary,
                this.currentThemeName === ThemeName.ENGINEERING
              )

              // ÂÆâÂÖ®‰∏ªÈ¢ò
              this.buildThemeOption(
                ThemeName.SAFETY,
                'ÂÆâÂÖ®‰∏ªÈ¢ò',
                '#52C41A',
                this.currentThemeName === ThemeName.SAFETY
              )

              // ‰∏ì‰∏ö‰∏ªÈ¢ò
              this.buildThemeOption(
                ThemeName.PROFESSIONAL,
                '‰∏ì‰∏ö‰∏ªÈ¢ò',
                '#2C3E50',
                this.currentThemeName === ThemeName.PROFESSIONAL
              )
            }
            .width('100%')
            .padding(16)
            .backgroundColor(ThemeManager.getCurrentSurfaceColor())
            .borderRadius(12)
            .shadow({
              radius: 4,
              color: ThemeManager.getCurrentShadowColor(),
              offsetX: 0,
              offsetY: 2
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 24 })

          // ‰∏ªÈ¢òÈ¢ÑËßà
          this.buildThemePreview()
        }
        .width('100%')
        .padding({ top: 16, bottom: 16 })
      }
      .layoutWeight(1)
      .backgroundColor(this.currentBgColor)

      // Â∫ïÈÉ®ÂØºËà™Ê†è
      BottomNavigation({
        currentPage: 'pages/settings/SettingsPlaceholderPage'
      })
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ÊûÑÂª∫‰∏ªÈ¢òÈÄâÈ°π
   */
  @Builder
  private buildThemeOption(name: ThemeName, title: string, color: string, isSelected: boolean) {
    Row() {
      // È¢úËâ≤È¢ÑËßàÂúÜÁÇπ
      Column({ space: 8 }) {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(isSelected ? ThemeManager.getCurrentPrimaryColor() : '#333333')

        Row({ space: 8 }) {
          // È¢úËâ≤È¢ÑËßà
          Row({ space: 4 }) {
            Circle({ width: 16, height: 16 })
              .fill(color)
              .margin({ right: 4 })

            Text('‰∏ªËâ≤Ë∞É')
              .fontSize(12)
              .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          }

          // ÈÄâ‰∏≠ÊåáÁ§∫Âô®
          if (isSelected) {
            Text('‚úì')
              .fontSize(16)
              .fontColor(ThemeManager.getCurrentPrimaryColor())
          }
        }
      }
      .layoutWeight(1)

      // ÈÄâÊã©ÊåâÈíÆ
      Button() {
        Text(isSelected ? 'Â∑≤ÈÄâÊã©' : 'ÈÄâÊã©')
          .fontSize(14)
          .fontColor(isSelected ? '#FFFFFF' : ThemeManager.getCurrentPrimaryColor())
      }
      .height(36)
      .padding({ left: 16, right: 16 })
      .backgroundColor(isSelected ? ThemeManager.getCurrentPrimaryColor() : Color.Transparent)
      .borderRadius(18)
      .border({
        width: 1,
        color: isSelected ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
      })
      .onClick(() => this.setThemeName(name))
    }
    .width('100%')
    .padding(12)
    .backgroundColor(isSelected ? ThemeManager.getCurrentPrimaryColor() + '20' : Color.Transparent)
    .borderRadius(8)
  }

  /**
   * ÊûÑÂª∫‰∏ªÈ¢òÈ¢ÑËßà
   */
  @Builder
  private buildThemePreview() {
    Column({ space: 16 }) {
      Text('‰∏ªÈ¢òÈ¢ÑËßà')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeManager.getCurrentTextColor())
        .alignSelf(ItemAlign.Start)

      // È¢ÑËßàÂç°Áâá
      Column({ space: 12 }) {
        // ‰∏ªËâ≤Ë∞ÉÈ¢ÑËßà
        Row() {
          Text('‰∏ªËâ≤Ë∞É')
            .fontSize(14)
            .fontColor(ThemeManager.getCurrentTextSecondaryColor())
            .width(80)

          Text(ThemeManager.getCurrentPrimaryColor())
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeManager.getCurrentTextColor())
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(ThemeManager.getCurrentPrimaryColor() + '20')
            .borderRadius(4)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .width('100%')

        // Áä∂ÊÄÅËâ≤È¢ÑËßà
        Row() {
          Column({ space: 4 }) {
            Text('ÊàêÂäü')
              .fontSize(12)
              .fontColor(ThemeManager.getCurrentTextSecondaryColor())
              .width(40)

            Text(ThemeManager.getCurrentSuccessColor())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeManager.getCurrentTextColor())
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor(ThemeManager.getCurrentSuccessColor() + '20')
              .borderRadius(4)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
          }

          Column({ space: 4 }) {
            Text('Ë≠¶Âëä')
              .fontSize(12)
              .fontColor(ThemeManager.getCurrentTextSecondaryColor())
              .width(40)

            Text(ThemeManager.getCurrentWarningColor())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeManager.getCurrentTextColor())
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor(ThemeManager.getCurrentWarningColor() + '20')
              .borderRadius(4)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
          }

          Column({ space: 4 }) {
            Text('ÈîôËØØ')
              .fontSize(12)
              .fontColor(ThemeManager.getCurrentTextSecondaryColor())
              .width(40)

            Text(ThemeManager.getCurrentErrorColor())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeManager.getCurrentTextColor())
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor(ThemeManager.getCurrentErrorColor() + '20')
              .borderRadius(4)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
          }
        }
        .width('100%')

        // ÊñáÊú¨Ëâ≤È¢ÑËßà
        Row() {
          Text('‰∏ªË¶ÅÊñáÊú¨')
            .fontSize(14)
            .fontColor(ThemeManager.getCurrentTextSecondaryColor())
            .width(80)

          Text(ThemeManager.getCurrentTextColor())
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeManager.getCurrentTextColor())
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(ThemeManager.getCurrentBgColor())
            .borderRadius(4)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(ThemeManager.getCurrentSurfaceColor())
      .borderRadius(12)
      .shadow({
        radius: 4,
        color: ThemeManager.getCurrentShadowColor(),
        offsetX: 0,
        offsetY: 2
      })
    }
  }
}