/**
 * ä¸»é¢˜åˆ‡æ¢ç»„ä»¶
 * æä¾›æµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
 */

import { ThemeManager, ThemeType, ThemeName } from '../../theme/ThemeManager'
import { ThemeState, ThemeConfig } from '../../theme/ThemeObservable'
import { AppColors } from '../../theme/AppColors'

/**
 * ä¸»é¢˜åˆ‡æ¢å±žæ€§æŽ¥å£
 */
export interface ThemeToggleProps {
  showText?: boolean // æ˜¯å¦æ˜¾ç¤ºæ–‡å­—æ ‡ç­¾
  size?: 'small' | 'medium' | 'large' // æŒ‰é’®å°ºå¯¸
  style?: 'button' | 'switch' // åˆ‡æ¢æ ·å¼
  onThemeChanged?: () => void // ä¸»é¢˜å˜åŒ–å›žè°ƒ
}

@ComponentV2
export struct ThemeToggle {
  @Param showText: boolean = true
  @Param toggleSize: 'small' | 'medium' | 'large' = 'medium'
  @Param style: 'button' | 'switch' = 'button'
  @Param onThemeChanged: (() => void) | undefined = undefined

  @Local private themeState: ThemeState = ThemeState.getInstance()
  @Local private refreshTrigger: number = 0

  private get currentThemeType(): ThemeType {
    // å¼ºåˆ¶ä¾èµ–refreshTriggerä»¥ç¡®ä¿UIé‡æ–°æ¸²æŸ“
    void this.refreshTrigger
    return this.themeState.currentTheme.type
  }

  aboutToAppear() {
    this.themeState = ThemeState.getInstance()
  }

  private refreshTheme(): void {
    console.log('=== ThemeToggle.refreshTheme() START ===')
    console.log('ThemeToggle: refreshTheme called, current trigger:', this.refreshTrigger)
    this.refreshTrigger++
    console.log('ThemeToggle: refreshTheme completed, new trigger:', this.refreshTrigger)
    console.log('ThemeToggle: After refresh - currentThemeType:', this.currentThemeType)
    console.log('=== ThemeToggle.refreshTheme() END ===')
  }

  /**
   * åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
   */
  private setLightTheme(): void {
    console.log('ThemeToggle: setLightTheme called')
    const currentTheme = this.themeState.currentTheme
    const newTheme: ThemeConfig = {
      type: ThemeType.LIGHT,
      name: currentTheme.name,
      isDark: false
    }
    console.log('ThemeToggle: Setting theme to', newTheme)
    ThemeManager.setTheme(newTheme)
    this.themeState.setTheme(newTheme)
    this.refreshTheme()

    // è°ƒç”¨çˆ¶ç»„ä»¶çš„å›žè°ƒ
    if (this.onThemeChanged) {
      console.log('ThemeToggle: Calling onThemeChanged callback')
      this.onThemeChanged()
    }

    console.log('ThemeToggle: Light theme set completed')
  }

  /**
   * åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜
   */
  private setDarkTheme(): void {
    console.log('=== ThemeToggle.setDarkTheme START ===')
    console.log('ThemeToggle: setDarkTheme called')
    console.log('ThemeToggle: Before - ThemeState currentTheme:', JSON.stringify(this.themeState.currentTheme))
    console.log('ThemeToggle: Before - ThemeManager currentTheme:', JSON.stringify(ThemeManager.getCurrentTheme()))

    const currentTheme = this.themeState.currentTheme
    const newTheme: ThemeConfig = {
      type: ThemeType.DARK,
      name: currentTheme.name,
      isDark: true
    }

    console.log('ThemeToggle: New theme config:', JSON.stringify(newTheme))
    console.log('ThemeToggle: Calling ThemeManager.setTheme...')

    ThemeManager.setTheme(newTheme)

    console.log('ThemeToggle: After ThemeManager.setTheme - ThemeManager currentTheme:', JSON.stringify(ThemeManager.getCurrentTheme()))
    console.log('ThemeToggle: Calling ThemeState.setTheme...')

    this.themeState.setTheme(newTheme)

    console.log('ThemeToggle: After ThemeState.setTheme - ThemeState currentTheme:', JSON.stringify(this.themeState.currentTheme))
    console.log('ThemeToggle: After ThemeState.setTheme - ThemeManager currentTheme:', JSON.stringify(ThemeManager.getCurrentTheme()))

    // Test color retrieval immediately
    console.log('ThemeToggle: Testing color retrieval...')
    console.log('ThemeToggle: getCurrentBgColor() should return #121212, got:', ThemeManager.getCurrentBgColor())
    console.log('ThemeToggle: getCurrentTextColor() should return #FFFFFF, got:', ThemeManager.getCurrentTextColor())
    console.log('ThemeToggle: getCurrentSurfaceColor() should return #1E1E1E, got:', ThemeManager.getCurrentSurfaceColor())

    this.refreshTheme()

    // è°ƒç”¨çˆ¶ç»„ä»¶çš„å›žè°ƒ
    if (this.onThemeChanged) {
      console.log('ThemeToggle: Calling onThemeChanged callback')
      this.onThemeChanged()
    }

    console.log('ThemeToggle: Dark theme set completed')
    console.log('ThemeToggle: Final check - currentThemeType:', this.currentThemeType)
    console.log('ThemeToggle: Final check - refreshTrigger:', this.refreshTrigger)
    console.log('=== ThemeToggle.setDarkTheme END ===')
  }

  /**
   * åˆ‡æ¢åˆ°è‡ªåŠ¨ä¸»é¢˜
   */
  private setAutoTheme(): void {
    console.log('ThemeToggle: setAutoTheme called')
    console.log('ThemeToggle: Before - ThemeState currentTheme:', this.themeState.currentTheme)
    console.log('ThemeToggle: Before - ThemeManager currentTheme:', ThemeManager.getCurrentTheme())

    const currentTheme = this.themeState.currentTheme
    const newTheme: ThemeConfig = {
      type: ThemeType.AUTO,
      name: currentTheme.name,
      isDark: false
    }

    console.log('ThemeToggle: New theme config:', newTheme)
    console.log('ThemeToggle: Calling ThemeManager.setTheme...')

    ThemeManager.setTheme(newTheme)

    console.log('ThemeToggle: After ThemeManager.setTheme - ThemeManager currentTheme:', ThemeManager.getCurrentTheme())
    console.log('ThemeToggle: Calling ThemeState.setTheme...')

    this.themeState.setTheme(newTheme)

    console.log('ThemeToggle: After ThemeState.setTheme - ThemeState currentTheme:', this.themeState.currentTheme)
    console.log('ThemeToggle: After ThemeState.setTheme - ThemeManager currentTheme:', ThemeManager.getCurrentTheme())

    this.refreshTheme()

    // è°ƒç”¨çˆ¶ç»„ä»¶çš„å›žè°ƒ
    if (this.onThemeChanged) {
      console.log('ThemeToggle: Calling onThemeChanged callback')
      this.onThemeChanged()
    }

    console.log('ThemeToggle: Auto theme set completed')
    console.log('ThemeToggle: Final check - currentThemeType:', this.currentThemeType)
  }

  /**
   * æž„å»ºæŒ‰é’®å¼ä¸»é¢˜åˆ‡æ¢
   */
  @Builder
  private buildButtonStyle() {
    Row({ space: 8 }) {
      // æµ…è‰²ä¸»é¢˜æŒ‰é’®
      Button() {
        Row({ space: 6 }) {
          Text('â˜€ï¸')
            .fontSize(16)
            .fontColor(this.currentThemeType === ThemeType.LIGHT ? '#FFFFFF' : '#666666')

          if (this.showText) {
            Text('æµ…è‰²')
              .fontSize(14)
              .fontColor(this.currentThemeType === ThemeType.LIGHT ? '#FFFFFF' : '#666666')
          }
        }
      }
      .height(this.toggleSize === 'small' ? 32 : this.toggleSize === 'large' ? 48 : 40)
      .padding({
        left: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
        right: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
        top: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8,
        bottom: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8
      })
      .backgroundColor(this.currentThemeType === ThemeType.LIGHT ? ThemeManager.getCurrentPrimaryColor() : Color.Transparent)
      .border({
        width: this.currentThemeType === ThemeType.LIGHT ? 0 : 1,
        color: ThemeManager.getCurrentBorderColor()
      })
      .borderRadius(20)
      .onClick(() => this.setLightTheme())

      // æ·±è‰²ä¸»é¢˜æŒ‰é’®
      Button() {
        Row({ space: 6 }) {
          Text('ðŸŒ™')
            .fontSize(16)
            .fontColor(this.currentThemeType === ThemeType.DARK ? '#FFFFFF' : '#666666')

          if (this.showText) {
            Text('æ·±è‰²')
              .fontSize(14)
              .fontColor(this.currentThemeType === ThemeType.DARK ? '#FFFFFF' : '#666666')
          }
        }
      }
      .height(this.toggleSize === 'small' ? 32 : this.toggleSize === 'large' ? 48 : 40)
      .padding({
        left: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
        right: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
        top: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8,
        bottom: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8
      })
      .backgroundColor(this.currentThemeType === ThemeType.DARK ? ThemeManager.getCurrentPrimaryColor() : Color.Transparent)
      .border({
        width: this.currentThemeType === ThemeType.DARK ? 0 : 1,
        color: ThemeManager.getCurrentBorderColor()
      })
      .borderRadius(20)
      .onClick(() => this.setDarkTheme())

      // è‡ªåŠ¨ä¸»é¢˜æŒ‰é’®
      if (this.style === 'button') {
        Button() {
          Row({ space: 6 }) {
            Text('ðŸ”„')
              .fontSize(16)
              .fontColor(this.currentThemeType === ThemeType.AUTO ? '#FFFFFF' : '#666666')

            if (this.showText) {
              Text('è‡ªåŠ¨')
                .fontSize(14)
                .fontColor(this.currentThemeType === ThemeType.AUTO ? '#FFFFFF' : '#666666')
            }
          }
        }
        .height(this.toggleSize === 'small' ? 32 : this.toggleSize === 'large' ? 48 : 40)
        .padding({
          left: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
          right: this.toggleSize === 'small' ? 8 : this.toggleSize === 'large' ? 20 : 12,
          top: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8,
          bottom: this.toggleSize === 'small' ? 4 : this.toggleSize === 'large' ? 12 : 8
        })
        .backgroundColor(this.currentThemeType === ThemeType.AUTO ? ThemeManager.getCurrentPrimaryColor() : Color.Transparent)
        .border({
          width: this.currentThemeType === ThemeType.AUTO ? 0 : 1,
          color: ThemeManager.getCurrentBorderColor()
        })
        .borderRadius(20)
        .onClick(() => this.setAutoTheme())
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
  }

  /**
   * æž„å»ºå¼€å…³å¼ä¸»é¢˜åˆ‡æ¢
   */
  @Builder
  private buildSwitchStyle() {
    Row({ space: 16 }) {
      // ä¸»é¢˜æ ‡ç­¾
      Column() {
        Text('ä¸»é¢˜æ¨¡å¼')
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentTextColor())
          .margin({ bottom: 8 })

        Text(this.currentThemeType === ThemeType.LIGHT ? 'æµ…è‰²' :
               this.currentThemeType === ThemeType.DARK ? 'æ·±è‰²' : 'è·Ÿéšç³»ç»Ÿ')
          .fontSize(12)
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      // ä¸»é¢˜åˆ‡æ¢å¼€å…³
      Row() {
        // æµ…è‰²ä¸»é¢˜é€‰é¡¹
        Row({ space: 8 }) {
          Text('â˜€ï¸')
            .fontSize(20)
            .fontColor(this.currentThemeType === ThemeType.LIGHT ? AppColors.primary : '#999999')

          Text('æµ…è‰²')
            .fontSize(16)
            .fontColor(ThemeManager.getCurrentTextColor())
        }
        .layoutWeight(1)
        .onClick(() => this.setLightTheme())

        // æ·±è‰²ä¸»é¢˜é€‰é¡¹
        Row({ space: 8 }) {
          Text('ðŸŒ™')
            .fontSize(20)
            .fontColor(this.currentThemeType === ThemeType.DARK ? AppColors.primary : '#999999')

          Text('æ·±è‰²')
            .fontSize(16)
            .fontColor(ThemeManager.getCurrentTextColor())
        }
        .layoutWeight(1)
        .onClick(() => this.setDarkTheme())
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(ThemeManager.getCurrentSurfaceColor())
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: ThemeManager.getCurrentShadowColor(),
      offsetX: 0,
      offsetY: 2
    })
  }

  build() {
    if (this.style === 'switch') {
      this.buildSwitchStyle()
    } else {
      this.buildButtonStyle()
    }
  }
}