/**
 * è®¾ç½®é¡µé¢
 * æä¾›åº”ç”¨çš„å„ç§è®¾ç½®é€‰é¡¹ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€å­˜å‚¨ã€å…³äºç­‰åŠŸèƒ½
 */

import { BottomNavigation } from '../../components/common/BottomNavigation'
import { SVGIcon } from '../../components/icons/SVGIcon'
import router from '@ohos.router'
import { ThemeManager } from '../../theme/ThemeManager'

interface SettingItem {
  title: string
  subtitle?: string
  icon: string
  iconName?: string // æ–°å¢ï¼šSVGå›¾æ ‡åç§°
  onPress: () => void
}

@Entry
@Component
struct SettingsPage {
  @State private isDarkMode: boolean = false
  @State private storageUsed: string = '125.6 MB'
  @State private photoCount: number = 156
  @State private version: string = '1.0.0'

  // ä¸»é¢˜ç›¸å…³çŠ¶æ€
  @State private themeRefreshTrigger: number = 0
  @State private currentBgColor: string = '#FFFFFF'
  @State private currentTextColor: string = '#262626'
  @State private currentSurfaceColor: string = '#FFFFFF'
  @State private currentPrimaryColor: string = '#1890FF'

  private settingsList: SettingItem[] = [
    {
      title: 'ä¸»é¢˜è®¾ç½®',
      subtitle: 'åˆ‡æ¢æµ…è‰²/æ·±è‰²ä¸»é¢˜',
      icon: 'ğŸ¨',
      iconName: 'palette',
      onPress: () => {
        this.navigateToTheme()
      }
    },
    {
      title: 'å­˜å‚¨ç®¡ç†',
      subtitle: `å·²ä½¿ç”¨ ${this.storageUsed}`,
      icon: 'ğŸ“±',
      iconName: 'photo',
      onPress: () => {
        console.log('Storage management clicked')
      }
    },
    {
      title: 'ç›¸æœºè®¾ç½®',
      subtitle: 'ç…§ç‰‡è´¨é‡ã€æ°´å°é…ç½®',
      icon: 'ğŸ“¸',
      iconName: 'camera',
      onPress: () => {
        console.log('Camera settings clicked')
      }
    },
    {
      title: 'å…³äºåº”ç”¨',
      subtitle: `ç‰ˆæœ¬ ${this.version}`,
      icon: 'â„¹ï¸',
      iconName: 'info-circle',
      onPress: () => {
        this.navigateToAbout()
      }
    }
  ]

  /**
   * åˆ·æ–°ä¸»é¢˜é¢œè‰²
   */
  private refreshThemeColors(): void {
    console.log('SettingsPage: Refreshing theme colors...')
    this.currentBgColor = ThemeManager.getCurrentBgColor()
    this.currentTextColor = ThemeManager.getCurrentTextColor()
    this.currentSurfaceColor = ThemeManager.getCurrentSurfaceColor()
    this.currentPrimaryColor = ThemeManager.getCurrentPrimaryColor()
    this.themeRefreshTrigger++
    console.log('SettingsPage: Theme colors updated - Bg:', this.currentBgColor, 'Text:', this.currentTextColor)
  }

  aboutToAppear(): void {
    console.log('SettingsPage aboutToAppear')
    this.refreshThemeColors()
  }

  onPageShow(): void {
    console.log('SettingsPage onPageShow - checking theme updates')
    this.refreshThemeColors()
  }

  private navigateToTheme(): void {
    try {
      router.replaceUrl({
        url: 'pages/settings/themePage',
        params: {}
      }).catch((error: Error) => {
        console.error('Navigate to theme page failed:', error)
      })
    } catch (error) {
      console.error('Navigation to theme page failed with exception:', error)
    }
  }

  private navigateToAbout(): void {
    try {
      router.replaceUrl({
        url: 'pages/about/AboutPage',
        params: {}
      }).catch((error: Error) => {
        console.error('Navigate to about page failed:', error)
      })
    } catch (error) {
      console.error('Navigation to about page failed with exception:', error)
    }
  }

  build() {
    Column() {
      // å¼ºåˆ¶ä¾èµ–ä¸»é¢˜è§¦å‘å™¨ä»¥ç¡®ä¿é‡æ–°æ¸²æŸ“
      if (this.themeRefreshTrigger >= 0) {
        // å¤´éƒ¨
        Row() {
          Text('è®¾ç½®')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTextColor)
            .layoutWeight(1)
            .textAlign(TextAlign.Start)

          Blank()
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor(this.currentSurfaceColor)
      } else {
        // å¤´éƒ¨
        Row() {
          Text('è®¾ç½®')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTextColor)
            .layoutWeight(1)
            .textAlign(TextAlign.Start)

          Blank()
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor(this.currentSurfaceColor)
      }

      // è®¾ç½®é¡¹åˆ—è¡¨
      Scroll() {
        Column({ space: 1 }) {
          // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
          Column() {
            Row() {
              SVGIcon({ iconName: 'user', iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
                .margin({ right: 12 })

              Column() {
                Text('å·¥ç¨‹å¸ˆ')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#262626')
                Text('ç®¡ç†å‘˜')
                  .fontSize(14)
                  .fontColor('#8C8C8C')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor('#C0C0C0')
            }
            .width('100%')
            .padding(16)
            .alignItems(VerticalAlign.Center)
          }
          .backgroundColor('#FFFFFF')
          .onClick(() => {
            console.log('User profile clicked')
          })

          // ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ
          Column() {
            Row() {
                SVGIcon({ iconName: 'database', iconSize: 20, iconColor: '#1890FF', iconStrokeWidth: 2 })
                  .margin({ right: 8 })
                Text('ä½¿ç”¨ç»Ÿè®¡')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#262626')
              }
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            Row() {
              Column() {
                Text(this.photoCount.toString())
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#1890FF')
                Text('ç…§ç‰‡')
                  .fontSize(12)
                  .fontColor('#8C8C8C')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)

              Column() {
                Text('12')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#52C41A')
                Text('å·¥ç¨‹')
                  .fontSize(12)
                  .fontColor('#8C8C8C')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)

              Column() {
                Text('28')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FAAD14')
                Text('å·¥ç‚¹')
                  .fontSize(12)
                  .fontColor('#8C8C8C')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceAround)
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')

          // è®¾ç½®é€‰é¡¹
          ForEach(this.settingsList, (item: SettingItem) => {
            Column() {
              Row() {
                // ä½¿ç”¨SVGå›¾æ ‡æˆ–fallbackåˆ°emoji
                if (item.iconName) {
                  SVGIcon({ iconName: item.iconName, iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
                    .margin({ right: 12 })
                } else {
                  Text(item.icon)
                    .fontSize(24)
                    .margin({ right: 12 })
                }

                Column() {
                  Text(item.title)
                    .fontSize(16)
                    .fontColor('#262626')
                  if (item.subtitle) {
                    Text(item.subtitle)
                      .fontSize(14)
                      .fontColor('#8C8C8C')
                      .margin({ top: 2 })
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor('#C0C0C0')
              }
              .width('100%')
              .padding(16)
              .alignItems(VerticalAlign.Center)
            }
            .backgroundColor('#FFFFFF')
            .onClick(() => {
              item.onPress()
            })
          })

          // ç‰ˆæœ¬ä¿¡æ¯
          Column() {
            Text(`Engineering Camera v${this.version}`)
              .fontSize(14)
              .fontColor('#8C8C8C')
              .textAlign(TextAlign.Center)
            Text('Â© 2024 å·¥ç¨‹æ‹è®°å›¢é˜Ÿ')
              .fontSize(12)
              .fontColor('#C0C0C0')
              .textAlign(TextAlign.Center)
              .margin({ top: 4 })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .margin({ top: 20 })
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavigation({
        currentPage: 'pages/settings/SettingsPlaceholderPage'
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
