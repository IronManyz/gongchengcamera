/**
 * ËÆæÁΩÆ‰∏ªÈ°µÈù¢
 * Êèê‰æõÂ∫îÁî®ËÆæÁΩÆ‰∏ªÁïåÈù¢ÔºåÂåÖÊã¨ËÆæÁΩÆÈ°πÂàÜÁ±ª„ÄÅÂØºËà™ÂíåÁä∂ÊÄÅÊåÅ‰πÖÂåñ
 */

import router from '@ohos.router'
import { bundleManager } from '@kit.AbilityKit'
import { Logger } from '../../utils/Logger'
import { EnhancedSVGIcon } from '../../components/icons/EnhancedSVGIcon'
import { themeStore as themeStoreInstance } from '../../store/theme/ThemeStore'
import { userStore as userStoreInstance } from '../../store/user/UserStore'
import { LoadingDialog } from '../../components/common/LoadingDialog'
import { ConfirmDialog } from '../../components/common/ConfirmDialog'
import { ThemeType } from '../../store/theme/ThemeConstants'
import { projectStore } from '../../store/project/ProjectStore'
import { ProjectStats } from '../../services/database/ProjectService'

/**
 * ËÆæÁΩÆÈ°πÊé•Âè£
 */
interface SettingsItem {
  id: string
  title: string
  subtitle?: string
  icon?: Resource
  type: 'navigation' | 'switch' | 'action' | 'info'
  value?: any
  action?: () => void
  page?: string
}

/**
 * ËÆæÁΩÆÂàÜÁªÑÊé•Âè£
 */
interface SettingsGroup {
  title: string
  items: SettingsItem[]
}

interface UsageOverview {
  totalProjects: number
  activeProjects: number
  totalPhotos: number
  totalSites: number
}

@Entry
@Component
struct SettingsPage {
  private logger = new Logger('SettingsPage')
  private themeStore = themeStoreInstance
  private userStore = userStoreInstance

  // Áä∂ÊÄÅÁÆ°ÁêÜ
  @State private isLoading: boolean = false
  @State private settingsGroups: SettingsGroup[] = []
  @State private showAboutDialog: boolean = false
  @State private showResetDialog: boolean = false
  @State private showThemeDialog: boolean = false
  @State private showCameraQualityDialog: boolean = false
  @State private showHelpDialog: boolean = false
  @State private usageStats: UsageOverview = this.createDefaultUsageStats()
  @State private isUsageLoading: boolean = false
  @State private appVersion: string = '1.0.0'
  @State private buildNumber: string = ''
  @State private pendingTheme: ThemeType = ThemeType.SYSTEM
  @State private pendingPhotoQuality: 'high' | 'medium' | 'low' = 'high'

  aboutToAppear() {
    this.logger.info('SettingsPage appeared')
    this.initializeSettings()
  }

  aboutToDisappear() {
    this.logger.info('SettingsPage disappeared')
  }

  private createDefaultUsageStats(): UsageOverview {
    return {
      totalProjects: 0,
      activeProjects: 0,
      totalPhotos: 0,
      totalSites: 0
    }
  }

  /**
   * ÂàùÂßãÂåñËÆæÁΩÆÈ°π
   */
  private async initializeSettings() {
    this.isLoading = true
    try {
      if (!this.themeStore.isInitialized) {
        await this.themeStore.initialize()
      }
      if (!this.userStore.isInitialized) {
        await this.userStore.initialize()
      }
      if (!projectStore.isInitialized) {
        await projectStore.initialize()
      }

      await this.loadSettingsData()
      await this.loadUsageStats()
      await this.loadAppInfo()
    } catch (error) {
      this.logger.error('ÂàùÂßãÂåñËÆæÁΩÆÂ§±Ë¥•', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ
   */
  private async loadSettingsData() {
    const preferences = this.userStore.userState.preferences
    const themeState = this.themeStore.themeState

    this.pendingTheme = themeState.currentTheme
    this.pendingPhotoQuality = preferences.photoQuality

    this.settingsGroups = [
      {
        title: 'ÈÄöÁî®ËÆæÁΩÆ',
        items: [
          {
            id: 'theme',
            title: '‰∏ªÈ¢òËÆæÁΩÆ',
            subtitle: this.getThemeText(themeState.currentTheme),
            icon: $r('app.media.ic_theme'),
            type: 'action',
            action: () => this.showThemeDialog = true
          },
          {
            id: 'language',
            title: 'ËØ≠Ë®ÄËÆæÁΩÆ',
            subtitle: 'ÁÆÄ‰Ωì‰∏≠Êñá',
            icon: $r('app.media.ic_language'),
            type: 'navigation',
            page: 'pages/settings/LanguagePage'
          },
          {
            id: 'notification',
            title: 'ÈÄöÁü•ËÆæÁΩÆ',
            subtitle: 'ÁÆ°ÁêÜÂ∫îÁî®ÈÄöÁü•',
            icon: $r('app.media.ic_notification'),
            type: 'navigation',
            page: 'pages/settings/NotificationPage'
          }
        ]
      },
      {
        title: 'Áõ∏Êú∫ËÆæÁΩÆ',
        items: [
          {
            id: 'camera_quality',
            title: 'ÁÖßÁâáË¥®Èáè',
            subtitle: this.getPhotoQualityText(preferences.photoQuality),
            icon: $r('app.media.ic_camera'),
            type: 'action',
            action: () => this.showCameraQualityDialog = true
          },
          {
            id: 'watermark',
            title: 'Ê∞¥Âç∞ËÆæÁΩÆ',
            subtitle: 'ÈÖçÁΩÆÈªòËÆ§Ê∞¥Âç∞',
            icon: $r('app.media.ic_watermark'),
            type: 'navigation',
            page: 'pages/settings/WatermarkSettingsPage'
          },
          {
            id: 'location',
            title: '‰ΩçÁΩÆÊúçÂä°',
            subtitle: preferences.enableLocationService ? 'Ëá™Âä®ËÆ∞ÂΩï‰ΩçÁΩÆ‰ø°ÊÅØ' : '‰ΩçÁΩÆÊúçÂä°Â∑≤ÂÖ≥Èó≠',
            icon: $r('app.media.ic_location'),
            type: 'switch',
            value: preferences.enableLocationService,
            action: () => this.toggleLocationService()
          }
        ]
      },
      {
        title: 'Êï∞ÊçÆÁÆ°ÁêÜ',
        items: [
          {
            id: 'database',
            title: 'Êï∞ÊçÆÂ∫ìÁÆ°ÁêÜ',
            subtitle: 'ÁÆ°ÁêÜÈ°πÁõÆ„ÄÅÁÖßÁâáÊï∞ÊçÆ',
            icon: $r('app.media.ic_database'),
            type: 'navigation',
            page: 'pages/settings/DatabasePage'
          },
          {
            id: 'backup',
            title: 'Â§á‰ªΩÁÆ°ÁêÜ',
            subtitle: 'Êï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç',
            icon: $r('app.media.ic_backup'),
            type: 'navigation',
            page: 'pages/settings/BackupPage'
          },
          {
            id: 'storage',
            title: 'Â≠òÂÇ®Á©∫Èó¥',
            subtitle: 'Êü•ÁúãÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ',
            icon: $r('app.media.ic_storage'),
            type: 'navigation',
            page: 'pages/settings/StoragePage'
          }
        ]
      },
      {
        title: 'ÈöêÁßÅ‰∏éÂÆâÂÖ®',
        items: [
          {
            id: 'privacy',
            title: 'ÈöêÁßÅËÆæÁΩÆ',
            subtitle: 'ÁÆ°ÁêÜÊï∞ÊçÆÊùÉÈôê',
            icon: $r('app.media.ic_privacy'),
            type: 'navigation',
            page: 'pages/settings/PrivacyPage'
          },
          {
            id: 'security',
            title: 'ÂÆâÂÖ®ËÆæÁΩÆ',
            subtitle: 'Â∫îÁî®ÂÆâÂÖ®ÈÖçÁΩÆ',
            icon: $r('app.media.ic_security'),
            type: 'navigation',
            page: 'pages/settings/SecurityPage'
          },
          {
            id: 'biometric',
            title: 'ÁîüÁâ©ËØÜÂà´',
            subtitle: 'ÊåáÁ∫π„ÄÅÈù¢ÈÉ®ËØÜÂà´',
            icon: $r('app.media.ic_biometric'),
            type: 'switch',
            value: false,
            action: () => this.toggleBiometric()
          }
        ]
      },
      {
        title: 'ÂÖ≥‰∫éÂ∫îÁî®',
        items: [
          {
            id: 'about',
            title: 'ÂÖ≥‰∫éÂ∫îÁî®',
            subtitle: `ÁâàÊú¨ ${this.appVersion}${this.buildNumber ? ` (${this.buildNumber})` : ''}`,
            icon: $r('app.media.ic_about'),
            type: 'action',
            action: () => this.showAboutDialog = true
          },
          {
            id: 'feedback',
            title: 'ÊÑèËßÅÂèçÈ¶à',
            subtitle: 'Êèê‰∫§ÈóÆÈ¢òÂíåÂª∫ËÆÆ',
            icon: $r('app.media.ic_feedback'),
            type: 'navigation',
            page: 'pages/settings/FeedbackPage'
          },
          {
            id: 'help',
            title: 'Â∏ÆÂä©‰∏≠ÂøÉ',
            subtitle: '‰ΩøÁî®ÊåáÂçóÂíåÂ∏∏ËßÅÈóÆÈ¢ò',
            icon: $r('app.media.ic_help'),
            type: 'action',
            action: () => this.showHelpDialog = true
          }
        ]
      },
      {
        title: 'È´òÁ∫ßËÆæÁΩÆ',
        items: [
          {
            id: 'developer',
            title: 'ÂºÄÂèëËÄÖÈÄâÈ°π',
            subtitle: 'Ë∞ÉËØïÂíåÂºÄÂèëÂ∑•ÂÖ∑',
            icon: $r('app.media.ic_developer'),
            type: 'navigation',
            page: 'pages/settings/DeveloperPage'
          },
          {
            id: 'reset',
            title: 'ÈáçÁΩÆËÆæÁΩÆ',
            subtitle: 'ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ',
            icon: $r('app.media.ic_reset'),
            type: 'action',
            action: () => this.showResetDialog = true
          }
        ]
      }
    ]
  }

  private async loadUsageStats() {
    this.isUsageLoading = true
    try {
      if (!projectStore.isInitialized) {
        await projectStore.initialize()
      }

      const stats: ProjectStats | null = projectStore.projectStats
      if (stats) {
        this.usageStats = {
          totalProjects: stats.totalProjects,
          activeProjects: stats.activeProjects,
          totalPhotos: stats.totalPhotos,
          totalSites: stats.totalSites
        }
      } else {
        this.usageStats = this.createDefaultUsageStats()
      }
    } catch (error) {
      this.logger.error('Âä†ËΩΩ‰ΩøÁî®ÁªüËÆ°Â§±Ë¥•', error)
      this.usageStats = this.createDefaultUsageStats()
    } finally {
      this.isUsageLoading = false
    }
  }

  private async loadAppInfo() {
    try {
      const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION)
      this.appVersion = bundleInfo?.versionName || this.appVersion
      this.buildNumber = bundleInfo?.versionCode ? bundleInfo.versionCode.toString() : this.buildNumber
    } catch (error) {
      this.logger.error('Ëé∑ÂèñÂ∫îÁî®‰ø°ÊÅØÂ§±Ë¥•', error)
    }
  }

  /**
   * Ëé∑Âèñ‰∏ªÈ¢òÊñáÊú¨
   */
  private getThemeText(theme: ThemeType): string {
    switch (theme) {
      case ThemeType.LIGHT:
        return 'ÊµÖËâ≤‰∏ªÈ¢ò'
      case ThemeType.DARK:
        return 'Ê∑±Ëâ≤‰∏ªÈ¢ò'
      case ThemeType.SYSTEM:
        return 'Ë∑üÈöèÁ≥ªÁªü'
      default:
        return 'Ë∑üÈöèÁ≥ªÁªü'
    }
  }

  private getPhotoQualityText(quality: 'high' | 'medium' | 'low'): string {
    switch (quality) {
      case 'high':
        return 'È´òË¥®Èáè'
      case 'medium':
        return 'Ê†áÂáÜË¥®Èáè'
      case 'low':
        return 'ËäÇÁúÅÂ≠òÂÇ®'
      default:
        return 'Ê†áÂáÜË¥®Èáè'
    }
  }

  /**
   * ÂàáÊç¢‰ΩçÁΩÆÊúçÂä°
   */
  private async toggleLocationService() {
    try {
      if (!this.userStore.isInitialized) {
        await this.userStore.initialize()
      }
      const preferences = this.userStore.userState.preferences
      const targetValue = !preferences.enableLocationService
      await this.userStore.updatePreferences({ enableLocationService: targetValue })
      await this.loadSettingsData()
      this.logger.info(`‰ΩçÁΩÆÊúçÂä°Â∑≤${targetValue ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`)
    } catch (error) {
      this.logger.error('ÂàáÊç¢‰ΩçÁΩÆÊúçÂä°Â§±Ë¥•', error)
    }
  }

  /**
   * ÂàáÊç¢ÁîüÁâ©ËØÜÂà´
   */
  private async toggleBiometric() {
    try {
      // ÂÆûÁé∞ÁîüÁâ©ËØÜÂà´ÂàáÊç¢ÈÄªËæë
      this.logger.info('ÂàáÊç¢ÁîüÁâ©ËØÜÂà´')
    } catch (error) {
      this.logger.error('ÂàáÊç¢ÁîüÁâ©ËØÜÂà´Â§±Ë¥•', error)
    }
  }

  private async updatePhotoQuality(quality: 'high' | 'medium' | 'low') {
    try {
      if (!this.userStore.isInitialized) {
        await this.userStore.initialize()
      }
      await this.userStore.updatePreferences({ photoQuality: quality })
      this.pendingPhotoQuality = quality
      await this.loadSettingsData()
      this.showCameraQualityDialog = false
      this.logger.info(`ÁÖßÁâáË¥®ÈáèÂ∑≤ËÆæÁΩÆ‰∏∫: ${quality}`)
    } catch (error) {
      this.logger.error('Êõ¥Êñ∞ÁÖßÁâáË¥®ÈáèÂ§±Ë¥•', error)
    }
  }

  /**
   * ÈáçÁΩÆËÆæÁΩÆ
   */
  private async resetSettings() {
    try {
      // ÂÆûÁé∞ËÆæÁΩÆÈáçÁΩÆÈÄªËæë
      this.logger.info('ÈáçÁΩÆËÆæÁΩÆ')
      this.showResetDialog = false
    } catch (error) {
      this.logger.error('ÈáçÁΩÆËÆæÁΩÆÂ§±Ë¥•', error)
    }
  }

  private async applyTheme(theme: ThemeType) {
    try {
      if (!this.themeStore.isInitialized) {
        await this.themeStore.initialize()
      }
      await this.themeStore.setTheme(theme)
      this.pendingTheme = theme
      await this.loadSettingsData()
      this.showThemeDialog = false
      this.logger.info(`‰∏ªÈ¢òÂ∑≤ËÆæÁΩÆ‰∏∫: ${theme}`)
    } catch (error) {
      this.logger.error('ËÆæÁΩÆ‰∏ªÈ¢òÂ§±Ë¥•', error)
    }
  }

  /**
   * ÂØºËà™Âà∞ËÆæÁΩÆÈ°µÈù¢
   */
  private navigateToSettingsPage(page: string, item: SettingsItem) {
    router.pushUrl({
      url: page,
      params: {
        settingsId: item.id,
        settingsTitle: item.title
      }
    })
  }

  /**
   * Â§ÑÁêÜËÆæÁΩÆÈ°πÁÇπÂáª
   */
  private handleSettingsItemClick(item: SettingsItem) {
    switch (item.type) {
      case 'navigation':
        if (item.page) {
          this.navigateToSettingsPage(item.page, item)
        }
        break
      case 'action':
        if (item.action) {
          item.action()
        }
        break
      case 'switch':
        // ÂàáÊç¢ÂºÄÂÖ≥Áä∂ÊÄÅ
        if (item.action) {
          item.action()
        }
        break
      case 'info':
        // ÊòæÁ§∫‰ø°ÊÅØ
        break
    }
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      this.buildTopBar()

      // ËÆæÁΩÆÂàóË°®
      this.buildSettingsList()

      // ÂÖ≥‰∫éÂØπËØùÊ°Ü
      if (this.showAboutDialog) {
        this.buildAboutDialog()
      }

      if (this.showThemeDialog) {
        this.buildThemeDialog()
      }

      if (this.showCameraQualityDialog) {
        this.buildCameraQualityDialog()
      }

      if (this.showHelpDialog) {
        this.buildHelpDialog()
      }

      // ÈáçÁΩÆÁ°ÆËÆ§ÂØπËØùÊ°Ü
      if (this.showResetDialog) {
        ConfirmDialog({
          title: 'ÈáçÁΩÆËÆæÁΩÆ',
          message: 'Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',
          confirmText: 'ÈáçÁΩÆ',
          cancelText: 'ÂèñÊ∂à',
          onConfirm: () => this.resetSettings(),
          onCancel: () => this.showResetDialog = false
        })
      }

      // Âä†ËΩΩÂØπËØùÊ°Ü
      if (this.isLoading) {
        LoadingDialog({ message: 'Âä†ËΩΩ‰∏≠...' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * ÊûÑÂª∫È°∂ÈÉ®ÂØºËà™Ê†è
   */
  @Builder
  private buildTopBar() {
    Row() {
      // Ê†áÈ¢ò
      Text('ËÆæÁΩÆ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Start)

      // ÊêúÁ¥¢ÊåâÈíÆÔºàÂèØÈÄâÔºâ
      Button() {
        Image($r('app.media.ic_search'))
          .width(24)
          .height(24)
          .fillColor('#666666')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        // ÂÆûÁé∞ËÆæÁΩÆÊêúÁ¥¢ÂäüËÉΩ
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 2,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetX: 0,
      offsetY: 1
    })
  }

  /**
   * ÊûÑÂª∫ËÆæÁΩÆÂàóË°®
   */
  @Builder
  private buildSettingsList() {
    Scroll() {
      Column({ space: 16 }) {
        this.buildPersonalCenter()

        ForEach(
          this.settingsGroups,
          (group: SettingsGroup) => {
            this.buildSettingsGroup(group)
          },
          (group: SettingsGroup) => group.title
        )
      }
      .width('100%')
      .padding({ horizontal: 16, vertical: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  /**
   * ÊûÑÂª∫‰∏™‰∫∫‰∏≠ÂøÉ
   */
  @Builder
  private buildPersonalCenter() {
    Column({ space: 16 }) {
      // Áî®Êà∑‰ø°ÊÅØÂç°Áâá
      Row({ space: 16 }) {
        // Áî®Êà∑Â§¥ÂÉè
        Column() {
          EnhancedSVGIcon({ iconName: 'user', iconSize: 48, iconColor: '#1890FF', iconStrokeWidth: 2 })
            .width(64)
            .height(64)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor('#E6F4FF')
            .borderRadius(32)
        }
        .width(64)
        .height(64)

        // Áî®Êà∑‰ø°ÊÅØ
        Column({ space: 4 }) {
          Text('Â∑•Á®ãÂ∏à')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          Text('‰∏ì‰∏öÂ∑•Á®ãÊãçÊëÑ‰∏éÁÆ°ÁêÜ')
            .fontSize(14)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)

          Row({ space: 8 }) {
            Text('È´òÁ∫ßÁî®Êà∑')
              .fontSize(12)
              .fontColor('#1890FF')
              .backgroundColor('#E6F4FF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(8)

            Text('Â∑≤ËÆ§ËØÅ')
              .fontSize(12)
              .fontColor('#52C41A')
              .backgroundColor('#F6FFED')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(8)
          }
          .alignSelf(ItemAlign.Start)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: 'rgba(0, 0, 0, 0.08)',
        offsetX: 0,
        offsetY: 2
      })

      // ‰∏™‰∫∫ÁªüËÆ°‰ø°ÊÅØ
      Row({ space: 12 }) {
        Column({ space: 8 }) {
          Text(this.usageStats.totalProjects.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1890FF')

          Text('È°πÁõÆÊï∞')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(64)
        .height(64)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F0F8FF')
        .borderRadius(8)

        Column({ space: 8 }) {
          Text(this.usageStats.totalPhotos.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#52C41A')

          Text('ÁÖßÁâáÊï∞')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(64)
        .height(64)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F0FFF0')
        .borderRadius(8)

        Column({ space: 8 }) {
          Text(this.usageStats.totalSites.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FAAD14')

          Text('Â∑•ÁÇπÊï∞')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(64)
        .height(64)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#FFFAF0')
        .borderRadius(8)

        Column({ space: 8 }) {
          Text('100%')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#722ED1')

          Text('ÂÆåÊàêÁéá')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width(64)
        .height(64)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F8F0FF')
        .borderRadius(8)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // Âø´Êç∑Êìç‰Ωú
      Row({ space: 12 }) {
        Button() {
          Column({ space: 4 }) {
            EnhancedSVGIcon({ iconName: 'database', iconSize: 28, iconColor: '#FFFFFF', iconStrokeWidth: 2 })
            Text('Êï∞ÊçÆÂàÜÊûê')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
        .width(80)
        .height(60)
        .backgroundColor('#1890FF')
        .borderRadius(8)
        .onClick(() => {
          // TODO: ÂØºËà™Âà∞Êï∞ÊçÆÂàÜÊûêÈ°µÈù¢
        })

        Button() {
          Column({ space: 4 }) {
            Text('‚≠ê')
              .fontSize(20)
            Text('ÊàëÁöÑÊî∂Ëóè')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
        .width(80)
        .height(60)
        .backgroundColor('#52C41A')
        .borderRadius(8)
        .onClick(() => {
          // TODO: ÂØºËà™Âà∞Êî∂ËóèÈ°µÈù¢
        })

        Button() {
          Column({ space: 4 }) {
            Text('üìù')
              .fontSize(20)
            Text('‰ΩøÁî®Êó•Âøó')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
        .width(80)
        .height(60)
        .backgroundColor('#FAAD14')
        .borderRadius(8)
        .onClick(() => {
          // TODO: ÂØºËà™Âà∞‰ΩøÁî®Êó•ÂøóÈ°µÈù¢
        })

        Button() {
          Column({ space: 4 }) {
            Text('üèÜ')
              .fontSize(20)
            Text('ÊàêÂ∞±ÂããÁ´†')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
        }
        .width(80)
        .height(60)
        .backgroundColor('#722ED1')
        .borderRadius(8)
        .onClick(() => {
          // TODO: ÂØºËà™Âà∞ÊàêÂ∞±È°µÈù¢
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ‰∏™ÊÄßËÆæÁΩÆ
      Column({ space: 12 }) {
        Row() {
          Text('‰∏™ÊÄßËÆæÁΩÆ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#666666')
          Blank()
          Text('ÁºñËæëËµÑÊñô')
            .fontSize(12)
            .fontColor('#1890FF')
            .onClick(() => {
              // TODO: ÂØºËà™Âà∞ÁºñËæëËµÑÊñôÈ°µÈù¢
            })
        }
        .width('100%')

        Row({ space: 12 }) {
          Column() {
            EnhancedSVGIcon({ iconName: 'palette', iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
            Text('‰∏ªÈ¢ò')
              .fontSize(12)
              .fontColor('#666666')
          }
          .width(60)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          Column() {
            EnhancedSVGIcon({ iconName: 'photo', iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
            Text('Â∏ÉÂ±Ä')
              .fontSize(12)
              .fontColor('#666666')
          }
          .width(60)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          Column() {
            Text('üîî')
              .fontSize(16)
            Text('ÈÄöÁü•')
              .fontSize(12)
              .fontColor('#666666')
          }
          .width(60)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          Column() {
            EnhancedSVGIcon({ iconName: 'cloud-storage', iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
            Text('‰∫ëÁ´Ø')
              .fontSize(12)
              .fontColor('#666666')
          }
          .width(60)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          Column() {
            EnhancedSVGIcon({ iconName: 'shield', iconSize: 24, iconColor: '#1890FF', iconStrokeWidth: 2 })
            Text('ÈöêÁßÅ')
              .fontSize(12)
              .fontColor('#666666')
          }
          .width(60)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F8F8F8')
          .borderRadius(8)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: 'rgba(0, 0, 0, 0.08)',
        offsetX: 0,
        offsetY: 2
      })
    }
    .width('100%')
  }

  /**
   * ÊûÑÂª∫ËÆæÁΩÆÂàÜÁªÑ
   */
  @Builder
  private buildSettingsGroup(group: SettingsGroup) {
    Column({ space: 0 }) {
      // ÂàÜÁªÑÊ†áÈ¢ò
      if (group.title) {
        Row() {
          Text(group.title)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#666666')
        }
        .width('100%')
        .padding({ left: 16, bottom: 8 })
        .alignItems(VerticalAlign.Center)
      }

      // ÂàÜÁªÑÂÜÖÂÆπ
      Column() {
        ForEach(
          group.items,
          (item: SettingsItem, index: number) => {
            this.buildSettingsItem(item, index === group.items.length - 1)
          },
          (item: SettingsItem) => item.id
        )
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({
        radius: 4,
        color: 'rgba(0, 0, 0, 0.08)',
        offsetX: 0,
        offsetY: 2
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  /**
   * ÊûÑÂª∫ËÆæÔøΩÔøΩÔøΩÈ°π
   */
  @Builder
  private buildSettingsItem(item: SettingsItem, isLast: boolean) {
    Row() {
      // ÂõæÊ†á
      if (item.icon) {
        Image(item.icon)
          .width(24)
          .height(24)
          .fillColor('#666666')
          .margin({ right: 12 })
      }

      // Ê†áÈ¢òÂíåÂâØÊ†áÈ¢ò
      Column({ space: 4 }) {
        Text(item.title)
          .fontSize(16)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (item.subtitle) {
          Text(item.subtitle)
            .fontSize(14)
            .fontColor('#999999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // Âè≥‰æßÂÜÖÂÆπ
      if (item.type === 'switch') {
        Toggle({ type: ToggleType.Switch, isOn: item.value })
          .selectedColor('#007AFF')
          .switchPointColor('#FFFFFF')
          .onChange((isOn: boolean) => {
            item.value = isOn
            if (item.action) {
              item.action()
            }
          })
      } else if (item.type === 'navigation' || item.type === 'action') {
        Image($r('app.media.ic_arrow_right'))
          .width(16)
          .height(16)
          .fillColor('#CCCCCC')
      }
    }
    .width('100%')
    .height(56)
    .padding({ horizontal: 16, vertical: 8 })
    .onClick(() => this.handleSettingsItemClick(item))

    if (!isLast) {
      Divider()
        .width('100%')
        .margin({ left: 52 })
        .color('#F0F0F0')
    }
  }

  /**
   * ÊûÑÂª∫‰∏ªÈ¢òÈÄâÊã©ÂØπËØùÊ°Ü
   */
  @Builder
  private buildThemeDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.35)')
        .onClick(() => this.showThemeDialog = false)

      Column({ space: 16 }) {
        Text('ÈÄâÊã©‰∏ªÈ¢ò')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Column({ space: 12 }) {
          const options: { label: string; value: ThemeType; description: string }[] = [
            { label: 'ÊµÖËâ≤Ê®°Âºè', value: ThemeType.LIGHT, description: 'ÈÄÇÂêàÊòé‰∫ÆÁéØÂ¢ÉÔºåÊèêÂçáÂèØËØªÊÄß' },
            { label: 'Ê∑±Ëâ≤Ê®°Âºè', value: ThemeType.DARK, description: 'ÈÄÇÂêàÂ§úÈó¥‰∏éÂº±ÂÖâÁéØÂ¢ÉÔºå‰øùÊä§ËßÜÂäõ' },
            { label: 'Ë∑üÈöèÁ≥ªÁªü', value: ThemeType.SYSTEM, description: 'Ëá™Âä®ÈÄÇÈÖçÁ≥ªÁªü‰∏ªÈ¢ò' }
          ]

          ForEach(
            options,
            (option) => {
              Column({ space: 6 }) {
                Row() {
                  Text(option.label)
                    .fontSize(16)
                    .fontColor('#262626')
                    .layoutWeight(1)

                  if (this.pendingTheme === option.value) {
                    Text('‚úì')
                      .fontSize(18)
                      .fontColor('#1890FF')
                  }
                }
                .width('100%')
                .onClick(() => this.applyTheme(option.value))

                Text(option.description)
                  .fontSize(12)
                  .fontColor('#8C8C8C')
                  .width('100%')
              }
              .width('100%')
              .padding({ vertical: 12, horizontal: 12 })
              .backgroundColor(this.pendingTheme === option.value ? '#EDF4FF' : '#F7F9FC')
              .borderRadius(12)
              .onClick(() => this.applyTheme(option.value))
            },
            (option) => option.value
          )
        }

        Button('ÂèñÊ∂à')
          .fontSize(16)
          .fontColor('#1890FF')
          .backgroundColor(Color.Transparent)
          .height(44)
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(22)
          .onClick(() => this.showThemeDialog = false)
      }
      .width('86%')
      .padding({ top: 24, bottom: 20, left: 20, right: 20 })
      .backgroundColor('#FFFFFF')
      .borderRadius(18)
      .shadow({
        radius: 18,
        color: 'rgba(0,0,0,0.2)',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(200)
  }

  /**
   * ÊûÑÂª∫ÁÖßÁâáË¥®ÈáèÈÄâÊã©ÂØπËØùÊ°Ü
   */
  @Builder
  private buildCameraQualityDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.35)')
        .onClick(() => this.showCameraQualityDialog = false)

      Column({ space: 16 }) {
        Text('ÁÖßÁâáË¥®Èáè')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Column({ space: 12 }) {
          const options: Array<{ label: string; value: 'high' | 'medium' | 'low'; description: string }> = [
            { label: 'È´òË¥®Èáè', value: 'high', description: 'ÊúÄÈ´òÁîªË¥®ÔºåÈÄÇÂêàÁ≤æÁªÜÂ∑•Á®ãËÆ∞ÂΩïÔºåÊñá‰ª∂ËæÉÂ§ß' },
            { label: 'Ê†áÂáÜË¥®Èáè', value: 'medium', description: 'ÁîªË¥®‰∏é‰ΩìÁßØÂπ≥Ë°°ÔºåÊé®ËçêÊó•Â∏∏‰ΩøÁî®' },
            { label: 'ËäÇÁúÅÂ≠òÂÇ®', value: 'low', description: 'Èôç‰ΩéÁîªË¥®Êç¢ÂèñÊúÄÂ∞è‰ΩìÁßØÔºåËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥' }
          ]

          ForEach(
            options,
            (option) => {
              Column({ space: 6 }) {
                Row() {
                  Text(option.label)
                    .fontSize(16)
                    .fontColor('#262626')
                    .layoutWeight(1)

                  if (this.pendingPhotoQuality === option.value) {
                    Text('‚úì')
                      .fontSize(18)
                      .fontColor('#1890FF')
                  }
                }
                .width('100%')
                .onClick(() => this.updatePhotoQuality(option.value))

                Text(option.description)
                  .fontSize(12)
                  .fontColor('#8C8C8C')
                  .width('100%')
              }
              .width('100%')
              .padding({ vertical: 12, horizontal: 12 })
              .backgroundColor(this.pendingPhotoQuality === option.value ? '#EDF4FF' : '#F7F9FC')
              .borderRadius(12)
              .onClick(() => this.updatePhotoQuality(option.value))
            },
            (option) => option.value
          )
        }

        Button('ÂèñÊ∂à')
          .fontSize(16)
          .fontColor('#1890FF')
          .backgroundColor(Color.Transparent)
          .height(44)
          .border({ width: 1, color: '#1890FF' })
          .borderRadius(22)
          .onClick(() => this.showCameraQualityDialog = false)
      }
      .width('86%')
      .padding({ top: 24, bottom: 20, left: 20, right: 20 })
      .backgroundColor('#FFFFFF')
      .borderRadius(18)
      .shadow({
        radius: 18,
        color: 'rgba(0,0,0,0.2)',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(210)
  }

  /**
   * Â∏ÆÂä©‰∏≠ÂøÉÂØπËØùÊ°Ü
   */
  @Builder
  private buildHelpDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.35)')
        .onClick(() => this.showHelpDialog = false)

      Column({ space: 16 }) {
        Text('‰ΩøÁî®Â∏ÆÂä©')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Column({ space: 10 }) {
          Text('Âø´ÈÄü‰∏äÊâã')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')
            .alignSelf(ItemAlign.Start)

          ForEach(
            [
              '1. Âú®‚ÄúÂ∑•Á®ã‚ÄùÈ°µÂàõÂª∫È°πÁõÆ‰∏éÂ∑•ÁÇπÔºåÂÆåÊàêÈ°πÁõÆÂü∫Á°Ä‰ø°ÊÅØ„ÄÇ',
              '2. ËøõÂÖ•‚ÄúÊãçÁÖß‚ÄùÂø´ÈÄüËÆ∞ÂΩïÁé∞Âú∫ÔºåÂπ∂Ëá™Âä®ÂÜôÂÖ•Ê∞¥Âç∞ÂíåÂÆö‰Ωç„ÄÇ', 
              '3. Âú®‚ÄúÁõ∏ÂÜå‚Äù‰∏≠Á≠õÈÄâ„ÄÅÁºñËæë„ÄÅÂØºÂá∫Â∑•Á®ãÁÖßÁâá„ÄÇ',
              '4. ËÆæÁΩÆÈ°µÂèØË∞ÉÊï¥‰∏ªÈ¢ò„ÄÅÊãçÁÖßË¥®Èáè„ÄÅÂ§á‰ªΩÁ≠ñÁï•Á≠â„ÄÇ'
            ],
            (tip) => {
              Text(tip)
                .fontSize(14)
                .fontColor('#666666')
                .width('100%')
                .textAlign(TextAlign.Start)
            },
            (tip) => tip
          )
        }

        Column({ space: 8 }) {
          Text('Êõ¥Â§öËµÑÊ∫ê')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')
            .alignSelf(ItemAlign.Start)

          ForEach(
            [
              '‚Ä¢ Áî®Êà∑ÊâãÂÜåÔºöËØ¶Ëß£‰∏ªË¶ÅÂäüËÉΩ‰∏éÊìç‰ΩúÊµÅÁ®ã',
              '‚Ä¢ Â∏∏ËßÅÈóÆÈ¢òÔºöÂø´ÈÄüÂÆö‰ΩçÂπ∂Ëß£ÂÜ≥Â∏∏ËßÅÁñëÈóÆ',
              '‚Ä¢ ËÅîÁ≥ªÊîØÊåÅÔºöÈÄöËøáÊÑèËßÅÂèçÈ¶à‰∏éÊàë‰ª¨ÂèñÂæóËÅîÁ≥ª'
            ],
            (item) => {
              Text(item)
                .fontSize(14)
                .fontColor('#666666')
                .width('100%')
                .textAlign(TextAlign.Start)
            },
            (item) => item
          )
        }

        Button('Áü•ÈÅì‰∫Ü')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .height(44)
          .borderRadius(22)
          .onClick(() => this.showHelpDialog = false)
      }
      .width('88%')
      .padding({ top: 24, bottom: 20, left: 20, right: 20 })
      .backgroundColor('#FFFFFF')
      .borderRadius(18)
      .shadow({
        radius: 18,
        color: 'rgba(0,0,0,0.2)',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(200)
  }

  /**
   * ÊûÑÂª∫ÂÖ≥‰∫éÂØπËØùÊ°Ü
   */
  @Builder
  private buildAboutDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.35)')
        .onClick(() => this.showAboutDialog = false)

      Column({ space: 20 }) {
        Image($r('app.media.app_icon'))
          .width(80)
          .height(80)
          .borderRadius(16)

        Column({ space: 8 }) {
          Text('Â∑•Á®ãÁõ∏Êú∫')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Text(`ÁâàÊú¨ ${this.appVersion}${this.buildNumber ? ` (${this.buildNumber})` : ''}`)
            .fontSize(16)
            .fontColor('#666666')

          Text('‰∏ì‰∏öÁöÑÂ∑•Á®ãÊãçÊëÑ‰∏éÁÆ°ÁêÜÂ∑•ÂÖ∑')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
        }

        Column({ space: 12 }) {
          Text('‰∏ªË¶ÅÂäüËÉΩ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          Column({ space: 8 }) {
            ForEach(
              [
                '‚Ä¢ È°πÁõÆ‰∏éÂ∑•ÁÇπÂÖ®ÊµÅÁ®ãÁÆ°ÁêÜ',
                '‚Ä¢ ‰∏ì‰∏öÊãçÁÖß‰∏éÊ∞¥Âç∞Ê®°Êùø',
                '‚Ä¢ ÁÖßÁâáÊ†áÊ≥®„ÄÅÊâπÂ§ÑÁêÜ‰∏éÂØºÂá∫',
                '‚Ä¢ Êï∞ÊçÆÂ§á‰ªΩ‰∏éÂõ¢ÈòüÂçè‰Ωú'
              ],
              (feature: string) => {
                Text(feature)
                  .fontSize(14)
                  .fontColor('#666666')
                  .width('100%')
                  .textAlign(TextAlign.Start)
              },
              (feature: string) => feature
            )
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
        }

        Text('¬© 2025 Â∑•Á®ãÁõ∏Êú∫Âõ¢Èòü‰øùÁïôÊâÄÊúâÊùÉÂà©')
          .fontSize(12)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)

        Button('ÂÖ≥Èó≠')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .height(44)
          .borderRadius(22)
          .onClick(() => this.showAboutDialog = false)
      }
      .width('88%')
      .padding({ top: 24, bottom: 20, left: 24, right: 24 })
      .backgroundColor('#FFFFFF')
      .borderRadius(18)
      .shadow({
        radius: 18,
        color: 'rgba(0,0,0,0.2)',
        offsetX: 0,
        offsetY: 6
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(220)
  }
}
