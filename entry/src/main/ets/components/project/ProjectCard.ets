/**
 * å·¥ç¨‹å¡ç‰‡ç»„ä»¶
 * å±•ç¤ºå·¥ç¨‹æ¦‚è¦ä¿¡æ¯ï¼Œç¬¦åˆåŸå‹è®¾è®¡
 */

import { Project } from '../../models/Project'
import { ProjectStatus } from '../../types/AppTypes'
import router from '@ohos.router'

@ComponentV2
export struct ProjectCard {
  @Require @Param project: Project = new Project()
  @Param showStats: boolean = true
  @Require @Param onTap?: (project: Project) => void
  @Require @Param onLongPress?: (project: Project) => void

  // çŠ¶æ€é¢œè‰²æ˜ å°„
  private getStatusColor(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return '#52C41A' // ç»¿è‰² - è¿›è¡Œä¸­
      case ProjectStatus.COMPLETED:
        return '#1890FF' // è“è‰² - å·²å®Œæˆ
      case ProjectStatus.PAUSED:
        return '#FAAD14' // æ©™è‰² - æš‚åœ
      case ProjectStatus.CANCELLED:
        return '#FF4D4F' // çº¢è‰² - å·²å–æ¶ˆ
      default:
        return '#8C8C8C' // ç°è‰² - æœªçŸ¥
    }
  }

  // çŠ¶æ€æ–‡æœ¬æ˜ å°„
  private getStatusText(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return 'è¿›è¡Œä¸­'
      case ProjectStatus.COMPLETED:
        return 'å·²å®Œæˆ'
      case ProjectStatus.PAUSED:
        return 'æš‚åœ'
      case ProjectStatus.CANCELLED:
        return 'å·²å–æ¶ˆ'
      default:
        return 'æœªçŸ¥'
    }
  }

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Row() {
        // å·¦ä¾§ä¿¡æ¯
        Column() {
          // é¡¹ç›®ç¼–å·å’Œåç§°
          Row() {
            Text(`ğŸ“ ${this.project.code}`)
              .fontSize(14)
              .fontColor('#1890FF')
              .fontWeight(FontWeight.Medium)

            Blank()

            // çŠ¶æ€æ ‡ç­¾
            Text(this.getStatusText(this.project.status))
              .fontSize(12)
              .fontColor('#FFFFFF')
              .backgroundColor(this.getStatusColor(this.project.status))
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(4)
          }
          .width('100%')

          // é¡¹ç›®åç§°
          Text(this.project.getDisplayName())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')
            .margin({ top: 8 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')

          // è´Ÿè´£äººå’ŒçŠ¶æ€ä¿¡æ¯
          Row() {
            Text(`è´Ÿè´£äºº: ${this.project.manager || 'æœªæŒ‡å®š'}`)
              .fontSize(14)
              .fontColor('#595959')
              .margin({ top: 6 })

            Blank()

            Text(this.getStatusText(this.project.status))
              .fontSize(14)
              .fontColor(this.getStatusColor(this.project.status))
              .margin({ top: 6 })
          }
          .width('100%')

          // ç»Ÿè®¡ä¿¡æ¯
          if (this.showStats) {
            Row() {
              Text(`${this.project.siteCount || 0}ä¸ªå·¥ç‚¹`)
                .fontSize(14)
                .fontColor('#8C8C8C')

              Text(' | ')

              Text(`${this.project.photoCount || 0}å¼ ç…§ç‰‡`)
                .fontSize(14)
                .fontColor('#8C8C8C')

              Blank()

              Text(this.getRelativeTime(this.project.updatedAt))
                .fontSize(12)
                .fontColor('#BFBFBF')
            }
            .width('100%')
            .margin({ top: 8 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .padding({ right: 12 })

        // å³ä¾§æ“ä½œæŒ‰é’®
        Column() {
          Text('â‹®')
            .fontSize(20)
            .fontColor('#8C8C8C')
            .onClick(() => {
              if (this.onLongPress) {
                this.onLongPress(this.project)
              }
            })
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      if (this.onTap) {
        this.onTap(this.project)
      }
    })
    .gesture(
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          if (this.onLongPress) {
            this.onLongPress(this.project)
          }
        })
    )
  }

  /**
   * è·å–ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
   */
  private getRelativeTime(date: Date): string {
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffMinutes = Math.floor(diffMs / (1000 * 60))
    const diffHours = Math.floor(diffMinutes / 60)
    const diffDays = Math.floor(diffHours / 24)

    if (diffMinutes < 1) {
      return 'åˆšåˆš'
    } else if (diffMinutes < 60) {
      return `${diffMinutes}åˆ†é’Ÿå‰`
    } else if (diffHours < 24) {
      return `${diffHours}å°æ—¶å‰`
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`
    } else {
      return this.formatDate(date)
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(date: Date): string {
    return `${date.getMonth() + 1}-${date.getDate()}`
  }
}