/**
 * æ‰¹é‡æ“ä½œç»„ä»¶
 * æä¾›å¤šé€‰ã€æ‰¹é‡å¯¼å‡ºã€åˆ é™¤ç­‰åŠŸèƒ½
 */

import { ThemeManager } from '../../theme/ThemeManager'
import { Photo } from '../../models/Photo'

export interface BatchSelection {
  allSelected: boolean
  selectedCount: number
  totalCount: number
  selectedPhotos: Photo[]
}

export interface BatchOperation {
  key: string
  label: string
  icon: string
  description: string
  action: () => void
  type?: 'primary' | 'secondary' | 'danger'
  disabled?: boolean
}

@ComponentV2
export struct BatchOperations {
  @Param selection: BatchSelection
  @Param onToggleAll?: () => void
  @Param onClearSelection?: () => void
  @Param onDelete?: () => void
  @Param onExport?: (format?: string) => void
  @Param onAddTags?: () => void
  @Param onMoveToProject?: () => void

  @State private showExportOptions: boolean = false
  @State private showTagOptions: boolean = false
  @State private showProjectOptions: boolean = false
  @State private selectedExportFormat: string = 'PDF'

  private readonly exportFormats = [
    { key: 'PDF', label: 'PDFæŠ¥å‘Š', icon: 'ðŸ“„' },
    { key: 'JPG', label: 'JPGå›¾ç‰‡', icon: 'ðŸ–¼ï¸' },
    { key: 'PNG', label: 'PNGå›¾ç‰‡', icon: 'ðŸ–¼ï¸' },
    { key: 'ZIP', label: 'ZIPåŽ‹ç¼©åŒ…', icon: 'ðŸ—œï¸' }
  ]

  private readonly tagOptions = [
    { key: 'important', label: 'é‡è¦', icon: 'â­', color: '#FFA500' },
    { key: 'review', label: 'å¾…æ£€æŸ¥', icon: 'ðŸ‘ï¸', color: '#2196F3' },
    { key: 'approved', label: 'å·²é€šè¿‡', icon: 'âœ…', color: '#4CAF50' },
    { key: 'issue', label: 'é—®é¢˜', icon: 'âŒ', color: '#F44336' }
  ]

  /**
   * é€‰æ‹©æŽ§åˆ¶æ 
   */
  @Builder
  private SelectionControlBar() {
    Row({ space: 12 }) {
      // å…¨é€‰æŒ‰é’®
      Button() {
        Row({ space: 6 }) {
          Text(this.selection.allSelected ? 'â˜‘ï¸' : 'â¬œ')
            .fontSize(16)

          Text(this.selection.allSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('auto')
      .height(40)
      .backgroundColor(this.selection.allSelected ? '#F5F5F5' : ThemeManager.getCurrentPrimaryColor())
      .borderRadius(20)
      .border({
        width: 1,
        color: this.selection.allSelected ? '#E0E0E0' : ThemeManager.getCurrentPrimaryColor()
      })
      .fontColor(this.selection.allSelected ? '#666666' : '#FFFFFF')
      .onClick(() => this.onToggleAll?.())

      // é€‰æ‹©ç»Ÿè®¡
      Column({ space: 4 }) {
        Text(`å·²é€‰æ‹©`)
          .fontSize(14)
          .fontColor('#666666')

        Text(`${this.selection.selectedCount}å¼ `)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeManager.getCurrentPrimaryColor())
          .backgroundColor(this.selection.allSelected ? '#E3F2FD' : '#FFF7E6')
          .padding({ left: 12, right: 12, top: 4, bottom: 4 })
          .borderRadius(8)
      }

        Text(`/å…±${this.selection.totalCount}å¼ `)
          .fontSize(14)
          .fontColor('#999999')
      }

      // æ¸…é™¤é€‰æ‹©æŒ‰é’®
      if (this.selection.selectedCount > 0) {
        Button('æ¸…é™¤é€‰æ‹©')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .border({ width: 1, color: '#E0E0E0' })
          .padding({ left: 12, right: 12 })
          .onClick(() => this.onClearSelection?.())
      }
    }
    .width('100%')
    .padding({ horizontal: 16, vertical: 12 })
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æ‰¹é‡æ“ä½œæŒ‰é’®
   */
  @Builder
  private BatchActionButtons() {
    Column({ space: 12 }) {
      Text('æ‰¹é‡æ“ä½œ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      // æ“ä½œæŒ‰é’®ç»„
      Row({ space: 12 }) {
        // å¯¼å‡ºæŒ‰é’®
        Column({ space: 8 }) {
          Button() {
            Text('ðŸ“¤ å¯¼å‡º')
              .fontSize(16)
              .fontColor('#FFFFFF')
          }
          .width('100%')
          .height(48)
          .backgroundColor(ThemeManager.getCurrentPrimaryColor())
          .borderRadius(8)
          .onClick(() => this.showExportOptions = !this.showExportOptions)

          Text(this.selectedExportFormat)
            .fontSize(12)
            .fontColor('#FFFFFF')
            .opacity(0.8)
          .margin({ top: -24 })
        }
        .width('100%')

        // æ·»åŠ æ ‡ç­¾æŒ‰é’®
        Button() {
          Text('ðŸ·ï¸ æ·»åŠ æ ‡ç­¾')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width('100%')
        .height(48)
        .backgroundColor('#52C41A')
        .borderRadius(8)
        .onClick(() => this.showTagOptions = !this.showTagOptions)
      }
        .width('100%')

        // ç§»åŠ¨åˆ°é¡¹ç›®æŒ‰é’®
        Button() {
          Text('ðŸ“ ç§»åŠ¨åˆ°é¡¹ç›®')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width('100%')
        .height(48)
        .backgroundColor('#1890FF')
        .borderRadius(8)
        .onClick(() => this.showProjectOptions = !this.showProjectOptions)
      }
        .width('100%')

        // åˆ é™¤æŒ‰é’®
        Button() {
          Text('ðŸ—‘ï¸ åˆ é™¤')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width('100%')
        .height(48)
        .backgroundColor('#FF4D4F')
        .borderRadius(8)
        .onClick(() => this.onDelete?.())
      }
        .width('100%')
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .rowsGap(12)
      .width('100%')
    }
    .padding(20)
    .backgroundColor('#FAFAFA')
    .borderRadius(12)
  }

  /**
   * å¯¼å‡ºé€‰é¡¹å¼¹çª—
   */
  @Builder
  private ExportOptionsDialog() {
    Column({ space: 16 }) {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©å¯¼å‡ºæ ¼å¼')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Spacer()

        Button('âœ•')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor(Color.Transparent)
          .onClick(() => this.showExportOptions = false)
      }
      .width('100%')
      .padding({ horizontal: 16, vertical: 12 })

      // æ ¼å¼é€‰æ‹©
      Column({ space: 8 }) {
        Text('å¯¼å‡ºæ ¼å¼')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Grid() {
          ForEach(this.exportFormats, (format) => {
            GridItem() {
              Button() {
                Row({ space: 8 }) {
                  Text(format.icon)
                    .fontSize(16)

                  Column({ space: 4 }) {
                    Text(format.label)
                      .fontSize(14)
                      .fontColor(
                        this.selectedExportFormat === format.key ? '#FFFFFF' : '#333333'
                      )
                  }
                }
              }
              .width('100%')
              .height(60)
              .backgroundColor(
                this.selectedExportFormat === format.key ? ThemeManager.getCurrentPrimaryColor() : '#F5F5F5'
              )
              .borderRadius(8)
              .border({
                width: 1,
                color: this.selectedExportFormat === format.key ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
              })
              .onClick(() => {
                this.selectedExportFormat = format.key
              })
            }
          })
        })
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .width('100%')

      // ç¡®è®¤æŒ‰é’®
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 24, right: 24 })
          .onClick(() => this.showExportOptions = false)

        Button('ç¡®è®¤å¯¼å‡º')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(ThemeManager.getCurrentPrimaryColor())
          .borderRadius(20)
          .padding({ left: 24, right: 24 })
          .onClick(() => {
            this.onExport?.(this.selectedExportFormat)
            this.showExportOptions = false
          })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#00000030',
      offsetX: 0,
      offsetY: 8
    })
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  /**
   * æ ‡ç­¾é€‰æ‹©å¼¹çª—
   */
  @Builder
  private TagOptionsDialog() {
    Column({ space: 16 }) {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©æ ‡ç­¾')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Spacer()

        Button('âœ•')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor(Color.Transparent)
          .onClick(() => this.showTagOptions = false)
      }
      .width('100%')
      .padding({ horizontal: 16, vertical: 12 })

      // æ ‡ç­¾é€‰æ‹©
      Grid() {
        ForEach(this.tagOptions, (tag) => {
          GridItem() {
            Button() {
              Row({ space: 8 }) {
                Text(tag.icon)
                  .fontSize(16)

                Text(tag.label)
                  .fontSize(14)
                  .fontColor('#333333')
                  .textAlign(TextAlign.Start)
              }
            }
            .width('100%')
            .height(48)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .border({ width: 1, color: '#E0E0E0' })
            .onClick(() => {
              // åº”ç”¨æ ‡ç­¾åˆ°é€‰ä¸­çš„ç…§ç‰‡
              this.onAddTags?.()
            })
          }
        })
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(8)
      .columnsGap(8)
      .width('100%')

      // ç¡®è®¤æŒ‰é’®
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 24, right: 24 })
          .onClick(() => this.showTagOptions = false)

        Button('åº”ç”¨æ ‡ç­¾')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(ThemeManager.getCurrentPrimaryColor())
          .borderRadius(20)
          .padding({ left: 24, right: 24 })
          .onClick(() => {
            this.onAddTags?.()
            this.showTagOptions = false
          })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#00000030',
      offsetX: 0,
      offsetY: 8
    })
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  build() {
    Column({ space: 16 }) {
      this.SelectionControlBar()
      this.BatchActionButtons()
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FAFAFA')
    .borderRadius(16)

    // å¯¼å‡ºé€‰é¡¹å¼¹çª—
    if (this.showExportOptions) {
      this.ExportOptionsDialog()
    }

    // æ ‡ç­¾é€‰é¡¹å¼¹çª—
    if (this.showTagOptions) {
      this.TagOptionsDialog()
    }
  }
}