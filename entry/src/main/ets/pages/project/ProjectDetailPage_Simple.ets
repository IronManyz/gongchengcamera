/**
 * é¡¹ç›®è¯¦æƒ…é¡µé¢
 * æ ¹æ®åŸå‹è®¾è®¡å®ç°çš„é¡¹ç›®ç®¡ç†å’Œå·¥ç‚¹ç®¡ç†ç•Œé¢
 */

import router from '@ohos.router'
import { SimpleProject, ProjectStatus } from '../../models/SimpleProject'
import { SimpleSite } from '../../models/SimpleSite'
import { SiteCard } from '../../components/site/SiteCard'
import { StatCard } from '../../components/common/StatCard'

@Entry
@ComponentV2
struct ProjectDetailPage_Simple {
  @Local private currentTab: string = 'sites'
  @Local private project: SimpleProject = new SimpleProject()
  @Local private sites: SimpleSite[] = []
  @Local private isLoading: boolean = false

  aboutToAppear(): void {
    this.loadProjectData()
    this.loadSites()
  }

  /**
   * åŠ è½½é¡¹ç›®æ•°æ®
   */
  private loadProjectData(): void {
    console.log('=== ProjectDetailPage_Simple.loadProjectData() ===')

    // ä»è·¯ç”±å‚æ•°è·å–é¡¹ç›®ID
    const params = router.getParams() as Record<string, Object>
    const projectId = params?.projectId as string
    console.log('Received projectId:', projectId)

    if (projectId) {
      // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢ - æ ¹æ®IDæŸ¥æ‰¾é¡¹ç›®
      const mockProjects = this.createMockProjects()
      const foundProject = mockProjects.find(p => p.id === projectId)

      if (foundProject) {
        this.project = foundProject
        console.log('Project found:', this.project.name)
      } else {
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
        console.log('Project not found, using default data')
        this.project = new SimpleProject(
          projectId,
          'å¸‚æ”¿é“è·¯æ”¹é€ å·¥ç¨‹',
          ProjectStatus.ACTIVE,
          'å¼ ä¸‰',
          4,
          52
        )
        this.project.code = 'P2025-001'
        this.project.client = 'å¸‚å»ºé›†å›¢'
        this.project.description = 'åŸå¸‚ä¸»å¹²é“æ”¹é€ å·¥ç¨‹ï¼ŒåŒ…æ‹¬è·¯é¢ç¿»æ–°ã€æ’æ°´ç³»ç»Ÿå‡çº§ç­‰'
      }
    } else {
      console.error('No projectId provided in navigation parameters')
    }

    console.log('Project data loaded - Name:', this.project.name, 'Status:', this.project.status)
    console.log('=== End loadProjectData ===')
  }

  /**
   * åˆ›å»ºæ¨¡æ‹Ÿé¡¹ç›®æ•°æ®
   */
  private createMockProjects(): SimpleProject[] {
    const projectA = new SimpleProject('P2025-001', 'å¸‚æ”¿é“è·¯æ”¹é€ å·¥ç¨‹', ProjectStatus.ACTIVE, 'å¼ ä¸‰', 4, 52)
    projectA.code = 'P2025-001'
    projectA.client = 'å¸‚æ”¿å»ºè®¾å±€'
    projectA.description = 'å¸‚åŒºï¿½ï¿½å¹²é“æ”¹é€ ï¼Œä¸€æœŸè¦†ç›– 4 ä¸ªå·¥ç‚¹ï¼ŒæŒç»­ä¼˜åŒ–æ’æ°´ç³»ç»Ÿä¸é“è·¯é“ºè£…ã€‚'

    const projectB = new SimpleProject('P2025-002', 'ç”µåŠ›çº¿è·¯å·¡æ£€å·¥ç¨‹', ProjectStatus.COMPLETED, 'æå››', 6, 89)
    projectB.code = 'P2025-002'
    projectB.client = 'å›½å®¶ç”µç½‘'
    projectB.description = 'åŸåŒºé«˜å‹çº¿è·¯å·¡æ£€ä¸éšæ‚£æ’æŸ¥ï¼Œè¾“å‡ºå·¡æ£€ç…§ç‰‡ä¸æ•´æ”¹å•ã€‚'

    const projectC = new SimpleProject('P2025-003', 'å›­æ—ç»¿åŒ–é¡¹ç›®', ProjectStatus.PAUSED, 'ç‹äº”', 2, 15)
    projectC.code = 'P2025-003'
    projectC.client = 'åŸå¸‚å›­æ—ç®¡ç†å¤„'
    projectC.description = 'åŸåŒºç»¿åŒ–æå‡å·¥ç¨‹ï¼Œå½“å‰å› è®¾è®¡è°ƒæ•´æš‚ç¼“æ–½å·¥ã€‚'

    return [projectA, projectB, projectC]
  }

  /**
   * åŠ è½½å·¥ç‚¹åˆ—è¡¨
   */
  private async loadSites(): Promise<void> {
    this.isLoading = true

    try {
      // TODO: ä»æ•°æ®åº“åŠ è½½å·¥ç‚¹æ•°æ®
      // ä¸´æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.sites = [
        this.createMockSite('1', 'åŒ—ç¯è·¯æ®µ K3+200', 116.404, 39.915, 58, 24),
        this.createMockSite('2', 'å—ç¯è·¯æ®µ K5+800', 116.408, 39.910, 62, 15),
        this.createMockSite('3', 'ä¸œç¯ç«‹äº¤æ¡¥', 116.420, 39.920, 55, 8),
        this.createMockSite('4', 'è¥¿ç¯è·¯äº¤å‰å£', 116.395, 39.925, 48, 5)
      ]
    } catch (error) {
      console.error('åŠ è½½å·¥ç‚¹å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * åˆ›å»ºæ¨¡æ‹Ÿå·¥ç‚¹æ•°æ®
   */
  private createMockSite(id: string, name: string, lng: number, lat: number, alt: number, photoCount: number): SimpleSite {
    const site = new SimpleSite(id, name, this.project.id)
    site.longitude = lng
    site.latitude = lat
    site.altitude = alt
    site.photoCount = photoCount
    site.address = `${name}é™„è¿‘`
    site.description = `${name}æ–½å·¥åŒºåŸŸ`
    site.lastPhotoTime = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000) // éšæœºæ—¶é—´
    return site
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * å¤„ç†å·¥ç‚¹æ‹ç…§
   */
  private handleSiteCamera(site: SimpleSite): void {
    console.log('Site camera:', site.name)
    // TODO: è·³è½¬åˆ°ç›¸æœºé¡µé¢ï¼Œå¹¶ä¼ å…¥å·¥ç‚¹ä¿¡æ¯
    router.pushUrl({
      url: 'pages/camera/CameraPage_Simple',
      params: {
        projectId: this.project.id,
        siteId: site.id,
        siteName: site.name
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°ç›¸æœºå¤±è´¥:', error)
    })
  }

  /**
   * æŸ¥çœ‹å·¥ç‚¹ç…§ç‰‡
   */
  private handleSiteView(site: SimpleSite): void {
    console.log('View site photos:', site.name)
    router.pushUrl({
      url: 'pages/site/SitePhotoPage',
      params: {
        projectId: this.project.id,
        siteId: site.id,
        siteName: site.name
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°å·¥ç‚¹ç…§ç‰‡å¤±è´¥:', error)
    })
  }

  /**
   * åˆ›å»ºæ–°å·¥ç‚¹
   */
  private createNewSite(): void {
    console.log('Create new site')
    // TODO: æ˜¾ç¤ºåˆ›å»ºå·¥ç‚¹å¯¹è¯æ¡†
    // æ”¯æŒæ‰‹åŠ¨è¾“å…¥æˆ–åœ°å›¾é€‰ç‚¹
  }

  /**
   * å¯¼å‡ºæ•°æ®
   * æ³¨æ„: æ­¤æ–¹æ³•ä¸å†è¢«å¿«æ·æ“ä½œè°ƒç”¨ï¼Œä½†ä¿ç•™ä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
   */
  private exportData(): void {
    console.log('Export project data')
    // TODO: å¯¼å‡ºé¡¹ç›®æ•°æ®å’Œç…§ç‰‡
  }

  /**
   * ç”ŸæˆæŠ¥å‘Š
   * æ³¨æ„: æ­¤æ–¹æ³•ä¸å†è¢«å¿«æ·æ“ä½œè°ƒç”¨ï¼Œä½†ä¿ç•™ä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
   */
  private generateReport(): void {
    console.log('Generate report')
    // TODO: ç”Ÿæˆé¡¹ç›®æŠ¥å‘Š
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›æŒ‰é’®
        Text('â†')
          .fontSize(24)
          .fontColor('#1890FF')
          .onClick(() => {
            this.navigateBack()
          })

        Blank()

        // é¡¹ç›®åç§°
        Text(this.project.getDisplayName())
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#262626')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Blank()

        // æ“ä½œæŒ‰é’®
        Row({ space: 12 }) {
          Text('ğŸ“¤')
            .fontSize(20)
            .fontColor('#1890FF')
            .onClick(() => {
              this.exportData()
            })

          Text('â‹®')
            .fontSize(20)
            .fontColor('#1890FF')
            .onClick(() => {
              console.log('More options')
              // TODO: æ˜¾ç¤ºæ›´å¤šæ“ä½œèœå•
            })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E8E8E8' })

      // é¡¹ç›®ä¿¡æ¯åŒºåŸŸ
      Column() {
        Row() {
          // é¡¹ç›®çŠ¶æ€
          Text(this.project.getStatusText())
            .fontSize(14)
            .fontColor(this.project.getStatusColor())
            .backgroundColor(this.project.getStatusColor() + '15')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(10)

          Blank()

          // é¡¹ç›®ç¼–å·
          Text(this.project.code)
            .fontSize(14)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .margin({ bottom: 12 })

        // é¡¹ç›®åŸºæœ¬ä¿¡æ¯
        Row() {
          Column() {
            Text('è´Ÿè´£äºº')
              .fontSize(12)
              .fontColor('#8C8C8C')
            Text(this.project.manager)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .margin({ top: 4 })
          }
          .layoutWeight(1)

          Column() {
            Text('å®¢æˆ·')
              .fontSize(12)
              .fontColor('#8C8C8C')
            Text(this.project.client)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .margin({ top: 4 })
          }
          .layoutWeight(1)

          Column() {
            Text('å·¥ç‚¹æ•°')
              .fontSize(12)
              .fontColor('#8C8C8C')
            Text(this.project.siteCount.toString())
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .margin({ top: 4 })
          }
          .layoutWeight(1)

          Column() {
            Text('ç…§ç‰‡æ•°')
              .fontSize(12)
              .fontColor('#8C8C8C')
            Text(this.project.photoCount.toString())
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .margin({ top: 4 })
          }
          .layoutWeight(1)
        }
        .width('100%')

        // é¡¹ç›®æè¿°
        if (this.project.description) {
          Text(this.project.description)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
            .width('100%')
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .margin({ bottom: 12 })

      // Tabå¯¼èˆª
      Row() {
        TabBar({ tab: 'æ¦‚å†µ', current: this.currentTab === 'overview', onTap: () => { this.currentTab = 'overview' } })

        TabBar({ tab: 'å·¥ç‚¹', current: this.currentTab === 'sites', onTap: () => { this.currentTab = 'sites' } })

        TabBar({ tab: 'ç›¸å†Œ', current: this.currentTab === 'photos', onTap: () => { this.currentTab = 'photos' } })

        TabBar({ tab: 'å›¢é˜Ÿ', current: this.currentTab === 'team', onTap: () => { this.currentTab = 'team' } })

        TabBar({ tab: 'è®¾ç½®', current: this.currentTab === 'settings', onTap: () => { this.currentTab = 'settings' } })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 2 }, color: '#E8E8E8' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          if (this.currentTab === 'sites') {
            this.buildSitesTab()
          } else {
            // TODO: å®ç°å…¶ä»–Tabé¡µé¢
            this.buildComingSoonTab()
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ„å»ºå·¥ç‚¹Tabå†…å®¹
   */
  @Builder
  private buildSitesTab() {
    Column() {
      // å·¥ç‚¹åˆ—è¡¨æ ‡é¢˜
      Row() {
        Text('ğŸ“ å·¥ç‚¹åˆ—è¡¨')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#262626')

        Blank()

        Text(`${this.sites.length}ä¸ªå·¥ç‚¹`)
          .fontSize(14)
          .fontColor('#8C8C8C')

        Button('+ æ–°å»º')
          .fontSize(14)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.createNewSite()
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })

      // å·¥ç‚¹åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.sites.length === 0) {
        Column() {
          Text('ğŸ“')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('æš‚æ— å·¥ç‚¹')
            .fontSize(16)
            .fontColor('#8C8C8C')
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»ä¸Šæ–¹"æ–°å»º"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ç‚¹')
            .fontSize(14)
            .fontColor('#BFBFBF')
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        Column({ space: 12 }) {
          ForEach(this.sites, (site: SimpleSite) => {
            SiteCard({
              site: site,
              showThumbnails: true,
              showLocation: true,
              onCamera: (s: SimpleSite) => this.handleSiteCamera(s),
              onView: (s: SimpleSite) => this.handleSiteView(s),
              onTap: (s: SimpleSite) => this.handleSiteView(s),
              onLongPress: (s: SimpleSite) => {
                console.log('Site long press:', s.name)
                // TODO: æ˜¾ç¤ºå·¥ç‚¹æ“ä½œèœå•
              }
            })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 80 })
      }
    }
  }

  /**
   * æ„å»ºå¼€å‘ä¸­Tabå†…å®¹
   */
  @Builder
  private buildComingSoonTab() {
    Column() {
      Text('â³')
        .fontSize(48)
        .fontColor('#C0C0C0')
        .margin({ bottom: 16 })

      Text('åŠŸèƒ½å¼€å‘ä¸­')
        .fontSize(16)
        .fontColor('#8C8C8C')
        .margin({ bottom: 8 })

      Text('è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…')
        .fontSize(14)
        .fontColor('#BFBFBF')
    }
    .width('100%')
    .height(400)
    .justifyContent(FlexAlign.Center)
  }
}

/**
 * Tabæ ç»„ä»¶
 */
@ComponentV2
struct TabBar {
  @Param tab: string = ''
  @Param current: boolean = false
  @Param onTap: () => void = () => {}

  build() {
    Column() {
      Text(this.tab)
        .fontSize(14)
        .fontWeight(this.current ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(this.current ? '#1890FF' : '#8C8C8C')
        .padding({ top: 12, bottom: 12 })

      if (this.current) {
        Divider()
          .strokeWidth(2)
          .color('#1890FF')
          .width('80%')
      }
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.onTap()
    })
  }
}