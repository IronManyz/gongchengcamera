/**
 * é¡¹ç›®åˆ—è¡¨é¡µé¢
 * æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®ï¼Œæ”¯æŒæœç´¢ã€è¿‡æ»¤ã€æ’åºå’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
 */

import router from '@ohos.router'
import { Project } from '../../models/Project'
import { projectStore } from '../../store/project/ProjectStore'
import { ProjectFilter, ProjectSortOrder, ProjectStatus } from '../../types/AppTypes'
import { SearchBar } from '../../components/common/SearchBar'
import { LoadingDialog } from '../../components/common/LoadingDialog'
import { ConfirmDialog } from '../../components/common/ConfirmDialog'
import { ProjectCard } from '../../components/project/ProjectCard'


/**
 * è¿‡æ»¤é€‰é¡¹æ¥å£
 */
interface FilterOption {
  key: ProjectFilter
  label: string
}

/**
 * é€‰é¡¹æ¥å£
 */
interface OptionItem {
  key: string
  label: string
}

/**
 * æ—¶é—´èŒƒå›´é€‰é¡¹ç±»å‹
 */
type TimeRangeKey = 'all' | 'today' | 'week' | 'month' | 'quarter' | 'year'

/**
 * ä¼˜å…ˆçº§é€‰é¡¹ç±»å‹
 */
type PriorityKey = 'all' | 'high' | 'medium' | 'low'

/**
 * æ—¥æœŸèŒƒå›´æ¥å£
 */
interface DateRange {
  start: Date
  end: Date
}

@Entry
@Component
struct ProjectListPage {
  // çŠ¶æ€ç®¡ç†
  @State private isLoading: boolean = false
  @State private isRefreshing: boolean = false
  @State private searchQuery: string = ''
  @State private currentFilter: ProjectFilter = ProjectFilter.ALL
  @State private selectedProjectId: string = ''
  @State private showDeleteDialog: boolean = false
  @State private showFilterDialog: boolean = false
  @State private showAdvancedFilter: boolean = false
  @State private selectedManager: string = 'all'
  @State private selectedTimeRange: string = 'all'
  @State private selectedPriority: string = 'all'

  // é¡¹ç›®Store
  private projectStore = projectStore

  // ç­›é€‰é€‰é¡¹
  private readonly filterOptions: FilterOption[] = [
    { key: ProjectFilter.ALL, label: 'å…¨éƒ¨é¡¹ç›®' },
    { key: ProjectFilter.ACTIVE, label: 'è¿›è¡Œä¸­' },
    { key: ProjectFilter.COMPLETED, label: 'å·²å®Œæˆ' },
    { key: ProjectFilter.PAUSED, label: 'å·²æš‚åœ' },
    { key: ProjectFilter.CANCELLED, label: 'å·²å–æ¶ˆ' }
  ]

  // æ—¶é—´èŒƒå›´é€‰é¡¹
  private readonly timeRangeOptions: OptionItem[] = [
    { key: 'all', label: 'å…¨éƒ¨æ—¶é—´' },
    { key: 'today', label: 'ä»Šå¤©' },
    { key: 'week', label: 'æœ¬å‘¨' },
    { key: 'month', label: 'æœ¬æœˆ' },
    { key: 'quarter', label: 'æœ¬å­£åº¦' },
    { key: 'year', label: 'æœ¬å¹´' }
  ]

  // ä¼˜å…ˆçº§é€‰é¡¹
  private readonly priorityOptions: OptionItem[] = [
    { key: 'all', label: 'å…¨éƒ¨ä¼˜å…ˆçº§' },
    { key: 'high', label: 'é«˜ä¼˜å…ˆçº§' },
    { key: 'medium', label: 'ä¸­ä¼˜å…ˆçº§' },
    { key: 'low', label: 'ä½ä¼˜å…ˆçº§' }
  ]

  aboutToAppear() {
    this.loadProjectData()
  }

  /**
   * åŠ è½½é¡¹ç›®æ•°æ®
   */
  private async loadProjectData() {
    this.isLoading = true
    try {
      if (!this.projectStore.isInitialized) {
        await this.projectStore.initialize()
      } else {
        await this.projectStore.refresh()
      }
    } catch (error) {
      console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * ä¸‹æ‹‰åˆ·æ–°
   */
  private async onRefresh(): Promise<void> {
    this.isRefreshing = true
    try {
      await this.projectStore.refresh()
    } catch (error) {
      console.error('åˆ·æ–°é¡¹ç›®æ•°æ®å¤±è´¥:', error)
    } finally {
      this.isRefreshing = false
    }
  }

  /**
   * æœç´¢å¤„ç†
   */
  private onSearch(query: string): void {
    this.searchQuery = query
    this.projectStore.setSearchQuery(query)
  }

  /**
   * ç­›é€‰å¤„ç†
   */
  private onFilterChange(filter: ProjectFilter) {
    this.currentFilter = filter
    this.projectStore.setFilter(filter)
    this.showFilterDialog = false
  }

  /**
   * æ’åºå¤„ç†
   */
  private onSortOrderChange(sortOrder: ProjectSortOrder) {
    this.projectStore.setSortOrder(sortOrder)
  }

  /**
   * è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…
   */
  private navigateToProjectDetail(project: Project): void {
    router.pushUrl({
      url: 'pages/project/ProjectDetailPage',
      params: {
        projectId: project.id
      }
    })
  }

  /**
   * è·³è½¬åˆ°åˆ›å»ºé¡¹ç›®
   */
  private navigateToCreateProject() {
    router.pushUrl({
      url: 'pages/project/ProjectEditPage',
      params: {
        mode: 'create'
      }
    })
  }

  /**
   * è·³è½¬åˆ°ç¼–è¾‘é¡¹ç›®
   */
  private navigateToEditProject(project: Project) {
    router.pushUrl({
      url: 'pages/project/ProjectEditPage',
      params: {
        mode: 'edit',
        projectId: project.id
      }
    })
  }

  /**
   * åˆ é™¤é¡¹ç›®
   */
  private async deleteProject(): Promise<void> {
    if (this.selectedProjectId) {
      const success = await this.projectStore.deleteProject(this.selectedProjectId)
      if (success) {
        this.selectedProjectId = ''
        this.showDeleteDialog = false
      }
    }
  }

  /**
   * è·å–é¡¹ç›®çŠ¶æ€é¢œè‰²
   */
  private getProjectStatusColor(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return '#4CAF50'
      case ProjectStatus.COMPLETED:
        return '#2196F3'
      case ProjectStatus.PAUSED:
        return '#FF9800'
      case ProjectStatus.CANCELLED:
        return '#F44336'
      default:
        return '#757575'
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(date: Date): string {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
  }

  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildTopBar()

      // ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
      this.buildStatsOverview()

      // æœç´¢å’Œç­›é€‰æ 
      this.buildSearchAndFilterBar()

      // é¡¹ç›®åˆ—è¡¨
      this.buildProjectList()

      // åº•éƒ¨æ“ä½œæ 
      this.buildBottomActionBar()

      // åŠ è½½å¯¹è¯æ¡†
      if (this.isLoading) {
        LoadingDialog({
          show: this.isLoading,
          message: 'åŠ è½½ä¸­...',
          onCancel: () => {}
        })
      }

      // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      if (this.showDeleteDialog) {
        ConfirmDialog({
          show: this.showDeleteDialog,
          title: 'åˆ é™¤é¡¹ç›®',
          message: `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
          confirmText: 'åˆ é™¤',
          cancelText: 'å–æ¶ˆ',
          onConfirm: () => this.deleteProject(),
          onCancel: () => {
            this.showDeleteDialog = false
            this.selectedProjectId = ''
          },
          onClose: () => {
            this.showDeleteDialog = false
            this.selectedProjectId = ''
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  
  /**
   * æ„å»ºç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
   */
  @Builder
  private buildStatsOverview() {
    if (this.projectStore.projectStats) {
      Column({ space: 16 }) {
        // ä¸»è¦ç»Ÿè®¡å¡ç‰‡
        Row() {
          // å·¥ç¨‹æ•°é‡ç»Ÿè®¡
          Column() {
            Text(String(this.projectStore.projectStats.totalProjects))
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')

            Text('æ€»å·¥ç¨‹')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 4 })
          }
          .width('33.33%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F0F8FF')
          .borderRadius(12)
          .padding({ top: 16, bottom: 16 })

          // å·¥ç‚¹æ•°é‡ç»Ÿè®¡
          Column() {
            Text(String(this.projectStore.projectStats.totalSites))
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')

            Text('æ€»å·¥ç‚¹')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 4 })
          }
          .width('33.33%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F0FFF4')
          .borderRadius(12)
          .padding({ top: 16, bottom: 16 })

          // ç…§ç‰‡æ•°é‡ç»Ÿè®¡
          Column() {
            Text(String(this.projectStore.projectStats.totalPhotos))
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')

            Text('æ€»ç…§ç‰‡')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 4 })
          }
          .width('33.33%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFF8F0')
          .borderRadius(12)
          .padding({ top: 16, bottom: 16 })
        }
        .width('100%')
        .height(100)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceEvenly)

        // çŠ¶æ€åˆ†å¸ƒç»Ÿè®¡
        if (this.projectStore.projectStats.projectsByStatus) {
          Row({ space: 8 }) {
            this.buildStatusIndicator('è¿›è¡Œä¸­', this.projectStore.projectStats.projectsByStatus[ProjectStatus.ACTIVE] || 0, '#4CAF50')
            this.buildStatusIndicator('å·²å®Œæˆ', this.projectStore.projectStats.projectsByStatus[ProjectStatus.COMPLETED] || 0, '#2196F3')
            this.buildStatusIndicator('å·²æš‚åœ', this.projectStore.projectStats.projectsByStatus[ProjectStatus.PAUSED] || 0, '#FF9800')
            this.buildStatusIndicator('å·²å–æ¶ˆ', this.projectStore.projectStats.projectsByStatus[ProjectStatus.CANCELLED] || 0, '#F44336')
          }
          .width('100%')
          .padding({ left: 16, right: 16 })
          .justifyContent(FlexAlign.SpaceEvenly)
        }
      }
      .width('100%')
      .padding({ top: 12, bottom: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({
        radius: 4,
        color: 'rgba(0, 0, 0, 0.08)',
        offsetX: 0,
        offsetY: 2
      })
    }
  }

  /**
   * æ„å»ºçŠ¶æ€æŒ‡ç¤ºå™¨
   */
  @Builder
  private buildStatusIndicator(label: string, count: number, color: string) {
    Column() {
      Text(String(count))
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(label)
        .fontSize(12)
        .fontColor('#666666')
        .margin({ top: 2 })
    }
    .alignItems(HorizontalAlign.Center)
    .flexShrink(1)
  }

  /**
   * æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private buildTopBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Text('ğŸ”™')
          .width(24)
          .height(24)
          .fontColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      // æ ‡é¢˜
      Text('é¡¹ç›®ç®¡ç†')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 2,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetX: 0,
      offsetY: 1
    })
  }

  /**
   * æ„å»ºæœç´¢å’Œç­›é€‰æ 
   */
  @Builder
  private buildSearchAndFilterBar() {
    Column({ space: 12 }) {
      // æœç´¢æ 
      SearchBar({
        query: this.searchQuery,
        placeholder: 'æœç´¢é¡¹ç›®åç§°ã€ä»£ç ã€å®¢æˆ·...',
        onSearch: (query: string) => this.onSearch(query),
        onChange: (query: string) => this.searchQuery = query
      })

      // ç­›é€‰å’Œæ’åºæ 
      Row({ space: 12 }) {
        // ç­›é€‰æŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Text('ğŸ”')
              .width(16)
              .height(16)
              .fontColor(this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#666666')

            Text(this.getFilterText(this.currentFilter))
              .fontSize(14)
              .fontColor(this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#666666')
          }
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .border({
          width: 1,
          color: this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#E0E0E0'
        })
        .onClick(() => {
          this.showFilterDialog = !this.showFilterDialog
        })

        // é«˜çº§ç­›é€‰æŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Text('âš™ï¸')
              .width(16)
              .height(16)
              .fontColor(this.hasAdvancedFilters() ? '#007AFF' : '#666666')

            Text('é«˜çº§')
              .fontSize(14)
              .fontColor(this.hasAdvancedFilters() ? '#007AFF' : '#666666')
          }
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .border({
          width: 1,
          color: this.hasAdvancedFilters() ? '#007AFF' : '#E0E0E0'
        })
        .onClick(() => {
          this.showAdvancedFilter = !this.showAdvancedFilter
        })

        // æ’åºæŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Text('ğŸ“Š')
              .width(16)
              .height(16)
              .fontColor('#666666')

            Text('æœ€æ–°')
              .fontSize(14)
              .fontColor('#666666')
          }
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .border({ width: 1, color: '#E0E0E0' })
        .onClick(() => {
          // å¾ªç¯åˆ‡æ¢æ’åºæ–¹å¼
          const currentOrder = this.projectStore.currentSortOrder
          if (currentOrder === ProjectSortOrder.UPDATED_DESC) {
            this.onSortOrderChange(ProjectSortOrder.UPDATED_ASC)
          } else {
            this.onSortOrderChange(ProjectSortOrder.UPDATED_DESC)
          }
        })

        Blank()

        // æ¸…ç©ºç­›é€‰
        if (this.currentFilter !== ProjectFilter.ALL || this.searchQuery) {
          Button('æ¸…ç©º')
            .height(36)
            .fontSize(14)
            .fontColor('#666666')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.searchQuery = ''
              this.currentFilter = ProjectFilter.ALL
              this.projectStore.clearSearchConditions()
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // ç­›é€‰é€‰é¡¹å¼¹çª—
      if (this.showFilterDialog) {
        this.buildFilterDialog()
      }

      // é«˜çº§ç­›é€‰å¼¹çª—
      if (this.showAdvancedFilter) {
        this.buildAdvancedFilterDialog()
      }
    }
    .width('100%')
    .padding({ top: 12, bottom: 8 })
    .backgroundColor('#FFFFFF')
  }

  /**
   * æ„å»ºç­›é€‰å¯¹è¯æ¡†
   */
  @Builder
  private buildFilterDialog() {
    Column({ space: 0 }) {
      // ç­›é€‰é€‰é¡¹
      ForEach(
        this.filterOptions,
        (filter: FilterOption) => {
          Row() {
            Text(filter.label)
              .fontSize(16)
              .fontColor(this.currentFilter === filter.key ? '#007AFF' : '#333333')
              .layoutWeight(1)

            if (this.currentFilter === filter.key) {
              Text('âœ…')
                .width(20)
                .height(20)
                .fontColor('#007AFF')
            }
          }
          .width('100%')
          .height(48)
          .padding({ left: 16, right: 16 })
          .onClick(() => this.onFilterChange(filter.key))

          if (filter.key !== ProjectFilter.CANCELLED) {
            Divider().color('#F0F0F0')
          }
        },
        (filter: FilterOption) => filter.key
      )
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 2
    })
    .zIndex(10)
  }

  /**
   * æ„å»ºé¡¹ç›®åˆ—è¡¨
   */
  @Builder
  private buildProjectList() {
    Refresh({ refreshing: $$isRefreshing, friction: 100 }) {
      if (this.projectStore.hasFilteredProjects) {
        List({ space: 12 }) {
          ForEach(
            this.projectStore.filteredProjects,
            (project: Project) => {
              ListItem() {
                this.buildProjectItem(project)
              }
            },
            (project: Project) => project.id
          )
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      } else {
        Column() {
          Text('ğŸ“')
            .width(120)
            .height(120)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text(this.searchQuery ? 'æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®' : 'æš‚æ— é¡¹ç›®')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#666666')
            .margin({ bottom: 8 })

          Text(this.searchQuery ? 'å°è¯•ä¿®æ”¹æœç´¢æ¡ä»¶' : 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
            .lineHeight(20)
            .padding({ left: 32, right: 32 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .margin({ left: 16, right: 16 })
      }
    }
  }

  /**
   * æ„å»ºé¡¹ç›®é¡¹
   */
  @Builder
  private buildProjectItem(project: Project) {
    ProjectCard({
      project: project,
      showStats: true,
      onTap: (project) => this.navigateToProjectDetail(project),
      onLongPress: (project) => {
        this.selectedProjectId = project.id
        this.showDeleteDialog = true
      }
    })
  }

  /**
   * æ„å»ºåº•éƒ¨æ“ä½œæ 
   */
  @Builder
  private buildBottomActionBar() {
    Row() {
      Button() {
        Row({ space: 8 }) {
          Text('â•')
            .width(20)
            .height(20)
            .fontColor('#FFFFFF')

          Text('æ–°å»ºé¡¹ç›®')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
      }
      .height(48)
      .padding({ left: 24, right: 24 })
      .backgroundColor('#007AFF')
      .borderRadius(24)
      .margin({ bottom: 20 })
      .onClick(() => this.navigateToCreateProject())
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Transparent)
  }

  /**
   * æ„å»ºé«˜çº§ç­›é€‰å¯¹è¯æ¡†
   */
  @Builder
  private buildAdvancedFilterDialog() {
    Column() {
      // å¤´éƒ¨
      Row() {
        Text('é«˜çº§ç­›é€‰')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        Button('å…³é—­')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showAdvancedFilter = false
          })
      }
      .width('100%')
      .padding(16)
      .borderRadius({ topLeft: 8, topRight: 8 })

      Divider().color('#F0F0F0')

      // æ—¶é—´èŒƒå›´ç­›é€‰
      Column() {
        Text('æ—¶é—´èŒƒå›´')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 12 })

        Grid() {
          ForEach(
            this.timeRangeOptions,
            (option: OptionItem) => {
              GridItem() {
                Text(option.label)
                  .fontSize(14)
                  .fontColor(this.selectedTimeRange === (option.key as TimeRangeKey) ? '#007AFF' : '#333333')
                  .backgroundColor(this.selectedTimeRange === (option.key as TimeRangeKey) ? '#E6F4FF' : '#F8F8F8')
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .borderRadius(6)
                  .textAlign(TextAlign.Center)
                  .onClick(() => {
                    this.selectedTimeRange = option.key as TimeRangeKey
                  })
              }
            },
            (option: OptionItem) => option.key
          )
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
      }
      .width('100%')
      .padding(16)
      .alignItems(HorizontalAlign.Start)

      Divider().color('#F0F0F0')

      // ä¼˜å…ˆçº§ç­›é€‰
      Column() {
        Text('ä¼˜å…ˆçº§')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 12 })

        Row({ space: 8 }) {
          ForEach(
            this.priorityOptions,
            (option: OptionItem) => {
              Text(option.label)
                .fontSize(14)
                .fontColor(this.selectedPriority === option.key ? '#007AFF' : '#333333')
                .backgroundColor(this.selectedPriority === option.key ? '#E6F4FF' : '#F8F8F8')
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .borderRadius(6)
                .textAlign(TextAlign.Center)
                .onClick(() => {
                  this.selectedPriority = option.key as PriorityKey
                })
            },
            (option: OptionItem) => option.key as string
          )
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
      .alignItems(HorizontalAlign.Start)

      Divider().color('#F0F0F0')

      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('é‡ç½®')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor('#F8F8F8')
          .layoutWeight(1)
          .height(44)
          .borderRadius(22)
          .onClick(() => {
            this.resetAdvancedFilters()
          })

        Button('åº”ç”¨ç­›é€‰')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#007AFF')
          .layoutWeight(1)
          .height(44)
          .borderRadius(22)
          .onClick(() => {
            this.applyAdvancedFilters()
          })
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 2
    })
    .zIndex(10)
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰é«˜çº§ç­›é€‰
   */
  private hasAdvancedFilters(): boolean {
    return this.selectedTimeRange !== 'all' ||
           this.selectedPriority !== 'all' ||
           this.selectedManager !== 'all'
  }

  /**
   * é‡ç½®é«˜çº§ç­›é€‰
   */
  private resetAdvancedFilters(): void {
    this.selectedTimeRange = 'all'
    this.selectedPriority = 'all'
    this.selectedManager = 'all'
    this.showAdvancedFilter = false
    // è§¦å‘é‡æ–°ç­›é€‰
    this.applyAdvancedFilters()
  }

  /**
   * åº”ç”¨é«˜çº§ç­›é€‰
   */
  private applyAdvancedFilters(): void {
    // æ„å»ºç­›é€‰å‚æ•°
    const filterParams: Map<string, Object> = new Map<string, Object>()

    // æ·»åŠ æ—¶é—´èŒƒå›´ç­›é€‰
    const timeRange = this.getTimeRangeFilter()
    if (timeRange) {
      filterParams.set('dateRange', timeRange)
    }

    // æ·»åŠ ä¼˜å…ˆçº§ç­›é€‰
    const priority = this.getPriorityFilter()
    if (priority) {
      filterParams.set('priorities', [priority])
    }

    // æ·»åŠ è´Ÿè´£äººç­›é€‰
    if (this.selectedManager !== 'all') {
      filterParams.set('managers', [this.selectedManager])
    }

    // åº”ç”¨åˆ°ProjectStore
    this.projectStore.setAdvancedFilters(filterParams)
    this.showAdvancedFilter = false

    console.log('åº”ç”¨é«˜çº§ç­›é€‰:', filterParams)
  }

  /**
   * è·å–æ—¶é—´èŒƒå›´ç­›é€‰å‚æ•°
   */
  private getTimeRangeFilter(): DateRange | undefined {
    const now = new Date()
    let startDate: Date | undefined

    switch (this.selectedTimeRange) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate())
        break
      case 'week':
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
        break
      case 'month':
        startDate = new Date(now.getFullYear(), now.getMonth(), 1)
        break
      case 'quarter':
        startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1)
        break
      case 'year':
        startDate = new Date(now.getFullYear(), 0, 1)
        break
      default:
        return undefined
    }

    if (startDate) {
      return {
        start: startDate,
        end: now
      }
    }

    return undefined
  }

  /**
   * è·å–ä¼˜å…ˆçº§ç­›é€‰å‚æ•°
   */
  private getPriorityFilter(): string | undefined {
    switch (this.selectedPriority) {
      case 'high':
        return 'high'
      case 'medium':
        return 'medium'
      case 'low':
        return 'low'
      default:
        return undefined
    }
  }

  /**
   * è·å–ç­›é€‰æ–‡æœ¬
   */
  private getFilterText(filter: ProjectFilter): string {
    switch (filter) {
      case ProjectFilter.ALL:
        return 'å…¨éƒ¨'
      case ProjectFilter.ACTIVE:
        return 'è¿›è¡Œä¸­'
      case ProjectFilter.COMPLETED:
        return 'å·²å®Œæˆ'
      case ProjectFilter.PAUSED:
        return 'å·²æš‚åœ'
      case ProjectFilter.CANCELLED:
        return 'å·²å–æ¶ˆ'
      default:
        return 'å…¨éƒ¨'
    }
  }
}