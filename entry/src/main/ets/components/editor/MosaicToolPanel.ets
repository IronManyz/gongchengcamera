/**
 * é©¬èµ›å…‹æ¨¡ç³Šå·¥å…·é¢æ¿ç»„ä»¶
 * æä¾›é©¬èµ›å…‹ç”»ç¬”å’Œæ•æ„Ÿä¿¡æ¯æ¨¡ç³ŠåŠŸèƒ½
 */

import { ThemeManager } from '../../theme/ThemeManager'

export interface MosaicArea {
  id: string
  x: number
  y: number
  width: number
  height: number
  blurLevel: number
  mosaicSize: number
}

export interface MosaicMode {
  type: 'brush' | 'rectangle' | 'smart'
  name: string
  icon: string
  description: string
}

@ComponentV2
export struct MosaicToolPanel {
  @Param selectedMode: MosaicMode
  @Param blurLevel: number = 10
  @Param mosaicSize: number = 15
  @Param onModeChange?: (mode: MosaicMode) => void
  @Param onBlurLevelChange?: (level: number) => void
  @Param onMosaicSizeChange?: (size: number) => void
  @Param onClearAll?: () => void

  private readonly modes: MosaicMode[] = [
    {
      type: 'brush',
      name: 'ç”»ç¬”æ¨¡å¼',
      icon: 'ðŸ–Œï¸',
      description: 'è‡ªç”±æ¶‚æŠ¹é©¬èµ›å…‹'
    },
    {
      type: 'rectangle',
      name: 'çŸ©å½¢æ¨¡å¼',
      icon: 'â–­',
      description: 'æ¡†é€‰åŒºåŸŸè¿›è¡Œé©¬èµ›å…‹'
    },
    {
      type: 'smart',
      name: 'æ™ºèƒ½æ¨¡å¼',
      icon: 'âœ¨',
      description: 'è‡ªåŠ¨è¯†åˆ«äººè„¸è¿›è¡Œé©¬èµ›å…‹'
    }
  ]

  private readonly blurLevels = [
    { name: 'è½»åº¦', value: 5, preview: 'ðŸ™‚' },
    { name: 'ä¸­åº¦', value: 10, preview: 'ðŸ˜' },
    { name: 'é‡åº¦', value: 20, preview: 'ðŸ˜µ' },
    { name: 'å®Œå…¨', value: 50, preview: 'â¬›' }
  ]

  private readonly mosaicSizes = [5, 10, 15, 20, 30, 50]

  /**
   * æ¨¡å¼é€‰æ‹©å™¨
   */
  @Builder
  private ModeSelector() {
    Column({ space: 12 }) {
      Text('é©¬èµ›å…‹æ¨¡å¼')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Grid() {
        ForEach(this.modes, (mode: MosaicMode) => {
          GridItem() {
            Column({ space: 8 }) {
              Button() {
                Text(mode.icon)
                  .fontSize(24)
                  .fontColor(this.selectedMode?.type === mode.type ? '#FFFFFF' : '#666666')
              }
              .width(60)
              .height(60)
              .backgroundColor(this.selectedMode?.type === mode.type ? ThemeManager.getCurrentPrimaryColor() : '#F5F5F5')
              .borderRadius(12)
              .onClick(() => this.onModeChange?.(mode))

              Text(mode.name)
                .fontSize(12)
                .fontColor('#333333')
                .textAlign(TextAlign.Center)

              Text(mode.description)
                .fontSize(10)
                .fontColor('#999999')
                .textAlign(TextAlign.Center)
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsGap(16)
      .columnsGap(16)
      .width('100%')
      .padding(20)
    }
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  /**
   * æ¨¡ç³Šå¼ºåº¦è®¾ç½®
   */
  @Builder
  private BlurLevelSettings() {
    Column({ space: 16 }) {
      Text('æ¨¡ç³Šå¼ºåº¦')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      // å¼ºåº¦é¢„è§ˆ
      Row({ space: 16 }) {
        ForEach(this.blurLevels, (level, index) => {
          Column({ space: 8 }) {
            Text(level.name)
              .fontSize(12)
              .fontColor('#666666')

            Text(level.preview)
              .fontSize(32)
              .textAlign(TextAlign.Center)

            Text(`${level.value}px`)
              .fontSize(10)
              .fontColor('#999999')
          }
          .width(80)
          .height(100)
          .backgroundColor(this.blurLevel === level.value ? ThemeManager.getCurrentPrimaryColor() : '#F5F5F5')
          .borderRadius(8)
          .border({
            width: 2,
            color: this.blurLevel === level.value ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
          })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => this.onBlurLevelChange?.(level.value))
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)

      // è‡ªå®šä¹‰è°ƒèŠ‚
      Column({ space: 8 }) {
        Row() {
          Text('è‡ªå®šä¹‰å¼ºåº¦')
            .fontSize(14)
            .fontColor('#333333')
            .layoutWeight(1)

          Text(`${this.blurLevel}px`)
            .fontSize(14)
            .fontColor(ThemeManager.getCurrentPrimaryColor())
            .fontWeight(FontWeight.Medium)
        }

        Slider({
          value: this.blurLevel,
          min: 1,
          max: 100,
          step: 1,
          style: SliderStyle.OutSet
        })
        .width('100%')
        .trackColor('#E0E0E0')
        .selectedColor(ThemeManager.getCurrentPrimaryColor())
        .onChange((value: number) => this.onBlurLevelChange?.(value))

        // æ•ˆæžœé¢„è§ˆåŒºåŸŸ
        Row() {
          ForEach([0.2, 0.4, 0.6, 0.8], (opacity, index) => {
            Circle({ width: 30, height: 30 })
              .backgroundColor('#FF6B6B')
              .blur(this.blurLevel * opacity)
              .borderRadius(15)
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * é©¬èµ›å…‹å¤§å°è®¾ç½®
   */
  @Builder
  private MosaicSizeSettings() {
    Column({ space: 16 }) {
      Text('é©¬èµ›å…‹å¤§å°')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      // å¤§å°é¢„è§ˆç½‘æ ¼
      Grid() {
        ForEach(this.mosaicSizes, (size: number) => {
          GridItem() {
            Button() {
              // é©¬èµ›å…‹å—é¢„è§ˆ
              Grid() {
                ForEach(Array(size * size).fill(0), (_, index) => {
                  GridItem() {
                    Rectangle()
                      .width(100 / size)
                      .height(100 / size)
                      .fill(index % 2 === 0 ? '#FF0000' : '#00FF00')
                      .borderRadius(1)
                  }
                })
              }
              .width(50)
              .height(50)
              .borderRadius(8)
              .border({
                width: this.mosaicSize === size ? 3 : 1,
                color: this.mosaicSize === size ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
              })
            }
            .onClick(() => this.onMosaicSizeChange?.(size))
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsGap(8)
      .columnsGap(8)
      .width('100%')
      .padding(20)

      // å¤§å°æ•°å€¼æ˜¾ç¤º
      Row() {
        Text('é©¬èµ›å…‹å—å¤§å°')
          .fontSize(14)
          .fontColor('#333333')
          .layoutWeight(1)

        Text(`${this.mosaicSize} Ã— ${this.mosaicSize}px`)
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentPrimaryColor())
          .fontWeight(FontWeight.Medium)
      }

      // è‡ªå®šä¹‰è°ƒèŠ‚
      Slider({
        value: this.mosaicSize,
        min: 3,
        max: 100,
        step: 1,
        style: SliderStyle.OutSet
      })
      .width('100%')
      .trackColor('#E0E0E0')
      .selectedColor(ThemeManager.getCurrentPrimaryColor())
      .onChange((value: number) => this.onMosaicSizeChange?.(value))
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * ä½¿ç”¨æç¤º
   */
  @Builder
  private UsageTips() {
    Column({ space: 12 }) {
      Text('ä½¿ç”¨æç¤º')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Column({ space: 8 }) {
        Row({ space: 8 }) {
          Text('ðŸ’¡')
            .fontSize(16)

          Text('ç”»ç¬”æ¨¡å¼ï¼šç›´æŽ¥åœ¨éœ€è¦æ¨¡ç³Šçš„åŒºåŸŸæ¶‚æŠ¹')
            .fontSize(13)
            .fontColor('#666666')
            .layoutWeight(1)
        }

        Row({ space: 8 }) {
          Text('â–­')
            .fontSize(16)

          Text('çŸ©å½¢æ¨¡å¼ï¼šæ¡†é€‰éœ€è¦å¤„ç†çš„åŒºåŸŸ')
            .fontSize(13)
            .fontColor('#666666')
            .layoutWeight(1)
        }

        Row({ space: 8 }) {
          Text('âœ¨')
            .fontSize(16)

          Text('æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨è¯†åˆ«äººè„¸å’Œæ•æ„Ÿä¿¡æ¯')
            .fontSize(13)
            .fontColor('#666666')
            .layoutWeight(1)
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFF8F0')
      .borderRadius(8)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * æ¸…é™¤å’Œæ’¤é”€
   */
  @Builder
  private ActionButtons() {
    Row({ space: 12 }) {
      Button('æ¸…é™¤æ‰€æœ‰é©¬èµ›å…‹')
        .fontSize(14)
        .fontColor('#666666')
        .backgroundColor('#F5F5F5')
        .borderRadius(20)
        .border({ width: 1, color: '#E0E0E0' })
        .padding({ left: 20, right: 20 })
        .onClick(() => this.onClearAll?.())

      Button('æ’¤é”€ä¸Šä¸€æ­¥')
        .fontSize(14)
        .fontColor('#666666')
        .backgroundColor('#F5F5F5')
        .borderRadius(20)
        .border({ width: 1, color: '#E0E0E0' })
        .padding({ left: 20, right: 20 })
        .onClick(() => {
          // æ’¤é”€é©¬èµ›å…‹æ“ä½œ
        })

      Button('æ™ºèƒ½è¯†åˆ«')
        .fontSize(14)
        .fontColor('#FFFFFF')
        .backgroundColor(ThemeManager.getCurrentPrimaryColor())
        .borderRadius(20)
        .padding({ left: 20, right: 20 })
        .onClick(() => {
          // æ‰§è¡Œæ™ºèƒ½è¯†åˆ«
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .padding({ top: 16, bottom: 20 })
  }

  build() {
    Column({ space: 16 }) {
      this.ModeSelector()
      this.BlurLevelSettings()
      this.MosaicSizeSettings()
      this.UsageTips()
      this.ActionButtons()
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FAFAFA')
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 4
    })
  }
}