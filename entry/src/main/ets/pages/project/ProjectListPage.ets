/**
 * é¡¹ç›®åˆ—è¡¨é¡µé¢
 * æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®ï¼Œæ”¯æŒæœç´¢ã€è¿‡æ»¤ã€æ’åºå’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
 */

import router from '@ohos.router'
import { Project } from '../../models/Project'
import { projectStore } from '../../store/project/ProjectStore'
import { ProjectFilter, ProjectSortOrder, ProjectStatus } from '../../types/AppTypes'
import { SearchBar } from '../../components/common/SearchBar'
import { LoadingDialog } from '../../components/common/LoadingDialog'
import { ConfirmDialog } from '../../components/common/ConfirmDialog'
import { StatCard } from '../../components/common/StatCard'
import { ProjectCard } from '../../components/project/ProjectCard'

@Entry
@Component
struct ProjectListPage {
  // çŠ¶æ€ç®¡ç†
  @State private isLoading: boolean = false
  @State private isRefreshing: boolean = false
  @State private searchQuery: string = ''
  @State private currentFilter: ProjectFilter = ProjectFilter.ALL
  @State private selectedProject: Project | null = null
  @State private showDeleteDialog: boolean = false
  @State private showFilterDialog: boolean = false

  // é¡¹ç›®Store
  private projectStore = projectStore

  aboutToAppear() {
    this.loadProjectData()
  }

  /**
   * åŠ è½½é¡¹ç›®æ•°æ®
   */
  private async loadProjectData() {
    this.isLoading = true
    try {
      if (!this.projectStore.isInitialized) {
        await this.projectStore.initialize()
      } else {
        await this.projectStore.refresh()
      }
    } catch (error) {
      console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * ä¸‹æ‹‰åˆ·æ–°
   */
  private async onRefresh() {
    this.isRefreshing = true
    try {
      await this.projectStore.refresh()
    } catch (error) {
      console.error('åˆ·æ–°é¡¹ç›®æ•°æ®å¤±è´¥:', error)
    } finally {
      this.isRefreshing = false
    }
  }

  /**
   * æœç´¢å¤„ç†
   */
  private onSearch(query: string) {
    this.searchQuery = query
    this.projectStore.setSearchQuery(query)
  }

  /**
   * ç­›é€‰å¤„ç†
   */
  private onFilterChange(filter: ProjectFilter) {
    this.currentFilter = filter
    this.projectStore.setFilter(filter)
    this.showFilterDialog = false
  }

  /**
   * æ’åºå¤„ç†
   */
  private onSortOrderChange(sortOrder: ProjectSortOrder) {
    this.projectStore.setSortOrder(sortOrder)
  }

  /**
   * è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…
   */
  private navigateToProjectDetail(project: Project) {
    router.pushUrl({
      url: 'pages/project/ProjectDetailPage',
      params: {
        projectId: project.id
      }
    })
  }

  /**
   * è·³è½¬åˆ°åˆ›å»ºé¡¹ç›®
   */
  private navigateToCreateProject() {
    router.pushUrl({
      url: 'pages/project/ProjectEditPage',
      params: {
        mode: 'create'
      }
    })
  }

  /**
   * è·³è½¬åˆ°ç¼–è¾‘é¡¹ç›®
   */
  private navigateToEditProject(project: Project) {
    router.pushUrl({
      url: 'pages/project/ProjectEditPage',
      params: {
        mode: 'edit',
        projectId: project.id
      }
    })
  }

  /**
   * åˆ é™¤é¡¹ç›®
   */
  private async deleteProject() {
    if (this.selectedProject) {
      const success = await this.projectStore.deleteProject(this.selectedProject.id)
      if (success) {
        this.selectedProject = null
        this.showDeleteDialog = false
      }
    }
  }

  /**
   * è·å–é¡¹ç›®çŠ¶æ€é¢œè‰²
   */
  private getProjectStatusColor(status: ProjectStatus): string {
    switch (status) {
      case ProjectStatus.ACTIVE:
        return '#4CAF50'
      case ProjectStatus.COMPLETED:
        return '#2196F3'
      case ProjectStatus.PAUSED:
        return '#FF9800'
      case ProjectStatus.CANCELLED:
        return '#F44336'
      default:
        return '#757575'
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(date: Date): string {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
  }

  /**
   * è·å–é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
   */
  private getProjectStats() {
    const projects = this.projectStore.projects
    const totalProjects = projects.length
    const activeProjects = projects.filter(p => p.status === ProjectStatus.ACTIVE).length
    const totalSites = projects.reduce((sum, p) => sum + (p.siteCount || 0), 0)
    const totalPhotos = projects.reduce((sum, p) => sum + (p.photoCount || 0), 0)

    return {
      totalProjects,
      activeProjects,
      totalSites,
      totalPhotos
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildTopBar()

      // ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
      this.buildStatsOverview()

      // æœç´¢å’Œç­›é€‰æ 
      this.buildSearchAndFilterBar()

      // é¡¹ç›®åˆ—è¡¨
      this.buildProjectList()

      // åº•éƒ¨æ“ä½œæ 
      this.buildBottomActionBar()

      // åŠ è½½å¯¹è¯æ¡†
      if (this.isLoading) {
        LoadingDialog({ message: 'åŠ è½½ä¸­...' })
      }

      // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      if (this.showDeleteDialog && this.selectedProject) {
        ConfirmDialog({
          title: 'åˆ é™¤é¡¹ç›®',
          message: `ç¡®å®šè¦åˆ é™¤é¡¹ç›®"${this.selectedProject.getDisplayName()}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
          confirmText: 'åˆ é™¤',
          cancelText: 'å–æ¶ˆ',
          onConfirm: () => this.deleteProject(),
          onCancel: () => {
            this.showDeleteDialog = false
            this.selectedProject = null
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ„å»ºç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
   */
  @Builder
  private buildStatsOverview() {
    const stats = this.getProjectStats()

    Column() {
      // æ ‡é¢˜
      Text('ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#262626')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })

      // ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼
      Row() {
        StatCard({
          title: 'å·¥ç¨‹æ€»æ•°',
          value: stats.totalProjects,
          icon: $r('app.media.ic_folder'),
          color: '#1890FF',
          trend: 'stable'
        })
        .layoutWeight(1)

        StatCard({
          title: 'è¿›è¡Œä¸­',
          value: stats.activeProjects,
          icon: $r('app.media.ic_folder'),
          color: '#52C41A',
          trend: 'up'
        })
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })

      Row() {
        StatCard({
          title: 'å·¥ç‚¹æ€»è®¡',
          value: stats.totalSites,
          icon: $r('app.media.ic_folder'),
          color: '#FAAD14',
          trend: 'stable'
        })
        .layoutWeight(1)

        StatCard({
          title: 'ç…§ç‰‡æ€»è®¡',
          value: stats.totalPhotos,
          icon: $r('app.media.ic_folder'),
          color: '#722ED1',
          trend: 'up'
        })
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .shadow({
      radius: 6,
      color: '#00000008',
      offsetX: 0,
      offsetY: 3
    })
  }

  /**
   * æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private buildTopBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Image($r('app.media.ic_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      // æ ‡é¢˜
      Text('é¡¹ç›®ç®¡ç†')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // ç»Ÿè®¡ä¿¡æ¯
      if (this.projectStore.projectStats) {
        Text(`${this.projectStore.projectStats.totalCount}`)
          .fontSize(14)
          .fontColor('#666666')
          .margin({ right: 12 })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({
      radius: 2,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetX: 0,
      offsetY: 1
    })
  }

  /**
   * æ„å»ºæœç´¢å’Œç­›é€‰æ 
   */
  @Builder
  private buildSearchAndFilterBar() {
    Column({ space: 12 }) {
      // æœç´¢æ 
      SearchBar({
        query: this.searchQuery,
        placeholder: 'æœç´¢é¡¹ç›®åç§°ã€ä»£ç ã€å®¢æˆ·...',
        onSearch: (query: string) => this.onSearch(query),
        onChange: (query: string) => this.searchQuery = query
      })

      // ç­›é€‰å’Œæ’åºæ 
      Row({ space: 12 }) {
        // ç­›é€‰æŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Image($r('app.media.ic_filter'))
              .width(16)
              .height(16)
              .fillColor(this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#666666')

            Text(this.getFilterText(this.currentFilter))
              .fontSize(14)
              .fontColor(this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#666666')
          }
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .border({
          width: 1,
          color: this.currentFilter !== ProjectFilter.ALL ? '#007AFF' : '#E0E0E0'
        })
        .onClick(() => {
          this.showFilterDialog = !this.showFilterDialog
        })

        // æ’åºæŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Image($r('app.media.ic_sort'))
              .width(16)
              .height(16)
              .fillColor('#666666')

            Text('æœ€æ–°')
              .fontSize(14)
              .fontColor('#666666')
          }
        }
        .height(36)
        .padding({ left: 12, right: 12 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .border({ width: 1, color: '#E0E0E0' })
        .onClick(() => {
          // å¾ªç¯åˆ‡æ¢æ’åºæ–¹å¼
          const currentOrder = this.projectStore.currentSortOrder
          if (currentOrder === ProjectSortOrder.UPDATED_DESC) {
            this.onSortOrderChange(ProjectSortOrder.UPDATED_ASC)
          } else {
            this.onSortOrderChange(ProjectSortOrder.UPDATED_DESC)
          }
        })

        Blank()

        // æ¸…ç©ºç­›é€‰
        if (this.currentFilter !== ProjectFilter.ALL || this.searchQuery) {
          Button('æ¸…ç©º')
            .height(36)
            .fontSize(14)
            .fontColor('#666666')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.searchQuery = ''
              this.currentFilter = ProjectFilter.ALL
              this.projectStore.clearSearchConditions()
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // ç­›é€‰é€‰é¡¹å¼¹çª—
      if (this.showFilterDialog) {
        this.buildFilterDialog()
      }
    }
    .width('100%')
    .padding({ top: 12, bottom: 8 })
    .backgroundColor('#FFFFFF')
  }

  /**
   * æ„å»ºç­›é€‰å¯¹è¯æ¡†
   */
  @Builder
  private buildFilterDialog() {
    Column({ space: 0 }) {
      // ç­›é€‰é€‰é¡¹
      ForEach(
        [
          { key: ProjectFilter.ALL, label: 'å…¨éƒ¨é¡¹ç›®' },
          { key: ProjectFilter.ACTIVE, label: 'è¿›è¡Œä¸­' },
          { key: ProjectFilter.COMPLETED, label: 'å·²å®Œæˆ' },
          { key: ProjectFilter.PAUSED, label: 'å·²æš‚åœ' },
          { key: ProjectFilter.CANCELLED, label: 'å·²å–æ¶ˆ' }
        ],
        (filter: { key: ProjectFilter, label: string }) => {
          Row() {
            Text(filter.label)
              .fontSize(16)
              .fontColor(this.currentFilter === filter.key ? '#007AFF' : '#333333')
              .layoutWeight(1)

            if (this.currentFilter === filter.key) {
              Image($r('app.media.ic_check'))
                .width(20)
                .height(20)
                .fillColor('#007AFF')
            }
          }
          .width('100%')
          .height(48)
          .padding({ horizontal: 16 })
          .onClick(() => this.onFilterChange(filter.key))

          if (filter.key !== ProjectFilter.CANCELLED) {
            Divider().color('#F0F0F0')
          }
        },
        (filter: { key: ProjectFilter, label: string }) => filter.key
      )
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 2
    })
    .zIndex(10)
  }

  /**
   * æ„å»ºé¡¹ç›®åˆ—è¡¨
   */
  @Builder
  private buildProjectList() {
    Refresh({ refreshing: $$isRefreshing, friction: 100 }) {
      if (this.projectStore.hasFilteredProjects) {
        List({ space: 12, onRefresh: () => this.onRefresh() }) {
          ForEach(
            this.projectStore.filteredProjects,
            (project: Project) => {
              ListItem() {
                this.buildProjectItem(project)
              }
            },
            (project: Project) => project.id
          )
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      } else {
        Column() {
          Image($r('app.media.ic_folder'))
            .width(120)
            .height(120)
            .fillColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text(this.searchQuery ? 'æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®' : 'æš‚æ— é¡¹ç›®')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#666666')
            .margin({ bottom: 8 })

          Text(this.searchQuery ? 'å°è¯•ä¿®æ”¹æœç´¢æ¡ä»¶' : 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
            .lineHeight(20)
            .padding({ left: 32, right: 32 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        .margin({ left: 16, right: 16 })
      }
    }
  }

  /**
   * æ„å»ºé¡¹ç›®é¡¹
   */
  @Builder
  private buildProjectItem(project: Project) {
    ProjectCard({
      project: project,
      showStats: true,
      onTap: (project) => this.navigateToProjectDetail(project),
      onLongPress: (project) => {
        this.selectedProject = project
        this.showDeleteDialog = true
      }
    })
  }

  /**
   * æ„å»ºåº•éƒ¨æ“ä½œæ 
   */
  @Builder
  private buildBottomActionBar() {
    Row() {
      Button() {
        Row({ space: 8 }) {
          Image($r('app.media.ic_add'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')

          Text('æ–°å»ºé¡¹ç›®')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
      }
      .height(48)
      .padding({ horizontal: 24 })
      .backgroundColor('#007AFF')
      .borderRadius(24)
      .margin({ bottom: 20 })
      .onClick(() => this.navigateToCreateProject())
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Transparent)
  }

  /**
   * è·å–ç­›é€‰æ–‡æœ¬
   */
  private getFilterText(filter: ProjectFilter): string {
    switch (filter) {
      case ProjectFilter.ALL:
        return 'å…¨éƒ¨'
      case ProjectFilter.ACTIVE:
        return 'è¿›è¡Œä¸­'
      case ProjectFilter.COMPLETED:
        return 'å·²å®Œæˆ'
      case ProjectFilter.PAUSED:
        return 'å·²æš‚åœ'
      case ProjectFilter.CANCELLED:
        return 'å·²å–æ¶ˆ'
      default:
        return 'å…¨éƒ¨'
    }
  }
}