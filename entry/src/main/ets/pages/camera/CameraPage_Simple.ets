/**
 * ç®€åŒ–ç›¸æœºé¡µé¢
 * æ ¹æ®åŸå‹è®¾è®¡å®ç°çš„å·¥ç¨‹æ‹ç…§ç•Œé¢
 */

import router from '@ohos.router'
import { common } from '@kit.AbilityKit'
import { PermissionManager, PermissionStatus } from '../../utils/PermissionManager'
import { CameraManager, CameraResult } from '../../utils/CameraManager'

/**
 * Surfaceå°ºå¯¸æ¥å£
 */
interface SurfaceSize {
  width: number
  height: number
}

@Entry
@ComponentV2
struct CameraPage_Simple {
  @Local private isCameraReady: boolean = false
  @Local private isLoading: boolean = true
  @Local private showPreview: boolean = false
  @Local private capturedImagePath: string = ''
  @Local private capturedPhotoData: ArrayBuffer | null = null

  // æƒé™ç›¸å…³çŠ¶æ€
  @Local private permissionStatus: PermissionStatus = PermissionStatus.NOT_DETERMINED
  @Local private showPermissionDialog: boolean = false
  @Local private permissionMessage: string = ''

  // å·¥ç‚¹ä¿¡æ¯
  @Local private projectId: string = ''
  @Local private siteId: string = ''
  @Local private siteName: string = ''

  // è®¾ç½®é€‰é¡¹
  @Local private watermarkEnabled: boolean = true
  @Local private flashEnabled: boolean = false

  // ç›¸æœºç®¡ç†ç›¸å…³
  @Local private cameraManager: CameraManager | null = null
  @Local private cameraErrorMessage: string = ''
  @Local private surfaceId: string = ''
  @Local private showCameraError: boolean = false

  aboutToAppear(): void {
    this.loadRouteParams()
    this.checkAndRequestPermission()
  }

  aboutToDisappear(): void {
    console.log('=== CameraPage.aboutToDisappear() ===')
    this.releaseCamera()
  }

  /**
   * é‡Šæ”¾ç›¸æœºèµ„æº
   */
  private async releaseCamera(): Promise<void> {
    console.log('=== CameraPage.releaseCamera() ===')

    try {
      if (this.cameraManager) {
        await this.cameraManager.releaseCamera()
        this.cameraManager = null
        console.log('Camera resources released')
      }
    } catch (error) {
      console.error('Release camera failed:', error)
    }
  }

  /**
   * åŠ è½½è·¯ç”±å‚æ•°
   */
  private loadRouteParams(): void {
    try {
      const params = router.getParams() as Record<string, Object>
      if (params) {
        this.projectId = (params.projectId as string) || ''
        this.siteId = (params.siteId as string) || ''
        this.siteName = (params.siteName as string) || ''
      }
    } catch (error) {
      console.error('Failed to load route params:', error)
    }
  }

  /**
   * æ£€æŸ¥å¹¶ç”³è¯·ç›¸æœºæƒé™
   */
  private async checkAndRequestPermission(): Promise<void> {
    console.log('=== CameraPage.checkAndRequestPermission() ===')

    try {
      console.log('Getting UIAbility context for permission check...')
      // è·å–UIAbilityContext
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        console.error('Failed to get UIAbility context for permission check')
        throw new Error('Failed to get application context')
      }

      console.log('Checking camera permission...')
      // æ£€æŸ¥æƒé™çŠ¶æ€
      const permissionManager = PermissionManager.getInstance()
      const result = await permissionManager.ensureCameraPermission(context)

      this.permissionStatus = result.status
      this.permissionMessage = result.message || ''

      console.log('Permission result:', result)
      console.log('Permission status:', result.status)
      console.log('Permission message:', result.message)

      if (result.status === PermissionStatus.GRANTED) {
        console.log('Camera permission granted, initializing camera manager...')
        this.initCameraManager()
      } else {
        console.log('Camera permission not granted:', result.message)
        this.isLoading = false
        this.showPermissionDialog = true
      }
    } catch (error) {
      console.error('Permission check failed:', error)
      this.permissionMessage = `æƒé™æ£€æŸ¥å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      this.permissionStatus = PermissionStatus.DENIED
      this.isLoading = false
      this.showPermissionDialog = true
    }
  }

  /**
   * ç”³è¯·ç›¸æœºæƒé™
   */
  private async requestPermission(): Promise<void> {
    console.log('=== CameraPage.requestPermission() ===')

    try {
      const context = getContext(this) as common.UIAbilityContext
      const permissionManager = PermissionManager.getInstance()

      const result = await permissionManager.requestCameraPermission(context)

      this.permissionStatus = result.status
      this.permissionMessage = result.message || ''

      if (result.status === PermissionStatus.GRANTED) {
        console.log('Camera permission granted after request')
        this.showPermissionDialog = false
        this.isLoading = true
        this.initCameraManager()
      } else {
        console.log('Camera permission denied after request')
        this.permissionMessage = 'ç›¸æœºæƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯'
      }
    } catch (error) {
      console.error('Request permission failed:', error)
      this.permissionMessage = 'æƒé™ç”³è¯·å¤±è´¥'
    }
  }

  /**
   * åˆå§‹åŒ–ç›¸æœºç®¡ç†å™¨
   */
  private async initCameraManager(): Promise<void> {
    console.log('=== CameraPage.initCameraManager() ===')

    try {
      // è·å–ç›¸æœºç®¡ç†å™¨å®ä¾‹
      this.cameraManager = CameraManager.getInstance()
      console.log('Camera manager instance created')

      // é‡è¦ï¼šè®¾ç½®isLoadingä¸ºfalseï¼Œè®©XComponentå¯ä»¥æ¸²æŸ“
      this.isLoading = false
      console.log('Loading state set to false, XComponent should now render')

      // è®¾ç½®åˆå§‹åŒ–è¶…æ—¶ - 30ç§’åè‡ªåŠ¨åœæ­¢åŠ è½½
      const timeoutId = setTimeout(() => {
        if (!this.isCameraReady && !this.showCameraError) {
          console.error('Camera initialization timeout (30 seconds)')
          this.cameraErrorMessage = 'ç›¸æœºåˆå§‹åŒ–è¶…æ—¶ï¼Œè¯·é‡è¯•'
          this.showCameraError = true
        }
      }, 30000)

      // è®¾ç½®å›è°ƒ
      this.cameraManager.onInitialized(() => {
        console.log('Camera manager initialization callback triggered')
        clearTimeout(timeoutId) // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        this.isCameraReady = true
        console.log('Camera ready for use')
      })

      this.cameraManager.onError((error: string) => {
        console.error('Camera manager error:', error)
        clearTimeout(timeoutId) // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        this.cameraErrorMessage = error
        this.showCameraError = true
      })

      console.log('Camera manager initialized, waiting for surface ID')

    } catch (error) {
      console.error('Init camera manager failed:', error)
      this.cameraErrorMessage = `ç›¸æœºç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      this.showCameraError = true
      this.isLoading = false
    }
  }

  /**
   * ä½¿ç”¨Surface IDåˆå§‹åŒ–ç›¸æœº
   */
  async initializeCameraWithSurface(surfaceId: string): Promise<void> {
    console.log('=== CameraPage.initializeCameraWithSurface() ===')
    console.log('Surface ID:', surfaceId)
    console.log('Camera manager exists:', !!this.cameraManager)
    console.log('Current loading state:', this.isLoading)

    try {
      if (!this.cameraManager) {
        console.error('Camera manager is null or undefined')
        throw new Error('Camera manager not initialized')
      }

      console.log('Getting UIAbility context...')
      const context = getContext(this) as common.UIAbilityContext
      if (!context) {
        console.error('Failed to get UIAbility context')
        throw new Error('Failed to get application context')
      }

      console.log('Starting camera initialization with surface...')
      const result = await this.cameraManager.initializeCamera(context, surfaceId)
      console.log('Camera initialization result:', result)

      if (result.success) {
        console.log('Camera initialized with surface successfully')
        this.surfaceId = surfaceId
        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè®¾ç½®isLoading = falseï¼Œå› ä¸ºè¿™ä¼šåœ¨onInitializedå›è°ƒä¸­å¤„ç†
      } else {
        console.error('Camera initialization failed:', result.message)
        this.cameraErrorMessage = result.message || 'ç›¸æœºåˆå§‹åŒ–å¤±è´¥'
        this.showCameraError = true
        this.isLoading = false
      }

    } catch (error) {
      console.error('Initialize camera with surface failed:', error)
      this.cameraErrorMessage = `ç›¸æœºé¢„è§ˆåˆå§‹åŒ–å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      this.showCameraError = true
      this.isLoading = false
    }
  }

  /**
   * æ‹ç…§
   */
  private async takePhoto(): Promise<void> {
    console.log('=== CameraPage.takePhoto() ===')

    try {
      if (!this.cameraManager || !this.cameraManager.isCameraReady()) {
        console.error('Camera not ready for taking photo')
        this.cameraErrorMessage = 'ç›¸æœºæœªå°±ç»ªï¼Œæ— æ³•æ‹ç…§'
        this.showCameraError = true
        return
      }

      console.log('Taking photo with camera...')

      // æ‰§è¡ŒçœŸå®æ‹ç…§
      const result = await this.cameraManager.takePhoto()

      if (result.success) {
        console.log('Photo captured successfully')
        this.capturedPhotoData = result.data instanceof ArrayBuffer ? result.data : null
        this.capturedImagePath = `/storage/camera/photo_${Date.now()}.jpg`
        this.showPreview = true
        console.log('Photo data size:', this.capturedPhotoData?.byteLength || 0)
      } else {
        console.error('Take photo failed:', result.message)
        this.cameraErrorMessage = result.message || 'æ‹ç…§å¤±è´¥'
        this.showCameraError = true
      }

    } catch (error) {
      console.error('Take photo failed with exception:', error)
      this.cameraErrorMessage = 'æ‹ç…§è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯'
      this.showCameraError = true
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * é‡æ–°æ‹ç…§
   */
  private retakePhoto(): void {
    this.showPreview = false
    this.capturedImagePath = ''
  }

  /**
   * ç¡®è®¤ç…§ç‰‡
   */
  private confirmPhoto(): void {
    // TODO: ä¿å­˜ç…§ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“ï¼Œå…³è”å·¥ç‚¹
    console.log('Photo confirmed and saved')
    this.navigateBack()
  }

  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          Text('ğŸ“¸')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('ç›¸æœºåˆå§‹åŒ–ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#000000')

      } else if (this.showCameraError) {
        // ç›¸æœºé”™è¯¯çŠ¶æ€
        this.buildCameraErrorDialog()

      } else if (this.showPermissionDialog) {
        // æƒé™å¯¹è¯æ¡†çŠ¶æ€
        this.buildPermissionDialog()

      } else if (this.showPreview) {
        // é¢„è§ˆçŠ¶æ€
        this.buildPreviewView()

      } else if (this.isCameraReady) {
        // ç›¸æœºé¢„è§ˆçŠ¶æ€
        this.buildCameraView()

      } else {
        // é»˜è®¤çŠ¶æ€ - ç­‰å¾…ç›¸æœºç®¡ç†å™¨è®¾ç½®å®Œæˆ
        this.buildCameraView()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }

  /**
   * æ„å»ºç›¸æœºè§†å›¾
   */
  @Builder
  buildCameraView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('â†')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.navigateBack()
          })

        Blank()

        // å·¥ç‚¹ä¿¡æ¯
        if (this.siteName) {
          Text(this.siteName)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
        }

        Blank()

        // é—ªå…‰ç¯æŒ‰é’®
        Button(this.flashEnabled ? 'âš¡' : 'ğŸ”¦')
          .fontSize(20)
          .fontColor(this.flashEnabled ? '#FFD700' : '#FFFFFF')
          .backgroundColor('transparent')
          .onClick(async () => {
            if (this.cameraManager && this.cameraManager.isCameraReady()) {
              const result = await this.cameraManager.toggleFlash()
              if (result.success) {
                this.flashEnabled = !this.flashEnabled
                console.log('Flash toggled successfully')
              } else {
                console.error('Toggle flash failed:', result.message)
              }
            } else {
              console.log('Camera not ready for flash toggle')
            }
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // ç›¸æœºé¢„è§ˆåŒºåŸŸ
      Stack() {
        // ç›¸æœºé¢„è§ˆSurface
        XComponent({
          id: 'camera_preview',
          type: 'surface',
          libraryname: '',
        })
          .onLoad((xComponent: XComponentController) => {
            console.log('Camera preview XComponent loaded')
            try {
              xComponent.setXComponentSurfaceSize({
                surfaceWidth: 1280,
                surfaceHeight: 960
              })
              console.log('Surface size set: 1280 x 960')

              // è·å–Surface ID
              const surfaceId: string = xComponent.getXComponentSurfaceId()
              console.log('Surface ID:', surfaceId)

              if (surfaceId && surfaceId.length > 0) {
                // ä½¿ç”¨Surface IDåˆå§‹åŒ–ç›¸æœº
                console.log('Surface ID is valid, initializing camera...')
                this.initializeCameraWithSurface(surfaceId)
              } else {
                console.error('Surface ID is empty or invalid')
                this.cameraErrorMessage = 'ç›¸æœºé¢„è§ˆåŒºåŸŸåˆå§‹åŒ–å¤±è´¥ï¼šSurface IDæ— æ•ˆ'
                this.showCameraError = true
                this.isLoading = false
              }
            } catch (error) {
              console.error('Get surface size failed:', error)
              this.cameraErrorMessage = 'è·å–ç›¸æœºé¢„è§ˆåŒºåŸŸå¤±è´¥'
              this.showCameraError = true
              this.isLoading = false
            }
          })
          .width('100%')
          .height('100%')

        // æ°´å°è¦†ç›–å±‚
        if (this.watermarkEnabled) {
          Column({ space: 8 }) {
            Text('ğŸ“¸ å·¥ç¨‹æ‹è®°')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#00000080')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(16)

            if (this.siteName) {
              Text(`ğŸ“ ${this.siteName}`)
                .fontSize(12)
                .fontColor('#FFFFFF')
                .backgroundColor('#00000080')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(12)
            }

            Text(new Date().toLocaleString())
              .fontSize(12)
              .fontColor('#FFFFFF')
              .backgroundColor('#00000080')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }
          .position({ x: 16, y: 16 })
          .alignItems(HorizontalAlign.Start)
        }
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#000000')

      // åº•éƒ¨æ§åˆ¶æ 
      Column() {
        // åŠŸèƒ½æŒ‰é’®
        Row({ space: 20 }) {
          Button('ğŸ”')
            .fontSize(24)
            .fontColor('#FFFFFF')
            .backgroundColor('#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              // TODO: åˆ‡æ¢å‰åæ‘„åƒå¤´
              console.log('Switch camera')
            })

          // æ‹ç…§æŒ‰é’®
          Button()
            .width(80)
            .height(80)
            .borderRadius(40)
            .backgroundColor('#FFFFFF')
            .border({ width: 4, color: '#E0E0E0' })
            .onClick(() => {
              this.takePhoto()
            })

          Button('ğŸ’§')
            .fontSize(24)
            .fontColor(this.watermarkEnabled ? '#1890FF' : '#FFFFFF')
            .backgroundColor(this.watermarkEnabled ? '#FFFFFF20' : '#333333')
            .width(50)
            .height(50)
            .borderRadius(25)
            .onClick(() => {
              this.watermarkEnabled = !this.watermarkEnabled
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 20 })

        // æç¤ºä¿¡æ¯
        Text('è½»è§¦æ‹ç…§ï¼Œé•¿æŒ‰è¿æ‹')
          .fontSize(14)
          .fontColor('#CCCCCC')
          .margin({ bottom: 20 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 20 })
      .backgroundColor('#00000080')
    }
  }

  /**
   * æ„å»ºé¢„è§ˆè§†å›¾
   */
  @Builder
  buildPreviewView() {
    Column() {
      // é¡¶éƒ¨æ§åˆ¶æ 
      Row() {
        Button('âœ•')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.retakePhoto()
          })

        Blank()

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Medium)

        Blank()

        Button('âœ“')
          .fontSize(20)
          .fontColor('#1890FF')
          .backgroundColor('transparent')
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // å›¾ç‰‡é¢„è§ˆï¼ˆæ¨¡æ‹Ÿï¼‰
      Column() {
        Text('ğŸ–¼ï¸')
          .fontSize(64)
          .fontColor('#666666')
          .margin({ bottom: 16 })

        Text('ç…§ç‰‡é¢„è§ˆ')
          .fontSize(16)
          .fontColor('#999999')
          .margin({ bottom: 8 })

        Text(this.capturedImagePath)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (this.watermarkEnabled) {
          Text('ğŸ’§ åŒ…å«æ°´å°ä¿¡æ¯')
            .fontSize(14)
            .fontColor('#1890FF')
            .margin({ top: 8 })
        }

        if (this.siteName) {
          Text(`ğŸ“ å·¥ç‚¹: ${this.siteName}`)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#00000080')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#000000')

      // åº•éƒ¨æ“ä½œæ 
      Row({ space: 20 }) {
        Button('é‡æ–°æ‹ç…§')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#666666')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.retakePhoto()
          })

        Button('ä½¿ç”¨ç…§ç‰‡')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1890FF')
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(8)
          .onClick(() => {
            this.confirmPhoto()
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20, top: 16, bottom: 40 })
      .backgroundColor('#00000080')
    }
  }

  /**
   * æ„å»ºæƒé™å¯¹è¯æ¡†
   */
  @Builder
  buildPermissionDialog() {
    Column() {
      // æƒé™å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // å›¾æ ‡
        Text('ğŸ“¸')
          .fontSize(64)
          .fontColor('#FFFFFF')
          .margin({ bottom: 16 })

        // æ ‡é¢˜
        Text('éœ€è¦ç›¸æœºæƒé™')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 8 })

        // è¯´æ˜
        Text('å·¥ç¨‹æ‹è®°éœ€è¦è®¿é—®ç›¸æœºæ¥æ‹æ‘„å·¥ç¨‹ç°åœºç…§ç‰‡')
          .fontSize(16)
          .fontColor('#E0E0E0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 16 })

        Text('ç”¨äºé¡¹ç›®è®°å½•å’Œç®¡ç†')
          .fontSize(14)
          .fontColor('#B0B0B0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.permissionMessage) {
          Text(this.permissionMessage)
            .fontSize(14)
            .fontColor('#FF6B6B')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 20 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }

        // æŒ‰é’®ç»„
        Column({ space: 12 }) {
          if (this.permissionStatus === PermissionStatus.NOT_DETERMINED) {
            // é¦–æ¬¡ç”³è¯·æƒé™
            Button('æˆäºˆç›¸æœºæƒé™')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                console.log('User clicked grant permission')
                this.requestPermission()
              })
          } else {
            // æƒé™è¢«æ‹’ç»çš„æƒ…å†µ
            Button('é‡æ–°ç”³è¯·æƒé™')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(8)
              .onClick(() => {
                console.log('User clicked retry permission')
                this.requestPermission()
              })

            Button('å‰å¾€è®¾ç½®')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor('#1890FF')
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .border({ width: 1, color: '#1890FF' })
              .onClick(() => {
                console.log('User clicked open settings')
                const permissionManager = PermissionManager.getInstance()
                const context = getContext(this) as common.UIAbilityContext
                permissionManager.openAppSettings(context)
              })
          }

          Button('è¿”å›')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#8C8C8C')
            .backgroundColor('transparent')
            .borderRadius(8)
            .onClick(() => {
              console.log('User clicked back')
              this.navigateBack()
            })
        }
        .width('100%')
      }
      .width('88%')
      .backgroundColor('#1E1E1E')
      .borderRadius(16)
      .padding({ top: 32, bottom: 24, left: 24, right: 24 })
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.3)',
        offsetX: 0,
        offsetY: 8
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.8)')
    .onClick(() => {
      // ç‚¹å‡»èƒŒæ™¯ä¸ä¼šå…³é—­å¯¹è¯æ¡†ï¼Œç¡®ä¿ç”¨æˆ·å¿…é¡»åšå‡ºé€‰æ‹©
      console.log('Permission dialog background clicked - ignoring')
    })
  }

  /**
   * æ„å»ºç›¸æœºé”™è¯¯å¯¹è¯æ¡†
   */
  @Builder
  buildCameraErrorDialog() {
    Column() {
      // é”™è¯¯å¯¹è¯æ¡†å†…å®¹
      Column({ space: 20 }) {
        // å›¾æ ‡
        Text('âš ï¸')
          .fontSize(64)
          .fontColor('#FF6B6B')
          .margin({ bottom: 16 })

        // æ ‡é¢˜
        Text('ç›¸æœºé”™è¯¯')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 8 })

        // é”™è¯¯ä¿¡æ¯
        if (this.cameraErrorMessage) {
          Text(this.cameraErrorMessage)
            .fontSize(16)
            .fontColor('#E0E0E0')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 16 })
            .maxLines(3)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }

        // è¯´æ˜æ–‡å­—
        Text('è¯·æ£€æŸ¥ç›¸æœºæ˜¯å¦è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œæˆ–é‡å¯åº”ç”¨åé‡è¯•')
          .fontSize(14)
          .fontColor('#B0B0B0')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        // æŒ‰é’®ç»„
        Column({ space: 12 }) {
          Button('é‡è¯•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#1890FF')
            .borderRadius(8)
            .onClick(() => {
              console.log('User clicked retry camera')
              if (this.showCameraError !== undefined) {
                this.showCameraError = false
              }
              if (this.cameraErrorMessage !== undefined) {
                this.cameraErrorMessage = ''
              }
              if (this.isLoading !== undefined) {
                this.isLoading = true
              }
              this.initCameraManager()
            })

          Button('è¿”å›')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor('#8C8C8C')
            .backgroundColor('transparent')
            .borderRadius(8)
            .onClick(() => {
              console.log('User clicked back from camera error')
              this.navigateBack()
            })
        }
        .width('100%')
      }
      .width('88%')
      .backgroundColor('#1E1E1E')
      .borderRadius(16)
      .padding({ top: 32, bottom: 24, left: 24, right: 24 })
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.3)',
        offsetX: 0,
        offsetY: 8
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.8)')
    .onClick(() => {
      // ç‚¹å‡»èƒŒæ™¯ä¸ä¼šå…³é—­å¯¹è¯æ¡†
      console.log('Camera error dialog background clicked - ignoring')
    })
  }
}