/**
 * å·¥ç‚¹ç…§ç‰‡é¡µé¢
 * æ˜¾ç¤ºæŒ‡å®šå·¥ç‚¹çš„æ‰€æœ‰ç…§ç‰‡åˆ—è¡¨
 */

import router from '@ohos.router'
import { SimplePhoto } from '../../models/SimplePhoto'

@Entry
@ComponentV2
struct SitePhotoPage {
  @Local private siteId: string = ''
  @Local private siteName: string = ''
  @Local private projectId: string = ''
  @Local private photos: SimplePhoto[] = []
  @Local private isLoading: boolean = false
  @Local private selectedPhotos: SimplePhoto[] = []
  @Local private isSelectionMode: boolean = false
  @Local private sortBy: 'date' | 'name' | 'size' = 'date'
  @Local private sortOrder: 'asc' | 'desc' = 'desc'

  aboutToAppear(): void {
    this.loadRouteParams()
    this.loadPhotos()
  }

  /**
   * åŠ è½½è·¯ç”±å‚æ•°
   */
  private loadRouteParams(): void {
    try {
      const params = router.getParams() as Record<string, Object>
      if (params) {
        this.siteId = (params.siteId as string) || ''
        this.siteName = (params.siteName as string) || ''
        this.projectId = (params.projectId as string) || ''
      }
    } catch (error) {
      console.error('Failed to load route params:', error)
    }
  }

  /**
   * åŠ è½½ç…§ç‰‡åˆ—è¡¨
   */
  private async loadPhotos(): Promise<void> {
    this.isLoading = true
    try {
      // TODO: ä»æ•°æ®åº“åŠ è½½å·¥ç‚¹ç…§ç‰‡
      // ä¸´æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.photos = this.generateMockPhotos()
      this.sortPhotos()
    } catch (error) {
      console.error('Failed to load photos:', error)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * ç”Ÿæˆæ¨¡æ‹Ÿç…§ç‰‡æ•°æ®
   */
  private generateMockPhotos(): SimplePhoto[] {
    const mockPhotos: SimplePhoto[] = []
    const photoCount = Math.floor(Math.random() * 20) + 5

    for (let i = 0; i < photoCount; i++) {
      const photo = new SimplePhoto(
        `photo_${i + 1}`,
        `/mock/path/site_${this.siteId}/photo_${i + 1}.jpg`,
        this.projectId,
        this.siteId
      )

      photo.name = `${this.siteName}_ç…§ç‰‡_${i + 1}`
      photo.width = 1920
      photo.height = 1080
      photo.fileSize = Math.floor(Math.random() * 5000000) + 1000000
      photo.takenAt = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)

      // éšæœºä½ç½®ä¿¡æ¯
      if (Math.random() > 0.3) {
        photo.latitude = 39.915 + Math.random() * 0.1
        photo.longitude = 116.404 + Math.random() * 0.1
        photo.address = `${this.siteName}é™„è¿‘`
      }

      // éšæœºæ ‡ç­¾
      const tags = ['å·¥ç¨‹', 'å»ºç­‘', 'æ–½å·¥', 'è´¨é‡', 'å®‰å…¨', 'è¿›åº¦']
      photo.addTag(tags[Math.floor(Math.random() * tags.length)])

      // éšæœºç¼–è¾‘çŠ¶æ€
      if (Math.random() > 0.7) {
        photo.markAsEdited()
      }

      mockPhotos.push(photo)
    }

    return mockPhotos
  }

  /**
   * æ’åºç…§ç‰‡
   */
  private sortPhotos(): void {
    this.photos.sort((a, b) => {
      let result = 0

      switch (this.sortBy) {
        case 'date':
          result = a.takenAt.getTime() - b.takenAt.getTime()
          break
        case 'name':
          result = a.getDisplayName().localeCompare(b.getDisplayName())
          break
        case 'size':
          result = a.fileSize - b.fileSize
          break
      }

      return this.sortOrder === 'asc' ? result : -result
    })
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private navigateBack(): void {
    router.back()
  }

  /**
   * åˆ‡æ¢é€‰æ‹©æ¨¡å¼
   */
  private toggleSelectionMode(): void {
    this.isSelectionMode = !this.isSelectionMode
    if (!this.isSelectionMode) {
      this.selectedPhotos = []
    }
  }

  /**
   * é€‰æ‹©/å–æ¶ˆé€‰æ‹©ç…§ç‰‡
   */
  private togglePhotoSelection(photo: SimplePhoto): void {
    const index = this.selectedPhotos.findIndex(p => p.id === photo.id)
    if (index > -1) {
      this.selectedPhotos.splice(index, 1)
    } else {
      this.selectedPhotos.push(photo)
    }
  }

  /**
   * æ£€æŸ¥ç…§ç‰‡æ˜¯å¦è¢«é€‰ä¸­
   */
  private isPhotoSelected(photo: SimplePhoto): boolean {
    return this.selectedPhotos.some(p => p.id === photo.id)
  }

  /**
   * é€‰æ‹©æ‰€æœ‰ç…§ç‰‡
   */
  private selectAllPhotos(): void {
    this.selectedPhotos = [...this.photos]
  }

  /**
   * å–æ¶ˆé€‰æ‹©æ‰€æœ‰ç…§ç‰‡
   */
  private deselectAllPhotos(): void {
    this.selectedPhotos = []
  }

  /**
   * åˆ é™¤é€‰ä¸­çš„ç…§ç‰‡
   */
  private deleteSelectedPhotos(): void {
    if (this.selectedPhotos.length === 0) return

    // TODO: å®ç°ç…§ç‰‡åˆ é™¤ç¡®è®¤å’Œåˆ é™¤é€»è¾‘
    console.log(`Deleting ${this.selectedPhotos.length} photos`)

    // ä»åˆ—è¡¨ä¸­ç§»é™¤
    this.photos = this.photos.filter(photo =>
      !this.selectedPhotos.some(selected => selected.id === photo.id)
    )

    // æ¸…ç©ºé€‰æ‹©
    this.selectedPhotos = []
    this.isSelectionMode = false
  }

  /**
   * åˆ†äº«é€‰ä¸­çš„ç…§ç‰‡
   */
  private shareSelectedPhotos(): void {
    if (this.selectedPhotos.length === 0) return

    console.log(`Sharing ${this.selectedPhotos.length} photos`)
    // TODO: å®ç°ç…§ç‰‡åˆ†äº«åŠŸèƒ½
  }

  /**
   * é¢„è§ˆç…§ç‰‡
   */
  private previewPhoto(photo: SimplePhoto): void {
    router.pushUrl({
      url: 'pages/photo/PhotoPreviewPage',
      params: {
        photo: photo
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°ç…§ç‰‡é¢„è§ˆå¤±è´¥:', error)
    })
  }

  /**
   * æ‹ç…§
   */
  private takePhoto(): void {
    router.pushUrl({
      url: 'pages/camera/CameraPage_Simple',
      params: {
        projectId: this.projectId,
        siteId: this.siteId,
        siteName: this.siteName
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°ç›¸æœºå¤±è´¥:', error)
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        if (this.isSelectionMode) {
          // é€‰æ‹©æ¨¡å¼å¯¼èˆªæ 
          Button('âœ•')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('transparent')
            .onClick(() => {
              this.toggleSelectionMode()
            })

          Blank()

          Text(`å·²é€‰æ‹© ${this.selectedPhotos.length} å¼ `)
            .fontSize(16)
            .fontColor('#FFFFFF')

          Blank()

          if (this.selectedPhotos.length > 0) {
            Row({ space: 12 }) {
              Button('ğŸ—‘ï¸')
                .fontSize(20)
                .fontColor('#FF4444')
                .backgroundColor('transparent')
                .onClick(() => {
                  this.deleteSelectedPhotos()
                })

              Button('ğŸ“¤')
                .fontSize(20)
                .fontColor('#1890FF')
                .backgroundColor('transparent')
                .onClick(() => {
                  this.shareSelectedPhotos()
                })
            }
          }
        } else {
          // æŸ¥çœ‹æ¨¡å¼å¯¼èˆªæ 
          Button('â†')
            .fontSize(20)
            .fontColor('#FFFFFF')
            .backgroundColor('transparent')
            .onClick(() => {
              this.navigateBack()
            })

          Blank()

          Text(this.siteName || 'å·¥ç‚¹ç…§ç‰‡')
            .fontSize(18)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Blank()

          Row({ space: 12 }) {
            Button('ğŸ“¸')
              .fontSize(20)
              .fontColor('#FFFFFF')
              .backgroundColor('transparent')
              .onClick(() => {
                this.takePhoto()
              })

            Button('â˜‘ï¸')
              .fontSize(20)
              .fontColor('#FFFFFF')
              .backgroundColor('transparent')
              .onClick(() => {
                this.toggleSelectionMode()
              })
          }
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E8E8E8' })

      // å·¥ç‚¹ä¿¡æ¯åŒºåŸŸ
      if (!this.isSelectionMode) {
        Row() {
          Column() {
            Text('ğŸ“')
              .fontSize(16)
              .margin({ bottom: 4 })

            Text(`${this.photos.length} å¼ ç…§ç‰‡`)
              .fontSize(14)
              .fontColor('#666666')
          }
          .layoutWeight(1)

          // æ’åºé€‰é¡¹
          Row({ space: 8 }) {
            Text('æ’åº:')
              .fontSize(14)
              .fontColor('#666666')

            Button(this.sortBy === 'date' ? 'æ—¶é—´' : this.sortBy === 'name' ? 'åç§°' : 'å¤§å°')
              .fontSize(14)
              .fontColor('#1890FF')
              .backgroundColor('#F5F5F5')
              .onClick(() => {
                if (this.sortBy === 'date') {
                  this.sortBy = 'name'
                } else if (this.sortBy === 'name') {
                  this.sortBy = 'size'
                } else {
                  this.sortBy = 'date'
                }
                this.sortPhotos()
              })

            Button(this.sortOrder === 'desc' ? 'â†“' : 'â†‘')
              .fontSize(14)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .width(24)
              .height(24)
              .onClick(() => {
                this.sortOrder = this.sortOrder === 'desc' ? 'asc' : 'desc'
                this.sortPhotos()
              })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#FFFFFF')
      }

      // ç…§ç‰‡åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          Text('â³')
            .fontSize(48)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('åŠ è½½ç…§ç‰‡ä¸­...')
            .fontSize(16)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      } else if (this.photos.length === 0) {
        Column() {
          Text('ğŸ“·')
            .fontSize(64)
            .fontColor('#C0C0C0')
            .margin({ bottom: 16 })

          Text('æš‚æ— ç…§ç‰‡')
            .fontSize(18)
            .fontColor('#8C8C8C')
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»ç›¸æœºæŒ‰é’®æ‹æ‘„ç¬¬ä¸€å¼ ç…§ç‰‡')
            .fontSize(14)
            .fontColor('#BFBFBF')
            .margin({ bottom: 20 })

          Button('ğŸ“¸ å¼€å§‹æ‹ç…§')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#1890FF')
            .padding({ left: 24, right: 24, top: 12, bottom: 12 })
            .borderRadius(8)
            .onClick(() => {
              this.takePhoto()
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
      } else {
        this.buildPhotoGrid()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ„å»ºç…§ç‰‡ç½‘æ ¼
   */
  @Builder
  private buildPhotoGrid() {
    Grid() {
      ForEach(this.photos, (photo: SimplePhoto) => {
        GridItem() {
          this.buildPhotoItem(photo)
        }
      })
    }
    .columnsTemplate('1fr 1fr 1fr')
    .rowsGap(8)
    .columnsGap(8)
    .padding(12)
    .layoutWeight(1)
    .backgroundColor('#F5F5F5')
  }

  /**
   * æ„å»ºç…§ç‰‡é¡¹
   */
  @Builder
  private buildPhotoItem(photo: SimplePhoto) {
    Stack() {
      // ç…§ç‰‡ç¼©ç•¥å›¾
      Column() {
        // æ¨¡æ‹Ÿç…§ç‰‡æ˜¾ç¤º
        Column() {
          Text('ğŸ–¼ï¸')
            .fontSize(32)
            .fontColor('#CCCCCC')
            .margin({ bottom: 4 })

          Text(photo.getRelativeTimeText())
            .fontSize(10)
            .fontColor('#999999')
            .maxLines(1)
        }
        .width('100%')
        .height(120)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F0F0F0')
        .borderRadius(8)
      }

      // é€‰æ‹©æŒ‡ç¤ºå™¨
      if (this.isSelectionMode) {
        Row() {
          Blank()
          Column() {
            Circle({ width: 20, height: 20 })
              .fill(this.isPhotoSelected(photo) ? '#1890FF' : '#00000060')
              .stroke(Color.White)
              .strokeWidth(2)
              .margin(8)

            if (this.isPhotoSelected(photo)) {
              Text('âœ“')
                .fontSize(12)
                .fontColor(Color.White)
                .position({ x: 0, y: -15 })
                .width(20)
                .textAlign(TextAlign.Center)
            }
          }
        }
        .width('100%')
        .height('100%')
        .onClick(() => {
          this.togglePhotoSelection(photo)
        })
      } else {
        Stack()
          .onClick(() => {
            this.previewPhoto(photo)
          })
      }

      // çŠ¶æ€æŒ‡ç¤ºå™¨
      if (photo.isEdited) {
        Text('âœï¸')
          .fontSize(12)
          .fontColor('#1890FF')
          .backgroundColor('#FFFFFF')
          .padding({ left: 4, right: 4, top: 2, bottom: 2 })
          .borderRadius(4)
          .position({ x: 4, y: 4 })
      }

      if (photo.hasLocation()) {
        Text('ğŸ“')
          .fontSize(12)
          .fontColor('#52C41A')
          .backgroundColor('#FFFFFF')
          .padding({ left: 4, right: 4, top: 2, bottom: 2 })
          .borderRadius(4)
          .position({ x: 4, y: 20 })
      }
    }
    .width('100%')
    .aspectRatio(1)
  }
}