/**
 * ç…§ç‰‡æœç´¢ç®¡ç†ç»„ä»¶
 * æä¾›æŒ‰å…³é”®è¯ã€æ ‡ç­¾ã€æ—¶é—´çš„æœç´¢åŠŸèƒ½
 */

import { ThemeManager } from '../../theme/ThemeManager'
import { Photo } from '../../models/Photo'

export interface SearchFilter {
  keyword?: string
  tags?: string[]
  dateRange?: { start: Date, end: Date }
  projectIds?: string[]
  siteIds?: string[]
}

export interface SearchResult {
  photos: Photo[]
  totalCount: number
  hasMore: boolean
}

export interface SearchSuggestion {
  id: string
  text: string
  type: 'keyword' | 'tag' | 'date' | 'project' | 'site'
  icon?: string
  count?: number
}

@ComponentV2
export struct PhotoSearchManager {
  @Param onFilterChange?: (filter: SearchFilter) => void
  @Param onSearch?: (result: SearchResult) => void

  @State private searchQuery: string = ''
  @State private showAdvancedSearch: boolean = false
  @State private selectedTags: string[] = []
  @State private dateRange: { start: Date, end: Date } = { start: new Date(), end: new Date() }
  @State private suggestions: SearchSuggestion[] = []
  @State private searchHistory: string[] = []
  @State private isSearching: boolean = false

  private readonly quickTags = [
    'è´¨é‡é—®é¢˜', 'å®‰å…¨æ£€æŸ¥', 'è¿›åº¦è®°å½•', 'éªŒæ”¶é€šè¿‡',
    'ææ–™è¿›åœº', 'æ–½å·¥ç…§ç‰‡', 'å®ŒæˆæŠ¥å‘Š', 'è®¾å¤‡è°ƒè¯•',
    'äººå‘˜ç­¾åˆ°', 'å®‰å…¨ä¼šè®®', 'æŠ€æœ¯äº¤åº•', 'å˜æ›´ç”³è¯·'
  ]

  private readonly dateRanges = [
    { label: 'ä»Šå¤©', value: 1 },
    { label: 'æ˜¨å¤©', value: 2 },
    { label: 'æœ¬å‘¨', value: 3 },
    { label: 'æœ¬æœˆ', value: 4 },
    { label: 'è¿‘ä¸‰æœˆ', value: 5 },
    { label: 'æœ¬å¹´', value: 6 },
    { label: 'è‡ªå®šä¹‰', value: 0 }
  ]

  /**
   * è·å–æœç´¢å»ºè®®
   */
  private getSearchSuggestions(): SearchSuggestion[] {
    const suggestions: SearchSuggestion[] = []

    // æœç´¢å†å²å»ºè®®
    this.searchHistory.forEach((query, index) => {
      suggestions.push({
        id: `history_${index}`,
        text: query,
        type: 'keyword',
        icon: 'ğŸ•'
      })
    })

    // æ ‡ç­¾å»ºè®®
    if (this.searchQuery) {
      this.quickTags.forEach(tag => {
        if (tag.toLowerCase().includes(this.searchQuery.toLowerCase())) {
          suggestions.push({
            id: tag,
            text: tag,
            type: 'tag',
            icon: 'ğŸ·ï¸'
          })
        }
      })
    }

    // å¿«é€Ÿæ—¥æœŸèŒƒå›´å»ºè®®
    if (this.searchQuery.toLowerCase().includes('æ—¥æœŸ') ||
        this.searchQuery.toLowerCase().includes('ä»Šå¤©') ||
        this.searchQuery.toLowerCase().includes('æ˜¨å¤©')) {
      this.dateRanges.forEach(range => {
        if (range.label.toLowerCase().includes(this.searchQuery.toLowerCase())) {
          suggestions.push({
            id: range.label,
            text: range.label,
            type: 'date',
            icon: 'ğŸ“…'
          })
        }
      })
    }

    return suggestions.slice(0, 8)
  }

  /**
   * æ‰§è¡Œæœç´¢
   */
  private async performSearch(): Promise<void> {
    if (!this.searchQuery.trim()) {
      return
    }

    this.isSearching = true

    try {
      const filter: SearchFilter = {
        keyword: this.searchQuery,
        tags: this.selectedTags,
        dateRange: this.dateRange.start && this.dateRange.end ? this.dateRange : undefined,
        projectIds: undefined,
        siteIds: undefined
      }

      // è°ƒç”¨æœç´¢å›è°ƒ
      this.onSearch?.({
        photos: [], // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„æœç´¢é€»è¾‘
        totalCount: 0,
        hasMore: false
      })

      // æ·»åŠ åˆ°æœç´¢å†å²
      if (!this.searchHistory.includes(this.searchQuery)) {
        this.searchHistory = [this.searchQuery, ...this.searchHistory.slice(0, 9)]
      }

    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error)
    } finally {
      this.isSearching = false
    }
  }

  /**
   * æ¸…é™¤æœç´¢
   */
  private clearSearch(): void {
    this.searchQuery = ''
    this.selectedTags = []
    this.suggestions = []
  }

  /**
   * åº”ç”¨æœç´¢å»ºè®®
   */
  private applySuggestion(suggestion: SearchSuggestion): void {
    if (suggestion.type === 'keyword') {
      this.searchQuery = suggestion.text
    } else if (suggestion.type === 'tag') {
      this.selectedTags = [suggestion.text]
    }
    this.suggestions = []
    this.performSearch()
  }

  /**
   * æœç´¢è¾“å…¥æ 
   */
  @Builder
  private SearchInputBar() {
    Column({ space: 8 }) {
      Row({ space: 12 }) {
        // æœç´¢è¾“å…¥æ¡†
        Row({ space: 8 }) {
          TextInput({
            placeholder: 'æœç´¢ç…§ç‰‡ã€æ ‡ç­¾ã€æ—¥æœŸ...',
            text: this.searchQuery
          })
          .width('100%')
          .height(40)
          .fontSize(14)
          .fontColor('#333333')
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .border({ width: 1, color: '#E0E0E0' })
          .padding({ left: 16, right: 8 })
          .onChange((value: string) => {
            this.searchQuery = value
            this.suggestions = this.getSearchSuggestions()
          })
          .onSubmit(() => {
            this.performSearch()
          })

          // æ¸…é™¤æŒ‰é’®
          if (this.searchQuery) {
            Button('âœ•')
              .fontSize(16)
              .fontColor('#999999')
              .backgroundColor(Color.Transparent)
              .width(32)
              .height(32)
              .onClick(() => this.clearSearch())
          }
        }

        // æœç´¢æŒ‰é’®
        Button() {
          Text('ğŸ”')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width(40)
        .height(40)
        .backgroundColor(ThemeManager.getCurrentPrimaryColor())
        .borderRadius(20)
        .onClick(() => this.performSearch())
      }
    }
    .width('100%')

    // é«˜çº§æœç´¢åˆ‡æ¢
    Row() {
      Blank()

      Button(this.showAdvancedSearch ? 'æ”¶èµ·' : 'é«˜çº§æœç´¢')
        .fontSize(14)
        .fontColor('#666666')
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.showAdvancedSearch = !this.showAdvancedSearch
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .padding({ right: 16 })
  }

  /**
   * å¿«é€Ÿæ ‡ç­¾é€‰æ‹©
   */
  @Builder
  private QuickTagSelector() {
    Column({ space: 12 }) {
      Text('å¿«é€Ÿæ ‡ç­¾')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.quickTags, (tag: string) => {
            Button(tag)
              .fontSize(12)
              .fontColor(
                this.selectedTags.includes(tag) ? '#FFFFFF' : '#333333'
              )
              .backgroundColor(
                this.selectedTags.includes(tag) ? ThemeManager.getCurrentPrimaryColor() : '#F5F5F5'
              )
              .borderRadius(16)
              .padding({ left: 12, right: 12 })
              .border({
                width: 1,
                color: this.selectedTags.includes(tag) ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
              })
              .onClick(() => {
                if (this.selectedTags.includes(tag)) {
                  this.selectedTags = this.selectedTags.filter(t => t !== tag)
                } else {
                  this.selectedTags.push(tag)
                }
              })
          })
        })
      }
      .width('100%')
      .scrollBar(BarState.Off)
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
   */
  @Builder
  private DateRangeSelector() {
    Column({ space: 12 }) {
      Text('æ—¥æœŸèŒƒå›´')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Grid() {
        ForEach(this.dateRanges, (range) => {
          GridItem() {
            Button(range.label)
              .fontSize(12)
              .fontColor(
                this.dateRange.value === range.value ? '#FFFFFF' : '#333333'
              )
              .backgroundColor(
                this.dateRange.value === range.value ? ThemeManager.getCurrentPrimaryColor() : '#F5F5F5'
              )
              .borderRadius(8)
              .padding({ left: 12, right: 12 })
              .border({
                width: 1,
                color: this.dateRange.value === range.value ? ThemeManager.getCurrentPrimaryColor() : '#E0E0E0'
              })
              .onClick(() => {
                if (range.value === 0) {
                  // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
                  this.showCustomDatePicker()
                } else {
                  const today = new Date()
                  const days = range.value
                  const startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000))
                  this.dateRange = { start: startDate, end: today }
                }
              })
          })
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsGap(8)
      .columnsGap(8)
      .width('100%')
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * æœç´¢å»ºè®®åˆ—è¡¨
   */
  @Builder
  private SearchSuggestions() {
    if (this.suggestions.length > 0) {
      Column({ space: 4 }) {
        ForEach(this.suggestions, (suggestion: SearchSuggestion) => {
          Row({ space: 8 }) {
            Text(suggestion.icon || 'ğŸ”')
              .fontSize(16)

            Text(suggestion.text)
              .fontSize(14)
              .fontColor('#333333')
              .layoutWeight(1)

            if (suggestion.count) {
              Text(`${suggestion.count}`)
                .fontSize(12)
                .fontColor('#999999')
            }
          }
          .width('100%')
          .padding(12)
          .borderRadius(8)
          .backgroundColor('#F8F9FA')
          .onClick(() => this.applySuggestion(suggestion))
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8 })
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
    }
  }

  /**
   * æœç´¢çŠ¶æ€æŒ‡ç¤ºå™¨
   */
  @Builder
  private SearchIndicator() {
    if (this.isSearching) {
      Row({ space: 8 }) {
        LoadingProgress()
          .width(16)
          .height(16)
          .color(ThemeManager.getCurrentPrimaryColor())

        Text('æœç´¢ä¸­...')
          .fontSize(14)
          .fontColor('#666666')
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .padding(20)
  }

  build() {
    Column({ space: 16 }) {
      this.SearchInputBar()

      if (this.showAdvancedSearch) {
        Column({ space: 16 }) {
          this.QuickTagSelector()
          this.DateRangeSelector()
        }
      }

      this.SearchSuggestions()

      if (this.isSearching) {
        this.SearchIndicator()
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FAFAFA')
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 4
    })
  }

  /**
   * æ˜¾ç¤ºè‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨
   */
  private showCustomDatePicker(): void {
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥æœŸé€‰æ‹©å™¨
    console.log('æ˜¾ç¤ºè‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨')
  }
}