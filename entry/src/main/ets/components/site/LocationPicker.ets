/**
 * ä½ç½®é€‰æ‹©å™¨ç»„ä»¶
 * æä¾›åœ°å›¾é€‰ç‚¹å’Œç»çº¬åº¦è¾“å…¥åŠŸèƒ½
 */

import { ThemeManager } from '../../theme/ThemeManager'

export interface LocationData {
  latitude: number
  longitude: number
  altitude?: number
  address?: string
}

@ComponentV2
export struct LocationPicker {
  @Require @Param onLocationSelected: (location: LocationData) => void = () => {}
  @Param initialLocation?: LocationData
  @Param showAltitude: boolean = true
  @Param showAddress: boolean = true
  @Param title: string = 'é€‰æ‹©ä½ç½®'

  @State private latitude: string = ''
  @State private longitude: string = ''
  @State private altitude: string = ''
  @State private address: string = ''
  @State private showMapDialog: boolean = false
  @State private selectedLocation: LocationData = {
    latitude: 0,
    longitude: 0,
    altitude: 0
  }

  aboutToAppear() {
    if (this.initialLocation) {
      this.latitude = this.initialLocation.latitude.toString()
      this.longitude = this.initialLocation.longitude.toString()
      this.altitude = this.initialLocation.altitude?.toString() || '0'
      this.address = this.initialLocation.address || ''
      this.selectedLocation = this.initialLocation
    }
  }

  /**
   * éªŒè¯ä½ç½®æ•°æ®
   */
  private validateLocation(): boolean {
    const lat = parseFloat(this.latitude)
    const lng = parseFloat(this.longitude)
    const alt = parseFloat(this.altitude)

    return !isNaN(lat) && !isNaN(lng) && !isNaN(alt) &&
           lat >= -90 && lat <= 90 &&
           lng >= -180 && lng <= 180 &&
           alt >= -1000 && alt <= 10000
  }

  /**
   * ç¡®è®¤ä½ç½®é€‰æ‹©
   */
  private confirmLocation(): void {
    if (!this.validateLocation()) {
      console.warn('ä½ç½®æ•°æ®æ— æ•ˆ')
      return
    }

    this.selectedLocation = {
      latitude: parseFloat(this.latitude),
      longitude: parseFloat(this.longitude),
      altitude: parseFloat(this.altitude),
      address: this.address.trim() || undefined
    }

    if (this.onLocationSelected) {
      this.onLocationSelected(this.selectedLocation)
    }

    this.showMapDialog = false
  }

  /**
   * ç®€å•åœ°å›¾é¢„è§ˆ
   */
  @Builder
  private SimpleMapPreview() {
    Column() {
      Text('ðŸ“')
        .fontSize(24)
        .fontColor('#1890FF')
        .margin({ bottom: 8 })

      Text('ç‚¹å‡»é€‰æ‹©åœ°å›¾ä½ç½®')
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)

      if (this.validateLocation()) {
        Row({ space: 16 }) {
          Column() {
            Text('ðŸ“')
              .fontSize(16)
              .fontColor('#52C41A')

            Text(`${this.latitude.toFixed(4)}Â°`)
              .fontSize(12)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
          }

          Column() {
            Text('ðŸŒ')
              .fontSize(16)
              .fontColor('#1890FF')

            Text(`${this.longitude.toFixed(4)}Â°`)
              .fontSize(12)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
          }

          if (this.showAltitude) {
            Column() {
              Text('â›°ï¸')
                .fontSize(16)
                .fontColor('#FAAD14')

              Text(`${this.altitude}m`)
                .fontSize(12)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
            }
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F8F9FA')
        .borderRadius(8)
        .margin({ top: 16 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
  }

  /**
   * æ‰‹åŠ¨è¾“å…¥ä½ç½®
   */
  @Builder
  private ManualLocationInput() {
    Column({ space: 16 }) {
      Text('æ‰‹åŠ¨è¾“å…¥åæ ‡')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeManager.getCurrentTextColor())
        .margin({ bottom: 12 })

      // çº¬åº¦è¾“å…¥
      Row({ space: 12 }) {
        Text('çº¬åº¦')
          .fontSize(14)
          .fontColor('#666666')
          .width(60)

        TextInput({ placeholder: 'ä¾‹: 39.9042' })
          .width('100%')
          .height(44)
          .fontSize(14)
          .fontColor('#333333')
          .backgroundColor('#FFFFFF')
          .borderRadius(6)
          .border({ width: 1, color: '#E0E0E0' })
          .onChange((value: string) => {
            this.latitude = value
          })
      }
      .width('100%')
    }

      // ç»åº¦è¾“å…¥
      Row({ space: 12 }) {
        Text('ç»åº¦')
          .fontSize(14)
          .fontColor('#666666')
          .width(60)

        TextInput({ placeholder: 'ä¾‹: 116.4074' })
          .width('100%')
          .height(44)
          .fontSize(14)
          .fontColor('#333333')
          .backgroundColor('#FFFFFF')
          .borderRadius(6)
          .border({ width: 1, color: '#E0E0E0' })
          .onChange((value: string) => {
            this.longitude = value
          })
      }
      .width('100%')
    }

      // æµ·æ‹”è¾“å…¥
      if (this.showAltitude) {
        Row({ space: 12 }) {
          Text('æµ·æ‹”')
            .fontSize(14)
            .fontColor('#666666')
            .width(60)

          TextInput({ placeholder: 'ä¾‹: 50' })
            .width('100%')
            .height(44)
            .fontSize(14)
            .fontColor('#333333')
            .backgroundColor('#FFFFFF')
            .borderRadius(6)
            .border({ width: 1, color: '#E0E0E0' })
            .onChange((value: string) => {
              this.altitude = value
            })
        }
        .width('100%')
      }

      // åœ°å€è¾“å…¥
      if (this.showAddress) {
        Row({ space: 12 }) {
          Text('åœ°å€')
            .fontSize(14)
            .fontColor('#666666')
            .width(60)

          TextInput({ placeholder: 'è¯¦ç»†åœ°å€' })
            .width('100%')
            .height(44)
            .fontSize(14)
            .fontColor('#333333')
            .backgroundColor('#FFFFFF')
            .borderRadius(6)
            .border({ width: 1, color: '#E0E0E0' })
            .onChange((value: string) => {
              this.address = value
            })
        }
        .width('100%')
      }
    }
    .padding(16)
    .backgroundColor('#FAFAFA')
    .borderRadius(8)
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeManager.getCurrentTextColor())
          .layoutWeight(1)

        Button('å…³é—­')
          .fontSize(14)
          .fontColor(ThemeManager.getCurrentPrimaryColor())
          .backgroundColor(Color.Transparent)
          .onClick(() => this.showMapDialog = false)
      }
      .width('100%')
      .padding({ top: 16, left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.showMapDialog) {
        // åœ°å›¾é€‰æ‹©å¯¹è¯æ¡†
        Column() {
          // ç®€å•åœ°å›¾é¢„è§ˆ
          this.SimpleMapPreview()

          // è¾“å…¥åˆ‡æ¢æŒ‰é’®
          Row() {
            Button('åœ°å›¾é€‰æ‹©')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(6)
              .margin({ right: 8 })
              .onClick(() => {
                // è¿™é‡Œå¯ä»¥é›†æˆçœŸå®žçš„åœ°å›¾ç»„ä»¶
                console.log('æ‰“å¼€åœ°å›¾é€‰æ‹©å™¨')
              })

            Button('æ‰‹åŠ¨è¾“å…¥')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#52C41A')
              .borderRadius(6)
              .onClick(() => {
                this.showMapDialog = false
              })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FAFAFA')
          .borderRadius(8)
        }

        // æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
        this.ManualLocationInput()

        // ç¡®è®¤æŒ‰é’®
        Row() {
          Blank()

          Button() {
            Text('ç¡®è®¤é€‰æ‹©')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
          }
          .height(44)
          .padding({ left: 24, right: 24 })
          .backgroundColor('#1890FF')
          .borderRadius(22)
          .onClick(() => this.confirmLocation())
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: '#00000020',
        offsetX: 0,
        offsetY: 4
      })
      .margin({ top: 16, left: 16, right: 16 })
    }

    // è§¦å‘æŒ‰é’®
    Button() {
      Text('é€‰æ‹©ä½ç½®')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
    }
    .height(44)
    .padding({ left: 20, right: 20 })
    .backgroundColor(ThemeManager.getCurrentPrimaryColor())
    .borderRadius(22)
    .onClick(() => {
      this.showMapDialog = true
    })
    .width('100%')
    .margin(16)
    .shadow({
      radius: 6,
      color: '#00000015',
      offsetX: 0,
      offsetY: 2
    })
  }
}