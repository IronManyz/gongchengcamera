/**
 * ä¸»ç•Œé¢ - å·¥ç¨‹åˆ—è¡¨
 * æ ¹æ®åŽŸåž‹è®¾è®¡å®žçŽ°çš„å·¥ç¨‹ç®¡ç†ä¸»ç•Œé¢
 * åŒ…å«ç»Ÿè®¡æ¦‚è§ˆã€å·¥ç¨‹åˆ—è¡¨å’Œåº•éƒ¨å¯¼èˆª
 */

import router from '@ohos.router'
import { StatCard } from '../components/common/StatCard'
import { SimpleProjectCard } from '../components/project/SimpleProjectCard'
import { SimpleProject, ProjectStatus } from '../models/SimpleProject'

@Entry
@Component
struct MainPage {
  @State private currentTab: string = 'projects'
  @State private searchQuery: string = ''
  @State private selectedProjectCount: number = 3
  @State private selectedSiteCount: number = 12
  @State private selectedPhotoCount: number = 156

  // æ¨¡æ‹Ÿå·¥ç¨‹æ•°æ®
  private projects: SimpleProject[] = [
    new SimpleProject('P2025-001', 'å¸‚æ”¿é“è·¯æ”¹é€ å·¥ç¨‹', ProjectStatus.ACTIVE, 'å¼ ä¸‰', 4, 52),
    new SimpleProject('P2025-002', 'ç”µåŠ›çº¿è·¯å·¡æ£€å·¥ç¨‹', ProjectStatus.COMPLETED, 'æŽå››', 6, 89),
    new SimpleProject('P2025-003', 'å›­æž—ç»¿åŒ–é¡¹ç›®', ProjectStatus.PAUSED, 'çŽ‹äº”', 2, 15)
  ]

  aboutToAppear(): void {
    console.log('MainPage aboutToAppear')
  }

  /**
   * å¤„ç†é¡¹ç›®å¡ç‰‡ç‚¹å‡»
   */
  private handleProjectClick(project: SimpleProject): void {
    console.log('Project clicked:', project.name)
    // TODO: è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…é¡µé¢
    router.pushUrl({
      url: 'pages/project/ProjectDetailPage',
      params: { projectId: project.id }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…å¤±è´¥:', error)
    })
  }

  /**
   * å¤„ç†é¡¹ç›®å¡ç‰‡é•¿æŒ‰
   */
  private handleProjectLongPress(project: SimpleProject): void {
    console.log('Project long pressed:', project.name)
    // TODO: æ˜¾ç¤ºé¡¹ç›®æ“ä½œèœå•
  }

  /**
   * è·³è½¬åˆ°æ‹ç…§é¡µé¢
   */
  private navigateToCamera(): void {
    console.log('Navigate to camera - Starting navigation')
    try {
      router.pushUrl({
        url: 'pages/camera/CameraPage_Simple',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to camera page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°ç›¸æœºé¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to camera failed with exception:', error)
    }
  }

  /**
   * è·³è½¬åˆ°ç›¸å†Œé¡µé¢
   */
  private navigateToGallery(): void {
    console.log('Navigate to gallery - Starting navigation')
    try {
      router.pushUrl({
        url: 'pages/gallery/GalleryPlaceholderPage',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to gallery page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°ç›¸å†Œé¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to gallery failed with exception:', error)
    }
  }

  /**
   * è·³è½¬åˆ°è®¾ç½®é¡µé¢
   */
  private navigateToSettings(): void {
    console.log('Navigate to settings - Starting navigation')
    try {
      router.pushUrl({
        url: 'pages/settings/SettingsPlaceholderPage',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to settings page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°è®¾ç½®é¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to settings failed with exception:', error)
    }
  }

  /**
   * åˆ›å»ºæ–°å·¥ç¨‹
   */
  private createNewProject(): void {
    console.log('Create new project')
    // TODO: æ˜¾ç¤ºåˆ›å»ºå·¥ç¨‹å¯¹è¯æ¡†
  }

  /**
   * æœç´¢é¡¹ç›®
   */
  private searchProjects(): void {
    console.log('Search projects:', this.searchQuery)
    // TODO: å®žçŽ°æœç´¢åŠŸèƒ½
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // ä¾§è¾¹èœå•æŒ‰é’®
        Text('â˜°')
          .fontSize(20)
          .fontColor('#1890FF')
          .onClick(() => {
            console.log('Menu clicked')
            // TODO: æ˜¾ç¤ºä¾§è¾¹èœå•
          })

        Blank()

        // åº”ç”¨æ ‡é¢˜
        Text('å·¥ç¨‹ç›¸æœº')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#262626')

        Blank()

        // æœç´¢æŒ‰é’®
        Text('ðŸ”')
          .fontSize(20)
          .fontColor('#1890FF')
          .backgroundColor('#E6F7FF')
          .borderRadius(12)
          .width(32)
          .height(32)
          .textAlign(TextAlign.Center)
          .margin({ right: 16 })
          .animation({ duration: 150, curve: Curve.EaseInOut })
          .onClick(() => {
            console.log('Search clicked')
            // TODO: æ˜¾ç¤ºæœç´¢ç•Œé¢
          })

        // æ–°å»ºæŒ‰é’®
        Text('âŠ•')
          .fontSize(20)
          .fontColor('#1890FF')
          .backgroundColor('#E6F7FF')
          .borderRadius(12)
          .width(32)
          .height(32)
          .textAlign(TextAlign.Center)
          .animation({ duration: 150, curve: Curve.EaseInOut })
          .onClick(() => {
            console.log('Create project button clicked')
            this.createNewProject()
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E8E8E8' })

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // ç»Ÿè®¡æ¦‚è§ˆ
          Column() {
            Text('ðŸ“Š ç»Ÿè®¡æ¦‚è§ˆ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            // ç»Ÿè®¡å¡ç‰‡è¡Œ
            Row({ space: 12 }) {
              StatCard({
                title: 'å·¥ç¨‹æ•°',
                value: this.selectedProjectCount.toString(),
                icon: 'ðŸ“',
                color: '#1890FF'
              })

              StatCard({
                title: 'å·¥ç‚¹æ•°',
                value: this.selectedSiteCount.toString(),
                icon: 'ðŸ“',
                color: '#52C41A'
              })

              StatCard({
                title: 'ç…§ç‰‡æ•°',
                value: this.selectedPhotoCount.toString(),
                icon: 'ðŸ“·',
                color: '#FAAD14'
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceAround)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .margin({ bottom: 12 })
          .borderRadius(8)

          // å·¥ç¨‹åˆ—è¡¨æ ‡é¢˜
          Row() {
            Text('ðŸ—ï¸ æˆ‘çš„å·¥ç¨‹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')

            Blank()

            Text(`${this.projects.length}ä¸ªå·¥ç¨‹`)
              .fontSize(14)
              .fontColor('#8C8C8C')
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 12 })
          .alignItems(VerticalAlign.Center)

          // å·¥ç¨‹åˆ—è¡¨
          Column({ space: 12 }) {
            ForEach(this.projects, (project: SimpleProject, index?: number) => {
              SimpleProjectCard({
                project: project,
                showStats: true,
                onTap: (p: SimpleProject) => this.handleProjectClick(p),
                onLongPress: (p: SimpleProject) => this.handleProjectLongPress(p)
              })
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 80 }) // åº•éƒ¨ç•™å‡ºå¯¼èˆªæ ç©ºé—´
        }
        .width('100%')
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // å·¥ç¨‹å¯¼èˆª
        Column() {
          Text('ðŸ—ï¸')
            .fontSize(24)
            .fontColor(this.currentTab === 'projects' ? '#1890FF' : '#8C8C8C')
          Text('å·¥ç¨‹')
            .fontSize(12)
            .fontColor(this.currentTab === 'projects' ? '#1890FF' : '#8C8C8C')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === 'projects' ? '#E6F7FF' : Color.Transparent)
        .borderRadius(8)
        .padding({ top: 4, bottom: 4 })
        .animation({ duration: 200, curve: Curve.EaseInOut })
        .onClick(() => {
          console.log('Projects tab clicked')
          this.currentTab = 'projects'
          // æ·»åŠ è§¦è§‰åé¦ˆæ•ˆæžœ
          // TODO: æ·»åŠ è§¦è§‰åé¦ˆ
        })

        // ç›¸å†Œå¯¼èˆª
        Column() {
          Text('ðŸ“±')
            .fontSize(24)
            .fontColor(this.currentTab === 'gallery' ? '#1890FF' : '#8C8C8C')
          Text('ç›¸å†Œ')
            .fontSize(12)
            .fontColor(this.currentTab === 'gallery' ? '#1890FF' : '#8C8C8C')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === 'gallery' ? '#E6F7FF' : Color.Transparent)
        .borderRadius(8)
        .padding({ top: 4, bottom: 4 })
        .animation({ duration: 200, curve: Curve.EaseInOut })
        .onClick(() => {
          console.log('Gallery tab clicked')
          this.currentTab = 'gallery'
          this.navigateToGallery()
        })

        // è®¾ç½®å¯¼èˆª
        Column() {
          Text('âš™ï¸')
            .fontSize(24)
            .fontColor(this.currentTab === 'settings' ? '#1890FF' : '#8C8C8C')
          Text('è®¾ç½®')
            .fontSize(12)
            .fontColor(this.currentTab === 'settings' ? '#1890FF' : '#8C8C8C')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === 'settings' ? '#E6F7FF' : Color.Transparent)
        .borderRadius(8)
        .padding({ top: 4, bottom: 4 })
        .animation({ duration: 200, curve: Curve.EaseInOut })
        .onClick(() => {
          console.log('Settings tab clicked')
          this.currentTab = 'settings'
          this.navigateToSettings()
        })
      }
      .width('100%')
      .height(60)
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 1 }, color: '#E8E8E8' })
      .justifyContent(FlexAlign.SpaceAround)
      .padding({ bottom: 8 }) // ä¸ºå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}