/**
 * ç©ºçŠ¶æ€ç®¡ç†å™¨
 * ç»Ÿä¸€ç®¡ç†åº”ç”¨ä¸­çš„æ‰€æœ‰ç©ºçŠ¶æ€æ˜¾ç¤ºé€»è¾‘
 */

import { ThemeManager } from '../../theme/ThemeManager'
import { EmptyStateType, EmptyStateSize } from './EmptyStates'

export interface EmptyStateConfig {
  type?: EmptyStateType
  title?: string
  description?: string
  icon?: string
  image?: string
  size?: EmptyStateSize
  showButton?: boolean
  buttonText?: string
  buttonType?: 'primary' | 'secondary' | 'outline' | 'text'
  onButtonPress?: () => void
  autoHideDelay?: number
  animationType?: 'fade' | 'slide' | 'bounce' | 'none'
}

export interface EmptyStateRule {
  condition: () => boolean
  config: EmptyStateConfig
  priority: number  // ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
}

/**
 * ç©ºçŠ¶æ€è§„åˆ™ç®¡ç†å™¨
 * æä¾›æ™ºèƒ½ç©ºçŠ¶æ€æ˜¾ç¤ºå†³ç­–
 */
export class EmptyStateManager {
  private static instance: EmptyStateManager
  private rules: EmptyStateRule[] = []
  private currentState?: EmptyStateConfig

  static getInstance(): EmptyStateManager {
    if (!EmptyStateManager.instance) {
      EmptyStateManager.instance = new EmptyStateManager()
    }
    return EmptyStateManager.instance
  }

  /**
   * æ³¨å†Œç©ºçŠ¶æ€è§„åˆ™
   */
  registerRule(rule: EmptyStateRule): void {
    this.rules.push(rule)
    // æŒ‰ä¼˜å…ˆçº§æ’åº
    this.rules.sort((a, b) => a.priority - b.priority)
  }

  /**
   * æ¸…é™¤æ‰€æœ‰è§„åˆ™
   */
  clearRules(): void {
    this.rules = []
    this.currentState = undefined
  }

  /**
   * è¯„ä¼°å¹¶è·å–å½“å‰ç©ºçŠ¶æ€
   */
  evaluateState(data: any = {}): EmptyStateConfig | null {
    for (const rule of this.rules) {
      if (rule.condition(data)) {
        this.currentState = rule.config
        return rule.config
      }
    }
    return null
  }

  /**
   * æ‰‹åŠ¨è®¾ç½®ç©ºçŠ¶æ€
   */
  setManualState(config: EmptyStateConfig): void {
    this.currentState = config
  }

  /**
   * æ¸…é™¤å½“å‰ç©ºçŠ¶æ€
   */
  clearState(): void {
    this.currentState = undefined
  }

  /**
   * è·å–å½“å‰ç©ºçŠ¶æ€
   */
  getCurrentState(): EmptyStateConfig | undefined {
    return this.currentState
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºç©ºçŠ¶æ€
   */
  isShowingEmptyState(): boolean {
    return this.currentState !== undefined
  }

  /**
   * è·å–æ¨èçš„ç©ºçŠ¶æ€é…ç½®
   */
  getRecommendedConfig(type: EmptyStateType, data?: any): EmptyStateConfig {
    const configs: Record<EmptyStateType, EmptyStateConfig> = {
      'no-data': {
        type: 'no-data',
        title: 'æš‚æ— æ•°æ®',
        description: 'å½“å‰é¡µé¢æ²¡æœ‰æ˜¾ç¤ºçš„å†…å®¹',
        icon: 'ğŸ“¦',
        size: 'medium',
        showButton: false
      },
      'no-results': {
        type: 'no-results',
        title: 'æœªæ‰¾åˆ°ç»“æœ',
        description: 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶',
        icon: 'ğŸ”',
        size: 'medium',
        showButton: true,
        buttonText: 'é‡æ–°æœç´¢'
      },
      'no-network': {
        type: 'no-network',
        title: 'ç½‘ç»œè¿æ¥å¤±è´¥',
        description: 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶é‡è¯•',
        icon: 'ğŸ“¶',
        size: 'medium',
        showButton: true,
        buttonText: 'é‡è¯•',
        animationType: 'bounce'
      },
      'error': {
        type: 'error',
        title: 'æ“ä½œå¤±è´¥',
        description: 'æ‰§è¡Œæ“ä½œæ—¶å‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        icon: 'âŒ',
        size: 'medium',
        showButton: true,
        buttonText: 'é‡è¯•',
        buttonType: 'outline'
      },
      'loading': {
        type: 'loading',
        title: 'æ­£åœ¨åŠ è½½',
        description: 'è¯·ç¨å€™ï¼Œæ•°æ®æ­£åœ¨åŠ è½½ä¸­...',
        icon: 'â³',
        size: 'medium',
        showButton: false,
        animationType: 'pulse'
      },
      'empty-list': {
        type: 'empty-list',
        title: 'åˆ—è¡¨ä¸ºç©º',
        description: 'æš‚æ— åˆ—è¡¨é¡¹ç›®ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»º',
        icon: 'ğŸ“‹',
        size: 'large',
        showButton: true,
        buttonText: 'åˆ›å»ºé¡¹ç›®'
      },
      'empty-favorites': {
        type: 'empty-favorites',
        title: 'æš‚æ— æ”¶è—',
        description: 'æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•é¡¹ç›®ï¼Œç‚¹å‡»é¡¹ç›®å¡ç‰‡ä¸Šçš„æ”¶è—æŒ‰é’®æ¥æ·»åŠ ',
        icon: 'â­',
        size: 'medium',
        showButton: false
      },
      'no-permission': {
        type: 'no-permission',
        title: 'æƒé™ä¸è¶³',
        description: 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
        icon: 'ğŸ”’',
        size: 'medium',
        showButton: true,
        buttonText: 'ç”³è¯·æƒé™',
        buttonType: 'outline'
      },
      'not-found': {
        type: 'not-found',
        title: 'é¡µé¢æœªæ‰¾åˆ°',
        description: 'æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤',
        icon: 'ğŸ”',
        size: 'medium',
        showButton: true,
        buttonText: 'è¿”å›é¦–é¡µ'
      },
      'maintenance': {
        type: 'maintenance',
        title: 'ç³»ç»Ÿç»´æŠ¤ä¸­',
        description: 'ç³»ç»Ÿæ­£åœ¨è¿›è¡Œç»´æŠ¤å‡çº§ï¼Œé¢„è®¡å¾ˆå¿«å®Œæˆï¼Œè¯·ç¨åé‡è¯•',
        icon: 'ğŸ”§',
        size: 'large',
        showButton: false,
        animationType: 'bounce'
      },
      'first-use': {
        type: 'first-use',
        title: 'æ¬¢è¿ä½¿ç”¨',
        description: 'è®©æˆ‘ä»¬å¼€å§‹æ‚¨çš„ç¬¬ä¸€ä¸ªå·¥ç¨‹é¡¹ç›®',
        icon: 'ğŸ‘‹',
        size: 'large',
        showButton: true,
        buttonText: 'åˆ›å»ºé¡¹ç›®'
      }
    }

    const config = configs[type] || configs['no-data']

    // æ ¹æ®æ•°æ®åŠ¨æ€è°ƒæ•´é…ç½®
    if (data) {
      return this.enhanceConfigWithData(config, data)
    }

    return config
  }

  /**
   * æ ¹æ®æ•°æ®å¢å¼ºé…ç½®
   */
  private enhanceConfigWithData(config: EmptyStateConfig, data: any): EmptyStateConfig {
    const enhanced = { ...config }

    // æ ¹æ®æ•°æ®ç±»å‹è°ƒæ•´æè¿°
    if (data.itemCount !== undefined && data.itemType) {
      enhanced.description = `æš‚æ— ${data.itemType}ï¼Œ${data.createAction || 'ç‚¹å‡»åˆ›å»º'}ç¬¬ä¸€ä¸ª${data.itemType}å¼€å§‹ä½¿ç”¨`
    }

    // æ ¹æ®æœç´¢çŠ¶æ€è°ƒæ•´é…ç½®
    if (data.isSearching) {
      enhanced.title = 'æœç´¢ä¸­'
      enhanced.description = 'æ­£åœ¨æœç´¢ç›¸å…³å†…å®¹ï¼Œè¯·ç¨å€™...'
      enhanced.icon = 'ğŸ”'
      enhanced.animationType = 'pulse'
    }

    // æ ¹æ®ç½‘ç»œçŠ¶æ€è°ƒæ•´é…ç½®
    if (data.networkStatus) {
      switch (data.networkStatus) {
        case 'slow':
          enhanced.title = 'ç½‘ç»œè¾ƒæ…¢'
          enhanced.description = 'ç½‘ç»œè¿æ¥è¾ƒæ…¢ï¼ŒåŠ è½½å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´'
          enhanced.icon = 'ğŸ¢'
          break
        case 'timeout':
          enhanced.title = 'è¯·æ±‚è¶…æ—¶'
          enhanced.description = 'ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
          enhanced.icon = 'â°'
          break
      }
    }

    return enhanced
  }

  /**
   * åˆ›å»ºåŸºäºæ•°æ®çš„è§„åˆ™
   */
  createDataBasedRule(
    name: string,
    condition: (data: any) => boolean,
    config?: Partial<EmptyStateConfig>,
    priority: number = 10
  ): EmptyStateRule {
    return {
      name,
      condition,
      config: {
        ...config,
        type: config?.type || 'no-data'
      },
      priority
    }
  }

  /**
   * åˆ›å»ºåˆ—è¡¨ç©ºçŠ¶æ€è§„åˆ™
   */
  createEmptyListRule(
    listData: any[],
    config?: Partial<EmptyStateConfig>
  ): EmptyStateRule {
    return {
      name: 'empty-list',
      condition: (data: any) => {
        const list = data[listData.key] || []
        return !Array.isArray(list) || list.length === 0
      },
      config: {
        type: 'empty-list',
        title: `æš‚æ— ${data.itemType || 'é¡¹ç›®'}`,
        description: `è¿˜æ²¡æœ‰${data.itemType || 'é¡¹ç›®'}ï¼Œ${data.createAction || 'ç‚¹å‡»åˆ›å»º'}ç¬¬ä¸€ä¸ª${data.itemType || 'é¡¹ç›®'}å¼€å§‹ä½¿ç”¨`,
        ...config
      },
      priority: 5
    }
  }

  /**
   * åˆ›å»ºç½‘ç»œé”™è¯¯è§„åˆ™
   */
  createNetworkErrorRule(
    config?: Partial<EmptyStateConfig>
  ): EmptyStateRule {
    return {
      name: 'network-error',
      condition: (data: any) => {
        return data.networkError === true || data.isOffline === true
      },
      config: {
        type: 'no-network',
        ...config
      },
      priority: 2
    }
  }

  /**
   * åˆ›å»ºæƒé™é”™è¯¯è§„åˆ™
   */
  createPermissionErrorRule(
    config?: Partial<EmptyStateConfig>
  ): EmptyStateRule {
    return {
      name: 'permission-error',
      condition: (data: any) => {
        return data.permissionDenied === true || data.isUnauthorized === true
      },
      config: {
        type: 'no-permission',
        ...config
      },
      priority: 3
    }
  }
}

/**
 * ç©ºçŠ¶æ€å®¹å™¨ç»„ä»¶
 * æ™ºèƒ½æ˜¾ç¤ºå„ç§ç©ºçŠ¶æ€
 */
@ComponentV2
export struct EmptyStateContainer {
  @Param data: any = {}
  @Param rules?: EmptyStateRule[]
  @Param manualConfig?: EmptyStateConfig
  @Param manager?: EmptyStateManager
  @Param children: () => void = () => {}

  @State private currentConfig?: EmptyStateConfig
  @State private isVisible: boolean = false

  aboutToAppear() {
    this.setupEmptyState()
  }

  /**
   * è®¾ç½®ç©ºçŠ¶æ€
   */
  private setupEmptyState(): void {
    // ä½¿ç”¨æ‰‹åŠ¨é…ç½®
    if (this.manualConfig) {
      this.currentConfig = this.manualConfig
      this.isVisible = true
      return
    }

    // ä½¿ç”¨ç®¡ç†å™¨
    if (this.manager) {
      const config = this.manager.evaluateState(this.data)
      if (config) {
        this.currentConfig = config
        this.isVisible = true
        return
      }
    }

    // ä½¿ç”¨ä¼ å…¥çš„è§„åˆ™
    if (this.rules && this.rules.length > 0) {
      for (const rule of this.rules) {
        if (rule.condition(this.data)) {
          this.currentConfig = rule.config
          this.isVisible = true
          return
        }
      }
    }

    // é»˜è®¤çŠ¶æ€ï¼šä¸æ˜¾ç¤ºç©ºçŠ¶æ€
    this.currentConfig = undefined
    this.isVisible = false
  }

  build() {
    Stack() {
      // æ­£å¸¸å†…å®¹
      if (!this.isVisible && this.currentConfig?.type !== 'loading') {
        this.children()
      }

      // ç©ºçŠ¶æ€å†…å®¹
      if (this.isVisible && this.currentConfig) {
        this.buildEmptyState()
      }
    }
    .width('100%')
    .height('100%')
    .animation({
      duration: 300,
      curve: Curve.EaseInOut
    })
  }

  /**
   * æ„å»ºç©ºçŠ¶æ€å†…å®¹
   */
  @Builder
  private buildEmptyState() {
    if (!this.currentConfig) return

    const animationType = this.currentConfig.animationType || 'fade'

    Column() {
      // åŠ¨ç”»å›¾æ ‡
      if (this.currentConfig.icon || this.currentConfig.image) {
        Row() {
          if (this.currentConfig.type === 'loading') {
            LoadingProgress()
              .width(48)
              .height(48)
              .color(ThemeManager.getCurrentPrimaryColor())
          } else if (this.currentConfig.image) {
            Image(this.currentConfig.image)
              .width(80)
              .height(80)
              .objectFit(ImageFit.Contain)
          } else {
            Text(this.currentConfig.icon!)
              .fontSize(this.getIconSize())
          }
        }
        .margin({ bottom: 24 })
      }

      // æ ‡é¢˜
      if (this.currentConfig.title) {
        Text(this.currentConfig.title)
          .fontSize(this.getTitleSize())
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeManager.getCurrentTextColor())
          .margin({ bottom: 12 })
          .textAlign(TextAlign.Center)
      }

      // æè¿°
      if (this.currentConfig.description) {
        Text(this.currentConfig.description)
          .fontSize(this.getDescriptionSize())
          .fontColor(ThemeManager.getCurrentTextSecondaryColor())
          .textAlign(TextAlign.Center)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(24)
      }

      // æ“ä½œæŒ‰é’®
      if (this.currentConfig.showButton && this.currentConfig.buttonText) {
        Button(this.currentConfig.buttonText)
          .fontSize(16)
          .fontColor(this.getButtonTextColor())
          .fontWeight(FontWeight.Medium)
          .padding({ left: 24, right: 24, top: 12, bottom: 12 })
          .borderRadius(this.getButtonBorderRadius())
          .backgroundColor(this.getButtonBackgroundColor())
          .border({
            width: this.currentConfig.buttonType === 'outline' ? 1 : 0,
            color: this.getButtonTextColor()
          })
          .onClick(() => {
            this.currentConfig.onButtonPress?.()
          })
          .margin({ top: 32 })
      }
    }
    .width(this.getContentWidth())
    .padding(32)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(ThemeManager.getCurrentBackgroundColor())
    .transform(this.getTransformByAnimation(animationType))
  }

  /**
   * è·å–å›¾æ ‡å°ºå¯¸
   */
  private getIconSize(): number {
    const sizes: Record<string, number> = {
      'small': 48,
      'medium': 64,
      'large': 80,
      'full': 96
    }
    return sizes[this.currentConfig?.size || 'medium']
  }

  /**
   * è·å–æ ‡é¢˜å­—ä½“å¤§å°
   */
  private getTitleSize(): number {
    const sizes: Record<string, number> = {
      'small': 18,
      'medium': 20,
      'large': 24,
      'full': 28
    }
    return sizes[this.currentConfig?.size || 'medium']
  }

  /**
   * è·å–æè¿°å­—ä½“å¤§å°
   */
  private getDescriptionSize(): number {
    const sizes: Record<string, number> = {
      'small': 14,
      'medium': 16,
      'large': 18,
      'full': 20
    }
    return sizes[this.currentConfig?.size || 'medium']
  }

  /**
   * è·å–å†…å®¹å®½åº¦
   */
  private getContentWidth(): string {
    const widths: Record<string, string> = {
      'small': '280',
      'medium': '320',
      'large': '400',
      'full': '80%'
    }
    return widths[this.currentConfig?.size || 'medium']
  }

  /**
   * è·å–æŒ‰é’®èƒŒæ™¯é¢œè‰²
   */
  private getButtonBackgroundColor(): string {
    switch (this.currentConfig?.buttonType) {
      case 'primary':
        return ThemeManager.getCurrentPrimaryColor()
      case 'secondary':
        return ThemeManager.getCurrentSecondaryColor()
      case 'outline':
        return ThemeManager.getCurrentBackgroundColor()
      case 'text':
        return Color.Transparent
      default:
        return ThemeManager.getCurrentPrimaryColor()
    }
  }

  /**
   * è·å–æŒ‰é’®æ–‡å­—é¢œè‰²
   */
  private getButtonTextColor(): string {
    switch (this.currentConfig?.buttonType) {
      case 'primary':
      case 'secondary':
        return '#FFFFFF'
      case 'outline':
        return ThemeManager.getCurrentPrimaryColor()
      case 'text':
        return ThemeManager.getCurrentPrimaryColor()
      default:
        return '#FFFFFF'
    }
  }

  /**
   * è·å–æŒ‰é’®åœ†è§’
   */
  private getButtonBorderRadius(): number {
    return this.currentConfig?.buttonType === 'icon' ? 50 : 8
  }

  /**
   * æ ¹æ®åŠ¨ç”»ç±»å‹è·å–å˜æ¢
   */
  private getTransformByAnimation(animationType: string): { [key: string]: string | number } {
    switch (animationType) {
      case 'fade':
        return { opacity: this.isVisible ? 1 : 0 }
      case 'slide':
        return { translateY: this.isVisible ? 0 : -50 }
      case 'bounce':
        return { scale: { x: this.isVisible ? 1 : 0.8, y: this.isVisible ? 1 : 0.8 } }
      default:
        return {}
    }
  }
}