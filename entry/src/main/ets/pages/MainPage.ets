/**
 * ä¸»ç•Œé¢ - å·¥ç¨‹åˆ—è¡¨
 * æ ¹æ®åŽŸåž‹è®¾è®¡å®žçŽ°çš„å·¥ç¨‹ç®¡ç†ä¸»ç•Œé¢
 * åŒ…å«ç»Ÿè®¡æ¦‚è§ˆã€å·¥ç¨‹åˆ—è¡¨å’Œåº•éƒ¨å¯¼èˆª
 */

import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { StatCard } from '../components/common/StatCard'
import { SearchBar } from '../components/common/SearchBar'
import { DeleteConfirmDialog } from '../components/common/ConfirmDialog'
import { SimpleProjectCard } from '../components/project/SimpleProjectCard'
import { SimpleProject, ProjectStatus } from '../models/SimpleProject'

interface StatusFilterOption {
  key: 'all' | ProjectStatus
  label: string
}

const PROJECT_STATUS_FILTERS: StatusFilterOption[] = [
  { key: 'all', label: 'å…¨éƒ¨' },
  { key: ProjectStatus.ACTIVE, label: 'è¿›è¡Œä¸­' },
  { key: ProjectStatus.COMPLETED, label: 'å·²å®Œæˆ' },
  { key: ProjectStatus.PAUSED, label: 'å·²æš‚åœ' },
  { key: ProjectStatus.CANCELLED, label: 'å·²å–æ¶ˆ' }
]

@Entry
@Component
struct MainPage {
  @State private currentTab: string = 'projects'
  @State private searchQuery: string = ''
  @State private totalProjectCount: number = 0
  @State private totalSiteCount: number = 0
  @State private totalPhotoCount: number = 0
  @State private projectRevision: number = 0
  @State private statusFilter: 'all' | ProjectStatus = 'all'
  private projects: SimpleProject[] = []
  private filteredProjects: SimpleProject[] = []
  private activeProjectCache: SimpleProject | null = null
  @State private showSearchPanel: boolean = false
  @State private showQuickActions: boolean = false
  @State private showCreateDialog: boolean = false
  @State private newProjectName: string = ''
  @State private newProjectManager: string = ''
  @State private newProjectDescription: string = ''
  @State private activeProjectId: string | null = null
  @State private showProjectActions: boolean = false
  @State private showDeleteDialog: boolean = false

  aboutToAppear(): void {
    console.log('MainPage aboutToAppear')
    this.initializeProjects()
  }

  /**
   * åˆå§‹åŒ–å·¥ç¨‹æ•°æ®
   */
  private initializeProjects(): void {
    if (this.projects.length > 0) {
      this.searchProjects()
      this.updateProjectStatistics()
      return
    }

    const mockProjects = this.createMockProjects()
    this.projects = mockProjects
    this.searchProjects()
    this.updateProjectStatistics()
  }

  /**
   * æž„å»ºé»˜è®¤å·¥ç¨‹æ•°æ®
   */
  private createMockProjects(): SimpleProject[] {
    const now = new Date()

    const projectA = new SimpleProject('P2025-001', 'å¸‚æ”¿é“è·¯æ”¹é€ å·¥ç¨‹', ProjectStatus.ACTIVE, 'å¼ ä¸‰', 4, 52)
    projectA.code = 'P2025-001'
    projectA.client = 'å¸‚æ”¿å»ºè®¾å±€'
    projectA.description = 'å¸‚åŒºä¸»å¹²é“æ”¹é€ ï¼Œä¸€æœŸè¦†ç›– 4 ä¸ªå·¥ç‚¹ï¼ŒæŒç»­ä¼˜åŒ–æŽ’æ°´ç³»ç»Ÿä¸Žé“è·¯é“ºè£…ã€‚'
    projectA.createdAt = new Date(now.getTime() - 1000 * 60 * 60 * 24 * 30)
    projectA.updatedAt = new Date(now.getTime() - 1000 * 60 * 60 * 6)

    const projectB = new SimpleProject('P2025-002', 'ç”µåŠ›çº¿è·¯å·¡æ£€å·¥ç¨‹', ProjectStatus.COMPLETED, 'æŽå››', 6, 89)
    projectB.code = 'P2025-002'
    projectB.client = 'å›½å®¶ç”µç½‘'
    projectB.description = 'åŸŽåŒºé«˜åŽ‹çº¿è·¯å·¡æ£€ä¸Žéšæ‚£æŽ’æŸ¥ï¼Œè¾“å‡ºå·¡æ£€ç…§ç‰‡ä¸Žæ•´æ”¹å•ã€‚'
    projectB.createdAt = new Date(now.getTime() - 1000 * 60 * 60 * 24 * 90)
    projectB.updatedAt = new Date(now.getTime() - 1000 * 60 * 60 * 24 * 2)

    const projectC = new SimpleProject('P2025-003', 'å›­æž—ç»¿åŒ–é¡¹ç›®', ProjectStatus.PAUSED, 'çŽ‹äº”', 2, 15)
    projectC.code = 'P2025-003'
    projectC.client = 'åŸŽå¸‚å›­æž—ç®¡ç†å¤„'
    projectC.description = 'åŸŽåŒºç»¿åŒ–æå‡å·¥ç¨‹ï¼Œå½“å‰å› è®¾è®¡è°ƒæ•´æš‚ç¼“æ–½å·¥ã€‚'
    projectC.createdAt = new Date(now.getTime() - 1000 * 60 * 60 * 24 * 45)
    projectC.updatedAt = new Date(now.getTime() - 1000 * 60 * 60 * 12)

    return [projectA, projectB, projectC]
  }

  /**
   * æ›´æ–°å·¥ç¨‹ç»Ÿè®¡ä¿¡æ¯
   */
  private updateProjectStatistics(): void {
    this.totalProjectCount = this.projects.length
    this.totalSiteCount = this.projects.reduce((sum, project) => sum + project.siteCount, 0)
    this.totalPhotoCount = this.projects.reduce((sum, project) => sum + project.photoCount, 0)
  }

  /**
   * ç”Ÿæˆå·¥ç¨‹ç¼–å·
   */
  private generateProjectCode(): string {
    const prefix = `P${new Date().getFullYear()}`
    const random = Math.floor(Math.random() * 900 + 100)
    return `${prefix}-${random}`
  }

  /**
   * èŽ·å–å½“å‰é€‰ä¸­å·¥ç¨‹
   */
  private getActiveProject(): SimpleProject | null {
    if (!this.activeProjectId) {
      return null
    }
    if (this.activeProjectCache && this.activeProjectCache.id === this.activeProjectId) {
      return this.activeProjectCache
    }

    const project = this.projects.find((item: SimpleProject) => item.id === this.activeProjectId) || null
    this.activeProjectCache = project
    return project
  }

  /**
   * åˆ·æ–°å·¥ç¨‹åˆ—è¡¨è§†å›¾
   */
  private refreshProjectView(): void {
    this.projectRevision++
  }

  /**
   * å¤„ç†é¡¹ç›®å¡ç‰‡ç‚¹å‡»
   */
  private handleProjectClick(project: SimpleProject): void {
    console.log('Project clicked:', project.name)
    this.closeProjectActions()
    router.pushUrl({
      url: 'pages/project/ProjectDetailPage',
      params: { projectId: project.id }
    }).catch((error: Error) => {
      console.error('è·³è½¬åˆ°é¡¹ç›®è¯¦æƒ…å¤±è´¥:', error)
    })
  }

  /**
   * å¤„ç†é¡¹ç›®å¡ç‰‡é•¿æŒ‰
   */
  private handleProjectLongPress(project: SimpleProject): void {
    console.log('Project long pressed:', project.name)
    this.closeQuickActions()
    this.activeProjectId = project.id
    this.activeProjectCache = project
    this.showProjectActions = true
  }

  /**
   * è·³è½¬åˆ°æ‹ç…§é¡µé¢
   */
  private navigateToCamera(): void {
    console.log('Navigate to camera - Starting navigation')
    this.closeQuickActions()
    this.closeProjectActions()
    try {
      router.pushUrl({
        url: 'pages/camera/CameraPage_Simple',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to camera page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°ç›¸æœºé¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to camera failed with exception:', error)
    }
  }

  /**
   * è·³è½¬åˆ°ç›¸å†Œé¡µé¢
   */
  private navigateToGallery(): void {
    console.log('Navigate to gallery - Starting navigation')
    this.closeQuickActions()
    this.closeProjectActions()
    try {
      router.replaceUrl({
        url: 'pages/gallery/GalleryPlaceholderPage',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to gallery page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°ç›¸å†Œé¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to gallery failed with exception:', error)
    }
  }

  /**
   * è·³è½¬åˆ°è®¾ç½®é¡µé¢
   */
  private navigateToSettings(): void {
    console.log('Navigate to settings - Starting navigation')
    this.closeQuickActions()
    this.closeProjectActions()
    try {
      router.replaceUrl({
        url: 'pages/settings/SettingsPlaceholderPage',
        params: {}
      }).then(() => {
        console.log('Successfully navigated to settings page')
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°è®¾ç½®é¡µé¢å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('Navigation to settings failed with exception:', error)
    }
  }

  /**
   * åˆ›å»ºæ–°å·¥ç¨‹
   */
  private createNewProject(): void {
    console.log('Create new project')
    this.closeQuickActions()
    this.openCreateDialog()
  }

  /**
   * æ‰“å¼€åˆ›å»ºå·¥ç¨‹å¯¹è¯æ¡†
   */
  private openCreateDialog(): void {
    this.resetProjectForm()
    this.showCreateDialog = true
  }

  /**
   * å…³é—­åˆ›å»ºå·¥ç¨‹å¯¹è¯æ¡†
   */
  private closeCreateDialog(): void {
    this.showCreateDialog = false
  }

  /**
   * é‡ç½®åˆ›å»ºå·¥ç¨‹è¡¨å•
   */
  private resetProjectForm(): void {
    this.newProjectName = ''
    this.newProjectManager = ''
    this.newProjectDescription = ''
  }

  /**
   * ä¿å­˜æ–°å·¥ç¨‹
   */
  private saveNewProject(): void {
    if (!this.newProjectName.trim()) {
      this.showToast('è¯·è¾“å…¥å·¥ç¨‹åç§°')
      return
    }

    const project = new SimpleProject(this.generateProjectCode(), this.newProjectName.trim(), ProjectStatus.ACTIVE,
      this.newProjectManager.trim() || 'æœªè®¾ç½®', 0, 0)
    project.code = project.id
    project.description = this.newProjectDescription.trim()
    project.client = 'æœªè®¾ç½®'
    project.createdAt = new Date()
    project.updatedAt = new Date()

    this.projects = [...this.projects, project]
    this.closeCreateDialog()
    this.showToast('æ–°å·¥ç¨‹åˆ›å»ºæˆåŠŸ')
    this.searchProjects()
    this.updateProjectStatistics()
  }

  /**
   * æœç´¢é¡¹ç›®
   */
  private searchProjects(): void {
    const keyword = this.searchQuery.trim().toLowerCase()

    this.filteredProjects = this.projects.filter((project: SimpleProject) => {
      const matchStatus = this.statusFilter === 'all' || project.status === this.statusFilter

      if (!matchStatus) {
        return false
      }

      if (!keyword) {
        return true
      }

      const fields = [
        project.name,
        project.code,
        project.manager,
        project.client,
        project.description
      ]

      return fields.some(field => (field || '').toLowerCase().includes(keyword))
    })

    this.refreshProjectView()
  }

  /**
   * æœç´¢è¾“å…¥å˜åŒ–
   */
  private onSearchChange(query: string): void {
    this.searchQuery = query
    this.searchProjects()
  }

  /**
   * æœç´¢æäº¤
   */
  private onSearchSubmit(query: string): void {
    this.searchQuery = query
    this.searchProjects()
  }

  /**
   * çŠ¶æ€ç­›é€‰å˜æ›´
   */
  private onStatusFilterChange(filter: 'all' | ProjectStatus): void {
    if (this.statusFilter === filter) {
      return
    }
    this.statusFilter = filter
    this.searchProjects()
  }

  /**
   * åˆ‡æ¢æœç´¢é¢æ¿æ˜¾ç¤º
   */
  private toggleSearchPanel(): void {
    const willOpen = !this.showSearchPanel
    this.showSearchPanel = !this.showSearchPanel
    if (willOpen) {
      this.closeQuickActions()
    }
    if (!this.showSearchPanel) {
      this.clearSearch()
    }
  }

  /**
   * æ¸…ç©ºæœç´¢æ¡ä»¶
   */
  private clearSearch(): void {
    this.searchQuery = ''
    this.searchProjects()
  }

  /**
   * é‡ç½®ç­›é€‰æ¡ä»¶
   */
  private resetFilters(): void {
    this.searchQuery = ''
    this.statusFilter = 'all'
    this.showSearchPanel = false
    this.searchProjects()
  }

  private hasActiveFilter(): boolean {
    return this.statusFilter !== 'all' || this.searchQuery.trim().length > 0
  }

  /**
   * å…³é—­æœç´¢é¢æ¿
   */
  private closeSearchPanel(): void {
    this.showSearchPanel = false
    this.clearSearch()
  }

  /**
   * æ‰“å¼€å¿«æ·æ“ä½œé¢æ¿
   */
  private openQuickActions(): void {
    this.closeProjectActions()
    this.showQuickActions = true
  }

  /**
   * å…³é—­å¿«æ·æ“ä½œé¢æ¿
   */
  private closeQuickActions(): void {
    this.showQuickActions = false
  }

  /**
   * å¤„ç†å¿«æ·æ“ä½œ
   */
  private handleQuickAction(action: 'sync' | 'report' | 'help'): void {
    switch (action) {
      case 'sync':
        this.showToast('æ­£åœ¨åŒæ­¥é¡¹ç›®æ•°æ®...')
        break
      case 'report':
        this.showToast('å·²ç”Ÿæˆæœ€æ–°å·¥ç¨‹ç»Ÿè®¡æŠ¥è¡¨')
        break
      case 'help':
        this.showToast('è¯·å‰å¾€è®¾ç½®é¡µæŸ¥çœ‹å¸®åŠ©æ–‡æ¡£')
        break
    }
    this.closeQuickActions()
  }

  /**
   * å…³é—­é¡¹ç›®æ“ä½œé¢æ¿
   */
  private closeProjectActions(): void {
    this.showProjectActions = false
    // æ¸…ç†é€‰ä¸­å·¥ç¨‹ç¼“å­˜ï¼Œä¿ç•™åˆ é™¤æµç¨‹æ—¶çš„ç¼“å­˜ç”±è°ƒç”¨æ–¹æŽ§åˆ¶
    if (!this.showDeleteDialog) {
      this.resetActiveProject()
    }
  }

  private resetActiveProject(): void {
    this.activeProjectId = null
    this.activeProjectCache = null
  }

  /**
   * æ ‡è®°å·¥ç¨‹ä¸ºå®Œæˆ
   */
  private markProjectAsCompleted(project: SimpleProject): void {
    if (project.status === ProjectStatus.COMPLETED) {
      this.showToast('è¯¥å·¥ç¨‹å·²æ˜¯å®ŒæˆçŠ¶æ€')
      return
    }

    project.status = ProjectStatus.COMPLETED
    project.updatedAt = new Date()
    this.projects = [...this.projects]
    this.searchProjects()
    this.updateProjectStatistics()
    this.showToast('å·²æ ‡è®°å·¥ç¨‹ä¸ºå®Œæˆ')
    this.closeProjectActions()
  }

  /**
   * åˆ é™¤å½“å‰é€‰ä¸­çš„å·¥ç¨‹
   */
  private deleteActiveProject(): void {
    if (!this.activeProjectId) {
      this.showDeleteDialog = false
      return
    }

    const targetId = this.activeProjectId
    this.projects = this.projects.filter((project: SimpleProject) => project.id !== targetId)
    this.resetActiveProject()
    this.showDeleteDialog = false
    this.closeProjectActions()
    this.searchProjects()
    this.updateProjectStatistics()
    this.showToast('å·¥ç¨‹å·²åˆ é™¤')
  }

  /**
   * æ˜¾ç¤ºæç¤ºä¿¡æ¯
   */
  private showToast(message: string): void {
    try {
      promptAction.showToast({
        message,
        duration: 2000
      })
    } catch (error) {
      console.warn('showToast failed:', error)
    }
  }

  build() {
    Stack() {
      Column() {
        Blank()
          .height(24)

        this.buildTopBar()

        if (this.showSearchPanel) {
          this.buildSearchPanel()
        }

        this.buildFilterBar()

        this.buildProjectContent()

        this.buildBottomNavigation()
      }

      if (this.showQuickActions) {
        this.buildQuickActionsPanel()
      }

      if (this.showCreateDialog) {
        this.buildCreateProjectDialog()
      }

      if (this.showProjectActions && this.activeProjectCache) {
        this.buildProjectActionSheet(this.activeProjectCache)
      }

      DeleteConfirmDialog({
        show: this.showDeleteDialog,
        itemName: this.getActiveProject()?.getDisplayName() || '',
        onConfirm: () => this.deleteActiveProject(),
        onCancel: () => {
          this.showDeleteDialog = false
          this.resetActiveProject()
        },
        onClose: () => {
          this.showDeleteDialog = false
          this.resetActiveProject()
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * é¡¶éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private buildTopBar() {
    Row() {
      // ä¾§è¾¹èœå•æŒ‰é’®
      Button() {
        Text('â˜°')
          .fontSize(18)
          .fontColor(this.showQuickActions ? '#FFFFFF' : '#1890FF')
      }
      .width(36)
      .height(36)
      .backgroundColor(this.showQuickActions ? '#1890FF' : '#E6F7FF')
      .borderRadius(12)
      .onClick(() => {
        console.log('Menu clicked')
        if (this.showQuickActions) {
          this.closeQuickActions()
        } else {
          this.openQuickActions()
        }
      })

      Blank()

      // åº”ç”¨æ ‡é¢˜
      Text('å·¥ç¨‹ç›¸æœº')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#262626')

      Blank()

      // æœç´¢æŒ‰é’®
      Button() {
        Text(this.showSearchPanel ? 'âœ•' : 'ðŸ”')
          .fontSize(18)
          .fontColor(this.showSearchPanel ? '#FFFFFF' : '#1890FF')
      }
      .width(36)
      .height(36)
      .backgroundColor(this.showSearchPanel ? '#1890FF' : '#E6F7FF')
      .borderRadius(12)
      .margin({ right: 8 })
      .animation({ duration: 150, curve: Curve.EaseInOut })
      .onClick(() => {
        console.log('Search clicked')
        this.toggleSearchPanel()
      })

      // æ‹ç…§å¿«æ·å…¥å£
      Button() {
        Text('ðŸ“·')
          .fontSize(18)
          .fontColor('#1890FF')
      }
      .width(36)
      .height(36)
      .backgroundColor('#E6F7FF')
      .borderRadius(12)
      .margin({ right: 8 })
      .onClick(() => {
        console.log('Camera quick action clicked')
        this.navigateToCamera()
      })

      // æ–°å»ºæŒ‰é’®
      Button() {
        Text('âŠ•')
          .fontSize(18)
          .fontColor(this.showCreateDialog ? '#FFFFFF' : '#1890FF')
      }
      .width(36)
      .height(36)
      .backgroundColor(this.showCreateDialog ? '#1890FF' : '#E6F7FF')
      .borderRadius(12)
      .animation({ duration: 150, curve: Curve.EaseInOut })
      .onClick(() => {
        console.log('Create project button clicked')
        this.createNewProject()
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 1 }, color: '#E8E8E8' })
  }

  /**
   * æœç´¢é¢æ¿
   */
  @Builder
  private buildSearchPanel() {
    Column({ space: 8 }) {
      SearchBar({
        query: this.searchQuery,
        placeholder: 'æœç´¢å·¥ç¨‹åç§°ã€ç¼–å·æˆ–è´Ÿè´£äºº',
        showCancel: true,
        autoFocus: true,
        onSearch: (query: string) => this.onSearchSubmit(query),
        onChange: (query: string) => this.onSearchChange(query),
        onCancel: () => this.closeSearchPanel()
      })
        .padding({ left: 16, right: 16, top: 12 })

      if (this.searchQuery.trim().length > 0) {
        Text(`å…±æ‰¾åˆ° ${this.filteredProjects.length} ä¸ªå·¥ç¨‹`)
          .fontSize(12)
          .fontColor('#8C8C8C')
          .padding({ left: 20, right: 20, bottom: 4 })
      }
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 1 }, color: '#E8E8E8' })
  }

  /**
   * å·¥ç¨‹çŠ¶æ€ç­›é€‰
   */
  @Builder
  private buildFilterBar() {
    Row({ space: 8 }) {
      ForEach(PROJECT_STATUS_FILTERS, (option: StatusFilterOption) => {
        Button(option.label)
          .fontSize(14)
          .fontColor(this.statusFilter === option.key ? '#FFFFFF' : '#1890FF')
          .backgroundColor(this.statusFilter === option.key ? '#1890FF' : '#EDF4FF')
          .padding({ left: 16, right: 16 })
          .height(36)
          .borderRadius(18)
          .onClick(() => this.onStatusFilterChange(option.key))
      }, (option: StatusFilterOption) => option.key)
    }
    .padding({ left: 16, right: 16, top: 10, bottom: 8 })
    .backgroundColor('#FFFFFF')
  }

  /**
   * å·¥ç¨‹å†…å®¹åŒºåŸŸ
   */
  @Builder
  private buildProjectContent() {
    Scroll() {
      Column() {
        // ç»Ÿè®¡æ¦‚è§ˆ
        Column() {
          Text('ðŸ“Š ç»Ÿè®¡æ¦‚è§ˆ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 12 })

          // ç»Ÿè®¡å¡ç‰‡è¡Œ
          Row({ space: 12 }) {
            StatCard({
              title: 'å·¥ç¨‹æ•°',
              value: this.totalProjectCount.toString(),
              icon: 'ðŸ“',
              color: '#1890FF'
            })

            StatCard({
              title: 'å·¥ç‚¹æ•°',
              value: this.totalSiteCount.toString(),
              icon: 'ðŸ“',
              color: '#52C41A'
            })

            StatCard({
              title: 'ç…§ç‰‡æ•°',
              value: this.totalPhotoCount.toString(),
              icon: 'ðŸ“·',
              color: '#FAAD14'
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .margin({ bottom: 12 })
        .borderRadius(8)

        // å·¥ç¨‹åˆ—è¡¨æ ‡é¢˜
        Row() {
          Text('ðŸ—ï¸ æˆ‘çš„å·¥ç¨‹')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')

          Blank()

          Text(`${this.filteredProjects.length} ä¸ªå·¥ç¨‹`)
            .fontSize(14)
            .fontColor('#8C8C8C')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 12 })
        .alignItems(VerticalAlign.Center)

        if (this.filteredProjects.length === 0) {
          Column({ space: 12 }) {
            Text(this.hasActiveFilter() ? 'æœªæ‰¾åˆ°åŒ¹é…çš„å·¥ç¨‹' : 'è¿˜æ²¡æœ‰å·¥ç¨‹é¡¹ç›®')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .textAlign(TextAlign.Center)

            Text(this.hasActiveFilter() ? 'å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ¸…ç©ºæœç´¢å…³é”®å­—ã€‚' : 'åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ç¨‹ï¼Œå¼€å§‹ç®¡ç†é¡¹ç›®ä¸ŽçŽ°åœºæ•°æ®ã€‚')
              .fontSize(14)
              .fontColor('#8C8C8C')
              .textAlign(TextAlign.Center)
              .lineHeight(20)
              .padding({ left: 24, right: 24 })

            Button(this.hasActiveFilter() ? 'é‡ç½®ç­›é€‰' : 'æ–°å»ºå·¥ç¨‹')
              .height(44)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#1890FF')
              .borderRadius(22)
              .padding({ left: 32, right: 32 })
              .onClick(() => {
                if (this.hasActiveFilter()) {
                  this.resetFilters()
                } else {
                  this.createNewProject()
                }
              })
          }
          .width('100%')
          .padding({ top: 48, bottom: 60 })
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ left: 16, right: 16, bottom: 80 })
        } else {
          Column({ space: 12 }) {
            ForEach(this.filteredProjects, (project: SimpleProject) => {
              SimpleProjectCard({
                project: project,
                showStats: true,
                onTap: (p: SimpleProject) => this.handleProjectClick(p),
                onLongPress: (p: SimpleProject) => this.handleProjectLongPress(p)
              })
            }, (project: SimpleProject) => `${project.id}_${this.projectRevision}`)
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 80 }) // åº•éƒ¨ç•™å‡ºå¯¼èˆªæ ç©ºé—´
        }
      }
      .width('100%')
    }
    .layoutWeight(1)
    .backgroundColor('#F5F5F5')
  }

  /**
   * åº•éƒ¨å¯¼èˆªæ 
   */
  @Builder
  private buildBottomNavigation() {
    Row() {
      // å·¥ç¨‹å¯¼èˆª
      Column() {
        Text('ðŸ—ï¸')
          .fontSize(24)
          .fontColor(this.currentTab === 'projects' ? '#1890FF' : '#8C8C8C')
        Text('å·¥ç¨‹')
          .fontSize(12)
          .fontColor(this.currentTab === 'projects' ? '#1890FF' : '#8C8C8C')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.currentTab === 'projects' ? '#E6F7FF' : Color.Transparent)
      .borderRadius(8)
      .padding({ top: 4, bottom: 4 })
      .animation({ duration: 200, curve: Curve.EaseInOut })
      .onClick(() => {
        console.log('Projects tab clicked')
        this.currentTab = 'projects'
        this.closeQuickActions()
      })

      // ç›¸å†Œå¯¼èˆª
      Column() {
        Text('ðŸ“±')
          .fontSize(24)
          .fontColor(this.currentTab === 'gallery' ? '#1890FF' : '#8C8C8C')
        Text('ç›¸å†Œ')
          .fontSize(12)
          .fontColor(this.currentTab === 'gallery' ? '#1890FF' : '#8C8C8C')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.currentTab === 'gallery' ? '#E6F7FF' : Color.Transparent)
      .borderRadius(8)
      .padding({ top: 4, bottom: 4 })
      .animation({ duration: 200, curve: Curve.EaseInOut })
      .onClick(() => {
        console.log('Gallery tab clicked')
        this.currentTab = 'gallery'
        this.navigateToGallery()
      })

      // è®¾ç½®å¯¼èˆª
      Column() {
        Text('âš™ï¸')
          .fontSize(24)
          .fontColor(this.currentTab === 'settings' ? '#1890FF' : '#8C8C8C')
        Text('è®¾ç½®')
          .fontSize(12)
          .fontColor(this.currentTab === 'settings' ? '#1890FF' : '#8C8C8C')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.currentTab === 'settings' ? '#E6F7FF' : Color.Transparent)
      .borderRadius(8)
      .padding({ top: 4, bottom: 4 })
      .animation({ duration: 200, curve: Curve.EaseInOut })
      .onClick(() => {
        console.log('Settings tab clicked')
        this.currentTab = 'settings'
        this.navigateToSettings()
      })
    }
    .width('100%')
    .height(60)
    .backgroundColor('#FFFFFF')
    .border({ width: { top: 1 }, color: '#E8E8E8' })
    .justifyContent(FlexAlign.SpaceAround)
    .padding({ bottom: 8 }) // ä¸ºå®‰å…¨åŒºåŸŸç•™å‡ºç©ºé—´
  }

  /**
   * å¿«æ·æ“ä½œé¢æ¿
   */
  @Builder
  private buildQuickActionsPanel() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.35)')
        .onClick(() => this.closeQuickActions())

      Column({ space: 12 }) {
        Text('å¿«æ·æ“ä½œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#262626')

        Text('åŒæ­¥é¡¹ç›®æ•°æ®')
          .fontSize(16)
          .fontColor('#1890FF')
          .padding({ top: 8, bottom: 8 })
          .onClick(() => this.handleQuickAction('sync'))

        Text('å¯¼å‡ºé¡¹ç›®æŠ¥è¡¨')
          .fontSize(16)
          .fontColor('#262626')
          .padding({ top: 8, bottom: 8 })
          .onClick(() => this.handleQuickAction('report'))

        Text('æŸ¥çœ‹å¸®åŠ©ä¸ŽæŒ‡å—')
          .fontSize(16)
          .fontColor('#262626')
          .padding({ top: 8, bottom: 8 })
          .onClick(() => this.handleQuickAction('help'))

        Divider()
          .color('#F0F0F0')
          .margin({ top: 8, bottom: 8 })

        Text('å…³é—­')
          .fontSize(16)
          .fontColor('#8C8C8C')
          .padding({ top: 8, bottom: 8 })
          .onClick(() => this.closeQuickActions())
      }
      .width('88%')
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .padding({ top: 20, bottom: 12, left: 20, right: 20 })
      .shadow({
        radius: 18,
        color: 'rgba(0, 0, 0, 0.15)',
        offsetX: 0,
        offsetY: 8
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(200)
  }

  /**
   * åˆ›å»ºå·¥ç¨‹å¯¹è¯æ¡†
   */
  @Builder
  private buildCreateProjectDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.35)')
        .onClick(() => this.closeCreateDialog())

      Column({ space: 16 }) {
        Text('æ–°å»ºå·¥ç¨‹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#262626')

        Column({ space: 12 }) {
          Text('å·¥ç¨‹åç§°')
            .fontSize(14)
            .fontColor('#8C8C8C')
          TextInput({ placeholder: 'è¯·è¾“å…¥å·¥ç¨‹åç§°', text: this.newProjectName })
            .fontSize(16)
            .backgroundColor('#F5F5F5')
            .height(48)
            .padding({ left: 12, right: 12 })
            .borderRadius(12)
            .onChange((value: string) => this.newProjectName = value)

          Text('è´Ÿè´£äºº')
            .fontSize(14)
            .fontColor('#8C8C8C')
          TextInput({ placeholder: 'è¯·è¾“å…¥è´Ÿè´£äºº', text: this.newProjectManager })
            .fontSize(16)
            .backgroundColor('#F5F5F5')
            .height(48)
            .padding({ left: 12, right: 12 })
            .borderRadius(12)
            .onChange((value: string) => this.newProjectManager = value)

          Text('å·¥ç¨‹ç®€ä»‹')
            .fontSize(14)
            .fontColor('#8C8C8C')
          TextArea({ placeholder: 'å¯é€‰ï¼Œè¯´æ˜Žå·¥ç¨‹çš„ä¸»è¦å†…å®¹', text: this.newProjectDescription })
            .fontSize(16)
            .backgroundColor('#F5F5F5')
            .height(96)
            .borderRadius(12)
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .onChange((value: string) => this.newProjectDescription = value)
        }

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor('#8C8C8C')
            .backgroundColor('#F0F0F0')
            .borderRadius(12)
            .onClick(() => this.closeCreateDialog())

          Button('åˆ›å»º')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#1890FF')
            .borderRadius(12)
            .onClick(() => this.saveNewProject())
        }
      }
      .width('88%')
      .backgroundColor('#FFFFFF')
      .padding({ left: 20, right: 20, top: 24, bottom: 20 })
      .borderRadius(20)
      .shadow({
        radius: 24,
        color: 'rgba(0, 0, 0, 0.18)',
        offsetX: 0,
        offsetY: 12
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(250)
  }

  /**
   * å·¥ç¨‹æ“ä½œé¢æ¿
   */
  @Builder
  private buildProjectActionSheet(project: SimpleProject) {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.35)')
        .onClick(() => this.closeProjectActions())

      Column({ space: 12 }) {
        Text(project.getDisplayName())
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#262626')
          .textAlign(TextAlign.Center)

        Button('æŸ¥çœ‹è¯¦æƒ…')
          .height(44)
          .fontSize(16)
          .fontColor('#1890FF')
          .backgroundColor('#EDF4FF')
          .borderRadius(12)
          .onClick(() => {
            this.handleProjectClick(project)
          })

        Button(project.status === ProjectStatus.COMPLETED ? 'æ ‡è®°ä¸ºè¿›è¡Œä¸­' : 'æ ‡è®°ä¸ºå®Œæˆ')
          .height(44)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor(project.status === ProjectStatus.COMPLETED ? '#52C41A' : '#1890FF')
          .borderRadius(12)
          .onClick(() => {
            if (project.status === ProjectStatus.COMPLETED) {
              project.status = ProjectStatus.ACTIVE
              project.updatedAt = new Date()
              this.projects = [...this.projects]
              this.searchProjects()
              this.updateProjectStatistics()
              this.showToast('å·²æ¢å¤å·¥ç¨‹ä¸ºè¿›è¡Œä¸­')
              this.closeProjectActions()
            } else {
              this.markProjectAsCompleted(project)
            }
          })

        Button('åˆ é™¤å·¥ç¨‹')
          .height(44)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF4D4F')
          .borderRadius(12)
          .onClick(() => {
            this.showProjectActions = false
            this.showDeleteDialog = true
          })

        Button('å–æ¶ˆ')
          .height(44)
          .fontSize(16)
          .fontColor('#8C8C8C')
          .backgroundColor('#F0F0F0')
          .borderRadius(12)
          .onClick(() => this.closeProjectActions())
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 32 })
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 20, topRight: 20, bottomLeft: 0, bottomRight: 0 })
      .alignSelf(ItemAlign.End)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(220)
  }
}
